import pandas as pd
import warnings
from datetime import datetime, time
import requests
import os
import json
import time as tm
import pytz
from dotenv import load_dotenv
import yfinance as yf
from concurrent.futures import ThreadPoolExecutor, as_completed
import numpy as np  # ğŸ‘ˆ (Ø¶Ø±ÙˆØ±ÙŠ) Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„Ù„Ù€ DNA

# =========================================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ´ØºÙŠÙ„
# =========================================================
load_dotenv()
API_KEY = os.getenv('FMP_API_KEY')
EODHD_API_KEY = os.getenv('EODHD_API_KEY')

if not API_KEY:
    print("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ FMP_API_KEY")
    exit()

TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

warnings.simplefilter(action='ignore', category=FutureWarning)

FLOAT_CACHE_FILE = "float_cache.json"
DAILY_WATCH_FILE = "daily_watch_list.json"
PATTERNS_FILE = "successful_candles.csv"  # Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹

# =========================================================
# 2. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ø´ + ØªÙ†Ø³ÙŠÙ‚)
# =========================================================
def fmt_shares(n):
    if not isinstance(n, (int, float)): return "ØºÙŠØ± Ù…ØªØ§Ø­"
    if n >= 1_000_000: return f"{n/1_000_000:.1f}M".replace(".0M", "M")
    if n >= 1_000: return f"{n/1_000:.1f}K".replace(".0K", "K")
    return str(int(n))

def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r') as f: return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f: json.dump(data, f)
    except: pass

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´
float_data_store = load_json_file(FLOAT_CACHE_FILE)

# =========================================================
# 3. Ø¬Ù„Ø¨ 100 Ø³Ù‡Ù… (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ù…Ø±ØªÙØ¹ + Ù†Ø´ÙŠØ· + ÙØ±ÙŠ ÙÙ„ÙˆØª Ù…Ù†Ø®ÙØ¶)
# =========================================================
def get_watchlist():
    """Ø¬Ù„Ø¨ 100 Ø³Ù‡Ù… Ù…Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù…Ø±ØªÙØ¹ÙŠÙ† ÙˆØ§Ù„Ù†Ø´Ø·ÙŠÙ† ÙˆØ§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª Ø§Ù„Ù…Ù†Ø®ÙØ¶"""
    global float_data_store
    print("ğŸ“¦ Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† FMP...")

    all_candidates = {}  # {symbol: {'change': %, 'volume': int, 'float': int, 'price': float}}

    # 1ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø±ØªÙØ§Ø¹Ø§Ù‹ (Gainers) - Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©
    try:
        url_gainers = f"https://financialmodelingprep.com/stable/gainers?apikey={API_KEY}"
        gainers = requests.get(url_gainers, timeout=10).json()
        if isinstance(gainers, list):
            print(f"ğŸ“ˆ Gainers: {len(gainers)} Ø³Ù‡Ù…")
            for item in gainers:
                sym = item.get('symbol', '')
                price = float(item.get('price', 0))
                change = float(item.get('changesPercentage', 0))
                volume = int(item.get('volume', 0))
                
                # ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø±: $0.02 - $8
                if 0.02 <= price <= 8 and len(sym) <= 5:
                    all_candidates[sym] = {
                        'change': change,
                        'volume': volume,
                        'price': price,
                        'float': 0,
                        'is_gainer': True,
                        'is_active': False
                    }
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Gainers: {e}")

    # 2ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹ (Actives) - Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©
    try:
        url_actives = f"https://financialmodelingprep.com/stable/actives?apikey={API_KEY}"
        actives = requests.get(url_actives, timeout=10).json()
        if isinstance(actives, list):
            print(f"ğŸ”¥ Actives: {len(actives)} Ø³Ù‡Ù…")
            for item in actives:
                sym = item.get('symbol', '')
                price = float(item.get('price', 0))
                change = float(item.get('changesPercentage', 0))
                volume = int(item.get('volume', 0))
                
                # ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø±: $0.02 - $8
                if 0.02 <= price <= 8 and len(sym) <= 5:
                    if sym in all_candidates:
                        all_candidates[sym]['is_active'] = True
                        all_candidates[sym]['volume'] = max(all_candidates[sym]['volume'], volume)
                    else:
                        all_candidates[sym] = {
                            'change': change,
                            'volume': volume,
                            'price': price,
                            'float': 0,
                            'is_gainer': False,
                            'is_active': True
                        }
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Actives: {e}")

    # 3ï¸âƒ£ Ø¥Ø°Ø§ Ù„Ù… Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ 100ØŒ Ù†ÙƒÙ…Ù„ Ù…Ù† Screener
    if len(all_candidates) < 100:
        try:
            url_screener = (f"https://financialmodelingprep.com/stable/company-screener"
                          f"?priceMoreThan=0.02&priceLowerThan=8&volumeMoreThan=100000"
                          f"&isEtf=false&exchange=nasdaq,nyse,amex&isActivelyTrading=true&limit=500&apikey={API_KEY}")
            screener = requests.get(url_screener, timeout=20).json()
            if isinstance(screener, list):
                print(f"ğŸ“Š Screener: {len(screener)} Ø³Ù‡Ù…")
                for item in screener:
                    sym = item.get('symbol', '')
                    price = float(item.get('price', 0))
                    volume = int(item.get('volume', 0))
                    
                    if 0.02 <= price <= 8 and len(sym) <= 5 and sym not in all_candidates:
                        all_candidates[sym] = {
                            'change': 0,
                            'volume': volume,
                            'price': price,
                            'float': 0,
                            'is_gainer': False,
                            'is_active': False
                        }
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ Screener: {e}")

    print(f"ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†: {len(all_candidates)} Ø³Ù‡Ù…")

    # 4ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª Ù„ÙƒÙ„ Ø³Ù‡Ù… (Ù…Ø¹ 7 workers)
    print("ğŸ” Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª...")
    
    def fetch_float(sym):
        """Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª Ù„Ø³Ù‡Ù… ÙˆØ§Ø­Ø¯"""
        if sym in float_data_store:
            raw_val = float_data_store[sym]
            if isinstance(raw_val, dict):
                raw_val = raw_val.get('value', 0)
        else:
            raw_val = 0
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Yahoo
            try:
                ticker_obj = yf.Ticker(sym)
                info = ticker_obj.info
                yahoo_float = info.get('floatShares', 0)
                if yahoo_float and yahoo_float > 0:
                    raw_val = yahoo_float
            except:
                pass
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© FMP
            if raw_val == 0:
                try:
                    f_url = f"https://financialmodelingprep.com/stable/shares-float?symbol={sym}&apikey={API_KEY}"
                    f_data = requests.get(f_url, timeout=3).json()
                    if f_data and isinstance(f_data, list):
                        raw_val = f_data[0].get('floatShares', 0)
                except:
                    pass
            
            float_data_store[sym] = raw_val
        
        try:
            return sym, float(raw_val) if raw_val else 999_999_999_999
        except:
            return sym, 999_999_999_999
    
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… 7 workers
    with ThreadPoolExecutor(max_workers=7) as executor:
        futures = {executor.submit(fetch_float, sym): sym for sym in all_candidates.keys()}
        for future in as_completed(futures):
            try:
                sym, float_val = future.result()
                all_candidates[sym]['float'] = float_val
            except:
                pass

    save_json_file(FLOAT_CACHE_FILE, float_data_store)

    # 5ï¸âƒ£ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:
    # - Ù…Ø±ØªÙØ¹ + Ù†Ø´ÙŠØ· + ÙØ±ÙŠ ÙÙ„ÙˆØª Ù…Ù†Ø®ÙØ¶ = Ø§Ù„Ø£ÙØ¶Ù„
    # - Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„)
    # - Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„)  
    # - Ø§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª (Ø§Ù„Ø£Ù‚Ù„ Ø£ÙØ¶Ù„)
    
    def priority_score(sym):
        data = all_candidates[sym]
        score = 0
        
        # Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„Ù…Ø±ØªÙØ¹ÙŠÙ†
        if data['is_gainer']:
            score += 1000
        
        # Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„Ù†Ø´Ø·ÙŠÙ†
        if data['is_active']:
            score += 500
        
        # Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (0-100 Ù†Ù‚Ø·Ø©)
        score += min(data['change'], 100)
        
        # Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… (0-100 Ù†Ù‚Ø·Ø©)
        vol_score = min(data['volume'] / 10_000_000, 100)
        score += vol_score
        
        # Ø§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª Ø§Ù„Ù…Ù†Ø®ÙØ¶ (0-200 Ù†Ù‚Ø·Ø©) - Ø§Ù„Ø£Ù‚Ù„ Ø£ÙØ¶Ù„
        if 0 < data['float'] <= 200_000_000:
            float_score = 200 - (data['float'] / 1_000_000)  # ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† = -1 Ù†Ù‚Ø·Ø©
            score += max(float_score, 0)
        
        return score

    # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    sorted_symbols = sorted(all_candidates.keys(), key=priority_score, reverse=True)

    # Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ 100 Ù…Ø¹ ÙÙ„ØªØ± Ø§Ù„ÙØ±ÙŠ ÙÙ„ÙˆØª
    final_list = []
    for sym in sorted_symbols:
        if len(final_list) >= 100:
            break
        
        data = all_candidates[sym]
        # ÙÙ„ØªØ±: ÙØ±ÙŠ ÙÙ„ÙˆØª Ø£Ù‚Ù„ Ù…Ù† 200 Ù…Ù„ÙŠÙˆÙ†
        if 0 < data['float'] <= 200_000_000:
            final_list.append(sym)
            tag = ""
            if data['is_gainer'] and data['is_active']:
                tag = "ğŸ”¥ğŸ“ˆ"
            elif data['is_gainer']:
                tag = "ğŸ“ˆ"
            elif data['is_active']:
                tag = "ğŸ”¥"
            print(f"ğŸ“Œ {len(final_list)}/100: {sym} {tag} (${data['price']:.2f}, +{data['change']:.1f}%, Float:{data['float']/1_000_000:.1f}M)")

    print(f"âœ… ØªÙ… Ø¬Ù„Ø¨ {len(final_list)} Ø³Ù‡Ù…")
    return final_list

# =========================================================
# 4. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ (Ø±Ø§Ø¨Ø· FMP Ø§Ù„Ø¬Ø¯ÙŠØ¯ stable)
# =========================================================
def get_fmp_data(symbol):
    # ğŸ”¥ Ø±Ø§Ø¨Ø· FMP Ø§Ù„Ø¬Ø¯ÙŠØ¯ (stable)
    url = f"https://financialmodelingprep.com/stable/historical-chart/5min?symbol={symbol}&apikey={API_KEY}"
    try:
        r = requests.get(url, timeout=10).json()
        if not r: return pd.DataFrame()
        df = pd.DataFrame(r)
        try:
            df['date'] = pd.to_datetime(df['date'], errors='coerce')
        except Exception as e:
            return pd.DataFrame()
        df = df.set_index('date').sort_index()
        df.columns = df.columns.str.capitalize()
        return df
    except Exception as e:
        return pd.DataFrame()

# =========================================================
# 5. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ (Ù†Ø³Ø®Ø© Ù…ÙˆØ²ÙˆÙ†Ø© Ø¨Ø§Ù„Ø°Ù‡Ø¨)
# =========================================================
def check_ladder_pattern(df_window):
    # Ù†Ø­ØªØ§Ø¬ 3 Ø´Ù…Ø¹Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
    if len(df_window) < 3: return False, 0, "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©"

    candles = [row for _, row in df_window.iterrows()]
    
    # 1. Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù… (Ù‡Ù„ Ø§Ù„Ø³Ø¹Ø± ÙØ¹Ù„Ø§Ù‹ ØµØ¹Ø¯ØŸ)
    start_price = float(candles[0]['Open'])
    current_price = float(candles[-1]['Close'])
    
    # Ø¥Ø°Ø§ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø§ÙØªØªØ§Ø­ØŒ Ù‡Ø°Ø§ Ù…Ùˆ Ø³Ù„Ù… ØµØ§Ø¹Ø¯
    if current_price <= start_price: 
        return False, 0, "Ø§ØªØ¬Ø§Ù‡ Ù‡Ø§Ø¨Ø·"

    # 2. ÙØ­Øµ Ø§Ù„Ù‡ÙŠÙƒÙ„ (Structure Check)
    # Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙØ­Øµ ÙƒÙ„ Ø´Ù…Ø¹Ø© Ø¨Ø¯Ù‚Ø©ØŒ Ù†ÙØ­Øµ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø§Ù…
    green_candles = 0
    strong_candles = 0 # Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ù„ÙŠ Ø£ØºÙ„Ù‚Øª ÙÙˆÙ‚ Ù‚Ù…ØªÙ‡Ø§ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    
    highest_high = 0
    prev_close = start_price
    
    warnings = 0 # Ø¹Ø¯Ø§Ø¯ "Ø§Ù„Ø¹ÙŠÙˆØ¨" Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© (Ù…Ø¹Ù†Ø§ Ø±ØµÙŠØ¯ 2)

    for i, row in enumerate(candles):
        open_p = float(row['Open'])
        close_p = float(row['Close'])
        high_p = float(row['High'])
        low_p = float(row['Low'])
        
        body = abs(close_p - open_p)
        upper_wick = high_p - max(open_p, close_p)
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù…Ø©
        if high_p > highest_high:
            highest_high = high_p

        # ØªØµÙ†ÙŠÙ Ø§Ù„Ø´Ù…Ø¹Ø©
        if close_p > open_p:
            green_candles += 1
            # Ù‡Ù„ Ù‡ÙŠ Ø´Ù…Ø¹Ø© Ù‚ÙˆÙŠØ©ØŸ (Ø¬Ø³Ù…Ù‡Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† Ø°ÙŠÙ„Ù‡Ø§ Ø§Ù„Ø¹Ù„ÙˆÙŠ)
            if body > upper_wick:
                strong_candles += 1
        else:
            # Ø´Ù…Ø¹Ø© Ø­Ù…Ø±Ø§Ø¡.. Ù‡Ù„ Ù‡ÙŠ ÙƒØ§Ø±Ø«ÙŠØ©ØŸ
            # Ø¥Ø°Ø§ Ø¬Ø³Ù…Ù‡Ø§ Ø§Ù„Ø£Ø­Ù…Ø± ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ¨Ø± Ù…Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø±ÙƒØ©)ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ø¹ÙŠØ¨
            if body > (current_price * 0.005): # 0.5% Ù†Ø²ÙˆÙ„ Ù‚ÙˆÙŠ
                warnings += 1

        # ğŸ›‘ ÙÙ„ØªØ± Ø§Ù„Ø°ÙŠÙˆÙ„ "Ø§Ù„ÙØ§Ø­Ø´Ø©" ÙÙ‚Ø·
        # Ù†Ø±ÙØ¶ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ø°ÙŠÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (3 Ø£Ø¶Ø¹Ø§Ù Ø§Ù„Ø¬Ø³Ù…)
        # Ù‡Ø°Ø§ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØµÙŠØ¯ Ø§Ù„ØªØµØ±ÙŠÙØŒ Ù„ÙƒÙ† Ø¨ÙŠÙ…Ø´ÙŠ Ø§Ù„Ø°ÙŠÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        if body > 0 and upper_wick > (body * 3.5):
            warnings += 1
            
        # ğŸ›‘ ÙÙ„ØªØ± Ø§Ù„ÙƒØ³Ø± (Ù…Ø±ÙˆÙ†Ø© Ø¹Ø§Ù„ÙŠØ©)
        # Ù†Ø³Ù…Ø­ Ø¨ÙƒØ³Ø± Ø§Ù„Ù‚Ø§Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ù†Ø³Ø¨Ø© Ø¨Ø³ÙŠØ·Ø© (0.3%) Ù„Ù„ØªØ®ÙˆÙŠÙ
        if i > 0:
            prev_low = float(candles[i-1]['Low'])
            if low_p < (prev_low * 0.997): # ÙƒØ³Ø± Ø­Ù‚ÙŠÙ‚ÙŠ Ø£ÙƒØ«Ø± Ù…Ù† 0.3%
                warnings += 1

    # ================= Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ =================
    
    # 1. Ù‡Ù„ "Ø§Ù„Ø¹ÙŠÙˆØ¨" ÙƒØ«ÙŠØ±Ø©ØŸ (Ø£ÙƒØ«Ø± Ù…Ù† 2 Ø¹ÙŠÙˆØ¨ Ù†Ø±ÙØ¶)
    if warnings >= 2:
        return False, 0, f"Ø¹ÙŠÙˆØ¨ Ù‡ÙŠÙƒÙ„ÙŠØ© ({warnings})"

    # 2. Ù‡Ù„ Ø§Ù„Ø£ØºÙ„Ø¨ÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ØŸ (Ù†Ù‚Ø¨Ù„ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ù†ØµØŒ Ø¨Ø´Ø±Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù‚ÙˆÙŠ)
    # Ù…Ø«Ù„Ø§ 3 Ø®Ø¶Ø± Ùˆ 3 Ø­Ù…Ø± ØµØºØ§Ø± = Ù…Ù‚Ø¨ÙˆÙ„
    if green_candles < 2: # Ù…Ø³ØªØ­ÙŠÙ„ Ø³Ù„Ù… Ø¨Ø´Ù…Ø¹Ø© Ø®Ø¶Ø±Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø©
        return False, 0, "ØºÙ„Ø¨Ø© Ø­Ù…Ø±Ø§Ø¡"

    # 3. Ù‡Ù„ Ø§Ù„Ø³Ø¹Ø± Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ù…Ø©ØŸ (Ø£Ù‡Ù… Ø´Ø±Ø·)
    # Ù†Ø³Ù…Ø­ Ø¨ØªØ±Ø§Ø¬Ø¹ 2% Ù…Ù† Ø§Ù„Ù‚Ù…Ø© (Ù…Ø±ÙˆÙ†Ø©)
    if current_price < (highest_high * 0.98):
        return False, 0, "Ø¥ØºÙ„Ø§Ù‚ Ø¶Ø¹ÙŠÙ"

    # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙˆØ© (ØªÙ‚Ø¯ÙŠØ±ÙŠ)
    # ÙƒÙ„ Ù…Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙˆÙŠØ© ÙˆÙ‚Ø±Ø¨Ù†Ø§ Ù…Ù† Ø§Ù„Ù‡Ø§ÙŠØŒ Ø²Ø§Ø¯Øª Ø§Ù„Ù†Ø³Ø¨Ø©
    strength_pct = int((strong_candles / len(candles)) * 60) + int((current_price / highest_high) * 40)
    
    return True, strength_pct, "Ù†Ù…ÙˆØ°Ø¬ Ù…Ø±Ù† âœ…"

def get_float_shares(symbol):
    """Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª"""
    global float_data_store
    val = float_data_store.get(symbol, 0)
    if isinstance(val, dict):
        val = val.get('value', 0)
    return val if isinstance(val, (int, float)) else 0

def send_telegram(message):
    if not TELEGRAM_BOT_TOKEN: return
    try:
        requests.post(
            f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",
            data={'chat_id': TELEGRAM_CHAT_ID, 'text': message, 'parse_mode': 'Markdown'},
            timeout=5
        )
    except: pass

# ======================= Ø¯ÙˆØ§Ù„ Ø§Ù„Ù€ DNA (Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨ØµØ±ÙŠ) =======================

def normalize_series(series):
    """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠØ© Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ø³"""
    if len(series) == 0: return series
    start = series.iloc[0]
    if start == 0: return series
    # Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­ Ø§Ù„Ø£ÙˆÙ„) / Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­ Ø§Ù„Ø£ÙˆÙ„
    return ((series - start) / start) * 100

def check_dna_match(live_df):
    """Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø­ÙŠ Ù…Ø¹ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù€ DNA (Ø¨Ø´Ø±ÙˆØ· Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø©)"""
    # 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
    if not os.path.exists(PATTERNS_FILE): return False, "", 0.0
    
    # Ø´Ø±Ø· 1: Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙŠ Ø¢Ø®Ø± Ù†Øµ Ø³Ø§Ø¹Ø©
    # Ø¥Ø°Ø§ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ù€ 6 Ø´Ù…ÙˆØ¹ Ø£Ù‚Ù„ Ù…Ù† 50 Ø£Ù„ÙØŒ Ù‡Ø°Ø§ Ø³Ù‡Ù… Ù…ÙŠØª
    if live_df['Volume'].sum() < 50_000:
        return False, "", 0.0

    # Ø´Ø±Ø· 2: Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø¹Ø±ÙŠØ© (Momentum)
    # Ø¥Ø°Ø§ Ø§Ù„Ø³Ù‡Ù… Ù…Ø§ ØªØ­Ø±Ùƒ Ù…Ù† Ù…ÙƒØ§Ù†Ù‡ (ØªØºÙŠØ± Ø£Ù‚Ù„ Ù…Ù† 0.5% Ù…Ù† Ø§Ù„Ø§ÙØªØªØ§Ø­ Ù„Ù„Ø¥ØºÙ„Ø§Ù‚)ØŒ Ù„Ø§ ØªÙ‚Ø§Ø±Ù†Ù‡!
    start_price = live_df['Open'].iloc[0]
    end_price = live_df['Close'].iloc[-1]
    total_change = ((end_price - start_price) / start_price) * 100
    
    if total_change < 0.5: # Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ØªØ­Ø±Ùƒ Ù†Øµ Ø¨Ø§Ù„Ù…ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
        return False, "", 0.0

    # Ø´Ø±Ø· 3: Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ (Ø¹Ø´Ø§Ù† Ù†Ù‚ØªÙ„ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…Ø©)
    # Ø¥Ø°Ø§ Ø§Ù„Ø³Ù‡Ù… ÙŠÙ…Ø´ÙŠ Ø¹Ø±Ø¶ÙŠ Ù…Ù…Ù„ØŒ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø­Ù‚Ù‡ Ø¨ÙŠÙƒÙˆÙ† Ù‚Ø±ÙŠØ¨ Ø§Ù„ØµÙØ±
    if live_df['Close'].std() < 0.01:
        return False, "", 0.0

    try: patterns_df = pd.read_csv(PATTERNS_FILE)
    except: return False, "", 0.0

    if len(live_df) < 6: return False, "", 0.0
    
    # Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    live_curve = normalize_series(live_df['Close'].iloc[:6])
    
    best_match_score = -1.0
    best_match_name = ""

    grouped = patterns_df.groupby('symbol')
    
    for name, group in grouped:
        if len(group) < 6: continue
        
        pattern_curve = normalize_series(group['close'].iloc[:6].reset_index(drop=True))
        
        # Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· (Ø§Ù„Ø´ÙƒÙ„)
        correlation = np.corrcoef(live_curve.values, pattern_curve.values)[0, 1]
        
        # Ø§Ù„Ù…Ø³Ø§ÙØ© (Ø§Ù„Ø­Ø¬Ù…) - Ù‡Ù†Ø§ Ø§Ù„Ø³Ø± Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠÙ‚Ø§Ø±Ù† Ø³Ù‡Ù… Ù…ÙŠØª Ø¨Ø³Ù‡Ù… Ø­ÙŠ
        # Ø²Ø¯Ù†Ø§ Ø§Ù„ØµØ±Ø§Ù…Ø© Ù‡Ù†Ø§ØŒ Ù„Ùˆ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ© ÙƒØ¨ÙŠØ±ØŒ Ø§Ø±ÙØ¶
        diff = np.abs(live_curve.values - pattern_curve.values).mean()
        
        # Ø§Ù„Ø´Ø±ÙˆØ·: Ø§Ø±ØªØ¨Ø§Ø· Ø¹Ø§Ù„ÙŠ + Ù…Ø³Ø§ÙØ© Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹ (ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ¹ÙˆØ¯)
        if correlation > best_match_score and diff < 1.5: # Ø¶ÙŠÙ‚Ù†Ø§ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† 2.5 Ù„Ù€ 1.5
            best_match_score = correlation
            best_match_name = name

    # Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙˆÙ‚ 90%
    if best_match_score > 0.90:
        pct = int(best_match_score * 100)
        return True, best_match_name, pct
        
    return False, "", 0.0

# =========================================================
# 6. Ø§Ù„ØªØ´ØºÙŠÙ„
# =========================================================
def main():
    print("ğŸ›¡ï¸ Ø¨ÙˆØª Ø§Ù„Ø³Ù„Ù… + DNA (Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø°ÙƒÙŠ) Ø¬Ø§Ù‡Ø²... 10:00 NY")

    while True:
        ny_tz = pytz.timezone('America/New_York')
        now_ny = datetime.now(ny_tz)

        if now_ny.time() >= time(10, 0, 15) or True:
            print("\nğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ...")
            send_telegram("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ (ØªÙ… ÙØµÙ„ ÙÙ„Ø§ØªØ± Ø§Ù„Ø³Ù„Ù… Ø¹Ù† Ø§Ù„Ù€ DNA)...")

            market_list = get_watchlist()
            saved_list = load_json_file(DAILY_WATCH_FILE)
            if isinstance(saved_list, dict): saved_list = list(saved_list.keys())
            elif not isinstance(saved_list, list): saved_list = []
            
            full_list = list(set(market_list + saved_list))
            print(f"ğŸ”¬ ÙØ­Øµ {len(full_list)} Ø³Ù‡Ù…...")

            matches = 0
            for ticker in full_list:
                try:
                    df = get_fmp_data(ticker)
                    if df.empty: continue
                    
                    last_ts = df.index[-1]
                    if (now_ny.date() - last_ts.date()).days > 1: continue 
                    
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    day_data = df[df.index.date == last_ts.date()]
                    setup = day_data.between_time('09:30', '10:00')

                    if len(setup) < 3: continue

                    # Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ±
                    total_vol = setup['Volume'].sum()
                    period_high = setup['High'].max()
                    period_low = setup['Low'].min()
                    period_move_pct = ((period_high - period_low) / period_low) * 100
                    
                    # ğŸŸ¢ ÙÙ„ØªØ± Ø¹Ù…ÙˆÙ…ÙŠ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ (Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†ÙÙ‚Ø¯ Ø§Ù„Ø³Ù„Ù…)
                    if total_vol < 10_000: continue # Ø£Ù‚Ù„ Ø´ÙŠ 10 Ø¢Ù„Ø§Ù
                    
                    # -----------------------------------------------
                    
                    # 1ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ø§Ù„Ø³Ù„Ù…) - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù…ÙˆØ¹
                    # Ø§Ù„Ø³Ù„Ù… ÙŠÙ…Ø± Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù…ØªÙˆØ³Ø·Ø© (Ù…Ø«Ù„Ø§Ù‹ 30k)
                    is_ladder, ladder_strength, _ = check_ladder_pattern(setup)
                    
                    # 2ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ù€ DNA - (Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„ØµØ§Ø±Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡)
                    # Ø§Ù„Ù€ DNA Ù„Ø§Ø²Ù… ÙŠØ«Ø¨Øª Ù‚ÙˆØªÙ‡ Ø¨Ø§Ù„Ø³ÙŠÙˆÙ„Ø© ÙˆØ§Ù„Ø­Ø±ÙƒØ©
                    is_dna_candidate, dna_name, dna_pct = check_dna_match(setup)
                    is_dna = False
                    
                    if is_dna_candidate:
                        # Ø´Ø±ÙˆØ· Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù€ DNA ÙÙ‚Ø·:
                        # 1. Ø³ÙŠÙˆÙ„Ø© Ø¹Ø§Ù„ÙŠØ© (> 100k)
                        # 2. ØªØ­Ø±Ùƒ Ø³Ø¹Ø±ÙŠ ÙˆØ§Ø¶Ø­ (> 1.5%)
                        if total_vol > 100_000 and period_move_pct > 1.5:
                            is_dna = True
                        else:
                            # Ù„Ùˆ ØªØ¨ÙŠ ØªØ´ÙˆÙ ÙˆØ´ Ø±ÙØ¶ØŒ Ø´ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
                            # print(f"Ø±ÙØ¶ DNA Ù„Ù€ {ticker}: Ø³ÙŠÙˆÙ„Ø© {fmt_shares(total_vol)} Ø£Ùˆ ØªØ­Ø±Ùƒ {period_move_pct:.2f}%")
                            pass

                    # 3ï¸âƒ£ Ø§Ù„Ù‚Ø±Ø§Ø± ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„
                    if is_ladder or is_dna:
                        price = setup['Close'].iloc[-1]
                        float_val = get_float_shares(ticker)
                        
                        if is_ladder and is_dna:
                            title = "ğŸ¥ˆ Ø¥Ø´Ø§Ø±Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© (DOUBLE) ğŸ”¥"
                            details = f"ğŸ’ª Ø³Ù„Ù…: {ladder_strength}% | ğŸ§¬ DNA: {dna_pct}% ({dna_name})"
                        elif is_dna:
                            title = "ğŸ§¬ Ø¥Ø´Ø§Ø±Ø© Ù†Ù…Ø· DNA ÙÙ‚Ø·"
                            details = f"ğŸ§¬ ØªØ·Ø§Ø¨Ù‚: {dna_pct}% Ù…Ø¹ Ù†Ù…Ø· ({dna_name})"
                        else:
                            title = "ğŸªœ Ø¥Ø´Ø§Ø±Ø© Ø³Ù„Ù… ØµØ§Ø¹Ø¯ ÙÙ‚Ø·"
                            details = f"ğŸ’ª Ù‚ÙˆØ© Ø§Ù„Ø³Ù„Ù…: {ladder_strength}%"

                        msg = (
                            f"{title}\n\n"
                            f"âœ… Ø§Ù„Ø³Ù‡Ù…: *{ticker}*\n"
                            f"ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {details}\n"
                            f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: *${price:.2f}*\n"
                            f"ğŸ“ˆ Ø§Ù„ØªØ­Ø±Ùƒ: *{period_move_pct:.2f}%*\n" 
                            f"ğŸ“Š Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: *{fmt_shares(total_vol)}*\n"
                            f"ğŸª¶ Ø§Ù„ÙÙ„ÙˆØª: *{fmt_shares(float_val)}*\n"
                            f"ğŸ•’ Ø§Ù„ØªÙˆÙ‚ÙŠØª: 10:00 NY"
                        )
                        send_telegram(msg)
                        print(f"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ {ticker}: {title}")
                        matches += 1

                except Exception as e:
                    continue

            if matches == 0:
                send_telegram("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ Ø§Ù„ÙŠÙˆÙ….")
                print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ.")
            else:
                print(f"ğŸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ {matches} ÙØ±Øµ.")
            
            print(f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ØªÙ… ÙØ­Øµ ÙØ¹Ù„ÙŠ {len(full_list)} Ø³Ù‡Ù…")
            break
        else:
            print(f"â³ {now_ny.strftime('%H:%M:%S')} NY - Ø§Ù†ØªØ¸Ø§Ø±...", end='\r')
            tm.sleep(10)

if __name__ == "__main__":
    main()
