import requests
import sys
import os
from datetime import datetime
from bs4 import BeautifulSoup
from dotenv import load_dotenv
import yfinance as yf

# ==============================================================================
# ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
# ==============================================================================
load_dotenv()

TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

# ==============================================================================
# ğŸ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
# ==============================================================================
MAX_FLOAT = 1_000_000          # Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„Ø£Ù‚ØµÙ‰: 1 Ù…Ù„ÙŠÙˆÙ†
MAX_DISTANCE_FROM_LOW = 15     # Ø£Ù‚ØµÙ‰ Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹: 15%

# Ø§Ù„ÙƒÙˆÙƒÙŠØ² ÙˆØ§Ù„Ù‡ÙŠØ¯Ø±
FINVIZ_COOKIE = """chartsTheme=dark; notice-newsletter=show; .ASPXAUTH=D330CB967EBE91926315BB9896B542528FF96DB8449F94F13D70816840198C006BFE7A3CF07AC123267CF83332233DAA6683BF667094DA4E899E12522DE82675747491B6F4350E4509C583E3631170A62D3152AC1D06B0829E119643B88B6BDCD3F47CE1F3BD22EFC8D6D838309B4DE85731B7FA14B437E1F3B858A371CA791B8AC3C09A10CD35225E249F3A817831A54209E9B0D90CE1C50B44482DC1FF1075E2A7F75B80B548D294C3873028318046AF1626F9FED7865D8217521A464D229739F4137055A9F5D559A2E58B0C731C9185F567CC; survey_dialog_cohort=0; customColors=%7B%22light%22%3A%7B%7D%2C%22dark%22%3A%7B%7D%7D; customColorsExpiration=12%2F27%2F2025%203%3A58%3A53%20PM"""

FINVIZ_HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
    "Connection": "keep-alive",
    "Cookie": FINVIZ_COOKIE
}

def log(msg):
    print(f"[{datetime.now().strftime('%H:%M:%S')}] {msg}")
    sys.stdout.flush()

def send_telegram(message):
    if not TELEGRAM_BOT_TOKEN: return
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": message}
        resp = requests.post(url, json=payload, timeout=10)
        if not resp.json().get('ok'):
            log(f"âŒ Ø®Ø·Ø£ ØªÙ„ÙŠØ¬Ø±Ø§Ù…: {resp.json()}")
    except Exception as e:
        log(f"âŒ Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„: {e}")

def clean_number(text):
    if not text or text == '-': return 0
    if isinstance(text, (int, float)): return text
    text = str(text).replace(',', '').replace('%', '')
    try:
        if 'M' in text: return float(text.replace('M', '')) * 1_000_000
        if 'B' in text: return float(text.replace('B', '')) * 1_000_000_000
        if 'K' in text: return float(text.replace('K', '')) * 1_000
        return float(text)
    except: return 0

def format_float(num):
    """ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ„ÙˆØª Ø¨Ø´ÙƒÙ„ Ù…Ù‚Ø±ÙˆØ¡"""
    if num >= 1_000_000:
        return f"{num/1_000_000:.2f}M"
    elif num >= 1_000:
        return f"{num/1_000:.0f}K"
    return str(int(num))

# ==============================================================================
# ğŸ¯ ØµÙŠØ§Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† - ÙÙ„ÙˆØª < 1.5M + Ù‚Ø±ÙŠØ¨ Ù…Ù† 52W Low
# ==============================================================================
def run_support_hunter_strategy():
    log("ğŸ”µ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Finviz (ÙÙ„ÙˆØª < 2M)...")

    # ============================================================
    # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† Finviz - ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
    # sh_float_u1 = ÙÙ„ÙˆØª Ø£Ù‚Ù„ Ù…Ù† 1 Ù…Ù„ÙŠÙˆÙ† (Ø£Ø¯Ù‚ ÙÙ„ØªØ± Ù…ØªØ§Ø­)
    # v=152 = Ø¹Ø±Ø¶ ÙŠØ´Ù…Ù„ Ø§Ù„ÙÙ„ÙˆØª
    # ============================================================

    candidates = []
    page = 1

    while True:
        start = (page - 1) * 20 + 1
        # v=152 ÙŠØ¹Ø±Ø¶: Float, Outstanding, Market Cap
        finviz_url = f"https://finviz.com/screener.ashx?v=152&f=sh_float_u1,sh_price_u20&ft=4&o=float&r={start}"

        try:
            resp = requests.get(finviz_url, headers=FINVIZ_HEADERS, timeout=15)
            soup = BeautifulSoup(resp.text, 'html.parser')

            table = soup.find('table', {'class': 'screener_table'})
            if not table:
                for t in soup.find_all('table'):
                    if len(t.find_all('tr')) > 10:
                        table = t
                        break

            if not table:
                break

            rows = table.find_all('tr')
            if len(rows) <= 1:
                break

            found_in_page = 0
            for row in rows[1:]:
                cells = row.find_all('td')
                if len(cells) >= 10:
                    try:
                        ticker = cells[1].get_text().strip()
                        float_text = cells[8].get_text().strip()  # Ø§Ù„ÙÙ„ÙˆØª ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© 8
                        price_text = cells[9].get_text().strip()  # Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© 9

                        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ„ÙˆØª
                        float_shares = clean_number(float_text)
                        price = clean_number(price_text)

                        # ============================================
                        # Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù‡Ù…Ø©:
                        # 1. Ø±Ù…Ø² ØµØ­ÙŠØ­ (Ù„ÙŠØ³ ETF)
                        # 2. ÙÙ„ÙˆØª Ù…Ø¹Ø±ÙˆÙ ÙˆØ£Ù‚Ù„ Ù…Ù† 1.5 Ù…Ù„ÙŠÙˆÙ†
                        # 3. Ø³Ø¹Ø± Ù…Ø¹Ù‚ÙˆÙ„
                        # ============================================

                        if ticker and len(ticker) <= 5 and '.' not in ticker:
                            # Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ù„ÙÙ„ÙˆØª Ù…Ø¹Ø±ÙˆÙ ÙˆØ£Ù‚Ù„ Ù…Ù† 1.5 Ù…Ù„ÙŠÙˆÙ†
                            if float_shares > 0 and float_shares <= MAX_FLOAT:
                                if 0.5 <= price <= 20.0:
                                    candidates.append({
                                        'symbol': ticker,
                                        'price': price,
                                        'float': float_shares
                                    })
                                    found_in_page += 1
                    except:
                        continue

            log(f"   ğŸ“„ ØµÙØ­Ø© {page}: ÙˆØ¬Ø¯Ù†Ø§ {found_in_page} Ø³Ù‡Ù… (ÙÙ„ÙˆØª < 1.5M)")

            if found_in_page == 0 and page > 1:
                break

            page += 1
            if page > 15:
                break

        except Exception as e:
            log(f"âš ï¸ Ø®Ø·Ø£ Finviz ØµÙØ­Ø© {page}: {e}")
            break

    if not candidates:
        log("ğŸ¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¨ÙÙ„ÙˆØª < 1.5M ÙÙŠ Finviz")
        return

    log(f"âœ… ÙˆØ¬Ø¯Ù†Ø§ {len(candidates)} Ø³Ù‡Ù… Ø¨ÙÙ„ÙˆØª < 1.5M Ù…Ù† Finviz")
    for c in candidates[:5]:
        log(f"   ğŸ“Œ {c['symbol']} | ${c['price']:.2f} | Float: {format_float(c['float'])}")

    # ============================================================
    # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¬Ù„Ø¨ 52W Low Ù…Ù† Yahoo Finance
    # ============================================================
    log(f"ğŸ” Ø¬Ù„Ø¨ 52W Low Ù…Ù† Yahoo Finance...")

    final_matches = []

    for stock in candidates:
        symbol = stock['symbol']
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info

            # ØªØ­Ù‚Ù‚ Ø¥Ù†Ù‡ Ù…Ùˆ ETF Ø£Ùˆ ØµÙ†Ø¯ÙˆÙ‚
            quote_type = info.get('quoteType', '')
            if quote_type in ['ETF', 'MUTUALFUND', 'INDEX']:
                continue

            price = info.get('currentPrice') or info.get('regularMarketPrice') or info.get('previousClose', 0)
            year_low = info.get('fiftyTwoWeekLow', 0)
            year_high = info.get('fiftyTwoWeekHigh', 0)
            change_pct = info.get('regularMarketChangePercent', 0)
            volume = info.get('volume', 0) or info.get('regularMarketVolume', 0)

            if not price or price <= 0 or not year_low or year_low <= 0:
                continue

            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
            distance = ((price - year_low) / year_low) * 100

            # Ø´Ø±Ø·: Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
            if distance <= MAX_DISTANCE_FROM_LOW:
                final_matches.append({
                    'symbol': symbol,
                    'price': price,
                    'year_low': year_low,
                    'year_high': year_high,
                    'float': stock['float'],  # Ø§Ù„ÙÙ„ÙˆØª Ù…Ù† Finviz
                    'distance': distance,
                    'change': change_pct,
                    'volume': volume
                })
                log(f"   ğŸ¯ {symbol} | ${price:.2f} | Float: {format_float(stock['float'])} | {distance:.1f}% from 52W Low")

        except Exception as e:
            continue

    # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
    final_matches.sort(key=lambda x: x['distance'])

    if final_matches:
        log(f"ğŸ¯ ÙˆØ¬Ø¯Ù†Ø§ {len(final_matches)} Ø³Ù‡Ù… Ù‚Ø±ÙŠØ¨ Ù…Ù† Ù‚Ø§Ø¹Ù‡!")

        # ÙÙ„ØªØ±Ø©: ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨ÙÙˆÙ„ÙŠÙˆÙ… Ø£ÙƒØ«Ø± Ù…Ù† 100K
        high_volume = [s for s in final_matches if s['volume'] >= 100_000]
        high_volume.sort(key=lambda x: x['volume'], reverse=True)

        if high_volume:
            # Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Yahoo Ù„ÙƒÙ„ Ø³Ù‡Ù…
            log("ğŸ“Š Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Yahoo...")
            for stock in high_volume:
                try:
                    ticker = yf.Ticker(stock['symbol'])
                    info = ticker.info
                    yahoo_float = info.get('floatShares', 0)
                    if yahoo_float and yahoo_float > 0:
                        stock['float'] = yahoo_float
                        log(f"   âœ… {stock['symbol']}: Float = {format_float(yahoo_float)}")
                except:
                    pass

            msg = "ğŸ”¥ğŸ’ ØµÙŠØ§Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† - ÙØ±Øµ Ø§Ù„ÙŠÙˆÙ… ğŸ’ğŸ”¥\n"
            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            msg += f"ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\n"
            msg += f"ğŸ¯ ÙÙ„ÙˆØª < 1M | Ù‚Ø±ÙŠØ¨ Ù…Ù† 52W Low | ÙÙˆÙ„ÙŠÙˆÙ… > 100K\n"
            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

            for i, stock in enumerate(high_volume, 1):
                distance_icon = "ğŸ”¥" if stock['distance'] < 5 else "âœ…" if stock['distance'] < 10 else "ğŸ“"

                msg += f"{distance_icon} #{i} - {stock['symbol']}\n"
                msg += f"â”£ ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: {stock['price']:.2f}\n"
                msg += f"â”£ ğŸ“Š Ø§Ù„ÙÙ„ÙˆØª: {format_float(stock['float'])}\n"
                msg += f"â”£ ğŸ“ˆ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ…: {stock['volume']:,.0f}\n"
                msg += f"â”£ ğŸ“‰ Ù‚Ø§Ø¹ 52 Ø£Ø³Ø¨ÙˆØ¹: {stock['year_low']:.2f}\n"
                msg += f"â”£ ğŸ“ Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ù‚Ø§Ø¹: {stock['distance']:.1f}%\n"
                msg += f"â”— ğŸ“Š Ø§Ù„ØªØºÙŠØ±: {stock['change']:+.1f}%\n\n"

            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            msg += f"âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Øµ: {len(high_volume)}\n"
            msg += "ğŸ¤– Low Float Hunter Bot"

            send_telegram(msg)
            log(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ {len(high_volume)} ÙØ±ØµØ© (ÙÙˆÙ„ÙŠÙˆÙ… > 100K) Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…")
        else:
            log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¨ÙÙˆÙ„ÙŠÙˆÙ… > 100K")

        # Ø£ÙØ¶Ù„ 10 Ù…Ù† Ù†Ø§Ø­ÙŠØ© Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… Ù„Ù„Ø¹Ø±Ø¶
        top_volume = sorted(final_matches, key=lambda x: x['volume'], reverse=True)[:10]

        print("\n" + "="*70)
        print("ğŸ¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ù‚Ø§Ø¹Ù‡Ø§ (Float < 1M):")
        print("="*70)
        for stock in final_matches:
            print(f"  {stock['symbol']:6} | ${stock['price']:7.2f} | Float: {format_float(stock['float']):>8} | {stock['distance']:.1f}% from low | Vol: {stock['volume']:,.0f}")
        print("="*70)

        print("\n" + "="*70)
        print("ğŸ”¥ Ø£ÙØ¶Ù„ 10 Ù…Ù† Ù†Ø§Ø­ÙŠØ© Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ…:")
        print("="*70)
        for i, stock in enumerate(top_volume, 1):
            print(f"  {i:2}. {stock['symbol']:6} | ${stock['price']:7.2f} | Float: {format_float(stock['float']):>8} | Vol: {stock['volume']:>12,}")
        print("="*70)

    else:
        log("ğŸ¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ù‚Ø§Ø¹Ù‡Ø§")

# ==============================================================================
# Ø§Ù„ØªØ´ØºÙŠÙ„
# ==============================================================================
def main():
    print("="*50)
    print("ğŸ¤– LOW FLOAT HUNTER - ØµÙŠØ§Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†")
    print("="*50)
    run_support_hunter_strategy()
    print("âœ… Done.")
    sys.exit()

if __name__ == "__main__":
    main()
