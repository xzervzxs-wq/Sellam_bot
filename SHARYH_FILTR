#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ğŸš€ Saudi Rotation Sniper (Final Diamond Version)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Rotation (High Volume / Low Float < 50M).
2. Ø§Ù„Ø´Ø±Ø¹ÙŠØ©: Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ØµÙˆÙ„ (Total Assets) < 33.33%.
3. Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©:
   - âœ… Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ† (Mining) ÙÙ‚Ø·ØŒ ÙˆØ·Ø±Ø¯ Ø§Ù„Ù…Ù†ØµØ§Øª (BKKT).
   - âœ… Ø·Ø±Ø¯ Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙØ±ÙŠ Ø§Ù„ØªÙŠ ØªØ¹ØªØ§Ø´ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ (MEIP).
   - âœ… Ø·Ø±Ø¯ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø±ÙŠØª (CMCT).
   - âœ… Ø·Ø±Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ÙˆÙ‚ÙˆÙØ© (isActivelyTrading = False).
4. Ø§Ù„ØªÙˆÙ‚ÙŠØª: Ø£ØªÙ…ØªØ© ÙƒØ§Ù…Ù„Ø© (NY Time).
5. Ø§Ù„Ø°Ø§ÙƒØ±Ø©: Master Cache ØªØ±Ø§ÙƒÙ…ÙŠ.
6. Ø§Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø°ÙƒÙŠ: ÙŠØ³ØªÙ…Ø± Ø¨Ø§Ù„Ø¨Ø­Ø« Ø­ØªÙ‰ ÙŠØ¬Ø¯ 20 Ø³Ù‡Ù… Ø­Ù„Ø§Ù„ Ù†Ø´Ø·.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

import os
import json
import time
import requests
import re
import sys
from datetime import datetime, timedelta
import pytz
from dotenv import load_dotenv

load_dotenv()

# ======================= âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =======================
FMP_API_KEY = os.getenv("FMP_API_KEY", "AzN1tXfit4MUgxLSvWO73Wusjz8f2v21")
TELEGRAM_BOT_TOKEN = "8320565935:AAFUnuZlt81XKiEZ_IxIGe6yXslF0mZk0_k"
TELEGRAM_CHAT_ID = "237657512"

# Ø§Ù„Ù…Ù„ÙØ§Øª
DAILY_WATCHLIST_FILE = "daily_watchlist.json"
MASTER_CACHE_FILE = "shariah_stocks_master.json"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ù…Ù† zakam.py - Strongest Rotation)
MIN_PRICE = 0.9           # Ù†ÙØ³ zakam.py (Ø±ÙØ¹Ù†Ø§Ù‡Ø§ Ù…Ù† 0.8 Ø¥Ù„Ù‰ 0.9)
MAX_PRICE = 12.0          # Ù†ÙØ³ zakam.py
MIN_VOLUME = 700_000      # Ù†ÙØ³ zakam.py (700K)
MAX_FLOAT = 50_000_000    # ÙÙ„ÙˆØª 50 Ù…Ù„ÙŠÙˆÙ† (Ø£Ø³Ù‡Ù… Ø®ÙÙŠÙØ©)
TARGET_COUNT = 20         # ğŸ¯ Ø§Ù„Ù‡Ø¯Ù 20 Ø³Ù‡Ù… Ù†Ø¸ÙŠÙ ÙÙ‚Ø· (Ø±Ø§Ø¨Ø­Ø© ÙˆÙ†Ø´Ø·Ø©)
CHECK_POOL_SIZE = 150     # Ù†ÙØ­Øµ Ø£Ù‚ÙˆÙ‰ 150 Ø³Ù‡Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ 20 Ø­Ù„Ø§Ù„
MIN_STOCK_AGE_MONTHS = 6  # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

# ======================= ğŸš« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø®ØµØµØ© =======================
HARAM_KEYWORDS = [
    'Bank', 'Lending', 'Loan', 'Interest', 'Mortgage', 'Insurance', 'Credit',
    'Financial', 'Asset Management', 'Brokerage', 'Capital', 'Investment',
    'Alcohol', 'Liquor', 'Beer', 'Wine', 'Brewer', 'Distiller',
    'Tobacco', 'Cigarette', 'Cannabis', 'Marijuana',
    'Pork', 'Ham', 'Bacon',
    'Casino', 'Gambling', 'Betting', 'Gaming', 'Resort',
    'Entertainment', 'Broadcasting', 'Media', 'Music', 'Television',
    'Gold', 'Silver', 'Precious Metals',
    'Defense', 'Weapon',
    'REIT', 'Real Estate Investment Trust' # â›”ï¸ Ø­Ø¸Ø± Ø§Ù„Ø±ÙŠØª
]

CRITICAL_KEYWORDS = [
    'Casino', 'Gambling', 'Alcohol', 'Liquor', 'Beer',
    'Wine', 'Tobacco', 'Pornography', 'Pork', 'Restaurant',
    'Nightclub', 'Adult'
]

# ======================= ğŸ› ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… =======================

def log(msg):
    print(f"[{datetime.now().strftime('%H:%M:%S')}] {msg}", flush=True)

def send_telegram(msg):
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": msg, "parse_mode": "HTML"}
        requests.post(url, json=payload, timeout=5)
    except: pass

def save_daily_watchlist(watchlist):
    try:
        with open(DAILY_WATCHLIST_FILE, 'w') as f: json.dump(watchlist, f, indent=2)
    except: pass

def clear_watchlist():
    """Ø­Ø°Ù Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆØªØ¬Ù‡ÙŠØ²Ù‡Ø§ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ"""
    save_daily_watchlist([])
    log("ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (End of Day Cleanup) Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ø§Ù‹ Ù„Ø£Ø³Ù‡Ù…Ùƒ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ØºØ¯Ø§Ù‹")

# ======================= ğŸ§  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Master Cache) =======================

def load_master_cache():
    if os.path.exists(MASTER_CACHE_FILE):
        try:
            with open(MASTER_CACHE_FILE, 'r') as f:
                data = json.load(f)
                return data if isinstance(data, dict) else {}
        except: pass
    return {}

def save_master_cache(cache_data):
    try:
        with open(MASTER_CACHE_FILE, 'w') as f: json.dump(cache_data, f, indent=2)
    except: pass

def get_cached_status(symbol, cache):
    if symbol in cache:
        entry = cache[symbol]
        status = entry if isinstance(entry, str) else entry.get('status')
        date_str = entry.get('date') if isinstance(entry, dict) else None

        if status in ['haram', 'haram_activity', 'haram_financial']: return 'haram'

        if status == 'halal':
            # âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØµÙ„Ø§Ø­ÙŠØ© 90 ÙŠÙˆÙ… (3 Ø´Ù‡ÙˆØ±) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 7 Ø£ÙŠØ§Ù…
            # Ù„Ø£Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© ØªØªØ­Ø¯Ø« Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ§Ù‹
            if date_str:
                try:
                    last_check = datetime.strptime(date_str, "%Y-%m-%d")
                    if (datetime.now() - last_check).days < 90:
                        return 'halal'
                except: pass
            else:
                return 'halal'
    return None

def update_cache(cache, symbol, status, reason=""):
    cache[symbol] = {"status": status, "date": datetime.now().strftime("%Y-%m-%d"), "reason": reason}
    save_master_cache(cache)

# ======================= ğŸ” Ø§Ù„Ù…Ø­Ø±Ùƒ: Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† NASDAQ =======================

def fetch_gainers_and_active():
    """Ø¬Ù„Ø¨ Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† NASDAQ Screener"""
    log("ğŸš€ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† NASDAQ (Volume > 700K, Price 0.9-12$)...")

    all_candidates = []
    seen_symbols = set()

    try:
        log("   ğŸ“Š Ø¬Ù„Ø¨ Ø£Ø³Ù‡Ù… NASDAQ...")

        # Ø¬Ù„Ø¨ Ù…Ù† screener Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù… (Ù†Ø²ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØºØ·ÙŠØ© Ø£ÙƒØ¨Ø±)
        for offset in [0, 500, 1000, 1500, 2000, 2500]:
            url = f"https://financialmodelingprep.com/api/v3/stock-screener"
            params = {
                "volumeMoreThan": MIN_VOLUME,
                "priceMoreThan": MIN_PRICE,
                "priceLowerThan": MAX_PRICE,
                "exchange": "NASDAQ",
                "isEtf": "false",
                "limit": 500,
                "offset": offset,
                "apikey": FMP_API_KEY
            }

            stocks = requests.get(url, params=params, timeout=15).json()

            if not stocks or not isinstance(stocks, list):
                break

            log(f"   ğŸ“¥ Ø¬Ù„Ø¨ {len(stocks)} Ø³Ù‡Ù… Ù…Ù† offset {offset}")

            for stock in stocks:
                try:
                    symbol = stock.get('symbol', '')
                    if symbol in seen_symbols:
                        continue
                    seen_symbols.add(symbol)

                    price = stock.get('price', 0)
                    volume = stock.get('volume', 0)
                    market_cap = stock.get('marketCap', 0)

                    # ğŸ”¥ ÙÙ„ØªØ± Ø£ÙˆÙ„ÙŠ: Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ÙˆÙ‚ÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                    is_actively_trading = stock.get('isActivelyTrading', True)

                    if MIN_PRICE <= price <= MAX_PRICE and volume >= MIN_VOLUME and is_actively_trading:
                        all_candidates.append({
                            'symbol': symbol,
                            'price': price,
                            'volume': volume,
                            'market_cap': market_cap,
                            'change_pct': 0,  # Ø³Ù†Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù…
                            'type': 'active'
                        })
                except:
                    continue

            if len(stocks) < 100:
                break

        log(f"   âœ… ØªÙ… Ø¬Ù…Ø¹ {len(all_candidates)} Ù…Ø±Ø´Ø­")

        # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù… (Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹)
        all_candidates = sorted(all_candidates, key=lambda x: x['volume'], reverse=True)

        # Ø£Ø®Ø° Ø£ÙØ¶Ù„ 150 Ø³Ù‡Ù… Ù„Ù„ÙØ­Øµ Ø§Ù„Ø´Ø±Ø¹ÙŠ (Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ 20 Ø­Ù„Ø§Ù„)
        all_candidates = all_candidates[:CHECK_POOL_SIZE]

        log(f"ğŸ¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠÙŠÙ†: {len(all_candidates)} Ø³Ù‡Ù… (Ø£Ø¹Ù„Ù‰ Ø­Ø¬Ù… ØªØ¯Ø§ÙˆÙ„)")

    except Exception as e:
        log(f"   âŒ Ø®Ø·Ø£: {e}")

    return all_candidates

# ======================= âš–ï¸ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø±Ø¹ÙŠ (Ø§Ù„Ø¯Ù‚ÙŠÙ‚) =======================

def check_shariah_compatible(symbol, cache):
    # 1. ÙØ­Øµ Ø§Ù„ÙƒØ§Ø´
    stat = get_cached_status(symbol, cache)
    if stat == 'halal': return True
    if stat == 'haram': return False

    try:
        prof = requests.get(f"https://financialmodelingprep.com/api/v3/profile/{symbol}?apikey={FMP_API_KEY}", timeout=5).json()
        if not prof: return False

        ind = prof[0].get('industry', ''); desc = prof[0].get('description', ''); sec = prof[0].get('sector', '')
        comp_name = prof[0].get('companyName', ''); ipo = prof[0].get('ipoDate', '')

        # ğŸ”¥ Ø·Ø±Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ÙˆÙ‚ÙˆÙØ© Ø¹Ù† Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (NAKD, CVT, GRUB, INFN Fix)
        is_active = prof[0].get('isActivelyTrading', True)
        if not is_active:
            update_cache(cache, symbol, 'haram_activity', 'Not Actively Trading (Delisted/Halted)')
            return False

        # Ø£) Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ IPO Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if ipo:
            try:
                if datetime.strptime(ipo, '%Y-%m-%d') > (datetime.now() - timedelta(days=MIN_STOCK_AGE_MONTHS * 30)):
                    return False
            except: pass

        # Ø¨) Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Mining Only) - BKKT Fix
        is_real_mining = any(k in desc.lower() or k in comp_name.lower()
                             for k in ['mining', 'miner', 'hashrate', 'blockchain infrastructure'])

        # Ø¬) Ø­Ø¸Ø± Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ (ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¹Ø¯Ù†ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ†)
        if sec == 'Financial Services' and not is_real_mining:
            update_cache(cache, symbol, 'haram_activity', 'Financial Sector')
            return False

        # Ø¯) Ø­Ø¸Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª
        for kw in CRITICAL_KEYWORDS + HARAM_KEYWORDS:
            # Ù†ØªØ¬Ø§ÙˆØ² ÙƒÙ„Ù…Ø§Øª Capital/Financial Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø¯Ù†Ø§Ù‹ Ø­Ù‚ÙŠÙ‚ÙŠØ§Ù‹
            if is_real_mining and kw.lower() in ['capital', 'financial']: continue

            if re.search(r'\b' + re.escape(kw.lower()) + r'\b', desc.lower()) or \
               re.search(r'\b' + re.escape(kw.lower()) + r'\b', ind.lower()):
                update_cache(cache, symbol, 'haram_activity', f'Keyword: {kw}')
                return False

        # 3. Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø£ØµÙˆÙ„ + Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙØ±ÙŠ)
        bs = requests.get(f"https://financialmodelingprep.com/api/v3/balance-sheet-statement/{symbol}?period=quarter&limit=1&apikey={FMP_API_KEY}", timeout=5).json()
        inc = requests.get(f"https://financialmodelingprep.com/api/v3/income-statement/{symbol}?period=quarter&limit=1&apikey={FMP_API_KEY}", timeout=5).json()

        if not bs or not inc: return False

        assets = bs[0].get('totalAssets', 0)
        if assets == 0: return False # Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¶Ø±ÙˆØ¨Ø©

        debt = bs[0].get('totalDebt', 0)
        cash = bs[0].get('cashAndShortTermInvestments', 0)
        intr = inc[0].get('interestIncome', 0) or 0
        rev = inc[0].get('revenue', 0) or 0

        # Ø§Ù„Ù†Ø³Ø¨ (Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ØµÙˆÙ„)
        debt_ratio = (debt / assets) * 100
        liq_ratio = (cash / assets) * 100

        # ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙØ±ÙŠ (MEIP Fix)
        if rev == 0:
            if intr > 0: pur_ratio = 100.0 # Ø­Ø±Ø§Ù… ÙÙˆØ±Ø§Ù‹
            else: pur_ratio = 0.0 # Ø­Ù„Ø§Ù„ (Ø´Ø±ÙƒØ© Ù†Ø§Ø´Ø¦Ø© Ù„Ù… ØªÙ‚ØªØ±Ø¶)
        else:
            pur_ratio = (intr / rev) * 100

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (33.33% Ø£ØµÙˆÙ„ / 5% ØªØ·Ù‡ÙŠØ±)
        if (debt_ratio < 33.33) and (liq_ratio < 33.33) and (pur_ratio < 5.0):
            update_cache(cache, symbol, 'halal', f"D:{debt_ratio:.1f} L:{liq_ratio:.1f} P:{pur_ratio:.1f}")
            log(f"   âœ… {symbol} Ù…Ù‚Ø¨ÙˆÙ„ (Rot High)")
            return True
        else:
            reason = f"Fail: D:{debt_ratio:.1f}% L:{liq_ratio:.1f}% P:{pur_ratio:.1f}%"
            update_cache(cache, symbol, 'haram_financial', reason)
            return False

    except: return False

# ======================= ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°ÙƒÙŠ =======================

def update_process(reset=False):
    log("ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« (Top Gainers + Most Active + Shariah Filter)...")

    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°ÙƒÙŠ
    old_list = []
    if not reset and os.path.exists(DAILY_WATCHLIST_FILE):
        try:
            with open(DAILY_WATCHLIST_FILE, 'r') as f:
                old_list = json.load(f)
                log(f"ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: {len(old_list)} Ø³Ù‡Ù…")
        except: pass

    if reset:
        save_daily_watchlist([])
        old_list = []

    candidates = fetch_gainers_and_active()
    if not candidates:
        log("âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø£ÙŠ Ù…Ø±Ø´Ø­ÙŠÙ† Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚")
        return

    # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù…ÙˆØ³ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
    candidates_dict = {item['symbol']: item for item in candidates}

    cache = load_master_cache()
    final_list = []
    checked = 0
    removed_stocks = []  # ğŸ“Š Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
    added_stocks = []    # ğŸ“Š Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø¶Ø§ÙØ©
    delisted_stocks = []

    # 1ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ©)
    if old_list:
        log(f"ğŸ” Ø¯Ù…Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ({len(old_list)} Ø³Ù‡Ù…) Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...")

        # Ù†Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„ÙŠØ¯ÙˆÙŠØ©) Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
        for symbol in old_list:
            final_list.append(symbol)
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ù‡Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù†Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
            if symbol in candidates_dict:
                log(f"Â  Â âœ… {symbol} (ÙŠØ¯ÙˆÙŠ + Ù†Ø´Ø· Ø¨Ø§Ù„Ø³ÙˆÙ‚)")
            else:
                log(f"Â  Â ğŸ›¡ï¸ {symbol} (ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„ÙŠÙ‡ Ù„Ø£Ù†Ù‡ Ù…Ø¶Ø§Ù ÙŠØ¯ÙˆÙŠØ§Ù‹)")

    # 2ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù
    needed = TARGET_COUNT - len(final_list)
    if needed > 0:
        log(f"ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† {needed} Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ¹ÙˆÙŠØ¶...")

        for item in candidates:
            if len(final_list) >= TARGET_COUNT:
                break

            checked += 1
            symbol = item['symbol']

            # ØªØ®Ø·ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
            if symbol in final_list:
                continue

            # ØªØ®Ø·ÙŠ Ø§Ù„Ù…ÙˆÙ‚ÙˆÙØ©
            if symbol in cache and cache[symbol].get('reason') == 'Not Actively Trading (Delisted/Halted)':
                delisted_stocks.append(symbol)
                continue

            if check_shariah_compatible(symbol, cache):
                final_list.append(symbol)
                added_stocks.append(symbol)
                log(f"   âœ… {symbol} Ø¬Ø¯ÙŠØ¯ - ${item['price']:.2f} | Ø­Ø¬Ù…: {item['volume']:,}")

    if final_list:
        save_daily_watchlist(final_list)
        title = "ğŸ”” <b>Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© (Fresh)</b>" if reset else "ğŸ”„ <b>ØªØ­Ø¯ÙŠØ« Ø°ÙƒÙŠ (Smart Update)</b>"

        msg = f"{title}\nğŸš€ <b>NASDAQ Top {len(final_list)} Most Active (Halal)</b>\n"
        msg += f"ğŸ’° Ø§Ù„Ø³Ø¹Ø±: {MIN_PRICE}-{MAX_PRICE}$ | Ø§Ù„Ø­Ø¬Ù…: >{MIN_VOLUME:,}\n"

        # ğŸ”¥ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°ÙƒÙŠ
        if not reset and (removed_stocks or added_stocks):
            msg += f"\nğŸ“Š <b>Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:</b>\n"
            if removed_stocks:
                msg += f"âŒ Ù…Ø­Ø°ÙˆÙ ({len(removed_stocks)}): {', '.join(removed_stocks)}\n"
            if added_stocks:
                msg += f"âœ… Ù…Ø¶Ø§Ù ({len(added_stocks)}): {', '.join(added_stocks)}\n"

        msg += f"\n<b>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ({len(final_list)}):</b>\n" + ", ".join(final_list)

        send_telegram(msg)
        log(f"ğŸ“ ØªÙ… Ø­ÙØ¸ {len(final_list)} Ø³Ù‡Ù… ÙÙŠ {DAILY_WATCHLIST_FILE}")
        if removed_stocks:
            log(f"âŒ Ù…Ø­Ø°ÙˆÙ: {', '.join(removed_stocks)}")
        if added_stocks:
            log(f"âœ… Ù…Ø¶Ø§Ù: {', '.join(added_stocks)}")
        log(f"âœ… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {', '.join(final_list)}")
        save_master_cache(cache)
    else:
        log("âŒ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø£ÙŠ Ø³Ù‡Ù….")

# ======================= â° Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ =======================

# ======================= ğŸ”¥ ÙØ­Øµ 1000 Ø³Ù‡Ù… ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ§Ø´ =======================

def fetch_all_stocks_from_nasdaq():
    """Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† NASDAQ/NYSE/AMEX (Ù…Ø¬Ø§Ù†ÙŠ - Ø¨Ø¯ÙˆÙ† API)"""
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json, text/plain, */*',
    }
    
    all_stocks = []
    
    exchanges = [
        ('NASDAQ', 'https://api.nasdaq.com/api/screener/stocks?tableonly=true&limit=10000&exchange=NASDAQ'),
        ('NYSE', 'https://api.nasdaq.com/api/screener/stocks?tableonly=true&limit=10000&exchange=NYSE'),
        ('AMEX', 'https://api.nasdaq.com/api/screener/stocks?tableonly=true&limit=10000&exchange=AMEX'),
    ]
    
    for name, url in exchanges:
        try:
            r = requests.get(url, headers=headers, timeout=30)
            if r.status_code == 200:
                data = r.json()
                rows = data.get('data', {}).get('table', {}).get('rows', [])
                log(f"   ğŸ“Š {name}: {len(rows)} Ø³Ù‡Ù…")
                all_stocks.extend(rows)
        except Exception as e:
            log(f"   âŒ {name}: Ø®Ø·Ø£ - {e}")
    
    return all_stocks

def bulk_shariah_check():
    """Ø¬Ù„Ø¨ Ø£Ø³Ù‡Ù… < $10 Ù…Ù† NASDAQ/NYSE ÙˆÙØ­Øµ Ø§Ù„Ø´Ø±Ø¹ÙŠØ©"""
    log("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„...")
    
    cache = load_master_cache()
    log(f"ğŸ“¦ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø­Ø§Ù„ÙŠ: {len(cache)} Ø³Ù‡Ù… Ù…Ø­ÙÙˆØ¸")
    
    # 1. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† NASDAQ/NYSE/AMEX (Ù…Ø¬Ø§Ù†ÙŠ)
    log("ğŸ“Š Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† NASDAQ/NYSE/AMEX...")
    all_stocks = fetch_all_stocks_from_nasdaq()
    log(f"âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {len(all_stocks)} Ø³Ù‡Ù…")
    
    if not all_stocks:
        log("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù…")
        return
    
    # 2. ÙÙ„ØªØ±Ø©: Ø³Ø¹Ø± < $10ØŒ Ø±Ù…Ø² â‰¤ 4 Ø­Ø±ÙˆÙ
    def get_price(s):
        try:
            p = s.get('lastsale', '$100').replace('$','').replace(',','')
            return float(p) if p else 100
        except:
            return 100
    
    filtered = []
    for stock in all_stocks:
        symbol = stock.get('symbol', '')
        price = get_price(stock)
        
        if symbol and len(symbol) <= 4 and '.' not in symbol and 0.01 < price < 10:
            filtered.append({'symbol': symbol, 'price': price, 'name': stock.get('name', '')})
    
    log(f"ğŸ” Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© (< $10ØŒ Ø±Ù…Ø² â‰¤4): {len(filtered)} Ø³Ù‡Ù…")
    
    # 3. ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„ÙƒØ§Ø´
    to_check = []
    skipped = 0
    
    for stock in filtered:
        symbol = stock['symbol']
        if symbol in cache:
            skipped += 1
        else:
            to_check.append(stock)
    
    log(f"â­ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ² {skipped} Ø³Ù‡Ù… (Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„ÙƒØ§Ø´)")
    log(f"ğŸ”¬ Ø³ÙŠØªÙ… ÙØ­Øµ {len(to_check)} Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯...")
    
    if not to_check:
        log("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙØ­Øµ!")
        send_telegram(f"âœ… <b>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯Ø©</b>\nğŸ“¦ Ø§Ù„ÙƒØ§Ø´: {len(cache)} Ø³Ù‡Ù…")
        return
    
    # 4. ÙØ­Øµ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    halal_count = 0
    haram_count = 0
    error_count = 0
    
    for i, stock in enumerate(to_check):
        symbol = stock['symbol']
        price = stock['price']
        
        try:
            # ÙØ­Øµ Ø§Ù„Ø´Ø±Ø¹ÙŠØ©
            is_halal = check_shariah_compatible(symbol, cache)
            
            if is_halal:
                halal_count += 1
                log(f"   âœ… [{i+1}/{len(to_check)}] {symbol} - ${price:.2f} (Ø­Ù„Ø§Ù„)")
            else:
                haram_count += 1
                if (i+1) % 100 == 0:  # Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ 100 Ø³Ù‡Ù…
                    log(f"   â³ [{i+1}/{len(to_check)}] Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ... (Ø­Ù„Ø§Ù„: {halal_count})")
            
            # ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø± Ù…Ù† FMP
            if (i+1) % 5 == 0:
                time.sleep(0.3)
                
        except Exception as e:
            error_count += 1
            if error_count <= 10:
                log(f"   âŒ {symbol}: Ø®Ø·Ø£ - {str(e)[:50]}")
    
    # 5. Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    save_master_cache(cache)
    
    # 6. Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    log("")
    log("=" * 50)
    log("ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„:")
    log(f"   ğŸ“¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ù‡Ù…: {len(all_stocks)}")
    log(f"   ğŸ” Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©: {len(filtered)}")
    log(f"   â­ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡Ø§ (Ù…ÙˆØ¬ÙˆØ¯Ø©): {skipped}")
    log(f"   ğŸ”¬ ØªÙ… ÙØ­ØµÙ‡Ø§: {len(to_check)}")
    log(f"   âœ… Ø­Ù„Ø§Ù„: {halal_count}")
    log(f"   âŒ Ø­Ø±Ø§Ù…: {haram_count}")
    log(f"   âš ï¸ Ø£Ø®Ø·Ø§Ø¡: {error_count}")
    log(f"   ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø¢Ù†: {len(cache)} Ø³Ù‡Ù…")
    log("=" * 50)
    
    # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    msg = f"""ğŸ“Š <b>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„</b>

ğŸ“¥ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† NASDAQ/NYSE: {len(all_stocks)}
ğŸ” Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© (< $10): {len(filtered)}
â­ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡Ø§: {skipped}
ğŸ”¬ ØªÙ… ÙØ­ØµÙ‡Ø§: {len(to_check)}

âœ… Ø­Ù„Ø§Ù„: {halal_count}
âŒ Ø­Ø±Ø§Ù…: {haram_count}
ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´: {len(cache)} Ø³Ù‡Ù…"""
    
    send_telegram(msg)

def main():
    log("ğŸš€ ÙˆØ¶Ø¹ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„ (Bulk Shariah Check)...")
    log("ğŸ“Š Ø¬Ù„Ø¨ Ù…Ù† NASDAQ/NYSE/AMEX (Ù…Ø¬Ø§Ù†ÙŠ)")
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
    bulk_shariah_check()
    
    log("âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙØ­Øµ!")

if __name__ == "__main__":
    main()