<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a472a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>المصمم القرآني | Quranic Designer Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <link id="fa-stylesheet" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link id="google-fonts" href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@400;700&family=El+Messiri:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@400;700&family=Lalezar&family=Mada:wght@400;700&family=Reem+Kufi:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold-primary: #c5a059;
            --green-deep: #1a472a;
            --bg-main: #fdfbf7;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-main);
            color: #2d3748;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            background-image: radial-gradient(var(--gold-primary) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Glassmorphism Panels --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -10px rgba(26, 71, 42, 0.15);
        }

        /* --- Canvas Area --- */
        .preview-area {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b4975a' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            border-radius: 24px;
            min-height: 60vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            border: 2px dashed var(--gold-primary);
            position: relative;
            transition: all 0.3s;
            padding: 20px;
        }

        #card {
            background-color: white;
            position: relative;
            box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2);
            overflow: hidden;
            margin: auto; direction: rtl;
            width: 378px; height: 672px;
            transform-origin: center;
            transition: width 0.3s, height 0.3s;
        }

        /* --- Z-INDEX & LAYERING SYSTEM --- */
        .image-layer.bg-image {
            width: 100% !important; height: 100% !important;
            top: 0 !important; left: 0 !important; transform: none !important;
            border: none !important; pointer-events: none;
            z-index: 1 !important;
        }
        #card-gradient {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 70%;
            background: linear-gradient(to top, rgba(255,255,255,0.95), transparent);
            pointer-events: none;
            display: none;
            z-index: 10 !important;
        }
        .frame-layer, .image-layer:not(.bg-image) { z-index: 20; }
        .text-layer { z-index: 50; }
        .draggable-el.selected { z-index: 100 !important; }
        #eraser-canvas, #snap-guide-v, #snap-guide-h { z-index: 200 !important; }

        /* --- Element Styling --- */
        .draggable-el {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            cursor: grab; touch-action: none;
            border: 1px solid transparent;
        }
        .draggable-el:active { cursor: grabbing; }
        .draggable-el.selected { border: 1px dashed var(--gold-primary); }
        .draggable-el.is-locked { cursor: default; }
        .draggable-el.selected.is-locked { border-color: #ef4444; border-style: dotted; }

        /* --- Handles --- */
        .handle { position: absolute; background: white; border: 1px solid var(--gold-primary); width: 12px; height: 12px; border-radius: 50%; z-index: 101; display: none; }
        .draggable-el.selected .handle { display: block; }
        .resize-nw { top: -6px; left: -6px; }
        .resize-ne { top: -6px; right: -6px; }
        .resize-sw { bottom: -6px; left: -6px; }
        .resize-se { bottom: -6px; right: -6px; }
        .resize-n { top: -6px; left: 50%; transform: translateX(-50%); }
        .resize-e { top: 50%; right: -6px; transform: translateY(-50%); }
        .resize-s { bottom: -6px; left: 50%; transform: translateX(-50%); }

        .control-btn { position: absolute; width: 28px; height: 28px; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 102; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .delete-btn { top: -35px; left: -10px; background: #ef4444; }
        .move-handle { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 40px; height: 28px; background: var(--green-deep); border-radius: 8px; cursor: move; display: none; align-items: center; justify-content: center; z-index: 102; color: var(--gold-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .draggable-el.selected .control-btn, .draggable-el.selected .move-handle { display: flex; }
        .draggable-el.is-locked .control-btn, .draggable-el.is-locked .handle, .draggable-el.is-locked .move-handle { display: none !important; }

        .ayah-text, .extra-text {
            line-height: 1.8; display: block; white-space: pre-wrap; outline: none;
            background: transparent; border: none; text-align: center; width: 100%;
            resize: none; overflow: visible;
            user-select: text !important; -webkit-user-select: text !important;
            touch-action: pan-x pan-y !important;
        }
        .image-layer img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        /* --- Controls Toolbar --- */
        .controls-row {
            width: 100%; margin-top: 0.5rem; padding: 0.8rem;
            border-top: 1px solid rgba(180, 151, 90, 0.2);
            display: none; flex-wrap: wrap; align-items: center; gap: 0.8rem;
            background: #faf9f6; border-radius: 12px;
        }
        .controls-row.active { display: flex; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-tool {
            background: white; border: 1px solid #efe9d9; color: var(--green-deep);
            padding: 8px; border-radius: 12px; font-weight: bold; font-size: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-tool:active { transform: scale(0.95); background: #f0fdf4; }

        #eraser-canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        .cursor-crosshair { cursor: crosshair !important; }
        .cursor-alias { cursor: alias !important; }

        #snap-guide-v, #snap-guide-h {
            position: absolute; background: #ef4444; display: none; pointer-events: none;
        }
        #snap-guide-v { top: 0; bottom: 0; left: 50%; width: 1px; }
        #snap-guide-h { left: 0; right: 0; top: 50%; height: 1px; }

        /* Progress Bar Styles */
        .progress-container { width: 80%; max-width: 300px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #c5a059; transition: width 0.3s ease; border-radius: 3px; }

        /* ===== MUSHAF WRAPPER (STANDALONE) ===== */
        #mushaf-wrapper {
            position: fixed; inset: 0; background: #fffbf2;
            z-index: 5000; display: none; flex-direction: column;
        }

        .mushaf-header {
            padding: 20px; background: linear-gradient(to bottom, rgba(255,255,255,0.95), transparent);
            display: flex; justify-content: space-between; color: var(--green-deep);
            font-family: 'Amiri', serif; font-size: 18px; z-index: 10;
        }

        .mushaf-frame {
            width: 100%; flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #mushaf-slider-view {
            position: relative; width: 100%; height: 100%;
        }

        .mushaf-slide-card {
            position: absolute; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s ease-out;
            transform: translateX(0);
        }

        #mushaf-verse-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            max-height: 60vh; display: flex; flex-direction: column;
            z-index: 2000; transform: translateY(100%); transition: transform 0.3s;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        #mushaf-verse-sheet.active { transform: translateY(0); }

        .verse-item-mushaf {
            padding: 12px; margin: 8px; border-radius: 8px;
            background: #f9f9f9; font-family: 'Amiri', serif;
            font-size: 16px; cursor: pointer; border: 1px solid transparent;
        }
        .verse-item-mushaf:active { background: #f0fdf4; border-color: var(--green-deep); }

        #mushaf-tafsir-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            z-index: 3000; display: none; justify-content: center; align-items: center;
        }

        .mushaf-tafsir-card {
            background: white; width: 90%; max-width: 500px; max-height: 70vh;
            border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
        }

        .mushaf-close-btn {
            position: absolute; top: 20px; left: 20px;
            background: #ef4444; color: white; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; font-size: 20px; z-index: 10;
        }

        body.dark-mode #mushaf-wrapper { background: #000; }
        body.dark-mode .mushaf-slide-card { background: #000; filter: invert(0.9) hue-rotate(180deg) brightness(1.1); }
    </style>
</head>
<body class="min-h-screen pb-10" onclick="deselect(event)">

    <!-- Hidden Font Loader -->
    <div id="hidden-font-loader" style="opacity:0; position:absolute; pointer-events:none;">
        <span style="font-family: 'Amiri', serif;">أ</span>
        <span style="font-family: 'Cairo', sans-serif;">أ</span>
        <span style="font-family: 'Aref Ruqaa', serif;">أ</span>
    </div>

    <!-- Start Overlay -->
    <div id="startup-overlay" style="position:fixed; inset:0; background:#1a472a; z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition:opacity 0.5s;">
        <i class="fas fa-kaaba text-[#c5a059] text-6xl mb-4 animate-pulse"></i>
        <div class="text-white font-bold text-xl mt-4 font-serif">المصمم القرآني</div>
        <div class="text-[#c5a059] text-sm">جاري التحميل...</div>
    </div>

    <!-- Export Overlay with Progress Bar -->
    <div id="export-overlay" style="display:none; position:fixed; inset:0; background:rgba(26,71,42,0.98); z-index:100000; flex-direction:column; justify-content:center; align-items:center;">
        <div class="text-[#c5a059] font-bold text-xl mb-2">جاري تجهيز التصميم</div>
        <div class="text-white text-xs opacity-90 mb-4" id="export-status">يرجى الانتظار قليلاً...</div>

        <div class="progress-container">
            <div class="progress-bar" id="export-progress"></div>
        </div>
        <div class="text-[#c5a059] text-[10px] mt-2 font-bold" id="progress-text">0%</div>
    </div>

    <!-- Save Modal -->
    <div id="save-modal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.95); z-index:100000; align-items:center; justify-content:center; flex-direction:column; padding:20px; backdrop-filter:blur(5px);">
        <div class="glass-panel p-6 rounded-2xl max-w-lg w-full flex flex-col items-center gap-4 border-none bg-white/10">
            <div class="text-white font-bold text-lg">✨ تم إنشاء التصميم</div>
            <img id="save-img" alt="تصميم" class="rounded-xl shadow-2xl max-h-[60vh] w-auto border-4 border-white/20">
            <div class="flex flex-col w-full gap-3">
                <button onclick="downloadImage()" class="bg-[#c5a059] text-white py-3 rounded-xl font-bold w-full shadow-lg">
                    <i class="fas fa-download"></i> حفظ في الاستوديو
                </button>
                <button onclick="document.getElementById('save-modal').style.display='none'" class="bg-white/10 text-white w-full py-3 rounded-xl font-bold">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Main UI -->
    <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">

        <!-- Sidebar Tools -->
        <div class="lg:col-span-4 glass-panel p-5 rounded-3xl flex flex-col gap-5 h-fit relative z-50" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between border-b border-[#efe9d9] pb-3">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-[#1a472a] rounded-xl flex items-center justify-center text-[#c5a059] shadow-lg"><i class="fas fa-quran text-2xl"></i></div>
                    <div>
                        <h1 class="font-bold text-[#1a472a] text-xl font-serif">المصمم القرآني</h1>
                        <p class="text-[11px] text-[#c5a059] font-bold">النسخة الاحترافية</p>
                    </div>
                </div>
            </div>

            <!-- Quran Selector -->
            <div class="bg-[#fdfbf7] p-4 rounded-2xl border border-[#efe9d9] space-y-3">
                <select id="surah-select" onchange="loadAyahs()" class="w-full p-3 bg-white border border-[#efe9d9] rounded-xl text-sm outline-none text-[#1a472a]"><option>اختر السورة...</option></select>
                <div class="flex gap-2">
                    <select id="ayah-select" class="flex-[3] p-3 bg-white border border-[#efe9d9] rounded-xl text-sm outline-none text-[#1a472a]"><option>رقم الآية...</option></select>
                    <button onclick="addAyah()" class="bg-[#1a472a] text-white py-2 px-4 rounded-xl text-xs font-bold whitespace-nowrap">إضافة</button>
                </div>
                <div class="pt-2 border-t border-dashed border-[#efe9d9]">
                    <button onclick="toggleRangeMode()" class="text-xs text-[#c5a059] font-bold flex items-center gap-1"><i class="fas fa-layer-group"></i> آيات متعددة</button>
                    <div id="range-ayah-container" class="hidden flex gap-2 mt-2">
                        <input type="number" id="ayah-from" placeholder="من" class="w-full p-2 rounded-lg border border-[#efe9d9] text-center">
                        <input type="number" id="ayah-to" placeholder="إلى" class="w-full p-2 rounded-lg border border-[#efe9d9] text-center">
                        <button onclick="addMultipleAyahs()" class="bg-[#c5a059] text-white w-10 rounded-lg"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </div>

            <!-- Quick Tools -->
            <div class="grid grid-cols-4 gap-2">
                <label class="btn-tool cursor-pointer col-span-2 flex-row justify-center gap-2 bg-[#1a472a] text-white">
                    <i class="far fa-image text-white"></i> <span>خلفية</span>
                    <input type="file" onchange="addImageLayer(this)" class="hidden" accept="image/*">
                </label>
                <label class="btn-tool cursor-pointer">
                    <i class="fas fa-camera"></i> صورة
                    <input type="file" onchange="addRegularImage(this)" class="hidden" accept="image/*">
                </label>
                <button onclick="addExtraText()" class="btn-tool"><i class="fas fa-font"></i> نص</button>
                <button onclick="addFrame()" class="btn-tool"><i class="far fa-square"></i> إطار</button>

                <button onclick="toggleShapeMenu()" class="btn-tool relative">
                    <i class="fas fa-shapes"></i> أشكال
                </button>

                <button onclick="toggleSizeMenu()" class="btn-tool col-span-2 flex-row justify-center gap-2">
                    <i class="fas fa-crop-alt"></i> مقاس <span id="size-label" class="text-[10px] text-gray-500 font-normal">Story</span>
                </button>
            </div>

            <div id="shape-menu-content" class="hidden bg-white p-3 rounded-xl border border-[#efe9d9] absolute top-full left-0 right-0 z-50 shadow-xl mt-2 flex gap-2 justify-center">
                <button onclick="addShape('square')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-square text-[#1a472a]"></i> مربع</button>
                <button onclick="addShape('circle')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-circle text-[#1a472a]"></i> دائرة</button>
                <button onclick="addShape('triangle')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-play text-[#1a472a] -rotate-90"></i> مثلث</button>
            </div>

            <div id="size-menu-content" class="hidden bg-white p-3 rounded-xl border border-[#efe9d9] absolute top-full left-0 right-0 z-50 shadow-xl mt-2">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setCardSize(378, 672, 'Story')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Story</button>
                    <button onclick="setCardSize(400, 400, 'Square')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Square</button>
                    <button onclick="setCardSize(378, 500, 'Post')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Post</button>
                </div>
            </div>
        </div>

        <!-- Workspace -->
        <div class="lg:col-span-8 flex flex-col gap-4">

            <!-- Floating Toolbar -->
            <div class="glass-panel p-3 rounded-2xl flex flex-wrap items-center justify-between gap-2 sticky top-2 z-30" onclick="event.stopPropagation()">
                <div class="flex items-center gap-2 bg-[#fdfbf7] p-1 rounded-xl border border-[#efe9d9]">
                    <button onclick="undoAction()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-[#1a472a]"><i class="fas fa-undo"></i></button>
                    <button onclick="redoAction()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-[#1a472a]"><i class="fas fa-redo"></i></button>
                </div>

                <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                    <button id="btn-grad" onclick="toggleGradient()" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a] flex items-center gap-2">
                        <i class="fas fa-adjust text-[#c5a059]"></i> تدرج
                    </button>
                    <button onclick="toggleBg()" id="btn-bg" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a]">شفافية</button>
                    <button id="btn-eraser" onclick="toggleEraserMode()" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a] flex items-center gap-2">
                        <i class="fas fa-eraser text-[#c5a059]"></i> الممحاة
                    </button>
                </div>

                <!-- Sub-Panels -->
                <div id="grad-controls" class="controls-row">
                    <span class="text-[10px] font-bold">اللون:</span>
                    <button onclick="setGradientColor('black')" class="w-6 h-6 rounded bg-black border border-gray-300"></button>
                    <button onclick="setGradientColor('white')" class="w-6 h-6 rounded bg-white border border-gray-300"></button>
                    <input type="range" min="0" max="1" step="0.1" value="0.8" oninput="setGradientOpacity(this.value)" class="w-20 accent-[#c5a059]">
                </div>

                <!-- Eraser Controls -->
                <div id="eraser-controls" class="controls-row">
                    <span class="text-[10px] font-bold">حجم:</span>
                    <input type="range" min="5" max="100" value="30" oninput="updateEraserSize(this.value)" class="w-20 accent-[#1a472a]">
                    <div class="w-px h-4 bg-gray-300 mx-2"></div>
                    <button id="btn-magic" onclick="toggleMagicMode()" class="px-2 py-1 rounded bg-white border border-[#efe9d9] text-[10px] font-bold flex items-center gap-1">
                        <i class="fas fa-magic"></i> سحرية
                    </button>
                    <div id="magic-tol-wrap" class="hidden items-center gap-1">
                        <span class="text-[10px]">دقة:</span>
                        <input type="range" min="1" max="100" value="30" oninput="updateMagicTolerance(this.value)" class="w-16 accent-[#c5a059]">
                    </div>
                    <button onclick="exitEraserMode()" class="bg-gray-200 px-3 py-1 rounded text-[10px] font-bold">إنهاء</button>
                </div>

                <!-- Frame Controls -->
                <div id="frame-controls" class="controls-row">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold">لون الحد:</span>
                        <input type="color" id="border-color" oninput="updateStyle('borderColor', this.value)" class="w-6 h-6 rounded border border-gray-300 cursor-pointer p-0">
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-[10px] font-bold">سمك:</span>
                        <input type="range" id="border-width" min="0" max="20" value="2" oninput="updateStyle('borderWidth', this.value + 'px')" class="w-16 accent-[#c5a059]">
                    </div>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold">تعبئة:</span>
                        <input type="color" id="bg-color" oninput="updateStyle('backgroundColor', this.value)" class="w-6 h-6 rounded border border-gray-300 cursor-pointer p-0">
                    </div>
                </div>

                <div id="top-font-controls" class="controls-row justify-between">
                    <div class="flex items-center gap-2 flex-1">
                        <i class="fas fa-text-height text-[#c5a059]"></i>
                        <input type="range" id="top-font-size" min="10" max="150" value="35" oninput="updateStyle('fontSize', this.value + 'px')" class="w-full accent-[#1a472a]">
                    </div>
                    <select id="top-font-family" onchange="updateStyle('fontFamily', this.value)" class="bg-white border border-[#efe9d9] rounded-lg text-xs font-bold py-1 px-2 outline-none text-[#1a472a] max-w-[100px]">
                        <option value="'Amiri', serif">النسخ (أميري)</option>
                        <option value="'Aref Ruqaa', serif">الرقعة</option>
                        <option value="'Cairo', sans-serif">كايرو</option>
                        <option value="'Tajawal', sans-serif">تجوال</option>
                        <option value="'Reem Kufi', sans-serif">كوفي</option>
                    </select>
                </div>

                <div id="quick-props" class="controls-row justify-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold">لون العنصر:</span>
                        <input type="color" id="quick-color" oninput="updateStyle('color', this.value)" class="w-8 h-8 rounded-full border-2 border-white shadow-sm overflow-hidden p-0 cursor-pointer">
                    </div>
                    <button onclick="deleteActive()" class="bg-red-50 text-red-600 px-4 py-1 rounded-full text-xs font-bold border border-red-100 flex items-center gap-1 hover:bg-red-100">
                        <i class="fas fa-trash-alt"></i> حذف
                    </button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="preview-area shadow-inner bg-[#f4f4f4]" onclick="deselect(event)">
                <div id="card" onclick="event.stopPropagation()">
                    <div id="card-gradient"></div>
                    <!-- Snap Guides -->
                    <div id="snap-guide-v"></div>
                    <div id="snap-guide-h"></div>
                </div>
            </div>

            <!-- Mobile Export Button -->
            <button onclick="exportCard()" class="fixed bottom-6 left-6 z-50 bg-[#c5a059] text-white w-16 h-16 rounded-full shadow-2xl flex flex-col items-center justify-center hover:scale-110 transition md:hidden border-4 border-white">
                <i class="fas fa-save text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold leading-none">حفظ</span>
            </button>

            <!-- Desktop Export -->
            <button onclick="exportCard()" class="hidden md:flex bg-[#1a472a] text-white w-full py-4 rounded-xl shadow-lg font-bold text-lg hover:bg-[#143620] items-center justify-center gap-2 transition">
                <i class="fas fa-file-export text-[#c5a059]"></i> حفظ التصميم النهائي
            </button>
        </div>
    </div>

    <script>
        const DPI_RATIO = 2;
        let activeEl = null;
        let currentSurahName = "";
        let undoStack = [];
        let redoStack = [];
        let isTransparent = false;
        let hasGradient = false;

        let eraserMode = false;
        let magicMode = false;
        let eraserSize = 30;
        let magicTolerance = 30;
        let eraserCanvas = null;

        window.onload = async () => {
            await document.fonts.ready;
            await inlineStyles();
            resizeCardToFit();
            window.addEventListener('resize', resizeCardToFit);

            setTimeout(() => {
                document.getElementById('startup-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('startup-overlay').remove(), 500);
            }, 1000);

            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                const sel = document.getElementById('surah-select');
                data.data.forEach(s => sel.innerHTML += `<option value="${s.number}">${s.number}. ${s.name}</option>`);
            } catch(e) {}
        };

        function resizeCardToFit() {
            const container = document.querySelector('.preview-area');
            const card = document.getElementById('card');
            card.style.transform = 'none';
            const scale = Math.min((container.clientWidth - 40) / card.offsetWidth, (container.clientHeight - 40) / card.offsetHeight);
            if (scale < 1) card.style.transform = `scale(${scale})`;
        }

        async function inlineStyles() {
            const links = [{id:'google-fonts', fa:false}, {id:'fa-stylesheet', fa:true}];
            for (const item of links) {
                try {
                    const el = document.getElementById(item.id);
                    if(!el) continue;
                    const res = await fetch(el.href);
                    let css = await res.text();
                    if(item.fa) css = css.replace(/\.\.\/webfonts/g, el.href.replace('/css/all.min.css','')+'/webfonts');
                    const style = document.createElement('style');
                    style.textContent = css;
                    document.head.appendChild(style);
                    el.remove();
                } catch(e){}
            }
        }

        function saveState() {
            const card = document.getElementById('card');
            undoStack.push(card.innerHTML);
            if (undoStack.length > 20) undoStack.shift();
            redoStack = [];
        }

        function undoAction() {
            if(undoStack.length === 0) return;
            const card = document.getElementById('card');
            redoStack.push(card.innerHTML);
            card.innerHTML = undoStack.pop();
            rebindEvents();
            deselect();
        }

        function redoAction() {
            if(redoStack.length === 0) return;
            const card = document.getElementById('card');
            undoStack.push(card.innerHTML);
            card.innerHTML = redoStack.pop();
            rebindEvents();
            deselect();
        }

        function rebindEvents() {
            document.querySelectorAll('.draggable-el').forEach(el => {
                if(!el.hasAttribute('data-events-bound')) setupInteract(el);
            });
        }

        function createWrapper(type) {
            const div = document.createElement('div');
            div.className = `draggable-el ${type} selected`;
            div.innerHTML = `
                <div class="control-btn delete-btn" onclick="removeEl(this.parentNode)"><i class="fas fa-times"></i></div>
                <div class="move-handle"><i class="fas fa-arrows-alt"></i></div>
                <div class="handle resize-nw"></div><div class="handle resize-ne"></div>
                <div class="handle resize-sw"></div><div class="handle resize-se"></div>
                <div class="handle resize-n"></div><div class="handle resize-e"></div><div class="handle resize-s"></div>
            `;
            const content = document.createElement('div');
            content.className = 'content-wrapper';
            content.style.width = '100%'; content.style.height = '100%';
            div.appendChild(content);
            div.insertBefore(content, div.lastChild);
            return div;
        }

        async function loadAyahs() {
            const num = document.getElementById('surah-select').value;
            if(!num) return;
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}`);
            const data = await res.json();
            currentSurahName = data.data.name;
            const sel = document.getElementById('ayah-select');
            sel.innerHTML = '<option value="">رقم الآية...</option>';
            data.data.ayahs.forEach(a => sel.innerHTML += `<option value="${a.numberInSurah}" data-text="${a.text}">${a.numberInSurah}</option>`);
        }

        function addAyah() {
            const sel = document.getElementById('ayah-select');
            if(!sel.value) return;
            const text = sel.options[sel.selectedIndex].getAttribute('data-text');
            addTextToCanvas(text.trim() + ' ﴿' + sel.value + '﴾', true);
            saveState();
        }

        function addTextToCanvas(content, isQuran) {
            const wrapper = createWrapper('text-layer');
            wrapper.style.color = '#2d3748';
            wrapper.style.fontSize = isQuran ? '28px' : '24px';
            wrapper.style.fontFamily = isQuran ? "'Amiri', serif" : "'Cairo', sans-serif";
            wrapper.style.fontWeight = isQuran ? '500' : '600';

            const textDiv = document.createElement('div');
            textDiv.className = isQuran ? 'ayah-text' : 'extra-text';
            textDiv.contentEditable = true;
            textDiv.innerText = content;
            textDiv.onblur = function() { if(this.innerText.trim() === '') this.innerText = 'نص...'; saveState(); };

            if(isQuran) {
                const span = document.createElement('div');
                span.innerText = currentSurahName;
                span.style.fontSize = '0.6em'; span.style.marginTop = '10px'; span.style.opacity = '0.7';
                span.className = 'surah-label';
                textDiv.appendChild(span);
            }
            wrapper.querySelector('.content-wrapper').appendChild(textDiv);
            document.getElementById('card').appendChild(wrapper);
            selectEl(wrapper); setupInteract(wrapper);
        }

        function addImageLayer(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'draggable-el image-layer bg-image is-locked';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    wrapper.appendChild(img);
                    const card = document.getElementById('card');
                    card.appendChild(wrapper);
                    saveState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function addRegularImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = createWrapper('image-layer');
                    wrapper.style.width = '200px'; wrapper.style.height = '200px';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    wrapper.querySelector('.content-wrapper').appendChild(img);
                    document.getElementById('card').appendChild(wrapper);
                    selectEl(wrapper); setupInteract(wrapper); saveState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function setupInteract(el) {
            if(el.hasAttribute('data-events-bound')) return;
            el.setAttribute('data-events-bound', 'true');

            let lastTap = 0;
            el.addEventListener('touchend', function(e) {
                const cur = new Date().getTime();
                if (cur - lastTap < 300 && !e.target.closest('.control-btn')) {
                    toggleLock(el); e.preventDefault();
                }
                lastTap = cur;
            });
            el.addEventListener('dblclick', () => toggleLock(el));

            el.addEventListener('mousedown', startDrag);
            el.addEventListener('touchstart', startDrag, {passive: false});

            function startDrag(e) {
                if(el.classList.contains('is-locked')) return;
                if(eraserMode) return;

                if(e.target.isContentEditable && !e.target.closest('.move-handle')) { selectEl(el); return; }

                const isTouch = e.type === 'touchstart';
                const startX = isTouch ? e.touches[0].clientX : e.clientX;
                const startY = isTouch ? e.touches[0].clientY : e.clientY;

                if(e.target.classList.contains('handle')) {
                    handleResize(e, el, e.target, startX, startY);
                    return;
                }
                if(e.target.closest('.control-btn')) return;

                e.preventDefault(); e.stopPropagation();
                selectEl(el);

                const startLeft = el.offsetLeft;
                const startTop = el.offsetTop;

                function onMove(ev) {
                    ev.preventDefault();
                    const cx = isTouch ? ev.touches[0].clientX : ev.clientX;
                    const cy = isTouch ? ev.touches[0].clientY : ev.clientY;
                    el.style.left = `${startLeft + (cx - startX)}px`;
                    el.style.top = `${startTop + (cy - startY)}px`;
                }

                function onUp() {
                    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
                    document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
                    saveState();
                }
                document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive: false});
                document.addEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
            }
        }

        function handleResize(e, el, handle, startX, startY) {
            const isTouch = e.type === 'touchstart';
            const startW = el.offsetWidth;
            const startH = el.offsetHeight;
            const startLeft = el.offsetLeft;
            const startTop = el.offsetTop;

            function onResize(ev) {
                ev.preventDefault(); ev.stopPropagation();
                const cx = isTouch ? ev.touches[0].clientX : ev.clientX;
                const cy = isTouch ? ev.touches[0].clientY : ev.clientY;
                const dx = cx - startX;
                const dy = cy - startY;

                let newW = startW, newH = startH, newLeft = startLeft, newTop = startTop;

                if (handle.classList.contains('resize-n') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-nw')) {
                    newH = Math.max(30, startH - dy);
                    newTop = startTop - (newH - startH)/2;
                } else if (handle.classList.contains('resize-s') || handle.classList.contains('resize-se') || handle.classList.contains('resize-sw')) {
                    newH = Math.max(30, startH + dy);
                    newTop = startTop + (newH - startH)/2;
                }

                if (handle.classList.contains('resize-e') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-se')) {
                    newW = Math.max(30, startW + dx);
                    newLeft = startLeft + (newW - startW)/2;
                } else if (handle.classList.contains('resize-w') || handle.classList.contains('resize-nw') || handle.classList.contains('resize-sw')) {
                    newW = Math.max(30, startW - dx);
                    newLeft = startLeft - (newW - startW)/2;
                }

                el.style.width = newW + 'px';
                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';

                if(el.classList.contains('text-layer')) {
                    if(!(handle.classList.contains('resize-n') || handle.classList.contains('resize-s'))) {
                        el.style.height = 'auto';
                    } else {
                        el.style.height = newH + 'px';
                    }
                } else {
                    el.style.height = newH + 'px';
                }
            }

            function onUp() {
                document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onResize);
                document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
                saveState();
            }
            document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onResize, {passive: false});
            document.addEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
        }

        function toggleEraserMode() {
            eraserMode = !eraserMode;
            magicMode = false;
            const btn = document.getElementById('btn-eraser');
            const controls = document.getElementById('eraser-controls');
            if(eraserMode) {
                deselect();
                btn.classList.add('border-[#c5a059]', 'bg-[#1a472a]', 'text-white');
                controls.classList.add('active');
                document.getElementById('card').classList.add('cursor-crosshair');
                initEraserCanvas();
            } else {
                exitEraserMode();
            }
        }

        function toggleMagicMode() {
            magicMode = !magicMode;
            const btn = document.getElementById('btn-magic');
            document.getElementById('magic-tol-wrap').style.display = magicMode ? 'flex' : 'none';
            btn.classList.toggle('bg-[#c5a059]', magicMode);
            btn.classList.toggle('text-white', magicMode);
            document.getElementById('card').classList.toggle('cursor-alias', magicMode);
        }

        function exitEraserMode() {
            eraserMode = false; magicMode = false;
            document.getElementById('btn-eraser').classList.remove('border-[#c5a059]', 'bg-[#1a472a]', 'text-white');
            document.getElementById('eraser-controls').classList.remove('active');
            document.getElementById('card').classList.remove('cursor-crosshair', 'cursor-alias');
            if(eraserCanvas) { eraserCanvas.remove(); eraserCanvas = null; }
        }

        function initEraserCanvas() {
            const card = document.getElementById('card');
            if(eraserCanvas) eraserCanvas.remove();
            eraserCanvas = document.createElement('canvas');
            eraserCanvas.width = card.offsetWidth; eraserCanvas.height = card.offsetHeight;
            eraserCanvas.id = 'eraser-canvas';

            const ctx = eraserCanvas.getContext('2d', {willReadFrequently:true});
            let isDrawing = false;

            const startDraw = (e) => {
                e.preventDefault();
                if(magicMode) {
                    const rect = eraserCanvas.getBoundingClientRect();
                    const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
                    const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
                    magicErase(x, y);
                    return;
                }
                isDrawing = true;
                saveState();
                moveDraw(e);
            };

            const moveDraw = (e) => {
                if(!isDrawing) return;
                const rect = eraserCanvas.getBoundingClientRect();
                const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
                const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;

                const images = card.querySelectorAll('.image-layer:not(.bg-image)');
                images.forEach(layer => {
                    const img = layer.querySelector('img');
                    if(!img) return;
                    const lRect = layer.getBoundingClientRect();
                    const cRect = card.getBoundingClientRect();
                    const lx = lRect.left - cRect.left;
                    const ly = lRect.top - cRect.top;

                    if(x >= lx && x <= lx + lRect.width && y >= ly && y <= ly + lRect.height) {
                       if(!layer.canvas) {
                           layer.canvas = document.createElement('canvas');
                           layer.canvas.width = lRect.width; layer.canvas.height = lRect.height;
                           layer.canvas.getContext('2d').drawImage(img,0,0, lRect.width, lRect.height);
                       }
                       const ictx = layer.canvas.getContext('2d');
                       ictx.globalCompositeOperation = 'destination-out';
                       ictx.beginPath();
                       ictx.arc(x-lx, y-ly, eraserSize/2, 0, Math.PI*2);
                       ictx.fill();
                       img.src = layer.canvas.toDataURL();
                    }
                });
            };

            eraserCanvas.addEventListener('mousedown', startDraw);
            eraserCanvas.addEventListener('mousemove', moveDraw);
            eraserCanvas.addEventListener('mouseup', () => isDrawing = false);
            eraserCanvas.addEventListener('touchstart', startDraw, {passive:false});
            eraserCanvas.addEventListener('touchmove', moveDraw, {passive:false});
            eraserCanvas.addEventListener('touchend', () => isDrawing = false);
            card.appendChild(eraserCanvas);
        }

        function magicErase(x, y) {
            saveState();
            const images = document.querySelectorAll('.image-layer:not(.bg-image)');
            images.forEach(layer => {
                const img = layer.querySelector('img');
                const lRect = layer.getBoundingClientRect();
                const cRect = document.getElementById('card').getBoundingClientRect();
                const lx = x - (lRect.left - cRect.left);
                const ly = y - (lRect.top - cRect.top);

                if(lx>=0 && lx<lRect.width && ly>=0 && ly<lRect.height) {
                    if(!layer.canvas) {
                        layer.canvas = document.createElement('canvas');
                        layer.canvas.width = lRect.width; layer.canvas.height = lRect.height;
                        layer.canvas.getContext('2d').drawImage(img,0,0, lRect.width, lRect.height);
                    }
                    const ctx = layer.canvas.getContext('2d');
                    const imgData = ctx.getImageData(0,0,lRect.width, lRect.height);
                    const data = imgData.data;
                    const idx = (Math.floor(ly)*lRect.width + Math.floor(lx)) * 4;
                    const tr=data[idx], tg=data[idx+1], tb=data[idx+2];

                    for(let i=0; i<data.length; i+=4) {
                        if(Math.abs(data[i]-tr) + Math.abs(data[i+1]-tg) + Math.abs(data[i+2]-tb) < magicTolerance*3) {
                            data[i+3] = 0;
                        }
                    }
                    ctx.putImageData(imgData, 0, 0);
                    img.src = layer.canvas.toDataURL();
                }
            });
        }

        function updateEraserSize(v) { eraserSize = parseInt(v); }
        function updateMagicTolerance(v) { magicTolerance = parseInt(v); }

        function selectEl(el) {
            if(activeEl) activeEl.classList.remove('selected');
            activeEl = el; activeEl.classList.add('selected');
            document.getElementById('quick-props').classList.add('active');

            if(el.classList.contains('text-layer')) {
                document.getElementById('top-font-controls').classList.add('active');
                document.getElementById('frame-controls').classList.remove('active');
                document.getElementById('top-font-size').value = parseInt(window.getComputedStyle(el).fontSize);
                const color = el.style.color || '#2d3748';
                document.getElementById('quick-color').value = rgbToHex(color);
            } else if (el.classList.contains('frame-layer')) {
                document.getElementById('frame-controls').classList.add('active');
                document.getElementById('top-font-controls').classList.remove('active');

                // Read color based on shape type
                let bg;
                if(el.dataset.shape === 'triangle') {
                    bg = el.querySelector('.content-wrapper').style.backgroundColor;
                } else {
                    bg = el.style.backgroundColor;
                }
                const bc = el.style.borderColor || '#000000';
                const bw = parseInt(el.style.borderWidth) || 0;

                document.getElementById('border-color').value = rgbToHex(bc);
                document.getElementById('border-width').value = bw;
                document.getElementById('bg-color').value = rgbToHex(bg || 'transparent');
                document.getElementById('quick-props').classList.remove('active');
            } else {
                document.getElementById('top-font-controls').classList.remove('active');
                document.getElementById('frame-controls').classList.remove('active');
            }
        }

        function rgbToHex(rgb) {
            if(!rgb || rgb==='transparent') return '#ffffff';
            if(rgb.startsWith('#')) return rgb;
            const sep = rgb.indexOf(',') > -1 ? ',' : ' ';
            const parts = rgb.substr(4).split(')')[0].split(sep);
            let r = (+parts[0]).toString(16), g = (+parts[1]).toString(16), b = (+parts[2]).toString(16);
            if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b;
            return "#" + r + g + b;
        }

        function deselect(e) {
            if(e && (e.target.closest('.draggable-el') || e.target.closest('.glass-panel') || e.target.closest('.controls-row'))) return;
            if(activeEl) activeEl.classList.remove('selected');
            activeEl = null;
            document.querySelectorAll('.controls-row').forEach(r => r.classList.remove('active'));
            exitEraserMode();
            document.getElementById('shape-menu-content').classList.add('hidden');
            document.getElementById('size-menu-content').classList.add('hidden');
        }

        function toggleLock(el) { el.classList.toggle('is-locked'); if(el.classList.contains('is-locked')) deselect(); else selectEl(el); }
        function removeEl(el) { el.remove(); deselect(); saveState(); }
        function deleteActive() { if(activeEl) removeEl(activeEl); }

        function updateStyle(prop, val) {
            if(!activeEl) return;

            // Triangle special case for background
            if (prop === 'backgroundColor' && activeEl.dataset.shape === 'triangle') {
                activeEl.querySelector('.content-wrapper').style.backgroundColor = val;
            } else {
                activeEl.style[prop] = val;
            }

            if(prop === 'color' || prop === 'borderColor') {
                const label = activeEl.querySelector('.surah-label');
                if(label) label.style.color = val;
            }
            if(prop === 'color') document.getElementById('quick-color').value = val;
            saveState();
        }

        function toggleGradient() {
            hasGradient = !hasGradient;
            document.getElementById('card-gradient').style.display = hasGradient ? 'block' : 'none';
            document.getElementById('grad-controls').classList.toggle('active', hasGradient);
            document.getElementById('btn-grad').classList.toggle('border-[#c5a059]', hasGradient);
        }
        function setGradientColor(c) {
            const end = c==='white' ? 'rgba(255,255,255,0.95)' : 'rgba(0,0,0,0.95)';
            const start = c==='white' ? 'rgba(255,255,255,0)' : 'rgba(0,0,0,0)';
            document.getElementById('card-gradient').style.background = `linear-gradient(to top, ${end}, ${start})`;
        }
        function setGradientOpacity(v) { document.getElementById('card-gradient').style.opacity = v; }
        function toggleBg() {
            isTransparent = !isTransparent;
            document.getElementById('card').style.backgroundColor = isTransparent ? 'transparent' : 'white';
            document.getElementById('btn-bg').classList.toggle('bg-[#1a472a]', isTransparent);
            document.getElementById('btn-bg').classList.toggle('text-white', isTransparent);
        }

        function setCardSize(w, h, l) {
            const card = document.getElementById('card');
            card.style.width = w+'px'; card.style.height = h+'px';
            document.getElementById('size-label').innerText = l;
            document.getElementById('size-menu-content').classList.add('hidden');
            resizeCardToFit();
        }
        function toggleSizeMenu() {
            document.getElementById('size-menu-content').classList.toggle('hidden');
            document.getElementById('shape-menu-content').classList.add('hidden');
        }
        function toggleShapeMenu() {
            document.getElementById('shape-menu-content').classList.toggle('hidden');
            document.getElementById('size-menu-content').classList.add('hidden');
        }
        function toggleRangeMode() { document.getElementById('range-ayah-container').classList.toggle('hidden'); }
        function addExtraText() { addTextToCanvas("نص جديد", false); saveState(); }

        function addFrame() {
            const w = createWrapper('frame-layer');
            w.style.borderColor='#1a472a';
            w.style.borderWidth='2px';
            w.style.width='200px'; w.style.height='200px';
            document.getElementById('card').appendChild(w); selectEl(w); setupInteract(w); saveState();
        }

        // New addShape logic
        function addShape(type) {
            const w = createWrapper('frame-layer');
            w.style.width='150px'; w.style.height='150px';
            w.dataset.shape = type; // Store shape type

            if(type === 'square') {
                w.style.backgroundColor='#c5a059';
                w.style.borderRadius='0';
            } else if(type === 'circle') {
                w.style.backgroundColor='#c5a059';
                w.style.borderRadius='50%';
            } else if(type === 'triangle') {
                w.style.backgroundColor='transparent'; // wrapper transparent
                const content = w.querySelector('.content-wrapper');
                content.style.backgroundColor = '#c5a059';
                content.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                content.style.width = '100%';
                content.style.height = '100%';
            }

            document.getElementById('card').appendChild(w);
            document.getElementById('shape-menu-content').classList.add('hidden');
            selectEl(w); setupInteract(w); saveState();
        }

        function addMultipleAyahs() {
            const f = parseInt(document.getElementById('ayah-from').value);
            const t = parseInt(document.getElementById('ayah-to').value);
            const sel = document.getElementById('ayah-select');
            if(!f || !t || f>t) return alert('خطأ في النطاق');
            let txt = "";
            for(let i=f; i<=t; i++) {
                for(let opt of sel.options) {
                    if(parseInt(opt.value)===i) { txt += opt.getAttribute('data-text').trim() + ' ﴿'+i+'﴾ '; break; }
                }
            }
            addTextToCanvas(txt, true); saveState();
        }

        // --- NEW EXPORT LOGIC WITH PROGRESS BAR & DECODE ---
        function updateProgress(percent, text) {
            document.getElementById('export-progress').style.width = percent + '%';
            document.getElementById('progress-text').innerText = percent + '%';
            document.getElementById('export-status').innerText = text;
        }

        async function exportCard() {
            deselect();
            const card = document.getElementById('card');
            const overlay = document.getElementById('export-overlay');
            const modal = document.getElementById('save-modal');
            const imgPreview = document.getElementById('save-img');

            overlay.style.display = 'flex';
            updateProgress(10, "جاري تحضير العناصر...");

            const oldT = card.style.transform;
            card.style.transform = 'scale(1)';
            document.querySelectorAll('.handle, .control-btn').forEach(e => e.style.display = 'none');

            try {
                // 1. Wait for Fonts
                await document.fonts.ready;
                updateProgress(30, "جاري معالجة الصور...");

                // 2. FORCE DECODE ALL IMAGES
                const imgs = card.querySelectorAll('img');
                const promises = Array.from(imgs).map(img => {
                    if (img.complete) {
                         // Try decoding if supported
                         if (img.decode) return img.decode().catch(() => {});
                         return Promise.resolve();
                    }
                    return new Promise(r => { img.onload = () => { if(img.decode) img.decode().catch(()=>{}); r(); }; img.onerror = r; });
                });
                await Promise.all(promises);

                updateProgress(50, "جاري المعالجة الأولية...");

                // 3. Force Layout Thrash
                void card.offsetHeight;
                await new Promise(r => setTimeout(r, 500)); // Delay for paint

                // 4. WARM UP CAPTURE (Discarded)
                updateProgress(70, "تحسين الدقة...");
                await htmlToImage.toPng(card, { quality: 0.5, pixelRatio: 1 });

                // 5. Short Delay before Final
                await new Promise(r => setTimeout(r, 800));

                // 6. FINAL CAPTURE
                updateProgress(90, "إنشاء الصورة النهائية...");
                const url = await htmlToImage.toPng(card, {
                    quality: 1.0, pixelRatio: 3, cacheBust: true, style: { transform: 'none', margin: 0 }
                });

                updateProgress(100, "تم!");

                imgPreview.src = url;

                setTimeout(() => {
                    overlay.style.display = 'none';
                    modal.style.display = 'flex';
                }, 500);

            } catch(e) {
                console.error(e);
                alert('حدث خطأ بسيط في التصدير، حاول مرة أخرى.');
                overlay.style.display = 'none';
            } finally {
                card.style.transform = oldT;
            }
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `quran-design-${Date.now()}.png`;
            link.href = document.getElementById('save-img').src;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function showInstallPrompt() { alert("لتثبيت التطبيق:\nآيفون: زر المشاركة -> إضافة للصفحة الرئيسية\nأندرويد: الثلاث نقاط -> تثبيت التطبيق"); }

        // ===== MUSHAF READER (STANDALONE) =====
        const MUSHAF_BASE_URL = 'https://raw.githubusercontent.com/batoulapps/quran-svg/main/svg/';
        const TOTAL_PAGES_MUSHAF = 604;
        let currentPageMushaf = parseInt(localStorage.getItem('lastPageMushaf')) || 1;
        let pageVersesMushaf = [];
        let selectedVerseMushaf = null;

        function openMushafMode() {
            const mushafView = document.getElementById('mushaf-wrapper');
            if (!mushafView) return;
            mushafView.style.display = 'flex';
            // تحميل الصفحة الأولى فوراً
            const container = document.getElementById('mushaf-slider-view');
            if (container) container.innerHTML = ''; // مسح الصفحات السابقة
            loadMushafPageView(currentPageMushaf).catch(e => console.error('Error loading page:', e));
            setupMushafTouchGestures();
        }

        function closeMushafMode() {
            const mushafView = document.getElementById('mushaf-wrapper');
            if (mushafView) mushafView.style.display = 'none';
        }

        async function loadMushafPageView(pageNum, direction = 'none') {
            if (pageNum < 1) pageNum = 1;
            if (pageNum > TOTAL_PAGES_MUSHAF) pageNum = TOTAL_PAGES_MUSHAF;

            const padded = String(pageNum).padStart(3, '0');
            const url = `${MUSHAF_BASE_URL}${padded}.svg`;

            const slide = document.createElement('div');
            slide.className = 'mushaf-slide-card';
            slide.innerHTML = `<img src="${url}" alt="صفحة ${pageNum}" style="max-width:100%; max-height:100%; object-fit:contain;">`;

            if (direction === 'next') slide.style.transform = 'translateX(-100%)';
            else if (direction === 'prev') slide.style.transform = 'translateX(100%)';

            const container = document.getElementById('mushaf-slider-view');
            container.appendChild(slide);

            const oldSlide = container.firstElementChild;
            if (direction !== 'none' && oldSlide && oldSlide !== slide) {
                slide.offsetHeight;
                slide.style.transform = 'translateX(0)';
                if (direction === 'next') oldSlide.style.transform = 'translateX(100%)';
                else oldSlide.style.transform = 'translateX(-100%)';
                setTimeout(() => oldSlide.remove(), 200);
            } else if (oldSlide) oldSlide.remove();

            currentPageMushaf = pageNum;
            localStorage.setItem('lastPageMushaf', currentPageMushaf);
            document.getElementById('mushaf-page-number').textContent = currentPageMushaf;

            await fetchMushafDataView(pageNum);
        }

        async function fetchMushafDataView(pageNum) {
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/page/${pageNum}/quran-uthmani`);
                const data = await res.json();
                pageVersesMushaf = data.data.ayahs;

                if (pageVersesMushaf.length) {
                    document.getElementById('mushaf-surah-name').textContent = pageVersesMushaf[0].surah.name;
                    document.getElementById('mushaf-juz-name').textContent = `الجزء ${pageVersesMushaf[0].juz}`;
                }
            } catch (e) {
                console.error('Error fetching data');
            }
        }

        function nextMushafPageView() {
            if (currentPageMushaf < TOTAL_PAGES_MUSHAF) loadMushafPageView(currentPageMushaf + 1, 'next');
        }

        function prevMushafPageView() {
            if (currentPageMushaf > 1) loadMushafPageView(currentPageMushaf - 1, 'prev');
        }

        function setupMushafTouchGestures() {
            const wrapper = document.getElementById('mushaf-wrapper');
            let touchX = 0;

            wrapper.addEventListener('touchstart', (e) => { touchX = e.changedTouches[0].screenX; }, { passive: true });
            wrapper.addEventListener('touchend', (e) => {
                const diff = touchX - e.changedTouches[0].screenX;
                if (Math.abs(diff) > 50) {
                    if (diff < 0) prevMushafPageView();
                    else nextMushafPageView();
                } else {
                    openMushafVerseSheet();
                }
            });
        }

        function openMushafVerseSheet() {
            const content = document.getElementById('mushaf-verse-content');
            if (pageVersesMushaf.length) {
                content.innerHTML = pageVersesMushaf.map(v => `
                    <div class="verse-item-mushaf" onclick="openMushafTafsir(${v.surah.number}, ${v.numberInSurah}, '${v.text.replace(/'/g, "\\'")}')">
                        (${v.numberInSurah}) ${v.text}
                    </div>
                `).join('');
            }
            document.getElementById('mushaf-verse-sheet').classList.add('active');
        }

        function closeMushafVerseSheet() {
            document.getElementById('mushaf-verse-sheet').classList.remove('active');
        }

        async function openMushafTafsir(surah, ayah, text) {
            selectedVerseMushaf = { surah, ayah, text };
            closeMushafVerseSheet();
            const modal = document.getElementById('mushaf-tafsir-modal');
            const content = document.getElementById('mushaf-tafsir-content');
            content.innerHTML = 'جاري التحميل...';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/ar.jalalayn`);
                const data = await res.json();
                content.innerHTML = data.data.text;
            } catch (e) {
                content.innerHTML = 'خطأ في التحميل';
            }
        }

        function closeMushafTafsir() {
            document.getElementById('mushaf-tafsir-modal').style.display = 'none';
        }

        function addVerseMushafToDesigner() {
            if (selectedVerseMushaf) {
                closeMushafTafsir();
                closeMushafMode();
                setTimeout(() => {
                    addTextToCanvas(selectedVerseMushaf.text + ` ﴿${selectedVerseMushaf.ayah}﴾`, true);
                }, 300);
            }
        }
    </script>

    <!-- ===== MUSHAF READER (STANDALONE MODE) ===== -->
    <div id="mushaf-wrapper">
        <div class="mushaf-header">
            <div id="mushaf-juz-name">الجزء ١</div>
            <div id="mushaf-surah-name">السورة</div>
            <button onclick="closeMushafMode()" class="mushaf-close-btn">✕</button>
        </div>

        <div class="mushaf-frame">
            <div id="mushaf-slider-view"></div>
            <div style="position: absolute; bottom: 95px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.8); padding: 6px 16px; border-radius: 20px; font-size: 14px; color: #666;">
                <span id="mushaf-page-number">1</span>
            </div>
            
            <!-- Navigation Buttons -->
            <button onclick="prevMushafPageView()" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; background: rgba(26,71,42,0.7); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 100;">›</button>
            <button onclick="nextMushafPageView()" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; background: rgba(26,71,42,0.7); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 100;">‹</button>
        </div>

        <!-- Verse List Sheet -->
        <div id="mushaf-verse-sheet">
            <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                <span style="font-weight: bold; color: var(--green-deep);">آيات الصفحة</span>
                <button onclick="closeMushafVerseSheet()" style="background: none; border: none; cursor: pointer; color: #ef4444; font-weight: bold;">✕</button>
            </div>
            <div id="mushaf-verse-content" style="overflow-y: auto; flex: 1; padding: 10px;"></div>
        </div>

        <!-- Tafsir Modal -->
        <div id="mushaf-tafsir-modal" onclick="if(event.target===this) closeMushafTafsir()">
            <div class="mushaf-tafsir-card" onclick="event.stopPropagation()">
                <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                    <h3 style="font-weight: bold; font-family: 'Amiri', serif; color: var(--green-deep);">تفسير الجلالين</h3>
                    <button onclick="closeMushafTafsir()" style="background: none; border: none; cursor: pointer; color: #ef4444; font-weight: bold;">✕</button>
                </div>
                <div id="mushaf-tafsir-content" style="flex: 1; overflow-y: auto; padding: 15px; text-align: justify; font-family: 'Amiri', serif; font-size: 16px;"></div>
                <div style="padding: 10px; border-top: 1px solid #eee;">
                    <button onclick="addVerseMushafToDesigner()" style="width: 100%; background: var(--green-deep); color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">إضافة للمصمم</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Mushaf Button -->
    <button onclick="openMushafMode()" style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--green-deep); color: var(--gold-primary); border: none; font-size: 24px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(26,71,42,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <i class="fas fa-book-open"></i>
    </button>

</body>
</html>