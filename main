import requests
import pandas as pd
import io
import os
import pytz
import json
import re
import yfinance as yf
from datetime import datetime, timedelta
from dotenv import load_dotenv
import concurrent.futures
import time

# ==============================================================================
# ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
# ==============================================================================
load_dotenv()
EODHD_API_KEY = os.getenv("EODHD_API_KEY")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
if not TELEGRAM_BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN is required. Please set it in your .env file.")
if not TELEGRAM_CHAT_ID:
    raise ValueError("TELEGRAM_CHAT_ID is required. Please set it in your .env file.")

MAX_WORKERS = 10  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø©
FLOAT_CACHE_FILE = "float_cache.json"
CHAT_HISTORY_FILE = "chat_history.json"
LAST_UPDATE_ID_FILE = "last_update_id.json"
USER_PREFERENCES_FILE = "user_preferences.json"

# Ù†Ù…Ø§Ø°Ø¬ GPT Ø§Ù„Ù…ØªØ§Ø­Ø©
GPT_PREMIUM_MODEL = "gpt-4"  # Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù…ÙŠØ²
GPT_STANDARD_MODEL = "gpt-3.5-turbo"  # Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (Ù…Ø¬Ø§Ù†ÙŠ Ù…Ø¹ Ø§Ù„Ø®Ø·Ø©)

# ==============================================================================
# ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¬Ù„Ø¨
# ==============================================================================
def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r', encoding='utf-8') as f: return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f: json.dump(data, f, indent=4)
    except: pass

float_cache = load_json_file(FLOAT_CACHE_FILE)

# ==============================================================================
# ğŸ’¬ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ GPT
# ==============================================================================
def load_last_update_id():
    """ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù ØªØ­Ø¯ÙŠØ« Ù…Ù† Ù…Ù„Ù"""
    data = load_json_file(LAST_UPDATE_ID_FILE)
    return data.get("last_update_id", 0)

def save_last_update_id(update_id):
    """Ø­ÙØ¸ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù ØªØ­Ø¯ÙŠØ«"""
    save_json_file(LAST_UPDATE_ID_FILE, {"last_update_id": update_id})

def send_telegram_message(chat_id, text):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù…"""
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "Markdown"
    }
    try:
        response = requests.post(url, json=payload, timeout=10)
        return response.json()
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")
        return None

def get_user_preference(chat_id, key, default=None):
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ¶ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…"""
    prefs = load_json_file(USER_PREFERENCES_FILE)
    user_prefs = prefs.get(str(chat_id), {})
    return user_prefs.get(key, default)

def set_user_preference(chat_id, key, value):
    """Ø­ÙØ¸ ØªÙØ¶ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…"""
    prefs = load_json_file(USER_PREFERENCES_FILE)
    if str(chat_id) not in prefs:
        prefs[str(chat_id)] = {}
    prefs[str(chat_id)][key] = value
    save_json_file(USER_PREFERENCES_FILE, prefs)

def chat_with_gpt(user_message, use_premium=True, _retry_count=0):
    """
    Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ GPT Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©
    
    Args:
        user_message: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        use_premium: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù…ÙŠØ² (True) Ø£Ùˆ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (False)
        _retry_count: Ø¹Ø¯Ø§Ø¯ Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ
    
    Returns:
        tuple: (response_text, model_used, success)
    """
    if not OPENAI_API_KEY:
        return "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ù…ÙØªØ§Ø­ OpenAI API. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© OPENAI_API_KEY ÙÙŠ Ù…Ù„Ù .env", None, False
    
    # Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ - Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù…Ù† premium Ø¥Ù„Ù‰ standard)
    if _retry_count > 0:
        return "âŒ ÙØ´Ù„Øª Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ù…Ø§Ø°Ø¬. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.", None, False
    
    model = GPT_PREMIUM_MODEL if use_premium else GPT_STANDARD_MODEL
    
    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": model,
        "messages": [
            {"role": "system", "content": "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙ…ÙÙŠØ¯. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø°Ù„Ùƒ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹."},
            {"role": "user", "content": user_message}
        ],
        "temperature": 0.7,
        "max_tokens": 1000
    }
    
    try:
        response = requests.post(
            "https://api.openai.com/v1/chat/completions",
            headers=headers,
            json=payload,
            timeout=30
        )
        
        if response.status_code == 200:
            data = response.json()
            answer = data["choices"][0]["message"]["content"]
            return answer, model, True
        
        elif response.status_code == 429 or response.status_code == 403:
            # ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© - Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ
            try:
                error_data = response.json()
                error_message = error_data.get("error", {}).get("message", "")
            except (json.JSONDecodeError, ValueError):
                error_message = response.text
            
            if use_premium and ("quota" in error_message.lower() or "allowance" in error_message.lower()):
                print("âš ï¸ ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©ØŒ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ...")
                # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ
                return chat_with_gpt(user_message, use_premium=False, _retry_count=_retry_count + 1)
            
            return f"âŒ Ø®Ø·Ø£: {error_message}", model, False
        
        else:
            try:
                error_data = response.json()
                error_message = error_data.get("error", {}).get("message", "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")
            except (json.JSONDecodeError, ValueError):
                error_message = f"Ø®Ø·Ø£ HTTP {response.status_code}"
            return f"âŒ Ø®Ø·Ø£ Ù…Ù† API: {error_message}", model, False
            
    except requests.exceptions.Timeout:
        return "â±ï¸ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", model, False
    except Exception as e:
        return f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}", model, False

def get_telegram_updates(offset=None):
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…"""
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/getUpdates"
    params = {
        "timeout": 30,
        "allowed_updates": ["message"]
    }
    if offset:
        params["offset"] = offset
    
    try:
        response = requests.get(url, params=params, timeout=35)
        if response.status_code == 200:
            return response.json().get("result", [])
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: {e}")
    
    return []

def process_telegram_messages():
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„ÙˆØ§Ø±Ø¯Ø©"""
    last_update_id = load_last_update_id()
    updates = get_telegram_updates(offset=last_update_id + 1 if last_update_id else None)
    
    for update in updates:
        update_id = update.get("update_id")
        message = update.get("message", {})
        chat_id = message.get("chat", {}).get("id")
        text = message.get("text", "")
        
        if not text or not chat_id:
            continue
        
        # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¨ÙˆØª (Ù…Ø«Ù„ /start)
        if text.startswith("/"):
            if text == "/start":
                welcome_msg = (
                    "ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø¨ÙˆØª Ø³Ù„Ø§Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ©.\n\n"
                    "ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ:\n"
                    "â€¢ Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ÙˆØ³Ø£Ø¬ÙŠØ¨ Ø¹Ù„ÙŠÙ‡\n"
                    "â€¢ Ø§Ø³ØªØ®Ø¯Ø§Ù… /premium Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù…ÙŠØ² GPT-4\n"
                    "â€¢ Ø§Ø³ØªØ®Ø¯Ø§Ù… /standard Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ GPT-3.5\n"
                    "â€¢ Ø§Ø³ØªØ®Ø¯Ø§Ù… /help Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©\n\n"
                    "ğŸ¯ Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„Ø¢Ù†!"
                )
                send_telegram_message(chat_id, welcome_msg)
            elif text == "/help":
                help_msg = (
                    "ğŸ“š **Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨ÙˆØª Ø³Ù„Ø§Ù…**\n\n"
                    "**Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:**\n"
                    "â€¢ /start - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\n"
                    "â€¢ /premium - Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ GPT-4 (Ù…Ù…ÙŠØ²)\n"
                    "â€¢ /standard - Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ GPT-3.5 (Ù‚ÙŠØ§Ø³ÙŠ)\n"
                    "â€¢ /help - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©\n\n"
                    "**Ø­ÙˆÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬:**\n"
                    "â€¢ GPT-4: Ù†Ù…ÙˆØ°Ø¬ Ù…ØªÙ‚Ø¯Ù… Ø¨Ù‚Ø¯Ø±Ø§Øª ÙØ§Ø¦Ù‚Ø© (Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª)\n"
                    "â€¢ GPT-3.5: Ù†Ù…ÙˆØ°Ø¬ Ù‚ÙŠØ§Ø³ÙŠ Ø³Ø±ÙŠØ¹ ÙˆÙ…ÙˆØ«ÙˆÙ‚ (Ù…Ø¬Ø§Ù†ÙŠ)\n\n"
                    "Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ."
                )
                send_telegram_message(chat_id, help_msg)
            elif text == "/premium":
                set_user_preference(chat_id, "use_premium", True)
                send_telegram_message(chat_id, "âœ… ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù…ÙŠØ² GPT-4 ğŸŒŸ\n\nØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… GPT-4 Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.")
            elif text == "/standard":
                set_user_preference(chat_id, "use_premium", False)
                send_telegram_message(chat_id, "âœ… ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ GPT-3.5 âš¡\n\nØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… GPT-3.5 Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.")
            
            save_last_update_id(update_id)
            continue
        
        print(f"ğŸ“¨ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† {chat_id}: {text}")
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "ÙŠÙƒØªØ¨..."
        requests.post(
            f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendChatAction",
            json={"chat_id": chat_id, "action": "typing"}
        )
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù…ÙŠØ² Ù…Ø¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
        use_premium = get_user_preference(chat_id, "use_premium", True)
        response_text, model_used, success = chat_with_gpt(text, use_premium=use_premium)
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if success and model_used:
            model_name = "GPT-4 ğŸŒŸ" if model_used == GPT_PREMIUM_MODEL else "GPT-3.5 âš¡"
            full_response = f"{response_text}\n\n_Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {model_name}_"
        else:
            full_response = response_text
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
        send_telegram_message(chat_id, full_response)
        
        # Ø­ÙØ¸ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù ØªØ­Ø¯ÙŠØ«
        save_last_update_id(update_id)
        print(f"âœ… ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… {model_used}")


def get_float_shares_safe(symbol):
    if symbol in float_cache: return float_cache[symbol]
    try:
        ticker = yf.Ticker(symbol)
        val = ticker.info.get('floatShares') or ticker.info.get('sharesOutstanding') or 0
        if val > 0:
            float_cache[symbol] = val
            save_json_file(FLOAT_CACHE_FILE, float_cache)
            return val
    except: return 0

def get_live_data(symbol):
    """Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù…ÙƒÙ†Ø© Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®"""
    try:
        # Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù€ yfinance Ù„Ø£Ù†Ù‡ Ø§Ù„Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Live)
        df = yf.download(symbol, period='2d', interval='5m', progress=False)
        if not df.empty:
            df.index = df.index.tz_convert('America/New_York')
            return df, "Yahoo-Live"
    except: pass
    return pd.DataFrame(), "None"

# ==============================================================================
# ğŸ§  ÙØ­Øµ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯)
# ==============================================================================
def evaluate_strategy(ticker):
    try:
        df, source = get_live_data(ticker)
        if df.empty: return None

        # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± ÙŠÙˆÙ… ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù€ DF
        last_date = df.index.date[-1]
        day_data = df[df.index.date == last_date]

        if len(day_data) < 3: return None

        # Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹
        c1 = day_data.iloc[-3] # Ø§Ù„Ø´Ù…Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        c2 = day_data.iloc[-2] # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        c3 = day_data.iloc[-1] # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        # Ø´Ø±Ø· Ø¨Ø³ÙŠØ·: Ø¢Ø®Ø± Ø´Ù…Ø¹ØªÙŠÙ† Ø®Ø¶Ø±Ø§Ø¡ Ù…Ø¹ ØµØ¹ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
        if c3['Close'] > c3['Open'] and c2['Close'] > c2['Open']:
            if c3['Low'] >= c2['Low']:

                float_val = get_float_shares_safe(ticker)
                current_price = float(c3['Close'])
                morning_high = day_data['High'].max()

                # Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                msg = (
                    f"ğŸªœ **Ø¥Ø´Ø§Ø±Ø© Ø³Ù„Ù… ØµØ§Ø¹Ø¯ (Live)**\n"
                    f"ğŸ† Ø§Ù„Ø³Ù‡Ù…: *{ticker}*\n"
                    f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¢Ù†: *${current_price:.2f}*\n"
                    f"ğŸ¯ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…: *${morning_high:.2f}*\n"
                    f"ğŸ“Š ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {last_date}\n"
                    f"ğŸ“¡ Ø§Ù„Ù…ØµØ¯Ø±: {source}\n"
                    f"---------------------------"
                )
                return msg
    except: pass
    return None

# ==============================================================================
# ğŸš€ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# ==============================================================================
def run_stock_monitor():
    """ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ù‡Ù…"""
    watch_list = ["TSLA", "NBY", "SIDU", "MVIS", "AAPL", "AMD", "NVDA", "RIVN", "MARA", "RIOT"]

    print(f"ğŸ“¡ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ© Ù„Ù€ {len(watch_list)} Ø³Ù‡Ù…...")

    with concurrent.futures.ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        results = list(executor.map(evaluate_strategy, watch_list))

        for msg in results:
            if msg:
                print("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ±ØµØ©!")
                # Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                send_telegram_message(TELEGRAM_CHAT_ID, msg)

    print("ğŸ Ø§Ù†ØªÙ‡Øª Ø¯ÙˆØ±Ø© ÙØ­Øµ Ø§Ù„Ø£Ø³Ù‡Ù….")

def main():
    """Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ø¯Ù…Ø¬ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø©"""
    print("ğŸ¤– Ø¨ÙˆØª Ø³Ù„Ø§Ù… - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„...")
    print(f"ğŸ“± Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…: {TELEGRAM_CHAT_ID}")
    
    if OPENAI_API_KEY:
        print("âœ… Ù…ÙØªØ§Ø­ OpenAI API Ù…ØªÙˆÙØ± - Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ÙØ¹Ù„Ø©")
    else:
        print("âš ï¸ Ù…ÙØªØ§Ø­ OpenAI API ØºÙŠØ± Ù…ØªÙˆÙØ± - Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹Ø·Ù„Ø©")
    
    print("\nğŸ”„ Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...")
    print("ğŸ’¬ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©...")
    print("ğŸ“Š Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ù‡Ù… ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚...\n")
    
    last_stock_check = 0
    stock_check_interval = 300  # 5 Ø¯Ù‚Ø§Ø¦Ù‚
    
    try:
        while True:
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
            try:
                process_telegram_messages()
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: {e}")
            
            # ÙØ­Øµ Ø§Ù„Ø£Ø³Ù‡Ù… ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
            current_time = time.time()
            if current_time - last_stock_check >= stock_check_interval:
                try:
                    run_stock_monitor()
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ù‡Ù…: {e}")
                last_stock_check = current_time
            
            # Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            time.sleep(2)
            
    except KeyboardInterrupt:
        print("\nğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")

if __name__ == "__main__":
    main()
