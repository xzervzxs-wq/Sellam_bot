import requests
import pandas as pd
import io
import os
import pytz
import json
import re
import yfinance as yf
from datetime import datetime, timedelta
from dotenv import load_dotenv
import concurrent.futures

# ==============================================================================
# ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
# ==============================================================================
load_dotenv()
EODHD_API_KEY = os.getenv("EODHD_API_KEY")
TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

MAX_WORKERS = 10  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø©
FLOAT_CACHE_FILE = "float_cache.json"

# ==============================================================================
# ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¬Ù„Ø¨
# ==============================================================================
def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r', encoding='utf-8') as f: return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f: json.dump(data, f, indent=4)
    except: pass

float_cache = load_json_file(FLOAT_CACHE_FILE)

def get_float_shares_safe(symbol):
    if symbol in float_cache: return float_cache[symbol]
    try:
        ticker = yf.Ticker(symbol)
        val = ticker.info.get('floatShares') or ticker.info.get('sharesOutstanding') or 0
        if val > 0:
            float_cache[symbol] = val
            save_json_file(FLOAT_CACHE_FILE, float_cache)
            return val
    except: return 0

def get_live_data(symbol):
    """Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù…ÙƒÙ†Ø© Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®"""
    try:
        # Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù€ yfinance Ù„Ø£Ù†Ù‡ Ø§Ù„Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Live)
        df = yf.download(symbol, period='2d', interval='5m', progress=False)
        if not df.empty:
            df.index = df.index.tz_convert('America/New_York')
            return df, "Yahoo-Live"
    except: pass
    return pd.DataFrame(), "None"

# ==============================================================================
# ğŸ§  ÙØ­Øµ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯)
# ==============================================================================
def evaluate_strategy(ticker):
    try:
        df, source = get_live_data(ticker)
        if df.empty: return None

        # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± ÙŠÙˆÙ… ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù€ DF
        last_date = df.index.date[-1]
        day_data = df[df.index.date == last_date]

        if len(day_data) < 3: return None

        # Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹
        c1 = day_data.iloc[-3] # Ø§Ù„Ø´Ù…Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        c2 = day_data.iloc[-2] # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        c3 = day_data.iloc[-1] # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        # Ø´Ø±Ø· Ø¨Ø³ÙŠØ·: Ø¢Ø®Ø± Ø´Ù…Ø¹ØªÙŠÙ† Ø®Ø¶Ø±Ø§Ø¡ Ù…Ø¹ ØµØ¹ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
        if c3['Close'] > c3['Open'] and c2['Close'] > c2['Open']:
            if c3['Low'] >= c2['Low']:

                float_val = get_float_shares_safe(ticker)
                current_price = float(c3['Close'])
                morning_high = day_data['High'].max()

                # Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                msg = (
                    f"ğŸªœ **Ø¥Ø´Ø§Ø±Ø© Ø³Ù„Ù… ØµØ§Ø¹Ø¯ (Live)**\n"
                    f"ğŸ† Ø§Ù„Ø³Ù‡Ù…: *{ticker}*\n"
                    f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¢Ù†: *${current_price:.2f}*\n"
                    f"ğŸ¯ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…: *${morning_high:.2f}*\n"
                    f"ğŸ“Š ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {last_date}\n"
                    f"ğŸ“¡ Ø§Ù„Ù…ØµØ¯Ø±: {source}\n"
                    f"---------------------------"
                )
                return msg
    except: pass
    return None

# ==============================================================================
# ğŸš€ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# ==============================================================================
def main():
    # Ù‡Ù†Ø§ Ø¶Ø¹ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù…Ø±Ø§Ù‚Ø¨ØªÙ‡Ø§ (Ø£Ùˆ Ø§Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ Finviz)
    # Ø³Ø£Ø¶Ø¹ Ø£Ù…Ø«Ù„Ø© Ù„Ø£Ø³Ù‡Ù… ØªØªØ­Ø±Ùƒ Ø§Ù„Ø¢Ù†
    watch_list = ["TSLA", "NBY", "SIDU", "MVIS", "AAPL", "AMD", "NVDA", "RIVN", "MARA", "RIOT"]

    print(f"ğŸ“¡ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ© Ù„Ù€ {len(watch_list)} Ø³Ù‡Ù…...")

    with concurrent.futures.ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        results = list(executor.map(evaluate_strategy, watch_list))

        for msg in results:
            if msg:
                print("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ±ØµØ©!")
                # Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
                requests.post(url, json={"chat_id": TELEGRAM_CHAT_ID, "text": msg, "parse_mode": "Markdown"})
            else:
                pass

    print("ğŸ Ø§Ù†ØªÙ‡Øª Ø¯ÙˆØ±Ø© Ø§Ù„ÙØ­Øµ.")

if __name__ == "__main__":
    main()
