#!/usr/bin/env python3
"""
ğŸ”¥ Pattern Matcher - Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø´Ù…Ø¹Ø© Ø¨Ø´Ù…Ø¹Ø©
ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø±Ø³Ù…Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù…Ø¹ Ø³Ù…Ø§Ø­ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ„ Ø´Ù…Ø¹Ø©
"""

import pandas as pd
import numpy as np

# =========================================================
# ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ù…Ø¹Ø© Ø¥Ù„Ù‰ "Ø¨ØµÙ…Ø©" (Fingerprint)
# =========================================================
def candle_fingerprint(candle, prev_candle=None):
    """
    Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù…Ø¹Ø©:
    - Ø§ØªØ¬Ø§Ù‡ (Ø®Ø¶Ø±Ø§Ø¡/Ø­Ù…Ø±Ø§Ø¡)
    - Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø³Ù… Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„ÙƒÙ„ÙŠ
    - Ù†Ø³Ø¨Ø© Ø§Ù„Ø°ÙŠÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ
    - Ù†Ø³Ø¨Ø© Ø§Ù„Ø°ÙŠÙ„ Ø§Ù„Ø³ÙÙ„ÙŠ
    - Ù‡Ù„ Ø§Ù„Ù‚Ø§Ø¹ ØµØ§Ø¹Ø¯ØŸ
    - Ù‡Ù„ Ø§Ù„Ù‚Ù…Ø© ØµØ§Ø¹Ø¯Ø©ØŸ
    """
    o, h, l, c = candle['open'], candle['high'], candle['low'], candle['close']
    
    body = c - o
    total_range = h - l if h > l else 0.0001
    
    upper_wick = h - max(o, c)
    lower_wick = min(o, c) - l
    
    fp = {
        'direction': 1 if body >= 0 else -1,  # Ø®Ø¶Ø±Ø§Ø¡ = 1ØŒ Ø­Ù…Ø±Ø§Ø¡ = -1
        'body_ratio': abs(body) / total_range,
        'upper_wick_ratio': upper_wick / total_range,
        'lower_wick_ratio': lower_wick / total_range,
        'higher_low': None,
        'higher_high': None,
    }
    
    if prev_candle is not None:
        fp['higher_low'] = 1 if l > prev_candle['low'] else -1
        fp['higher_high'] = 1 if h > prev_candle['high'] else -1
    
    return fp

# =========================================================
# Ù…Ù‚Ø§Ø±Ù†Ø© Ø´Ù…Ø¹ØªÙŠÙ† (Ù‡Ù„ Ù…ØªØ´Ø§Ø¨Ù‡ØªÙŠÙ†ØŸ)
# =========================================================
def compare_candles(fp1, fp2, tolerance=0.15):
    """
    Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ØµÙ…ØªÙŠÙ†
    tolerance: Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø³Ø¨ (15% Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
    
    Returns: (is_match, score, reason)
    """
    score = 0
    
    # 1. Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ù„Ø§Ø²Ù… ÙŠØªØ·Ø§Ø¨Ù‚ 100%)
    if fp1['direction'] != fp2['direction']:
        dir1 = "ğŸŸ¢" if fp1['direction'] == 1 else "ğŸ”´"
        dir2 = "ğŸŸ¢" if fp2['direction'] == 1 else "ğŸ”´"
        return False, 0, f"Ø§ØªØ¬Ø§Ù‡ Ù…Ø®ØªÙ„Ù ({dir1} vs {dir2})"
    score += 1
    
    # 2. Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø³Ù… (Ù…Ø¹ Ø³Ù…Ø§Ø­ÙŠØ©)
    diff = abs(fp1['body_ratio'] - fp2['body_ratio'])
    if diff > tolerance:
        return False, score, f"Ø¬Ø³Ù… Ù…Ø®ØªÙ„Ù ({fp1['body_ratio']:.2f} vs {fp2['body_ratio']:.2f})"
    score += 1 - (diff / tolerance) * 0.5
    
    # 3. Ø§Ù„Ø°ÙŠÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ù…Ø¹ Ø³Ù…Ø§Ø­ÙŠØ©)
    diff = abs(fp1['upper_wick_ratio'] - fp2['upper_wick_ratio'])
    if diff > tolerance:
        return False, score, f"Ø°ÙŠÙ„ Ø¹Ù„ÙˆÙŠ Ù…Ø®ØªÙ„Ù ({fp1['upper_wick_ratio']:.2f} vs {fp2['upper_wick_ratio']:.2f})"
    score += 1 - (diff / tolerance) * 0.5
    
    # 4. Ø§Ù„Ø°ÙŠÙ„ Ø§Ù„Ø³ÙÙ„ÙŠ (Ù…Ø¹ Ø³Ù…Ø§Ø­ÙŠØ©)
    diff = abs(fp1['lower_wick_ratio'] - fp2['lower_wick_ratio'])
    if diff > tolerance:
        return False, score, f"Ø°ÙŠÙ„ Ø³ÙÙ„ÙŠ Ù…Ø®ØªÙ„Ù ({fp1['lower_wick_ratio']:.2f} vs {fp2['lower_wick_ratio']:.2f})"
    score += 1 - (diff / tolerance) * 0.5
    
    # 5. Ø§Ù„Ù‚Ø§Ø¹ Ø§Ù„ØµØ§Ø¹Ø¯ (Ù„Ø§Ø²Ù… ÙŠØªØ·Ø§Ø¨Ù‚ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯)
    if fp1['higher_low'] is not None and fp2['higher_low'] is not None:
        if fp1['higher_low'] != fp2['higher_low']:
            hl1 = "â†—" if fp1['higher_low'] == 1 else "â†˜"
            hl2 = "â†—" if fp2['higher_low'] == 1 else "â†˜"
            return False, score, f"Ù‚Ø§Ø¹ Ù…Ø®ØªÙ„Ù ({hl1} vs {hl2})"
        score += 1
    
    # 6. Ø§Ù„Ù‚Ù…Ø© Ø§Ù„ØµØ§Ø¹Ø¯Ø© (Ù„Ø§Ø²Ù… ØªØªØ·Ø§Ø¨Ù‚ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©)
    if fp1['higher_high'] is not None and fp2['higher_high'] is not None:
        if fp1['higher_high'] != fp2['higher_high']:
            hh1 = "â†—" if fp1['higher_high'] == 1 else "â†˜"
            hh2 = "â†—" if fp2['higher_high'] == 1 else "â†˜"
            return False, score, f"Ù‚Ù…Ø© Ù…Ø®ØªÙ„ÙØ© ({hh1} vs {hh2})"
        score += 1
    
    return True, score, "âœ…"

# =========================================================
# Ù…Ù‚Ø§Ø±Ù†Ø© Ù†Ù…Ø·ÙŠÙ† ÙƒØ§Ù…Ù„ÙŠÙ† (6 Ø´Ù…ÙˆØ¹)
# =========================================================
def compare_patterns(test_candles, pattern_candles, tolerance=0.15):
    """
    Ù…Ù‚Ø§Ø±Ù†Ø© Ù†Ù…Ø·ÙŠÙ† Ø´Ù…Ø¹Ø© Ø¨Ø´Ù…Ø¹Ø©
    
    Returns: (is_match, total_score, failed_candle, reason)
    """
    if len(test_candles) != 6 or len(pattern_candles) != 6:
        return False, 0, 0, "Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­ (Ù„Ø§Ø²Ù… 6)"
    
    total_score = 0
    
    for i in range(6):
        # Ø§Ù„Ø¨ØµÙ…Ø© Ù„Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        prev_test = test_candles[i-1] if i > 0 else None
        prev_pattern = pattern_candles[i-1] if i > 0 else None
        
        fp_test = candle_fingerprint(test_candles[i], prev_test)
        fp_pattern = candle_fingerprint(pattern_candles[i], prev_pattern)
        
        # Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        is_match, score, reason = compare_candles(fp_test, fp_pattern, tolerance)
        
        if not is_match:
            return False, total_score, i + 1, f"Ø´Ù…Ø¹Ø© {i+1}: {reason}"
        
        total_score += score
    
    return True, total_score, 0, "ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„! âœ…"

# =========================================================
# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
# =========================================================
def load_patterns():
    """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ù† Ø§Ù„Ù…Ù„Ù"""
    df = pd.read_csv('successful_patterns_clean.csv')
    
    patterns = {}
    for symbol in df['symbol'].unique():
        sym_df = df[df['symbol'] == symbol]
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† 6 Ø´Ù…ÙˆØ¹
        if len(sym_df) != 6:
            print(f"âš ï¸ {symbol}: {len(sym_df)} Ø´Ù…ÙˆØ¹ (ØªØ¬Ø§Ù‡Ù„)")
            continue
        
        candles = []
        for _, row in sym_df.iterrows():
            candles.append({
                'open': row['open'],
                'high': row['high'],
                'low': row['low'],
                'close': row['close']
            })
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠØ± Ø§Ù„ÙƒÙ„ÙŠ
        total_change = (candles[-1]['close'] - candles[0]['open']) / candles[0]['open'] * 100
        
        patterns[symbol] = {
            'candles': candles,
            'total_change': total_change
        }
    
    return patterns

# =========================================================
# Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ ØªØ·Ø§Ø¨Ù‚
# =========================================================
def find_match(test_candles, patterns, tolerance=0.15):
    """
    Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø· Ù…Ø·Ø§Ø¨Ù‚
    """
    best_match = None
    best_score = 0
    best_reason = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚"
    
    # Ø£ÙØ¶Ù„ ÙØ´Ù„ (Ù„Ù„ØªÙˆØ¶ÙŠØ­)
    best_fail_candle = 0
    best_fail_reason = ""
    
    for name, pattern_data in patterns.items():
        is_match, score, fail_candle, reason = compare_patterns(
            test_candles, 
            pattern_data['candles'], 
            tolerance
        )
        
        if is_match:
            if score > best_score:
                best_match = name
                best_score = score
                best_reason = reason
        else:
            # Ø­ÙØ¸ Ø£ÙŠÙ† ÙØ´Ù„ (Ù„Ù„ØªÙˆØ¶ÙŠØ­)
            if fail_candle > best_fail_candle:
                best_fail_candle = fail_candle
                best_fail_reason = reason
    
    if not best_match and best_fail_reason:
        best_reason = best_fail_reason
    
    return best_match, best_score, best_reason

# =========================================================
# Ø¹Ø±Ø¶ Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù…ÙˆØ¹
# =========================================================
def print_fingerprints(candles, name):
    """Ø·Ø¨Ø§Ø¹Ø© Ø¨ØµÙ…Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹"""
    print(f"ğŸ“Š {name}:")
    prev = None
    for i, c in enumerate(candles):
        fp = candle_fingerprint(c, prev)
        
        color = "ğŸŸ¢" if fp['direction'] == 1 else "ğŸ”´"
        hl = ""
        hh = ""
        if prev:
            hl = "â†—" if fp['higher_low'] == 1 else "â†˜"
            hh = "â†—" if fp['higher_high'] == 1 else "â†˜"
        
        print(f"   {i+1}. {color} Ø¬Ø³Ù…:{fp['body_ratio']:4.0%} | Ø°ÙŠÙ„â†‘:{fp['upper_wick_ratio']:4.0%} | Ø°ÙŠÙ„â†“:{fp['lower_wick_ratio']:4.0%} | Ù‚Ø§Ø¹:{hl} Ù‚Ù…Ø©:{hh}")
        prev = c
    
    change = (candles[-1]['close'] - candles[0]['open']) / candles[0]['open'] * 100
    print(f"   ğŸ“ˆ Ø§Ù„ØªØºÙŠØ±: {change:+.1f}%")
    print()

# =========================================================
# Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¶Ø¹ÙŠÙØ© (Ù„Ù„Ø­Ø°Ù)
# =========================================================
WEAK_PATTERNS = ['EFA', 'GOGO', 'TRP', 'PM', 'SLV']

# =========================================================
# Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# =========================================================
if __name__ == "__main__":
    print("=" * 70)
    print("ğŸ”¥ Pattern Matcher - Ù…Ø·Ø§Ø¨Ù‚Ø© Ø´Ù…Ø¹Ø© Ø¨Ø´Ù…Ø¹Ø©")
    print("=" * 70)
    print()
    
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    patterns = load_patterns()
    print(f"ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(patterns)} Ù†Ù…Ø·")
    
    # Ø­Ø°Ù Ø§Ù„Ø¶Ø¹ÙŠÙØ©
    for weak in WEAK_PATTERNS:
        if weak in patterns:
            del patterns[weak]
    print(f"âœ… Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ: {len(patterns)} Ù†Ù…Ø· Ù‚ÙˆÙŠ")
    print()
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    print("ğŸ“‹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©:")
    for name, data in sorted(patterns.items(), key=lambda x: x[1]['total_change'], reverse=True):
        print(f"   â€¢ {name}: +{data['total_change']:.1f}%")
    print()
    
    # ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    test_df = pd.read_csv('test_candles_dec19.csv')
    test_df['date'] = pd.to_datetime(test_df['date'])
    
    symbols = test_df['symbol'].unique()
    print(f"ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ {len(symbols)} Ø³Ù‡Ù…")
    print("-" * 70)
    print()
    
    # Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© (15% = Ù…Ø±ÙˆÙ†Ø© Ø¨Ø³ÙŠØ·Ø©)
    TOLERANCE = 0.15
    
    results = []
    
    for symbol in symbols:
        sym_df = test_df[test_df['symbol'] == symbol].head(6)  # Ø£ÙˆÙ„ 6 Ø´Ù…ÙˆØ¹ ÙÙ‚Ø·
        
        if len(sym_df) < 6:
            print(f"{symbol:6} | âŒ Ø£Ù‚Ù„ Ù…Ù† 6 Ø´Ù…ÙˆØ¹")
            continue
        
        # ØªØ­ÙˆÙŠÙ„ Ù„Ù‚Ø§Ø¦Ù…Ø©
        test_candles = []
        for _, row in sym_df.iterrows():
            test_candles.append({
                'open': row['open'],
                'high': row['high'],
                'low': row['low'],
                'close': row['close']
            })
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºÙŠØ± Ø§Ù„ÙØ¹Ù„ÙŠ
        actual_change = (test_candles[-1]['close'] - test_candles[0]['open']) / test_candles[0]['open'] * 100
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚
        match_name, score, reason = find_match(test_candles, patterns, TOLERANCE)
        
        if match_name:
            status = f"âœ… ÙŠØ´Ø¨Ù‡ {match_name}"
            expected = patterns[match_name]['total_change']
        else:
            status = "âŒ Ù„Ø§ ØªØ·Ø§Ø¨Ù‚"
            expected = 0
        
        results.append({
            'symbol': symbol,
            'match': match_name,
            'score': score,
            'actual': actual_change,
            'expected': expected,
            'reason': reason
        })
        
        print(f"{symbol:6} | {status:20} | ÙØ¹Ù„ÙŠ: {actual_change:+6.1f}% | {reason}")
    
    print()
    print("=" * 70)
    print("ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ")
    print("=" * 70)
    
    matched = [r for r in results if r['match']]
    not_matched = [r for r in results if not r['match']]
    
    print(f"âœ… Ù…ØªØ·Ø§Ø¨Ù‚: {len(matched)}")
    print(f"âŒ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚: {len(not_matched)}")
    print()
    
    if matched:
        print("ğŸ¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©:")
        correct = 0
        for r in matched:
            if r['actual'] > 0:
                correct += 1
                mark = "âœ…"
            else:
                mark = "âŒ"
            print(f"   {mark} {r['symbol']} â†’ {r['match']} | ÙØ¹Ù„ÙŠ: {r['actual']:+.1f}%")
        
        print(f"\n   ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: {correct}/{len(matched)}")
    
    # Ø§Ù„ÙØ±Øµ Ø§Ù„Ø¶Ø§Ø¦Ø¹Ø©
    print()
    print("âš ï¸ Ø§Ù„ÙØ±Øµ Ø§Ù„Ø¶Ø§Ø¦Ø¹Ø© (>5%):")
    missed = 0
    for r in not_matched:
        if r['actual'] > 5:
            missed += 1
            print(f"   âš ï¸ {r['symbol']}: +{r['actual']:.1f}% | {r['reason']}")
    if missed == 0:
        print("   ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯!")
