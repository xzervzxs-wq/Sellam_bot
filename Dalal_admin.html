<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ø£ØµÙˆÙ„ | Dalal Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        
        /* Ø®Ù„ÙÙŠØ© Ø´Ø·Ø±Ù†Ø¬ Ù„Ù„Ù…Ù…Ø­Ø§Ø© */
        .checkerboard {
            background-color: #ffffff;
            background-image: linear-gradient(45deg, #e2e8f0 25%, transparent 25%), 
                              linear-gradient(-45deg, #e2e8f0 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e2e8f0 75%), 
                              linear-gradient(-45deg, transparent 75%, #e2e8f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .canvas-container {
            position: relative;
            overflow: hidden; 
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            background-color: white;
            height: 500px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ù†Ø·Ù‚Ø© */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            touch-action: none;
            user-select: none;
        }
        
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: crosshair;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        /* Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚Øµ */
        #crop-overlay {
            position: absolute;
            z-index: 20;
            display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            cursor: move; /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ø±ÙŠÙƒ */
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* ØªØ¹ØªÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© */
            border: 2px solid #fff;
            outline: 2px solid #6366f1;
        }

        /* Ù…Ù‚Ø§Ø¨Ø¶ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù‚Øµ */
        .crop-handle {
            position: absolute;
            width: 16px; /* Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ù„Ù„Ù…Ø³ */
            height: 16px;
            background: #6366f1;
            border: 2px solid white;
            border-radius: 50%; /* Ø¯Ø§Ø¦Ø±ÙŠ Ù„Ø´ÙƒÙ„ Ø£Ø¬Ù…Ù„ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 21;
        }
        /* ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø¨Ø¶ Ø¨Ø¯Ù‚Ø© Ù„Ù…Ù†ØªØµÙ Ø§Ù„Ø®Ø· */
        .ch-tl { top: -8px; left: -8px; cursor: nw-resize; }
        .ch-tr { top: -8px; right: -8px; cursor: ne-resize; }
        .ch-bl { bottom: -8px; left: -8px; cursor: sw-resize; }
        .ch-br { bottom: -8px; right: -8px; cursor: se-resize; }

        /* Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© */
        canvas.cursor-eraser {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>') 12 12, auto;
        }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ„ÙˆÙŠÙ† */
        canvas.cursor-paint {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%236366f1" stroke="white" stroke-width="2"><path d="M19 11L13 17L9 13L15 7M19 11L21 13M19 11L17 9M13 17L11 19M13 17L15 19M5 21L9 17L11 19L5 21Z"/></svg>') 0 24, auto;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
        .chip-btn {
            transition: all 0.2s;
        }
        .chip-btn.active {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
            transform: scale(1.05);
        }
        
        /* Loading Overlay */
        #loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Ø§Ù„Ø±Ø£Ø³ -->
    <header class="bg-[#1e1b4b] text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-cogs text-2xl text-[#ec4899]"></i>
                <div>
                    <h1 class="font-bold text-xl">Ù…Ø¯ÙŠØ± Ù‚ÙˆØ§Ù„Ø¨ Ø¯Ù„Ø§Ù„ ğŸ› ï¸</h1>
                    <p class="text-xs text-slate-300">ØªØ¬Ù‡ÙŠØ²ØŒ ØªÙØ±ÙŠØºØŒ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
                <input type="file" id="import-file" accept=".json" multiple class="hidden" onchange="importData(this)">
                <button onclick="document.getElementById('import-file').click()" class="bg-[#6366f1] hover:bg-[#4f46e5] text-white px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-md text-sm">
                    <i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª
                </button>

                <!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
                <button onclick="exportAllData()" class="bg-[#ec4899] hover:bg-[#db2777] text-white px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-md text-sm">
                    <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰: Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ² -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-[#6366f1]">
                    <span class="bg-[#e0e7ff] w-8 h-8 flex items-center justify-center rounded-full text-sm">1</span>
                    Ø±ÙØ¹ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø©)
                </h2>
                
                <div class="flex flex-col gap-4">
                    <label class="border-2 border-dashed border-[#6366f1] bg-[#f5f3ff] rounded-xl p-8 text-center cursor-pointer hover:bg-[#eef2ff] transition">
                        <input type="file" id="file-upload" class="hidden" accept="image/*,.svg" onchange="loadImage(this)">
                        <i class="fas fa-cloud-upload-alt text-4xl text-[#6366f1] mb-2"></i>
                        <p class="font-bold text-[#4f46e5]">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
                        <p class="text-xs text-slate-500">PNG, JPG, WEBP, SVG</p>
                    </label>

                    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù…Ø­Ø§Ø© ÙˆØ§Ù„Ù‚Øµ ÙˆØ§Ù„ØªÙ„ÙˆÙŠÙ† -->
                    <div id="editor-tools" class="hidden flex flex-col gap-3 bg-slate-50 p-3 rounded-lg border border-slate-200 shadow-inner">
                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¯Ø§Ø© ÙˆØ§Ù„ØªØ±Ø§Ø¬Ø¹ -->
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-slate-500">Ø§Ù„Ø£Ø¯Ø§Ø©:</span>
                                <div class="flex bg-white rounded-lg border border-slate-300 p-1 shadow-sm gap-1">
                                    <button onclick="setTool('magic')" id="tool-magic" class="px-3 py-1.5 rounded-md text-sm font-bold bg-[#6366f1] text-white shadow-sm transition flex items-center gap-2">
                                        <i class="fas fa-magic"></i> Ø³Ø­Ø±ÙŠØ©
                                    </button>
                                    <button onclick="setTool('manual')" id="tool-manual" class="px-3 py-1.5 rounded-md text-sm font-bold text-slate-600 hover:bg-slate-100 transition flex items-center gap-2">
                                        <i class="fas fa-eraser"></i> ÙŠØ¯ÙˆÙŠØ©
                                    </button>
                                    <div class="w-px bg-slate-200 my-1"></div>
                                    <button onclick="setTool('paint')" id="tool-paint" class="px-3 py-1.5 rounded-md text-sm font-bold text-slate-600 hover:bg-slate-100 transition flex items-center gap-2" title="ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©">
                                        <i class="fas fa-palette"></i> ØªÙ„ÙˆÙŠÙ†
                                    </button>
                                    <div class="w-px bg-slate-200 my-1"></div>
                                    <button onclick="startCropMode()" id="tool-crop" class="px-3 py-1.5 rounded-md text-sm font-bold text-slate-600 hover:bg-slate-100 transition flex items-center gap-2" title="Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø©">
                                        <i class="fas fa-crop-alt"></i> Ù‚Øµ
                                    </button>
                                </div>
                            </div>
                            
                            <button onclick="restoreOriginal()" class="text-xs font-bold text-slate-600 hover:text-red-500 flex items-center gap-1 bg-white px-3 py-1.5 rounded border border-slate-200 shadow-sm hover:shadow transition">
                                <i class="fas fa-undo"></i> ØªØ±Ø§Ø¬Ø¹ Ù„Ù„Ø£ØµÙ„
                            </button>
                        </div>

                        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø³ÙÙ„ÙŠ: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø© -->
                        <div class="flex items-center gap-3 w-full border-t border-slate-200 pt-2 min-h-[40px]">
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© -->
                            <div id="magic-settings" class="flex items-center gap-3 flex-1">
                                <span class="text-xs font-bold text-[#6366f1] bg-[#e0e7ff] px-2 py-1 rounded">ğŸ§¹ Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù„ÙˆÙ†:</span>
                                <input type="range" id="tolerance" min="1" max="100" value="30" class="accent-[#6366f1] flex-1 h-2 bg-slate-200 rounded-lg cursor-pointer">
                                <span id="tolerance-val" class="text-xs font-bold text-[#6366f1] w-8 text-center bg-white border border-slate-200 rounded px-1">30</span>
                            </div>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© -->
                            <div id="manual-settings" class="hidden flex items-center gap-3 flex-1">
                                <span class="text-xs font-bold text-[#ec4899] bg-pink-100 px-2 py-1 rounded">â­• Ø­Ø¬Ù… Ø§Ù„Ù…Ù…Ø­Ø§Ø©:</span>
                                <input type="range" id="brush-size" min="5" max="150" value="30" class="accent-[#ec4899] flex-1 h-2 bg-slate-200 rounded-lg cursor-pointer">
                                <span id="brush-size-val" class="text-xs font-bold text-[#ec4899] w-8 text-center bg-white border border-slate-200 rounded px-1">30</span>
                            </div>

                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„ÙˆÙŠÙ† -->
                            <div id="paint-settings" class="hidden flex items-center gap-3 flex-1">
                                <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded">ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†:</span>
                                <input type="color" id="paint-color" value="#ff0000" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                                <button onclick="colorAllNonTransparent()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded shadow-sm transition">
                                    ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                                </button>
                                <span class="text-[10px] text-slate-400 mr-2 border-r pr-2">Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ„ÙˆÙŠÙ† Ø¬Ø²Ø¡</span>
                            </div>

                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Øµ -->
                            <div id="crop-controls" class="hidden flex items-center gap-3 flex-1 justify-end">
                                <span class="text-xs font-bold text-slate-500 ml-auto">Ø¹Ø¯Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø«Ù… Ù‚Øµ:</span>
                                <button onclick="cancelCrop()" class="px-4 py-1 rounded bg-slate-200 text-slate-700 font-bold hover:bg-slate-300 text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                                <button onclick="applyCrop()" class="px-4 py-1 rounded bg-green-500 text-white font-bold hover:bg-green-600 text-xs shadow">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù‚Øµ</button>
                            </div>
                        </div>
                        
                        <div class="text-[10px] text-slate-400 text-center pt-1" id="tool-hint">
                            <i class="fas fa-info-circle"></i> Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù„ÙˆÙ† ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù…Ø³Ø­Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        </div>
                    </div>

                    <!-- Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ -->
                    <div class="canvas-container checkerboard" id="canvas-wrapper">
                        <div class="text-slate-400 text-sm font-bold pointer-events-none">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø©</div>
                        <!-- Ø¹Ù†ØµØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ù‚Øµ -->
                        <div id="crop-overlay">
                            <div class="crop-handle ch-tl"></div>
                            <div class="crop-handle ch-tr"></div>
                            <div class="crop-handle ch-bl"></div>
                            <div class="crop-handle ch-br"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ØµØ± -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-[#6366f1]">
                    <span class="bg-[#e0e7ff] w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span>
                    Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ±
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„ØªØµÙ†ÙŠÙ) -->
                    <div>
                        <label class="block text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Category):</label>
                        <div class="relative">
                            <input type="text" id="category-name" list="existing-categories" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„..." class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-[#6366f1]">
                            <datalist id="existing-categories">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                            </datalist>
                        </div>
                        
                        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                        <div id="category-chips" class="flex flex-wrap gap-2 mt-3 p-2 bg-slate-50 rounded-lg border border-slate-100 min-h-[40px]">
                            <span class="text-xs text-slate-400 self-center">Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</span>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                    </div>

                    <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†ØµØ± -->
                    <div class="flex flex-col justify-center gap-3">
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                            <input type="checkbox" id="is-colorable" class="w-5 h-5 accent-[#ec4899]">
                            <div>
                                <span class="block font-bold text-sm">ğŸ¨ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ„ÙˆÙŠÙ† (Colorable)</span>
                                <span class="text-[10px] text-slate-500">Ø§Ø®ØªØ± Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ø·Ø§Ø±Ø§Ù‹ Ø£Ùˆ Ù†Ù‚Ø´Ø§Ù‹ Ø£Ø³ÙˆØ¯ ØªØ±ÙŠØ¯ ØªÙ„ÙˆÙŠÙ†Ù‡.</span>
                            </div>
                        </label>
                    </div>
                </div>

                <button onclick="addToLibrary()" class="w-full mt-4 bg-[#6366f1] hover:bg-[#4f46e5] text-white py-3 rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙƒØªØ¨Ø©
                </button>
            </div>
        </div>

        <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠØ³Ø±Ù‰: Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <div class="lg:col-span-4 space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 h-[calc(100vh-120px)] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h2 class="font-bold text-[#1e293b]">ğŸ“¦ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                    <span id="total-count" class="bg-[#e0e7ff] text-[#4f46e5] px-2 py-1 rounded text-xs font-bold">0 Ø¹Ù†ØµØ±</span>
                </div>

                <div id="library-preview" class="flex-1 overflow-y-auto space-y-4 pr-1">
                    <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù‡Ù†Ø§ -->
                    <div class="text-center text-slate-400 py-10 text-sm">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</div>
                </div>
                
                <div id="size-warning" class="hidden text-[10px] bg-red-50 text-red-500 p-2 rounded text-center mt-2 border border-red-100"></div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
    <div id="rename-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] backdrop-blur-sm transition-all duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100 border border-slate-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg text-[#1e1b4b] flex items-center gap-2">
                    <i class="fas fa-edit text-[#6366f1]"></i> ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                </h3>
                <button onclick="closeRenameModal()" class="text-slate-400 hover:text-red-500 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <input type="text" id="new-category-name" class="w-full p-3 border border-slate-300 rounded-xl focus:border-[#6366f1] focus:ring-2 focus:ring-[#6366f1]/20 outline-none transition font-bold text-slate-700" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." onkeypress="handleEnter(event)">
            </div>
            
            <div class="flex justify-end gap-2">
                <button onclick="closeRenameModal()" class="px-5 py-2.5 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="saveRename()" class="px-5 py-2.5 bg-[#6366f1] hover:bg-[#4f46e5] text-white rounded-xl font-bold transition shadow-lg shadow-indigo-200">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ (Global Modal) -->
    <div id="global-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[110] backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-100 text-center transform scale-100 transition-transform duration-300">
            <div id="modal-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl mb-4">
                <!-- Icon Here -->
            </div>
            <h3 id="modal-title" class="font-bold text-xl text-[#1e1b4b] mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
            <p id="modal-message" class="text-slate-500 text-sm mb-6 leading-relaxed">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§...</p>
            
            <div id="modal-actions" class="flex justify-center gap-3">
                <!-- Buttons injected via JS -->
            </div>
        </div>
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØµØ¯ÙŠØ± -->
    <div id="loading-overlay" class="fixed inset-0 z-[120] hidden flex flex-col items-center justify-center text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[#6366f1] mb-4"></div>
        <h3 class="font-bold text-xl text-[#1e1b4b]">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„Ù...</h3>
        <p class="text-slate-500 text-sm">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
    </div>

    <script>
        // ==========================================
        //  Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal System)
        // ==========================================
        const modal = {
            el: document.getElementById('global-modal'),
            icon: document.getElementById('modal-icon'),
            title: document.getElementById('modal-title'),
            msg: document.getElementById('modal-message'),
            actions: document.getElementById('modal-actions'),
            
            show: function(type, title, message, onConfirm = null) {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
                let iconClass = '';
                let iconHtml = '';
                let confirmBtnClass = '';
                let confirmText = 'Ù…ÙˆØ§ÙÙ‚';

                if (type === 'success') {
                    iconClass = 'bg-green-100 text-green-500';
                    iconHtml = '<i class="fas fa-check"></i>';
                    confirmBtnClass = 'bg-green-500 hover:bg-green-600';
                } else if (type === 'error') {
                    iconClass = 'bg-red-100 text-red-500';
                    iconHtml = '<i class="fas fa-times"></i>';
                    confirmBtnClass = 'bg-red-500 hover:bg-red-600';
                } else if (type === 'warning') {
                    iconClass = 'bg-orange-100 text-orange-500';
                    iconHtml = '<i class="fas fa-exclamation"></i>';
                    confirmBtnClass = 'bg-orange-500 hover:bg-orange-600';
                    confirmText = 'Ù†Ø¹Ù…ØŒ ØªØ§Ø¨Ø¹';
                } else if (type === 'info') {
                    iconClass = 'bg-blue-100 text-blue-500';
                    iconHtml = '<i class="fas fa-info"></i>';
                    confirmBtnClass = 'bg-blue-500 hover:bg-blue-600';
                } else if (type === 'delete') {
                    iconClass = 'bg-red-100 text-red-500';
                    iconHtml = '<i class="fas fa-trash-alt"></i>';
                    confirmBtnClass = 'bg-red-500 hover:bg-red-600';
                    confirmText = 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù';
                }

                this.icon.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl ${iconClass}`;
                this.icon.innerHTML = iconHtml;
                this.title.innerText = title;
                this.msg.innerText = message;

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                this.actions.innerHTML = '';
                
                // Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ callback Ù„Ù„ØªØ£ÙƒÙŠØ¯)
                if (onConfirm) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'px-5 py-2.5 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition';
                    cancelBtn.innerText = 'Ø¥Ù„ØºØ§Ø¡';
                    cancelBtn.onclick = () => this.hide();
                    this.actions.appendChild(cancelBtn);
                }

                // Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
                const confirmBtn = document.createElement('button');
                confirmBtn.className = `px-5 py-2.5 text-white rounded-xl font-bold transition shadow-lg ${confirmBtnClass}`;
                confirmBtn.innerText = confirmText;
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    this.hide();
                };
                this.actions.appendChild(confirmBtn);

                this.el.classList.remove('hidden');
            },

            hide: function() {
                this.el.classList.add('hidden');
            }
        };

        // ==========================================
        //  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ÙˆØ§Ù„Ù…Ù…Ø­Ø§Ø© ÙˆØ§Ù„Ù‚Øµ
        // ==========================================
        let canvas, ctx;
        let originalImage = null;
        let currentTool = 'magic'; // 'magic', 'manual', 'paint', 'crop'
        let isDragging = false;

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‚Øµ
        let isCropping = false;
        let cropMode = 'none'; // 'create', 'move', 'resize'
        let activeHandle = null;
        let cropStart = { x: 0, y: 0 };
        let startLeft = 0, startTop = 0, startWidth = 0, startHeight = 0;

        let cropBox = document.getElementById('crop-overlay');
        const canvasContainer = document.getElementById('canvas-wrapper');
        const toleranceInput = document.getElementById('tolerance');
        const toleranceDisplay = document.getElementById('tolerance-val');
        const brushSizeInput = document.getElementById('brush-size');
        const brushSizeDisplay = document.getElementById('brush-size-val');

        toleranceInput.addEventListener('input', (e) => toleranceDisplay.innerText = e.target.value);
        brushSizeInput.addEventListener('input', (e) => brushSizeDisplay.innerText = e.target.value);

        function setTool(tool) {
            if (isCropping && tool !== 'crop') cancelCrop(); 

            currentTool = tool;
            
            const btnMagic = document.getElementById('tool-magic');
            const btnManual = document.getElementById('tool-manual');
            const btnPaint = document.getElementById('tool-paint');
            const btnCrop = document.getElementById('tool-crop');
            
            const magicSettings = document.getElementById('magic-settings');
            const manualSettings = document.getElementById('manual-settings');
            const paintSettings = document.getElementById('paint-settings');
            const cropControls = document.getElementById('crop-controls');
            const hint = document.getElementById('tool-hint');

            [btnMagic, btnManual, btnPaint, btnCrop].forEach(btn => 
                btn.className = "px-3 py-1.5 rounded-md text-sm font-bold text-slate-600 hover:bg-slate-100 transition flex items-center gap-2"
            );
            
            magicSettings.classList.add('hidden');
            manualSettings.classList.add('hidden');
            paintSettings.classList.add('hidden');
            cropControls.classList.add('hidden');
            
            if(canvas) {
                canvas.classList.remove('cursor-eraser');
                canvas.classList.remove('cursor-paint');
            }

            if (tool === 'magic') {
                btnMagic.className = "px-3 py-1.5 rounded-md text-sm font-bold bg-[#6366f1] text-white shadow-sm transition flex items-center gap-2";
                magicSettings.classList.remove('hidden');
                hint.innerHTML = '<i class="fas fa-info-circle"></i> Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù„ÙˆÙ† ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù…Ø³Ø­Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
            } else if (tool === 'manual') {
                btnManual.className = "px-3 py-1.5 rounded-md text-sm font-bold bg-[#ec4899] text-white shadow-sm transition flex items-center gap-2";
                manualSettings.classList.remove('hidden');
                hint.innerHTML = '<i class="fas fa-info-circle"></i> Ø§Ø¶ØºØ· ÙˆØ§Ø³Ø­Ø¨ Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹';
                if(canvas) canvas.classList.add('cursor-eraser');
            } else if (tool === 'paint') {
                btnPaint.className = "px-3 py-1.5 rounded-md text-sm font-bold bg-blue-500 text-white shadow-sm transition flex items-center gap-2";
                paintSettings.classList.remove('hidden');
                hint.innerHTML = '<i class="fas fa-palette"></i> Ø§Ø¶ØºØ· Ù„ØªÙ„ÙˆÙŠÙ† Ù…Ù†Ø·Ù‚Ø©ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„"';
                if(canvas) canvas.classList.add('cursor-paint');
            } else if (tool === 'crop') {
                btnCrop.className = "px-3 py-1.5 rounded-md text-sm font-bold bg-green-500 text-white shadow-sm transition flex items-center gap-2";
                cropControls.classList.remove('hidden');
                hint.innerHTML = '<i class="fas fa-crop"></i> Ø§Ø³Ø­Ø¨ Ù„Ù„Ø±Ø³Ù…ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚Ø§Ø¨Ø¶ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„ÙˆØ³Ø· Ù„Ù„ØªØ­Ø±ÙŠÙƒ';
            }
        }

        function loadImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        createCanvas(img);
                    };
                    img.src = e.target.result;
                    originalImage = img;
                };
                reader.readAsDataURL(input.files[0]);
                document.getElementById('editor-tools').classList.remove('hidden');
            }
        }

        function createCanvas(img) {
            canvasContainer.innerHTML = '';
            canvas = document.createElement('canvas');
            
            // === ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© ===
            const targetSize = 3000; 
            let width = img.width;
            let height = img.height;
            
            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø¶Ù„Ø¹ Ø§Ù„Ø£Ø·ÙˆÙ„ ÙŠØ³Ø§ÙˆÙŠ 3000
            const scale = targetSize / Math.max(width, height);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            width = Math.floor(width * scale);
            height = Math.floor(height * scale);

            canvas.width = width;
            canvas.height = height;
            
            if (width > canvasContainer.clientWidth) {
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
            } else {
                canvas.style.width = 'auto';
                canvas.style.height = 'auto';
            }
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙŠØ±Ø³Ø± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (currentTool === 'manual') canvas.classList.add('cursor-eraser');
            if (currentTool === 'paint') canvas.classList.add('cursor-paint');

            ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            // ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¹ÙŠÙ… Ø§Ù„ØµÙˆØ± Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ¨ÙŠØ±
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            ctx.drawImage(img, 0, 0, width, height);
            
            canvasContainer.appendChild(canvas);
            canvasContainer.appendChild(cropBox); 

            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            canvas.addEventListener('touchend', stopDrawing);
            
            setTool('magic');
        }

        function restoreOriginal() {
            if(originalImage) {
                createCanvas(originalImage);
                if (currentTool === 'crop') setTool('magic');
            }
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„ØªÙ„ÙˆÙŠÙ† ---
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: Math.floor((evt.clientX - rect.left) * scaleX),
                y: Math.floor((evt.clientY - rect.top) * scaleY)
            };
        }

        function handleMouseDown(e) {
            if (currentTool === 'crop') return; 
            
            const pos = getMousePos(e);
            if (currentTool === 'magic') {
                floodFill(pos.x, pos.y);
            } else if (currentTool === 'paint') {
                paintFloodFill(pos.x, pos.y);
            } else if (currentTool === 'manual') {
                isDragging = true;
                eraseManual(pos.x, pos.y);
            }
        }

        function handleMouseMove(e) {
            if (currentTool === 'manual' && isDragging) {
                const pos = getMousePos(e);
                eraseManual(pos.x, pos.y);
            }
        }

        function handleTouchStart(e) {
            if (currentTool === 'crop') return;
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousedown", { clientX: touch.clientX, clientY: touch.clientY });
            canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            if (currentTool === 'crop') return;
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousemove", { clientX: touch.clientX, clientY: touch.clientY });
            canvas.dispatchEvent(mouseEvent);
        }

        function stopDrawing() { isDragging = false; }

        function eraseManual(x, y) {
            const size = parseInt(brushSizeInput.value);
            ctx.save();
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, size / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø­Ø±ÙŠ (ØªØ¬Ø¹Ù„ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª Ø´ÙØ§ÙØ©)
        function floodFill(startX, startY) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const tolerance = parseInt(toleranceInput.value);
            
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = data[startPos];
            const startG = data[startPos + 1];
            const startB = data[startPos + 2];
            const startA = data[startPos + 3];

            if (startA === 0) return;

            const queue = [[startX, startY]];
            const visited = new Uint8Array(canvas.width * canvas.height);

            function match(pos) {
                const r = data[pos];
                const g = data[pos + 1];
                const b = data[pos + 2];
                const a = data[pos + 3];
                if (a === 0) return false;
                const diff = Math.abs(r - startR) + Math.abs(g - startG) + Math.abs(b - startB);
                return diff <= tolerance * 3; 
            }

            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const pos = (y * canvas.width + x) * 4;
                const pixelIndex = y * canvas.width + x;

                if (visited[pixelIndex]) continue;
                visited[pixelIndex] = 1;

                if (match(pos)) {
                    data[pos + 3] = 0; // Ø¬Ø¹Ù„Ù‡Ø§ Ø´ÙØ§ÙØ©
                    if (x > 0) queue.push([x - 1, y]);
                    if (x < canvas.width - 1) queue.push([x + 1, y]);
                    if (y > 0) queue.push([x, y - 1]);
                    if (y < canvas.height - 1) queue.push([x, y + 1]);
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ† (ØªØºÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª)
        function paintFloodFill(startX, startY) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const tolerance = parseInt(toleranceInput.value);
            
            // ØªØ­ÙˆÙŠÙ„ Ù„ÙˆÙ† Hex Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¥Ù„Ù‰ RGB
            const hexColor = document.getElementById('paint-color').value;
            const rNew = parseInt(hexColor.substr(1,2), 16);
            const gNew = parseInt(hexColor.substr(3,2), 16);
            const bNew = parseInt(hexColor.substr(5,2), 16);

            const startPos = (startY * canvas.width + startX) * 4;
            const startR = data[startPos];
            const startG = data[startPos + 1];
            const startB = data[startPos + 2];
            const startA = data[startPos + 3];

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙƒØ§Ù† Ø´ÙØ§ÙØŒ Ù„Ø§ Ù†Ù„ÙˆÙ† (Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ±Øº Ø§Ù„Ø®Ù„ÙÙŠØ©)
            if (startA === 0) return;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„ÙˆÙ† Ù‡Ùˆ Ù†ÙØ³Ù‡ØŒ Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹
            if (Math.abs(startR - rNew) < 5 && Math.abs(startG - gNew) < 5 && Math.abs(startB - bNew) < 5) return;

            const queue = [[startX, startY]];
            const visited = new Uint8Array(canvas.width * canvas.height);

            function match(pos) {
                const r = data[pos];
                const g = data[pos + 1];
                const b = data[pos + 2];
                const a = data[pos + 3];
                if (a === 0) return false;
                const diff = Math.abs(r - startR) + Math.abs(g - startG) + Math.abs(b - startB);
                return diff <= tolerance * 3; 
            }

            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const pos = (y * canvas.width + x) * 4;
                const pixelIndex = y * canvas.width + x;

                if (visited[pixelIndex]) continue;
                visited[pixelIndex] = 1;

                if (match(pos)) {
                    // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    data[pos] = rNew;
                    data[pos + 1] = gNew;
                    data[pos + 2] = bNew;
                    // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙƒÙ…Ø§ Ù‡ÙŠ (Ø£Ùˆ Ù†Ø¬Ø¹Ù„Ù‡Ø§ ÙƒØ§Ù…Ù„Ø© 255 Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø´Ø¨Ù‡ Ø´ÙØ§ÙØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† ØµÙ„Ø¨)
                    if (data[pos + 3] > 0) data[pos + 3] = 255; 

                    if (x > 0) queue.push([x - 1, y]);
                    if (x < canvas.width - 1) queue.push([x + 1, y]);
                    if (y > 0) queue.push([x, y - 1]);
                    if (y < canvas.height - 1) queue.push([x, y + 1]);
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // Ø¯Ø§Ù„Ø© ØªÙ„ÙˆÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡ ØºÙŠØ± Ø´ÙØ§Ù (Ù„Ù„Ø¥Ø·Ø§Ø±Ø§Øª)
        function colorAllNonTransparent() {
            if (!canvas || !ctx) return;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const hexColor = document.getElementById('paint-color').value;
            const rNew = parseInt(hexColor.substr(1,2), 16);
            const gNew = parseInt(hexColor.substr(3,2), 16);
            const bNew = parseInt(hexColor.substr(5,2), 16);

            for (let i = 0; i < data.length; i += 4) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙƒØ³Ù„ ØºÙŠØ± Ø´ÙØ§ÙØ© (Ø£ÙƒØ¨Ø± Ù…Ù† 10 Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø´ÙØ§ÙØ© Ø¬Ø¯Ø§Ù‹)
                if (data[i + 3] > 10) {
                    data[i] = rNew;
                    data[i + 1] = gNew;
                    data[i + 2] = bNew;
                    // Ø¬Ø¹Ù„Ù‡Ø§ ØµÙ„Ø¨Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙØ¶Ù„
                    data[i + 3] = 255; 
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Øµ ---
        function startCropMode() {
            setTool('crop');
            canvasContainer.style.cursor = "crosshair";
            
            canvasContainer.addEventListener('mousedown', initCropDrag);
            canvasContainer.addEventListener('touchstart', initCropDrag, {passive: false});

            window.addEventListener('mousemove', doCropDrag);
            window.addEventListener('touchmove', doCropDrag, {passive: false});
            window.addEventListener('mouseup', endCropDrag);
            window.addEventListener('touchend', endCropDrag);
        }

        function cancelCrop() {
            isCropping = false;
            cropBox.style.display = 'none';
            cropBox.style.width = '0';
            cropBox.style.height = '0';
            
            canvasContainer.removeEventListener('mousedown', initCropDrag);
            canvasContainer.removeEventListener('touchstart', initCropDrag);
            window.removeEventListener('mousemove', doCropDrag);
            window.removeEventListener('touchmove', doCropDrag);
            window.removeEventListener('mouseup', endCropDrag);
            window.removeEventListener('touchend', endCropDrag);
            
            canvasContainer.style.cursor = "default";
            setTool('magic');
        }

        function initCropDrag(e) {
            if (currentTool !== 'crop') return;
            if (e.type === 'touchstart') e.preventDefault();

            const rect = canvasContainer.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            const x = clientX - rect.left;
            const y = clientY - rect.top;
            const target = e.target;

            cropStart.x = x;
            cropStart.y = y;

            const style = window.getComputedStyle(cropBox);
            startLeft = parseFloat(style.left) || 0;
            startTop = parseFloat(style.top) || 0;
            startWidth = parseFloat(style.width) || 0;
            startHeight = parseFloat(style.height) || 0;

            if (target.classList.contains('crop-handle')) {
                isCropping = true;
                cropMode = 'resize';
                if (target.classList.contains('ch-tl')) activeHandle = 'tl';
                else if (target.classList.contains('ch-tr')) activeHandle = 'tr';
                else if (target.classList.contains('ch-bl')) activeHandle = 'bl';
                else if (target.classList.contains('ch-br')) activeHandle = 'br';

            } else if (target.id === 'crop-overlay') {
                isCropping = true;
                cropMode = 'move';

            } else {
                isCropping = true;
                cropMode = 'create';
                cropBox.style.display = 'block';
                cropBox.style.left = x + 'px';
                cropBox.style.top = y + 'px';
                cropBox.style.width = '0px';
                cropBox.style.height = '0px';
                startLeft = x;
                startTop = y;
            }
        }

        function doCropDrag(e) {
            if (!isCropping) return;
            if (e.type === 'touchmove') e.preventDefault();

            const rect = canvasContainer.getBoundingClientRect();
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            
            const currentX = clientX - rect.left;
            const currentY = clientY - rect.top;

            if (cropMode === 'create') {
                const width = currentX - startLeft;
                const height = currentY - startTop;

                if (width < 0) {
                    cropBox.style.left = currentX + 'px';
                    cropBox.style.width = Math.abs(width) + 'px';
                } else {
                    cropBox.style.left = startLeft + 'px';
                    cropBox.style.width = width + 'px';
                }

                if (height < 0) {
                    cropBox.style.top = currentY + 'px';
                    cropBox.style.height = Math.abs(height) + 'px';
                } else {
                    cropBox.style.top = startTop + 'px';
                    cropBox.style.height = height + 'px';
                }

            } else if (cropMode === 'move') {
                const dx = currentX - cropStart.x;
                const dy = currentY - cropStart.y;
                cropBox.style.left = (startLeft + dx) + 'px';
                cropBox.style.top = (startTop + dy) + 'px';

            } else if (cropMode === 'resize') {
                const dx = currentX - cropStart.x;
                const dy = currentY - cropStart.y;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;

                if (activeHandle === 'br') { newWidth = startWidth + dx; newHeight = startHeight + dy; } 
                else if (activeHandle === 'bl') { newWidth = startWidth - dx; newLeft = startLeft + dx; newHeight = startHeight + dy; } 
                else if (activeHandle === 'tr') { newWidth = startWidth + dx; newHeight = startHeight - dy; newTop = startTop + dy; } 
                else if (activeHandle === 'tl') { newWidth = startWidth - dx; newLeft = startLeft + dx; newHeight = startHeight - dy; newTop = startTop + dy; }

                if (newWidth > 10) { cropBox.style.width = newWidth + 'px'; cropBox.style.left = newLeft + 'px'; }
                if (newHeight > 10) { cropBox.style.height = newHeight + 'px'; cropBox.style.top = newTop + 'px'; }
            }
        }

        function endCropDrag() {
            isCropping = false;
            cropMode = 'none';
            activeHandle = null;
        }

        function applyCrop() {
            if (cropBox.style.display === 'none' || parseInt(cropBox.style.width) < 10) {
                modal.show('warning', 'ØªÙ†Ø¨ÙŠÙ‡', "ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ù†Ø·Ù‚Ø© Ù„Ù„Ù‚Øµ Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }

            const cropRect = cropBox.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();

            let selectX = cropRect.left - canvasRect.left;
            let selectY = cropRect.top - canvasRect.top;
            let selectW = cropRect.width;
            let selectH = cropRect.height;

            const scaleX = canvas.width / canvasRect.width;
            const scaleY = canvas.height / canvasRect.height;

            const finalX = selectX * scaleX;
            const finalY = selectY * scaleY;
            const finalW = selectW * scaleX;
            const finalH = selectH * scaleY;

            if (finalW <= 0 || finalH <= 0) return;

            try {
                const data = ctx.getImageData(finalX, finalY, finalW, finalH);
                canvas.width = finalW;
                canvas.height = finalH;
                
                if (finalW > canvasContainer.clientWidth) {
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                } else {
                    canvas.style.width = 'auto';
                    canvas.style.height = 'auto';
                }

                ctx.putImageData(data, 0, 0);
                cancelCrop();
            } catch (e) {
                console.error(e);
                modal.show('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Øµ', "ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù‚Øµ Ø¯Ø§Ø®Ù„ Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹.");
            }
        }

        // ==========================================
        //  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø©
        // ==========================================
        let libraryData = [];

        function renderCategoryChips() {
            const container = document.getElementById('category-chips');
            container.innerHTML = '';
            
            if (libraryData.length === 0) {
                container.innerHTML = '<span class="text-xs text-slate-400 self-center">Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</span>';
                return;
            }

            libraryData.forEach(cat => {
                const chip = document.createElement('button');
                chip.className = 'chip-btn px-3 py-1 bg-white hover:bg-[#6366f1] hover:text-white text-slate-700 text-xs rounded-full border border-slate-300 font-bold shadow-sm';
                chip.innerText = cat.name;
                chip.onclick = () => {
                    document.getElementById('category-name').value = cat.name;
                    document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active', 'ring-2', 'ring-offset-1', 'ring-[#6366f1]'));
                    chip.classList.add('active', 'ring-2', 'ring-offset-1', 'ring-[#6366f1]');
                };
                container.appendChild(chip);
            });
        }

        function addToLibrary() {
            if (!canvas) {
                modal.show('warning', 'ØªÙ†Ø¨ÙŠÙ‡', "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            const categoryName = document.getElementById('category-name').value.trim();
            if (!categoryName) {
                modal.show('warning', 'ØªÙ†Ø¨ÙŠÙ‡', "âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø¥Ø·Ø§Ø±Ø§Øª)");
                return;
            }

            const isColorable = document.getElementById('is-colorable').checked;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… WebP Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¨Ù†Ø³Ø¨Ø© ÙƒØ¨ÙŠØ±Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
            const imageDataUrl = canvas.toDataURL('image/webp', 0.85); 

            let category = libraryData.find(c => c.name === categoryName);
            
            if (!category) {
                category = { name: categoryName, items: [] };
                libraryData.push(category);
                updateCategoryDatalist();
            }

            category.items.push({
                src: imageDataUrl,
                colorable: isColorable,
                id: Date.now()
            });

            renderLibrary();
            renderCategoryChips();
            
            modal.show('success', 'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', `âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© "${categoryName}"`);
        }

        async function importData(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;

            const processImport = async (replace) => {
                if (replace) libraryData = [];
                
                let processedFiles = 0;
                let mergedCategories = 0;

                const readFileAsText = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsText(file);
                    });
                };

                for (const file of files) {
                    try {
                        const jsonContent = await readFileAsText(file);
                        const data = JSON.parse(jsonContent);

                        if (Array.isArray(data)) {
                            data.forEach(importedCat => {
                                const existingCat = libraryData.find(c => c.name.trim() === importedCat.name.trim());
                                if (existingCat) {
                                    existingCat.items.push(...importedCat.items);
                                    mergedCategories++;
                                } else {
                                    libraryData.push(importedCat);
                                }
                            });
                            processedFiles++;
                        }
                    } catch (err) {
                        console.error(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${file.name}`, err);
                    }
                }

                if (processedFiles > 0) {
                    renderLibrary();
                    updateCategoryDatalist();
                    renderCategoryChips();
                    modal.show('success', 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', `âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${processedFiles} Ù…Ù„ÙØ§Øª.`);
                } else {
                    modal.show('error', 'Ø®Ø·Ø£', "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©.");
                }
                input.value = '';
            };

            if (libraryData.length > 0) {
                modal.show('warning', 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª', "Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£Ù… Ø¯Ù…Ø¬Ù‡Ø§ØŸ", () => {
                    // Ø¥Ø°Ø§ Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ (Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¨Ø¯Ù„)
                    processImport(true);
                });
                // Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ Ø§Ù„Ø¯Ù…Ø¬ (Ù„Ø£Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ Ù‡Ùˆ Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„)
                // Ù„ÙƒÙ† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ØŒ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø§Ù„Ø¯Ù…Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ø£Ùˆ Ù†Ø³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ù…Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø²Ø± Ø¢Ø®Ø±
                // Ø³Ø£Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¢Ù…Ù†Ø©: Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¶ØºØ· Ù…ÙˆØ§ÙÙ‚ØŒ Ù†Ø¯Ù…Ø¬.
                const cancelBtn = document.querySelector('#modal-actions button:first-child');
                if(cancelBtn) {
                    cancelBtn.innerText = "Ø¯Ù…Ø¬";
                    cancelBtn.onclick = () => { processImport(false); modal.hide(); };
                }
                
                // ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙŠØºÙ„Ù‚ ÙÙ‚Ø·.
                // Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø£Ù…Ø± Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¯Ù…Ø¬ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¶ØºØ· "Ø§Ø³ØªØ¨Ø¯Ø§Ù„"
                // Ù„ÙƒÙ† Ø§Ù„Ø£ÙØ¶Ù„ Ù‡Ùˆ Ø£Ù† Ø£Ø¬Ø¹Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹ Ø¨Ø§Ù„Ø¯Ù…Ø¬
                processImport(false);
            } else {
                processImport(false);
            }
        }

        function moveCategory(index, direction) {
            if (direction === -1 && index > 0) {
                [libraryData[index], libraryData[index - 1]] = [libraryData[index - 1], libraryData[index]];
            } else if (direction === 1 && index < libraryData.length - 1) {
                [libraryData[index], libraryData[index + 1]] = [libraryData[index + 1], libraryData[index]];
            }
            renderLibrary();
            renderCategoryChips();
            updateCategoryDatalist();
        }

        let editingIndex = null;
        function renameCategory(index) {
            editingIndex = index;
            const currentName = libraryData[index].name;
            const input = document.getElementById('new-category-name');
            input.value = currentName;
            document.getElementById('rename-modal').classList.remove('hidden');
            setTimeout(() => input.focus(), 100);
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.add('hidden');
            editingIndex = null;
        }

        function handleEnter(e) { if(e.key === 'Enter') saveRename(); }

        function saveRename() {
            if (editingIndex === null) return;
            const newName = document.getElementById('new-category-name').value.trim();
            if (newName && newName !== "") {
                libraryData[editingIndex].name = newName;
                renderLibrary();
                renderCategoryChips();
                updateCategoryDatalist();
            }
            closeRenameModal();
        }

        function renderLibrary() {
            const container = document.getElementById('library-preview');
            const totalCountEl = document.getElementById('total-count');
            const warningEl = document.getElementById('size-warning');
            
            container.innerHTML = '';
            let totalItems = 0;

            if (libraryData.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10 text-sm">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</div>';
                totalCountEl.innerText = "0 Ø¹Ù†ØµØ±";
                warningEl.classList.add('hidden');
                return;
            }

            libraryData.forEach((cat, catIndex) => {
                totalItems += cat.items.length;
                
                const catEl = document.createElement('div');
                catEl.className = 'bg-slate-50 rounded-xl border border-slate-200 overflow-hidden';
                
                const isFirst = catIndex === 0;
                const isLast = catIndex === libraryData.length - 1;

                catEl.innerHTML = `
                    <div class="bg-slate-100 p-2 flex justify-between items-center" >
                        <div class="flex items-center gap-2 cursor-pointer flex-1" onclick="toggleCat(${catIndex})">
                            <h3 class="font-bold text-sm text-slate-700">ğŸ“‚ ${cat.name}</h3>
                            <span class="bg-white text-slate-500 text-[10px] px-2 py-0.5 rounded-full border border-slate-200">${cat.items.length}</span>
                        </div>
                        
                        <div class="flex items-center gap-1">
                            <button onclick="event.stopPropagation(); renameCategory(${catIndex})" class="w-7 h-7 flex items-center justify-center rounded hover:bg-white text-slate-500 hover:text-blue-600 transition" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…">
                                <i class="fas fa-pen text-xs"></i>
                            </button>

                            <div class="flex flex-col gap-[2px]">
                                <button onclick="event.stopPropagation(); moveCategory(${catIndex}, -1)" class="w-6 h-3 flex items-center justify-center bg-white hover:bg-slate-200 text-[8px] rounded border border-slate-200 ${isFirst ? 'opacity-30 cursor-not-allowed' : ''}" ${isFirst ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                                <button onclick="event.stopPropagation(); moveCategory(${catIndex}, 1)" class="w-6 h-3 flex items-center justify-center bg-white hover:bg-slate-200 text-[8px] rounded border border-slate-200 ${isLast ? 'opacity-30 cursor-not-allowed' : ''}" ${isLast ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            
                            <div class="w-px h-5 bg-slate-300 mx-1"></div>

                            <button onclick="event.stopPropagation(); deleteCategory(${catIndex})" class="w-7 h-7 flex items-center justify-center rounded hover:bg-red-50 text-slate-400 hover:text-red-500 transition" title="Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div id="cat-content-${catIndex}" class="p-2 grid grid-cols-3 gap-2 max-h-40 overflow-y-auto hidden">
                        ${cat.items.map((item, itemIndex) => `
                            <div class="relative group bg-white border border-slate-200 rounded-lg aspect-square flex items-center justify-center p-1 checkerboard">
                                <img src="${item.src}" class="max-w-full max-h-full object-contain">
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                                    <button onclick="deleteItem(${catIndex}, ${itemIndex})" class="text-white hover:text-red-400"><i class="fas fa-trash"></i></button>
                                </div>
                                ${item.colorable ? '<span class="absolute top-0 right-0 bg-[#ec4899] text-white text-[8px] px-1 rounded-bl">ØªÙ„ÙˆÙŠÙ†</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(catEl);
            });
            totalCountEl.innerText = `${totalItems} Ø¹Ù†ØµØ±`;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
            const dataStr = JSON.stringify(libraryData);
            const sizeInBytes = new Blob([dataStr]).size;
            const sizeInMB = sizeInBytes / (1024 * 1024);
            
            if(sizeInMB > 25) {
                warningEl.innerHTML = `âš ï¸ ØªØ­Ø°ÙŠØ±: Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ <b>${sizeInMB.toFixed(1)} MB</b>.<br>Ù‡Ø°Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø­Ø¯ GitHub (25MB).`;
                warningEl.classList.remove('hidden');
            } else {
                warningEl.classList.add('hidden');
            }
        }

        function toggleCat(index) {
            const content = document.getElementById(`cat-content-${index}`);
            if(content) content.classList.toggle('hidden');
        }

        function updateCategoryDatalist() {
            const datalist = document.getElementById('existing-categories');
            datalist.innerHTML = libraryData.map(c => `<option value="${c.name}">`).join('');
        }

        function deleteItem(catIndex, itemIndex) {
            modal.show('delete', 'Ø­Ø°Ù Ø¹Ù†ØµØ±', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ', () => {
                libraryData[catIndex].items.splice(itemIndex, 1);
                renderLibrary();
                renderCategoryChips(); 
            });
        }
        
        function deleteCategory(catIndex) {
            modal.show('delete', 'Ø­Ø°Ù Ù‚Ø§Ø¦Ù…Ø©', `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© "${libraryData[catIndex].name}" ÙˆÙƒØ§ÙØ© Ù…Ø­ØªÙˆÙŠØ§ØªÙ‡Ø§ØŸ`, () => {
                libraryData.splice(catIndex, 1);
                renderLibrary();
                updateCategoryDatalist();
                renderCategoryChips(); 
            });
        }

        function exportAllData() {
            if (libraryData.length === 0) {
                modal.show('warning', 'ØªØµØ¯ÙŠØ±', "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
                return;
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ£Ø®Ø° Ø«ÙˆØ§Ù†ÙŠ
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('hidden');

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©
            setTimeout(() => {
                try {
                    // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù†Øµ
                    const dataStr = JSON.stringify(libraryData, null, 2);
                    
                    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    try {
                        const testParse = JSON.parse(dataStr);
                        if(!Array.isArray(testParse)) throw new Error("Format error");
                    } catch(e) {
                        loading.classList.add('hidden');
                        modal.show('error', 'Ø®Ø·Ø£ ÙØ§Ø¯Ø­', "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©.");
                        return;
                    }

                    // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù…
                    const sizeInBytes = new Blob([dataStr]).size;
                    const sizeInMB = sizeInBytes / (1024 * 1024);

                    loading.classList.add('hidden');

                    let msg = `âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“¦ Ø§Ù„Ø­Ø¬Ù…: ${sizeInMB.toFixed(2)} MB\n\nğŸ’¡ Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø§Ù„Ù…Ù„Ù ÙØ§Ø±ØºØ§Ù‹ ÙÙŠ GitHubØŒ ÙÙ‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ Ø¬Ø¯Ø§Ù‹ (Ø§Ø¶ØºØ· Raw Ù„Ø±Ø¤ÙŠØªÙ‡).`;

                    if (sizeInMB > 25) {
                        modal.show('warning', 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ±', `Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (${sizeInMB.toFixed(2)} MB) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ÙÙŠ GitHub Web Upload (25MB).\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ`, () => {
                            downloadFile(dataStr);
                        });
                    } else {
                        downloadFile(dataStr);
                        modal.show('success', 'ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', msg);
                    }
                } catch (err) {
                    loading.classList.add('hidden');
                    console.error(err);
                    modal.show('error', 'Ø®Ø·Ø£', "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±.");
                }
            }, 100);
        }

        function downloadFile(dataStr) {
            const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `official.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }
    </script>
</body>
</html>