<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ø£ØµÙˆÙ„ | Dalal Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        
        /* Ø®Ù„ÙÙŠØ© Ø´Ø·Ø±Ù†Ø¬ Ù„Ù„Ù…Ù…Ø­Ø§Ø© */
        .checkerboard {
            background-color: #ffffff;
            background-image: linear-gradient(45deg, #e2e8f0 25%, transparent 25%), 
                              linear-gradient(-45deg, #e2e8f0 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e2e8f0 75%), 
                              linear-gradient(-45deg, transparent 75%, #e2e8f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .canvas-container {
            position: relative;
            /* ØªÙ… ØªØºÙŠÙŠØ± overflow Ø¥Ù„Ù‰ hidden Ù„Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© Ø³ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù… */
            overflow: hidden; 
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            background-color: white;
            height: 500px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ù†Ø·Ù‚Ø© */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px; /* Ù‡ÙˆØ§Ù…Ø´ Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØµØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­ÙˆØ§Ù */
        }
        
        canvas {
            /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø§Ù„ØµÙˆØ±Ø© Ø³ØªØ¸Ù‡Ø± ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø­Ø¬Ù…Ù‡Ø§ */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: crosshair;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
        .chip-btn {
            transition: all 0.2s;
        }
        .chip-btn.active {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Ø§Ù„Ø±Ø£Ø³ -->
    <header class="bg-[#1e1b4b] text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-cogs text-2xl text-[#ec4899]"></i>
                <div>
                    <h1 class="font-bold text-xl">Ù…Ø¯ÙŠØ± Ù‚ÙˆØ§Ù„Ø¨ Ø¯Ù„Ø§Ù„ ğŸ› ï¸</h1>
                    <p class="text-xs text-slate-300">ØªØ¬Ù‡ÙŠØ²ØŒ ØªÙØ±ÙŠØºØŒ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ØµÙˆÙ„</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                <button onclick="document.getElementById('import-file').click()" class="bg-[#6366f1] hover:bg-[#4f46e5] text-white px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-md text-sm">
                    <i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø³Ø§Ø¨Ù‚
                </button>

                <!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
                <button onclick="exportAllData()" class="bg-[#ec4899] hover:bg-[#db2777] text-white px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-md text-sm">
                    <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰: Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ² -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-[#6366f1]">
                    <span class="bg-[#e0e7ff] w-8 h-8 flex items-center justify-center rounded-full text-sm">1</span>
                    Ø±ÙØ¹ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø©)
                </h2>
                
                <div class="flex flex-col gap-4">
                    <label class="border-2 border-dashed border-[#6366f1] bg-[#f5f3ff] rounded-xl p-8 text-center cursor-pointer hover:bg-[#eef2ff] transition">
                        <input type="file" id="file-upload" class="hidden" accept="image/*,.svg" onchange="loadImage(this)">
                        <i class="fas fa-cloud-upload-alt text-4xl text-[#6366f1] mb-2"></i>
                        <p class="font-bold text-[#4f46e5]">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
                        <p class="text-xs text-slate-500">PNG, JPG, WEBP, SVG</p>
                    </label>

                    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù…Ø­Ø§Ø© -->
                    <div id="editor-tools" class="hidden flex flex-wrap items-center gap-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold">ğŸ§¹ Ø¯Ù‚Ø© Ø§Ù„Ù…Ù…Ø­Ø§Ø©:</span>
                            <input type="range" id="tolerance" min="1" max="100" value="30" class="accent-[#6366f1] w-32">
                            <span id="tolerance-val" class="text-xs font-bold text-[#6366f1]">30</span>
                        </div>
                        <div class="h-6 w-px bg-slate-300"></div>
                        <button onclick="restoreOriginal()" class="text-xs font-bold text-slate-600 hover:text-red-500 flex items-center gap-1">
                            <i class="fas fa-undo"></i> ØªØ±Ø§Ø¬Ø¹ Ù„Ù„Ø£ØµÙ„
                        </button>
                        <div class="flex-1"></div>
                        <div class="text-xs text-slate-500 font-bold bg-yellow-100 px-2 py-1 rounded text-yellow-700">
                            <i class="fas fa-magic"></i> Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù…Ø³Ø­Ù‡Ø§
                        </div>
                    </div>

                    <!-- Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ -->
                    <div class="canvas-container checkerboard" id="canvas-wrapper">
                        <div class="text-slate-400 text-sm font-bold pointer-events-none">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø©</div>
                    </div>
                </div>
            </div>

            <!-- 2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ØµØ± -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-[#6366f1]">
                    <span class="bg-[#e0e7ff] w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span>
                    Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ±
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„ØªØµÙ†ÙŠÙ) -->
                    <div>
                        <label class="block text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Category):</label>
                        <div class="relative">
                            <input type="text" id="category-name" list="existing-categories" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„..." class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-[#6366f1]">
                            <datalist id="existing-categories">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                            </datalist>
                        </div>
                        
                        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                        <div id="category-chips" class="flex flex-wrap gap-2 mt-3 p-2 bg-slate-50 rounded-lg border border-slate-100 min-h-[40px]">
                            <span class="text-xs text-slate-400 self-center">Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</span>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                    </div>

                    <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†ØµØ± -->
                    <div class="flex flex-col justify-center gap-3">
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition">
                            <input type="checkbox" id="is-colorable" class="w-5 h-5 accent-[#ec4899]">
                            <div>
                                <span class="block font-bold text-sm">ğŸ¨ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ„ÙˆÙŠÙ† (Colorable)</span>
                                <span class="text-[10px] text-slate-500">Ø§Ø®ØªØ± Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ø·Ø§Ø±Ø§Ù‹ Ø£Ùˆ Ù†Ù‚Ø´Ø§Ù‹ Ø£Ø³ÙˆØ¯ ØªØ±ÙŠØ¯ ØªÙ„ÙˆÙŠÙ†Ù‡.</span>
                            </div>
                        </label>
                    </div>
                </div>

                <button onclick="addToLibrary()" class="w-full mt-4 bg-[#6366f1] hover:bg-[#4f46e5] text-white py-3 rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙƒØªØ¨Ø©
                </button>
            </div>
        </div>

        <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠØ³Ø±Ù‰: Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <div class="lg:col-span-4 space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 h-[calc(100vh-120px)] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h2 class="font-bold text-[#1e293b]">ğŸ“¦ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                    <span id="total-count" class="bg-[#e0e7ff] text-[#4f46e5] px-2 py-1 rounded text-xs font-bold">0 Ø¹Ù†ØµØ±</span>
                </div>

                <div id="library-preview" class="flex-1 overflow-y-auto space-y-4 pr-1">
                    <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù‡Ù†Ø§ -->
                    <div class="text-center text-slate-400 py-10 text-sm">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ÙˆØ§Ù„Ù…Ù…Ø­Ø§Ø©
        // ==========================================
        let canvas, ctx;
        let originalImage = null;
        const canvasContainer = document.getElementById('canvas-wrapper');
        const toleranceInput = document.getElementById('tolerance');
        const toleranceDisplay = document.getElementById('tolerance-val');

        toleranceInput.addEventListener('input', (e) => toleranceDisplay.innerText = e.target.value);

        function loadImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        createCanvas(img);
                    };
                    img.src = e.target.result;
                    originalImage = img;
                };
                reader.readAsDataURL(input.files[0]);
                document.getElementById('editor-tools').classList.remove('hidden');
            }
        }

        function createCanvas(img) {
            canvasContainer.innerHTML = '';
            canvas = document.createElement('canvas');
            
            // === Ø±ÙØ¹ Ø§Ù„Ø¯Ù‚Ø© ===
            // ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ 3000 Ø¨ÙƒØ³Ù„ Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
            const maxSize = 3000; 
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxSize) {
                    height *= maxSize / width;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width *= maxSize / height;
                    height = maxSize;
                }
            }

            canvas.width = width;
            canvas.height = height;
            
            // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„Ø¹Ø±Ø¶ (CSS) Ù„ÙŠÙƒÙˆÙ† Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ù„Ù„Ø´Ø§Ø´Ø© Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø©
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ©ØŒ Ø³ÙŠØªÙ… ØªØµØºÙŠØ± Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
            if (width > canvasContainer.clientWidth) {
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
            } else {
                canvas.style.width = 'auto';
                canvas.style.height = 'auto';
            }

            ctx = canvas.getContext('2d', { willReadFrequently: true });
            ctx.drawImage(img, 0, 0, width, height);
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ù„Ù„Ù…Ø³Ø­
            canvas.addEventListener('mousedown', handleCanvasClick);
            
            canvasContainer.appendChild(canvas);
        }

        function restoreOriginal() {
            if(originalImage) createCanvas(originalImage);
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            
            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (CSS Fit) ÙˆØ§Ù„Ø­Ø¬Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Internal High Res)
            // Ù‡Ø°Ø§ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³Ø­ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ± Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            floodFill(x, y);
        }

        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© (Flood Fill) Ù„Ù„Ù…Ø³Ø­
        function floodFill(startX, startY) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const tolerance = parseInt(toleranceInput.value);
            
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = data[startPos];
            const startG = data[startPos + 1];
            const startB = data[startPos + 2];
            const startA = data[startPos + 3];

            if (startA === 0) return; // ØªÙ… Ù…Ø³Ø­Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„

            const queue = [[startX, startY]];
            const visited = new Uint8Array(canvas.width * canvas.height); // ØªØªØ¨Ø¹ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ø²ÙŠØ§Ø±ØªÙ‡Ø§

            // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù„ÙˆÙ†
            function match(pos) {
                const r = data[pos];
                const g = data[pos + 1];
                const b = data[pos + 2];
                const a = data[pos + 3];
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø´ÙØ§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ù…Ø®ØªÙ„ÙØ© Ø¬Ø¯Ø§Ù‹
                if (a === 0) return false;

                const diff = Math.abs(r - startR) + Math.abs(g - startG) + Math.abs(b - startB);
                return diff <= tolerance * 3; 
            }

            while (queue.length > 0) {
                const [x, y] = queue.shift();
                const pos = (y * canvas.width + x) * 4;
                const pixelIndex = y * canvas.width + x;

                if (visited[pixelIndex]) continue;
                visited[pixelIndex] = 1;

                if (match(pos)) {
                    // Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„
                    data[pos + 3] = 0;

                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙŠØ±Ø§Ù†
                    if (x > 0) queue.push([x - 1, y]);
                    if (x < canvas.width - 1) queue.push([x + 1, y]);
                    if (y > 0) queue.push([x, y - 1]);
                    if (y < canvas.height - 1) queue.push([x, y + 1]);
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // ==========================================
        //  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø©
        // ==========================================
        let libraryData = []; // Ø§Ù„Ù‡ÙŠÙƒÙ„: [ { category: "Ø¥Ø·Ø§Ø±Ø§Øª", items: [ {src, colorable} ] } ]

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
        function renderCategoryChips() {
            const container = document.getElementById('category-chips');
            container.innerHTML = '';
            
            if (libraryData.length === 0) {
                container.innerHTML = '<span class="text-xs text-slate-400 self-center">Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</span>';
                return;
            }

            libraryData.forEach(cat => {
                const chip = document.createElement('button');
                chip.className = 'chip-btn px-3 py-1 bg-white hover:bg-[#6366f1] hover:text-white text-slate-700 text-xs rounded-full border border-slate-300 font-bold shadow-sm';
                chip.innerText = cat.name;
                chip.onclick = () => {
                    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                    document.getElementById('category-name').value = cat.name;
                    
                    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
                    document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active', 'ring-2', 'ring-offset-1', 'ring-[#6366f1]'));
                    chip.classList.add('active', 'ring-2', 'ring-offset-1', 'ring-[#6366f1]');
                };
                container.appendChild(chip);
            });
        }

        function addToLibrary() {
            if (!canvas) {
                alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            const categoryName = document.getElementById('category-name').value.trim();
            if (!categoryName) {
                alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø¥Ø·Ø§Ø±Ø§Øª)");
                return;
            }

            const isColorable = document.getElementById('is-colorable').checked;
            
            // ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ù…Ù…ÙƒÙ†Ø©
            const imageDataUrl = canvas.toDataURL('image/png', 1.0); 

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            let category = libraryData.find(c => c.name === categoryName);
            
            if (!category) {
                category = { name: categoryName, items: [] };
                libraryData.push(category);
                updateCategoryDatalist();
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±
            category.items.push({
                src: imageDataUrl,
                colorable: isColorable,
                id: Date.now()
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            renderLibrary();
            renderCategoryChips(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
            
            // ØªÙ†Ø¸ÙŠÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            // restoreOriginal(); // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø£Ù… Ù…Ø³Ø­Ù‡Ø§ØŸ
            alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© "${categoryName}"`);
        }

        // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===
        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (Array.isArray(data)) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙŠØ³Øª ÙØ§Ø±ØºØ©ØŒ Ù†Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        if (libraryData.length > 0) {
                            if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ØŸ\n\nâœ… Ù…ÙˆØ§ÙÙ‚: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ù)\nâŒ Ø¥Ù„ØºØ§Ø¡: Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ")) {
                                libraryData = data;
                            } else {
                                // Ø¯Ù…Ø¬ Ø°ÙƒÙŠ: Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©
                                data.forEach(importedCat => {
                                    const existingCat = libraryData.find(c => c.name === importedCat.name);
                                    if (existingCat) {
                                        existingCat.items.push(...importedCat.items);
                                    } else {
                                        libraryData.push(importedCat);
                                    }
                                });
                            }
                        } else {
                            libraryData = data;
                        }
                        
                        renderLibrary();
                        updateCategoryDatalist();
                        renderCategoryChips(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
                        alert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\nØ¹Ø¯Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…: ${libraryData.length}`);
                    } else {
                        alert("âŒ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.");
                }
                input.value = ''; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù
            };
            reader.readAsText(file);
        }

        function renderLibrary() {
            const container = document.getElementById('library-preview');
            const totalCountEl = document.getElementById('total-count');
            
            container.innerHTML = '';
            let totalItems = 0;

            if (libraryData.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10 text-sm">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</div>';
                totalCountEl.innerText = "0 Ø¹Ù†ØµØ±";
                return;
            }

            libraryData.forEach((cat, catIndex) => {
                totalItems += cat.items.length;
                
                const catEl = document.createElement('div');
                catEl.className = 'bg-slate-50 rounded-xl border border-slate-200 overflow-hidden';
                
                // Ø±Ø£Ø³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                catEl.innerHTML = `
                    <div class="bg-slate-100 p-3 flex justify-between items-center cursor-pointer" onclick="toggleCat(${catIndex})">
                        <h3 class="font-bold text-sm text-slate-700">ğŸ“‚ ${cat.name}</h3>
                        <div class="flex items-center gap-2">
                            <span class="bg-white text-slate-500 text-[10px] px-2 py-0.5 rounded-full border border-slate-200">${cat.items.length}</span>
                            <button onclick="event.stopPropagation(); deleteCategory(${catIndex})" class="text-slate-400 hover:text-red-500 px-1"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div id="cat-content-${catIndex}" class="p-2 grid grid-cols-3 gap-2 max-h-40 overflow-y-auto hidden">
                        ${cat.items.map((item, itemIndex) => `
                            <div class="relative group bg-white border border-slate-200 rounded-lg aspect-square flex items-center justify-center p-1 checkerboard">
                                <img src="${item.src}" class="max-w-full max-h-full object-contain">
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                                    <button onclick="deleteItem(${catIndex}, ${itemIndex})" class="text-white hover:text-red-400"><i class="fas fa-trash"></i></button>
                                </div>
                                ${item.colorable ? '<span class="absolute top-0 right-0 bg-[#ec4899] text-white text-[8px] px-1 rounded-bl">ØªÙ„ÙˆÙŠÙ†</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(catEl);
            });
            
            // ÙØªØ­ Ø¢Ø®Ø± Ù‚Ø§Ø¦Ù…Ø© ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„ÙŠÙ‡Ø§
            const lastCatIndex = libraryData.length - 1;
            setTimeout(() => toggleCat(lastCatIndex), 100);

            totalCountEl.innerText = `${totalItems} Ø¹Ù†ØµØ±`;
        }

        function toggleCat(index) {
            const content = document.getElementById(`cat-content-${index}`);
            if(content) content.classList.toggle('hidden');
        }

        function updateCategoryDatalist() {
            const datalist = document.getElementById('existing-categories');
            datalist.innerHTML = libraryData.map(c => `<option value="${c.name}">`).join('');
        }

        function deleteItem(catIndex, itemIndex) {
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) {
                libraryData[catIndex].items.splice(itemIndex, 1);
                if(libraryData[catIndex].items.length === 0) {
                    // Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¥Ø°Ø§ Ø£Ø±Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯
                    // libraryData.splice(catIndex, 1); 
                }
                renderLibrary();
                renderCategoryChips(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            }
        }
        
        function deleteCategory(catIndex) {
            if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© "${libraryData[catIndex].name}" ÙˆÙƒØ§ÙØ© Ù…Ø­ØªÙˆÙŠØ§ØªÙ‡Ø§ØŸ`)) {
                libraryData.splice(catIndex, 1);
                renderLibrary();
                updateCategoryDatalist();
                renderCategoryChips(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            }
        }

        function exportAllData() {
            if (libraryData.length === 0) {
                alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
                return;
            }

            const dataStr = JSON.stringify(libraryData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØµØ¨Ø­ Ø§Ù„Ø§Ø³Ù… Ø«Ø§Ø¨ØªØ§Ù‹: official.json
            a.download = `official.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ø¢Ù† Ù‚Ù… Ø¨Ø±ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ GitHub ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Raw) ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.");
        }
    </script>
</body>
</html>