<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a472a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>المصحف الرقمي</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <link id="fa-stylesheet" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link id="google-fonts" href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Amiri+Quran&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@400;600;700&family=Reem+Kufi:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet" crossorigin="anonymous">

    <style>
        :root {
            --gold-primary: #c5a059;
            --green-deep: #1a472a;
            --paper-bg: #fffbf2;
            --dark-bg: #2b2b2b;
            --panel-light: #fffbf2;
            --panel-dark: rgba(43, 43, 43, 0.95);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f0f0;
            color: #2d3748;
            margin: 0; padding: 0;
            height: 100vh; height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- READER VIEW --- */
        #reader-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--paper-bg);
            z-index: 10; display: none; justify-content: center; align-items: center;
            padding: 0; 
            /* Normal Mode: Top Bar (60px) only at top */
            padding-top: 60px; 
            /* Normal Mode: Nav Bar (70px) + Info Bar (40px) = 110px space at bottom */
            padding-bottom: 110px; 
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #reader-view.active { display: flex; }
        
        /* Immersive Mode Padding */
        body.immersive-mode #reader-view { 
            padding-top: 50px; /* Height of Juz Strip (reduced) */
            padding-bottom: 45px; /* Height of Info Bar at bottom */
        }

        .mushaf-page-frame {
            width: 100%; height: 100%;
            background-color: var(--paper-bg);
            position: relative; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        #quran-slider-container {
            position: relative; width: 100%; height: 100%;
            overflow: hidden; z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }

        .quran-page-slide {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--paper-bg);
            transition: transform 0.2s ease-out; will-change: transform;
            padding: 10px; box-sizing: border-box;
        }

        .quran-page-slide img, .quran-page-slide svg {
            width: 100%; height: 100%;
            object-fit: contain; object-position: center center;
            transition: opacity 0.3s ease, filter 0.3s ease;
            opacity: 0;
        }
        .quran-page-slide img { pointer-events: none; }
        .quran-page-slide img.loaded, .quran-page-slide svg { opacity: 1; }

        /* Interactive Paths Style */
        .interactive-path { 
            cursor: pointer; 
            transition: fill 0.2s, fill-opacity 0.2s; 
            fill: transparent; /* Default transparent */
        }
        .interactive-path:active { 
            fill: rgba(197, 160, 89, 0.5) !important; 
            fill-opacity: 1 !important;
        }

        .interactive-ayah { cursor: pointer; fill-opacity: 0; transition: fill-opacity 0.2s; }
        .interactive-ayah:active { fill: rgba(197, 160, 89, 0.3); fill-opacity: 1; }

        /* --- Top Bar (Main Search) --- */
        .top-search-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background-color: var(--green-deep); z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease; gap: 8px;
            font-family: 'Cairo', sans-serif !important;
        }
        .immersive-mode .top-search-bar { transform: translateY(-100%); }

        .top-bar-section-1 { flex: 0 0 auto; width: 35%; }
        .surah-quick-select {
            width: 100%; background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 20px;
            padding: 5px 10px; color: white; 
            font-family: 'Cairo', sans-serif; font-size: 13px; font-weight: 600;
            outline: none; -webkit-appearance: none; appearance: none;
            text-align: center;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: left .7em top 50%; background-size: .65em auto;
        }

        .top-bar-section-2 { flex: 1; position: relative; }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 20px;
            padding: 5px 30px 5px 10px; color: white; 
            font-family: 'Cairo', sans-serif; font-size: 13px; outline: none; transition: 0.3s;
        }
        .search-input:focus { background: rgba(255,255,255,0.25); border-color: var(--gold-primary); }
        .search-input::placeholder { color: rgba(255,255,255,0.6); }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.6); pointer-events: none; font-size: 12px; }

        .top-bar-section-3 { flex: 0 0 auto; display: flex; gap: 5px; }
        .tool-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.7); cursor: pointer; transition: 0.2s;
            font-size: 14px;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .tool-btn.active { color: var(--gold-primary); border-color: var(--gold-primary); background: rgba(255,255,255,0.2); }

        #search-results {
            position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px;
            background: white; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 400px; overflow-y: auto; display: none;
            flex-direction: column; border: 1px solid #eee; z-index: 200;
        }
        .search-result-item { padding: 10px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .search-result-item:hover { background: #f9f9f9; }
        .search-result-text { font-family: 'Amiri', serif; font-size: 15px; color: #333; line-height: 1.6; }
        .search-result-info { font-family: 'Cairo', sans-serif; font-size: 10px; color: #888; background: #eee; padding: 2px 6px; border-radius: 8px; white-space: nowrap; margin-right: 10px; }
        .search-header-result { background: #f0fdf4; border-right: 4px solid var(--green-deep); }

        /* --- Page Info Bar --- */
        #page-info-bar {
            position: fixed;
            left: 0; right: 0;
            height: 40px; 
            background: rgba(255, 251, 242, 0.95);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            /* Changed Font to Tajawal and placed at bottom */
            font-family: 'Tajawal', sans-serif; 
            font-size: 13px; 
            font-weight: bold; 
            color: var(--green-deep);
            z-index: 90;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(5px);
            
            top: auto; 
            bottom: 70px; /* Above Nav Bar */
            border-bottom: none;
            border-top: 1px solid rgba(197, 160, 89, 0.2);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        body.immersive-mode #page-info-bar { 
            bottom: 0;
            border-top: 1px solid rgba(197, 160, 89, 0.2);
            background: rgba(255, 251, 242, 0.98); 
        }
        
        body.dark-mode #page-info-bar { 
            background: rgba(43, 43, 43, 0.95); 
            color: #c5a059; 
            border-color: rgba(255,255,255,0.1); 
        }

        /* --- Immersive Juz Progress Circles (GAMIFIED) --- */
        #immersive-progress-strip {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 50px; /* Reduced height */
            background: linear-gradient(to bottom, rgba(26, 71, 42, 0.98), rgba(26, 71, 42, 0.9));
            z-index: 150;
            display: flex;
            align-items: center;
            padding: 0 10px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
            direction: rtl; /* Ensure circles start from right */
        }
        #immersive-progress-strip::-webkit-scrollbar { display: none; }
        
        body.immersive-mode #immersive-progress-strip { transform: translateY(0); }

        .juz-circle-container {
            display: inline-flex;
            align-items: center;
            padding: 0 5px;
        }

        .juz-circle {
            width: 26px; height: 26px; /* Smaller circles */
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6);
            display: flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold; /* Smaller font */
            font-family: 'Tajawal', sans-serif;
            position: relative;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
        }

        .juz-line {
            width: 20px; height: 2px; /* Smaller lines */
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            transition: all 0.4s ease;
            flex-shrink: 0;
        }

        /* Completed/Active States */
        .juz-circle.completed {
            background: #c5a059;
            border-color: #e6c888;
            color: #1a472a;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.4);
        }
        .juz-circle.active {
            background: white;
            border-color: #c5a059;
            color: #c5a059;
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            z-index: 2;
        }
        .juz-line.filled {
            background: #c5a059;
            box-shadow: 0 0 5px rgba(197, 160, 89, 0.3);
        }

        /* Dark Mode */
        body.dark-mode #reader-view, body.dark-mode .mushaf-page-frame, body.dark-mode .quran-page-slide { background-color: var(--dark-bg) !important; }
        body.dark-mode .quran-page-slide img, body.dark-mode .quran-page-slide svg { filter: invert(1) grayscale(1) brightness(1.2) contrast(0.9); mix-blend-mode: screen; }
        body.dark-mode #search-results { background: #333; border-color: #444; }
        body.dark-mode .search-result-item { border-color: #444; }
        body.dark-mode .search-result-item:hover { background: #444; }
        body.dark-mode .search-result-text { color: #ddd; }
        body.dark-mode .search-header-result { background: #2f3b35; }

        /* Verse List Sheet */
        #verse-list-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 24px 24px 0 0;
            z-index: 2000; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 60vh; display: flex; flex-direction: column; touch-action: pan-y;
        }
        #verse-list-sheet.active { transform: translateY(0); }
        .sheet-header { 
            padding: 15px; border-bottom: 1px solid #eee; 
            display: flex; justify-content: center; align-items: center; 
            position: relative;
        }
        .sheet-content { overflow-y: auto; padding: 10px; flex: 1; }
        .verse-item { padding: 12px; margin-bottom: 8px; border-radius: 12px; background: #f9f9f9; font-family: 'Amiri Quran', serif; font-size: 18px; line-height: 1.8; border: 1px solid transparent; cursor: pointer; }
        .verse-item:active { background: #f0fdf4; border-color: var(--green-deep); }
        body.dark-mode #verse-list-sheet { background: #333; color: white; }
        body.dark-mode .sheet-header { border-color: #444; }
        body.dark-mode .verse-item { background: #3d3d3d; }

        /* Hints */
        #click-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 3000; }
        .immersive-mode #click-hint { display: none; }

        /* Tafsir Modal with Settings */
        #tafsir-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .tafsir-card { background: white; width: 100%; max-width: 500px; max-height: 70vh; border-radius: 20px; padding: 0; display: flex; flex-direction: column; overflow: hidden; animation: popIn 0.3s; position: relative; }
        
        .tafsir-header { 
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--green-deep); color: white; 
        }
        
        .tafsir-title-group { display: flex; align-items: center; gap: 8px; }
        .tafsir-settings-btn { color: rgba(255,255,255,0.8); cursor: pointer; padding: 5px; transition: 0.3s; }
        .tafsir-settings-btn:hover { color: var(--gold-primary); transform: rotate(45deg); }
        
        #tafsir-sources-menu {
            position: absolute; top: 55px; right: 10px; width: 250px;
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 1px solid #eee; z-index: 3010; display: none; overflow: hidden;
            animation: slideDown 0.2s ease-out;
        }
        .tafsir-source-item {
            padding: 12px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer;
            display: flex; flex-direction: column; gap: 2px;
        }
        .tafsir-source-item:hover { background: #f9f9f9; }
        .tafsir-source-item.active { background: #f0fdf4; border-right: 4px solid var(--green-deep); }
        .ts-name { font-weight: bold; font-size: 14px; color: #2d3748; }
        .ts-author { font-size: 11px; color: #888; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        body.dark-mode .tafsir-card { background: #333; color: #eee; }
        body.dark-mode .tafsir-header { background: var(--green-deep); border-color: rgba(255,255,255,0.1); }
        body.dark-mode #tafsir-sources-menu { background: #3a3a3a; border-color: #444; }
        body.dark-mode .tafsir-source-item { border-color: #444; }
        body.dark-mode .tafsir-source-item:hover { background: #444; }
        body.dark-mode .tafsir-source-item.active { background: #2f3b35; }
        body.dark-mode .ts-name { color: #eee; }

        /* --- NEW: Ayah Options Modal --- */
        #ayah-options-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 4000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .ayah-options-card { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.3s; position: relative; }
        .ayah-info-header { margin-bottom: 20px; }
        .ayah-info-text { font-family: 'Amiri', serif; color: #2d3748; font-size: 18px; margin-bottom: 5px; }
        .ayah-options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { background: #f8f8f8; border: 1px solid #eee; padding: 20px; border-radius: 15px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .option-btn:active { transform: scale(0.95); background: #f0fdf4; border-color: var(--green-deep); }
        .option-icon { font-size: 24px; color: var(--green-deep); }
        .option-label { font-family: 'Cairo', sans-serif; font-weight: bold; font-size: 14px; color: #555; }
        
        /* Audio Player View inside Modal */
        #audio-player-view { display: none; flex-direction: column; align-items: center; gap: 15px; width: 100%; }
        .reciter-name { font-family: 'Cairo', sans-serif; font-weight: bold; color: var(--green-deep); font-size: 14px; margin-top: 5px; }
        .player-controls { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .play-btn-large { width: 50px; height: 50px; border-radius: 50%; background: var(--green-deep); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(26, 71, 42, 0.3); }
        .audio-settings-btn { color: #888; cursor: pointer; transition: 0.3s; font-size: 18px; padding: 5px; }
        .audio-settings-btn:hover { color: var(--gold-primary); transform: rotate(45deg); }
        
        /* Reciter Menu */
        #reciter-menu { position: absolute; top: 60px; left: 20px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #eee; z-index: 4010; display: none; overflow: hidden; animation: slideDown 0.2s ease-out; max-height: 250px; overflow-y: auto; }
        body.dark-mode .ayah-options-card, body.dark-mode #reciter-menu { background: #333; color: white; }
        body.dark-mode .option-btn { background: #3d3d3d; border-color: #444; }
        body.dark-mode .option-label, body.dark-mode .ayah-info-text { color: #eee; }
        body.dark-mode .reciter-name { color: #c5a059; }

        /* --- DESIGNER CSS --- */
        #designer-view { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #fdfbf7; 
            background-image: radial-gradient(#c5a059 0.5px, transparent 0.5px);
            background-size: 20px 20px; 
            z-index: 10; display: none; overflow-y: auto; padding-bottom: 90px;
            color: #2d3748; 
        }
        #designer-view.active { display: block; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 30px -10px rgba(26, 71, 42, 0.15); }
        .preview-area { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b4975a' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); border-radius: 24px; min-height: 60vh; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 2px dashed var(--gold-primary); position: relative; transition: all 0.3s; padding: 20px 20px 100px 20px; }
        #card { background-color: white; position: relative; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2); overflow: hidden; margin: auto; direction: rtl; width: 378px; height: 672px; transform-origin: center; transition: width 0.3s, height 0.3s; }
        .image-layer.bg-image { width: 100% !important; height: 100% !important; top: 0 !important; left: 0 !important; transform: none !important; border: none !important; pointer-events: none; z-index: 1 !important; }
        #card-gradient { position: absolute; bottom: 0; left: 0; right: 0; height: 70%; background: linear-gradient(to top, rgba(255,255,255,0.95), transparent); pointer-events: none; display: none; z-index: 10 !important; }
        .frame-layer, .image-layer:not(.bg-image) { z-index: 20; } .text-layer { z-index: 50; }
        .draggable-el { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: grab; touch-action: none; border: 1px solid transparent; }
        .draggable-el.selected { z-index: 100 !important; border: 2px dashed var(--gold-primary); } 
        .handle { position: absolute; background: white; border: 1px solid var(--gold-primary); width: 15px; height: 15px; border-radius: 50%; z-index: 101; display: none; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .draggable-el.selected .handle { display: block; }
        .resize-nw { top: -8px; left: -8px; cursor: nw-resize; } .resize-ne { top: -8px; right: -8px; cursor: ne-resize; } .resize-sw { bottom: -8px; left: -8px; cursor: sw-resize; } .resize-se { bottom: -8px; right: -8px; cursor: se-resize; }
        .control-btn { position: absolute; width: 28px; height: 28px; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 102; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .delete-btn { top: -35px; left: -10px; background: #ef4444; }
        .move-handle { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 40px; height: 28px; background: var(--green-deep); border-radius: 8px; cursor: move; display: none; align-items: center; justify-content: center; z-index: 102; color: var(--gold-primary); }
        .draggable-el.selected .control-btn, .draggable-el.selected .move-handle { display: flex; }
        .ayah-text, .extra-text { line-height: 1.8; display: block; white-space: pre-wrap; outline: none; background: transparent; border: none; text-align: center; width: 100%; height:100%; resize: none; overflow: hidden; }
        .image-layer img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .controls-row { width: 100%; margin-top: 0.5rem; padding: 0.8rem; border-top: 1px solid rgba(180, 151, 90, 0.2); display: none; flex-wrap: wrap; align-items: center; gap: 0.8rem; background: #faf9f6; border-radius: 12px; }
        .controls-row.active { display: flex; animation: slideDown 0.2s ease-out; }
        .btn-tool { background: white; border: 1px solid #efe9d9; color: var(--green-deep); padding: 8px; border-radius: 12px; font-weight: bold; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-tool:active { transform: scale(0.95); background: #f0fdf4; }
        .design-btn { width: 100%; padding: 10px; border: none; border-radius: 8px; background: linear-gradient(135deg, #1a472a, #2d6a4f); color: white; font-weight: bold; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        #eraser-canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 200 !important; }
        .cursor-crosshair { cursor: crosshair !important; }
        .progress-container { width: 80%; max-width: 300px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #c5a059; transition: width 0.3s ease; border-radius: 3px; }

        /* --- Unified Bottom Nav (Fixed Bar) --- */
        .tab-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            width: 100%;
            height: 70px;
            /* Reverted to light gray */
            background: #f8f8f8; 
            border-top: 1px solid rgba(197, 160, 89, 0.2);
            border-radius: 20px 20px 0 0;
            display: flex; justify-content: space-around; align-items: center;
            /* UPDATED: Z-Index Higher than Modal */
            z-index: 200000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            padding-bottom: 10px; /* Safe area */
            transition: transform 0.3s ease;
        }
        
        body.immersive-mode .tab-nav { transform: translateY(100%); }

        /* Dark mode overrides */
        body.dark-mode .tab-nav { background: #1a1a1a; border-color: rgba(255,255,255,0.1); }

        /* Button Styles */
        .tab-btn {
            background: none; border: none; 
            color: #aaa; 
            cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px;
            width: auto; height: 100%; flex: 1;
            transition: all 0.2s ease;
        }
        
        .tab-btn i { font-size: 20px; transition: 0.3s ease; }
        .tab-btn span { 
            font-family: 'Tajawal', sans-serif; 
            font-size: 11px; 
            font-weight: bold;
        }

        /* Active State */
        .tab-btn.active { 
            background-color: transparent; 
            color: var(--green-deep); 
            box-shadow: 0 -2px 8px rgba(26, 71, 42, 0.2);
        }
        .tab-btn.active i { transform: translateY(-5px) scale(1.15); color: var(--green-deep); filter: drop-shadow(0 2px 4px rgba(26, 71, 42, 0.3)); }
        .tab-btn.active span { color: var(--green-deep); font-weight: 900; }
        
        body.dark-mode .tab-btn.active { color: #c5a059; }
        body.dark-mode .tab-btn.active i { color: #c5a059; }
        body.dark-mode .tab-btn.active span { color: #c5a059; }
        
        /* Gold Save Button in Designer (Moved to bottom) */
        .btn-gold-save {
            background: linear-gradient(135deg, #c5a059, #b48e42) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 4px 10px rgba(197, 160, 89, 0.4) !important;
            position: fixed !important;
            bottom: 20px !important;
            left: 20px !important;
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            display: none !important;
            z-index: 9998 !important;
            font-size: 24px !important;
        }
        .btn-gold-save:active { transform: scale(0.95); }
        @media (max-width: 1024px) {
            .btn-gold-save { display: flex !important; }
        }

        /* --- NEW QIBLA STYLES (PROFESSIONAL COMPASS) --- */
        .qibla-compass-container {
            width: 280px; height: 280px;
            position: relative;
            background: radial-gradient(circle at center, #1a472a 0%, #0f2e1b 100%);
            border-radius: 50%;
            border: 8px solid #c5a059;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
        }
        
        /* The decorative rim */
        .qibla-compass-rim {
            position: absolute; inset: 5px; border-radius: 50%;
            border: 2px dashed rgba(197, 160, 89, 0.3);
            pointer-events: none;
        }

        /* North Marker (Fixed to Compass) */
        .compass-dial {
            width: 100%; height: 100%;
            position: absolute;
            transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Cardinal Points */
        .cardinal-point {
            position: absolute; font-family: 'Amiri', serif; font-weight: bold;
            color: #c5a059; font-size: 16px;
        }
        .cp-n { top: 15px; left: 50%; transform: translateX(-50%); color: #ef4444; } /* North is Red */
        .cp-s { bottom: 15px; left: 50%; transform: translateX(-50%); }
        .cp-e { right: 15px; top: 50%; transform: translateY(-50%); }
        .cp-w { left: 15px; top: 50%; transform: translateY(-50%); }

        /* The Qibla Needle (Rotates relative to dial) */
        .qibla-needle-container {
            position: absolute;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 5;
        }

        .qibla-needle {
            width: 4px; height: 110px;
            background: linear-gradient(to top, transparent 50%, #c5a059 50%);
            position: relative;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.5);
        }

        /* Kaaba Icon on Tip of Needle */
        .kaaba-pointer {
            position: absolute; top: 0; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px; color: #c5a059;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0% { transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 0 rgba(197, 160, 89, 0)); }
            50% { transform: translate(-50%, -50%) scale(1.1); filter: drop-shadow(0 0 10px rgba(197, 160, 89, 0.8)); }
            100% { transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 0 rgba(197, 160, 89, 0)); }
        }

        /* Center Pin */
        .compass-center {
            position: absolute; width: 12px; height: 12px;
            background: #c5a059; border-radius: 50%;
            border: 2px solid #1a472a; z-index: 10;
        }

        /* Calibration Message */
        .calibration-msg {
            text-align: center; color: #fff; font-size: 12px;
            opacity: 0.7; margin-top: 10px; font-family: 'Tajawal', sans-serif;
            animation: fadeIn 1s infinite alternate;
        }

    </style>
</head>
<body class="designer-mode" onclick="handleGlobalClick(event)">

    <div id="startup-overlay" style="position:fixed; inset:0; background:#1a472a; z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition:opacity 0.5s;">
        <i class="fas fa-kaaba text-[#c5a059] text-6xl mb-4 animate-pulse"></i>
        <div class="text-white font-bold text-xl mt-4 font-serif">المصمم القرآني</div>
        <div class="text-white/80 text-xs font-serif mt-1">النسخة الذكية</div>
        <div class="text-[#c5a059] text-sm mt-4">جاري التحميل...</div>
    </div>

    <!-- Export Overlay -->
    <div id="export-overlay" style="display:none; position:fixed; inset:0; background:rgba(26,71,42,0.98); z-index:100000; flex-direction:column; justify-content:center; align-items:center;">
        <div class="text-[#c5a059] font-bold text-xl mb-2">جاري التصدير</div>
        <div class="text-white text-xs opacity-90 mb-4" id="export-status">يرجى الانتظار قليلاً...</div>
        <div class="progress-container"><div class="progress-bar" id="export-progress"></div></div>
        <div class="text-[#c5a059] text-[10px] mt-2 font-bold" id="progress-text">0%</div>
    </div>

    <!-- Save Modal -->
    <div id="save-modal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.95); z-index:100000; align-items:center; justify-content:center; flex-direction:column; padding:20px; backdrop-filter:blur(5px);">
        <div class="glass-panel p-6 rounded-2xl max-w-lg w-full flex flex-col items-center gap-4 border-none bg-white/10 mb-20">
            <div class="text-white font-bold text-lg">✨ تم إنشاء التصميم</div>
            <img id="save-img" alt="تصميم" class="rounded-xl shadow-2xl max-h-[50vh] w-auto border-4 border-white/20">
            <div class="flex gap-3 w-full">
                <button onclick="downloadImage()" class="flex-1 bg-[#c5a059] text-white py-3 rounded-xl font-bold shadow-lg">حفظ في الاستوديو</button>
                <button onclick="document.getElementById('save-modal').style.display='none'" class="flex-1 bg-white/10 text-white py-3 rounded-xl font-bold">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- ===== MODE 1: READER (SVG) ===== -->
    <div id="reader-view" class="view-section">
        
        <!-- Top Bar -->
        <div class="top-search-bar">
            <!-- 1. Quick Surah Select -->
            <div class="top-bar-section-1">
                <select id="quick-surah-picker" class="surah-quick-select" onchange="goToSurahStart(this.value)">
                    <option value="">السورة...</option>
                </select>
            </div>

            <!-- 2. Text Search -->
            <div class="top-bar-section-2">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="quran-search-input" class="search-input" placeholder="بحث آيات..." onkeyup="handleSearch(this.value)">
                    <div id="search-results"></div>
                </div>
            </div>

            <!-- 3. Tools -->
            <div class="top-bar-section-3">
                <button id="bookmark-btn" class="tool-btn" onclick="toggleBookmark()" title="حفظ العلامة"><i class="fas fa-bookmark"></i></button>
                <button id="btn-tafsir-toggle" class="tool-btn" onclick="toggleVerseSheet()" title="تفسير"><i class="fas fa-book-open-reader"></i></button>
                <button id="dark-mode-btn" class="tool-btn" onclick="toggleDarkMode()" title="ليلي"><i class="fas fa-moon" id="dark-mode-icon"></i></button>
            </div>
        </div>

        <!-- NEW: Immersive Gamified Progress Strip (Circles) -->
        <div id="immersive-progress-strip">
            <!-- Populated by JS -->
        </div>

        <div class="mushaf-page-frame">
             <div id="quran-slider-container"></div>
        </div>

        <!-- Page Info Bar (Moves to bottom in immersive) -->
        <div id="page-info-bar">
            <span id="juz-display">الجزء الأول</span>
            <span id="page-num-display">صفحة 1</span>
            <span id="surah-display">سورة الفاتحة</span>
        </div>

        <!-- Interaction Hint -->
        <div id="click-hint">اضغط لاختيار الآيات</div>

        <!-- Verse List Sheet -->
        <div id="verse-list-sheet" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" ontouchend="event.stopPropagation()">
            <div class="sheet-header" style="justify-content: center; position: relative;">
                <span class="font-bold text-[#1a472a]" id="sheet-title">اضغط على الآية للتفسير</span>
                <button onclick="closeVerseSheet()" class="text-red-500 font-bold px-3" style="position: absolute; left: 10px;">✕</button>
            </div>
            
            <div class="sheet-content" id="verse-list-content">
                <div class="text-center text-gray-400 py-10">جاري تحميل الآيات...</div>
            </div>
        </div>

        <!-- NEW: Ayah Options Modal (Tafsir / Audio) -->
        <div id="ayah-options-modal" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" ontouchend="event.stopPropagation()">
            <div class="ayah-options-card" onclick="event.stopPropagation()">
                <div class="ayah-info-header">
                    <div class="text-xs text-[#c5a059] font-bold mb-1" id="ayah-modal-subtitle">سورة البقرة - آية 1</div>
                    <!-- Audio Player View Header -->
                    <div id="audio-player-view">
                        <div class="reciter-name" id="current-reciter-name">علي الحذيفي</div>
                        <div class="player-controls">
                            <i class="fas fa-cog audio-settings-btn" onclick="toggleReciterMenu()"></i>
                            <div class="play-btn-large" onclick="togglePlayPause()">
                                <i class="fas fa-play" id="main-play-icon"></i>
                            </div>
                            <div style="width: 28px;"></div> <!-- Spacer for centering -->
                        </div>
                    </div>
                </div>

                <!-- Initial Options View -->
                <div class="ayah-options-grid" id="ayah-options-initial">
                    <div class="option-btn" onclick="openSelectedTafsir()">
                        <i class="fas fa-book-open option-icon"></i>
                        <span class="option-label">التفسير</span>
                    </div>
                    <div class="option-btn" onclick="switchToAudioMode()">
                        <i class="fas fa-volume-up option-icon"></i>
                        <span class="option-label">استماع</span>
                    </div>
                </div>

                <button onclick="closeAyahOptions()" class="absolute top-2 left-2 text-gray-400 hover:text-red-500 px-2 font-bold text-lg">✕</button>
                
                <!-- Reciter Selection Menu -->
                <div id="reciter-menu">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Tafsir Modal -->
        <div id="tafsir-modal" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" ontouchend="event.stopPropagation()">
            <div class="tafsir-card" onclick="event.stopPropagation()">
                <div class="tafsir-header">
                    <div class="tafsir-title-group">
                        <h3 class="text-white font-bold text-lg font-serif" id="tafsir-title">تفسير الجلالين</h3>
                        <i class="fas fa-cog tafsir-settings-btn" onclick="toggleTafsirMenu()"></i>
                    </div>
                    <button onclick="closeTafsir()" class="text-white hover:text-red-300 font-bold px-2 cursor-pointer p-2">✕</button>
                </div>
                
                <!-- Settings Dropdown -->
                <div id="tafsir-sources-menu">
                    <!-- Populated by JS -->
                </div>

                <div id="tafsir-content" class="flex-1 overflow-y-auto text-lg leading-loose text-justify p-5 font-serif text-gray-700"></div>
                <!-- Clean: Removed Design Button -->
            </div>
        </div>

        <!-- REMOVED: Navigation Zones to prevent accidental page flips on tap -->
        <!-- <div class="nav-zone nav-right"></div> -->
        <!-- <div class="nav-zone nav-left"></div> -->
    </div>

    <!-- ===== MODE 2: DESIGNER ===== -->
    <div id="designer-view" class="view-section active">
        <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            <!-- Sidebar -->
            <div class="lg:col-span-4 glass-panel p-5 rounded-3xl flex flex-col gap-5 h-fit relative z-50" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between border-b border-[#efe9d9] pb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-[#1a472a] rounded-xl flex items-center justify-center text-[#c5a059] shadow-lg"><i class="fas fa-quran text-2xl"></i></div>
                        <div><h1 class="font-bold text-[#1a472a] text-xl font-serif">المصمم القرآني</h1><p class="text-[11px] text-[#c5a059] font-bold">يهدي للتي هي أقوم</p></div>
                    </div>
                </div>
                <!-- Tools -->
                <div class="bg-[#fdfbf7] p-4 rounded-2xl border border-[#efe9d9] space-y-3">
                    <select id="surah-select" onchange="loadDesignerAyahs()" class="w-full p-2 bg-white border border-[#efe9d9] rounded-lg text-xs font-bold py-1 px-2 outline-none text-[#1a472a]"><option>اختر السورة...</option></select>
                    
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center gap-2 text-xs font-bold text-[#1a472a] cursor-pointer">
                            <input type="checkbox" id="range-toggle" onchange="toggleDesignerRangeMode()" class="accent-[#c5a059]">
                            <span>آيات متعددة</span>
                        </label>
                    </div>

                    <div class="flex gap-2">
                         <!-- From Ayah -->
                         <select id="ayah-select" class="flex-[3] p-2 bg-white border border-[#efe9d9] rounded-lg text-xs font-bold py-1 px-2 outline-none text-[#1a472a]"><option>الآية...</option></select>
                         
                         <!-- To Ayah (Hidden by default) -->
                         <select id="ayah-select-end" class="flex-[3] p-2 bg-white border border-[#efe9d9] rounded-lg text-xs font-bold py-1 px-2 outline-none text-[#1a472a] hidden"><option>إلى...</option></select>
                         
                         <button onclick="addAyah()" class="bg-[#1a472a] text-white px-4 rounded text-xs">إضافة</button>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <label class="btn-tool cursor-pointer col-span-2 flex-row justify-center gap-2 bg-[#1a472a] text-white"><i class="far fa-image text-white"></i> <span>خلفية</span><input type="file" onchange="addImageLayer(this)" class="hidden" accept="image/*"></label>
                    <label class="btn-tool cursor-pointer"><i class="fas fa-camera"></i> صورة<input type="file" onchange="addRegularImage(this)" class="hidden" accept="image/*"></label>
                    <button onclick="addExtraText()" class="btn-tool"><i class="fas fa-font"></i> نص</button>
                    <button onclick="addFrame()" class="btn-tool"><i class="far fa-square"></i> إطار</button>
                    <button onclick="toggleShapeMenu()" class="btn-tool relative"><i class="fas fa-shapes"></i> أشكال</button>
                    <button onclick="toggleSizeMenu()" class="btn-tool col-span-2 flex-row justify-center gap-2"><i class="fas fa-crop-alt"></i> مقاس <span id="size-label" class="text-[10px] text-gray-500 font-normal">Story</span></button>
                </div>

                <!-- Mobile Export Button -->
                <button onclick="exportCard()" class="fixed bottom-20 left-6 z-50 bg-[#c5a059] text-white w-16 h-16 rounded-full shadow-2xl flex flex-col items-center justify-center hover:scale-110 transition md:hidden border-4 border-white">
                    <i class="fas fa-save text-lg mb-0.5"></i>
                    <span class="text-[10px] font-bold leading-none">حفظ</span>
                </button>
                
                <!-- Desktop Export -->
                <button onclick="exportCard()" class="hidden md:flex bg-[#1a472a] text-white w-full py-4 rounded-xl shadow-lg font-bold text-lg hover:bg-[#143620] items-center justify-center gap-2 transition mt-auto">
                    <i class="fas fa-file-export text-[#c5a059]"></i> حفظ التصميم النهائي
                </button>

                <!-- Menus -->
                <div id="shape-menu-content" class="hidden bg-white p-3 rounded-xl border border-[#efe9d9] absolute top-full left-0 right-0 z-50 shadow-xl mt-2 flex gap-2 justify-center">
                    <button onclick="addShape('square')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-square text-[#1a472a]"></i> مربع</button>
                    <button onclick="addShape('circle')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-circle text-[#1a472a]"></i> دائرة</button>
                    <button onclick="addShape('triangle')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-play text-[#1a472a] -rotate-90"></i> مثلث</button>
                </div>
                <div id="size-menu-content" class="hidden bg-white p-3 rounded-xl border border-[#efe9d9] absolute top-full left-0 right-0 z-50 shadow-xl mt-2">
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setCardSize(378, 672, 'Story')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Story</button>
                        <button onclick="setCardSize(400, 400, 'Square')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Square</button>
                        <button onclick="setCardSize(378, 500, 'Post')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Post</button>
                    </div>
                </div>
            </div>
            <!-- Designer Canvas -->
            <div class="lg:col-span-8 flex flex-col gap-4">
                <div class="glass-panel p-3 rounded-2xl flex flex-wrap items-center justify-between gap-2 sticky top-2 z-30" onclick="event.stopPropagation()">
                    <div class="flex items-center gap-2 bg-[#fdfbf7] p-1 rounded-xl border border-[#efe9d9]">
                        <button onclick="undoAction()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-[#1a472a]"><i class="fas fa-undo"></i></button>
                        <button onclick="redoAction()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-[#1a472a]"><i class="fas fa-redo"></i></button>
                    </div>
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                        <button id="btn-grad" onclick="toggleGradient()" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a] flex items-center gap-2"><i class="fas fa-adjust text-[#c5a059]"></i> تدرج</button>
                        <button onclick="toggleBg()" id="btn-bg" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a]">شفافية</button>
                        <button id="btn-eraser" onclick="toggleEraserMode()" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a] flex items-center gap-2"><i class="fas fa-eraser text-[#c5a059]"></i> الممحاة</button>
                    </div>
                    <!-- Controls -->
                    <div id="grad-controls" class="controls-row"><span class="text-[10px] font-bold">اللون:</span><button onclick="setGradientColor('black')" class="w-6 h-6 rounded bg-black border border-gray-300"></button><button onclick="setGradientColor('white')" class="w-6 h-6 rounded bg-white border border-gray-300"></button><input type="range" min="0" max="1" step="0.1" value="0.8" oninput="setGradientOpacity(this.value)" class="w-20 accent-[#c5a059]"></div>
                    <div id="eraser-controls" class="controls-row"><span class="text-[10px] font-bold">حجم:</span><input type="range" min="5" max="100" value="30" oninput="updateEraserSize(this.value)" class="w-20 accent-[#1a472a]"><button id="btn-magic" onclick="toggleMagicMode()" class="px-2 py-1 rounded bg-white border border-[#efe9d9] text-[10px] font-bold flex items-center gap-1"><i class="fas fa-magic"></i> سحرية</button><div id="magic-tol-wrap" class="hidden items-center gap-1"><span class="text-[10px]">دقة:</span><input type="range" min="1" max="100" value="30" oninput="updateMagicTolerance(this.value)" class="w-16 accent-[#c5a059]"></div><button onclick="exitEraserMode()" class="bg-gray-200 px-3 py-1 rounded text-[10px] font-bold">إنهاء</button></div>
                    <div id="frame-controls" class="controls-row"><div class="flex items-center gap-2"><span class="text-[10px] font-bold">لون الحد:</span><input type="color" id="border-color" oninput="updateStyle('borderColor', this.value)" class="w-6 h-6 rounded border border-gray-300 cursor-pointer p-0"></div><div class="flex items-center gap-1"><span class="text-[10px] font-bold">سمك:</span><input type="range" id="border-width" min="0" max="20" value="2" oninput="updateStyle('borderWidth', this.value + 'px')" class="w-16 accent-[#c5a059]"></div><div class="flex items-center gap-2"><span class="text-[10px] font-bold">تعبئة:</span><input type="color" id="bg-color" oninput="updateStyle('backgroundColor', this.value)" class="w-6 h-6 rounded border border-gray-300 cursor-pointer p-0"></div><button onclick="deleteActive()" class="bg-red-50 text-red-600 px-2 py-1 rounded text-[10px] font-bold border border-red-100 flex items-center gap-1 hover:bg-red-100"><i class="fas fa-trash-alt text-xs"></i></button></div>
                    <div id="top-font-controls" class="controls-row justify-between"><div class="flex items-center gap-2 flex-1"><i class="fas fa-text-height text-[#c5a059]"></i><input type="range" id="top-font-size" min="10" max="150" value="35" oninput="updateStyle('fontSize', this.value + 'px')" class="w-full accent-[#1a472a]"></div><select id="top-font-family" onchange="updateStyle('fontFamily', this.value)" class="bg-white border border-[#efe9d9] rounded-lg text-xs font-bold py-1 px-2 outline-none text-[#1a472a] max-w-[100px]"><option value="'Amiri', serif">النسخ</option><option value="'Aref Ruqaa', serif">الرقعة</option><option value="'Cairo', sans-serif">كايرو</option></select></div>
                    <div id="quick-props" class="controls-row justify-center gap-4"><div class="flex items-center gap-2"><span class="text-[10px] font-bold">لون العنصر:</span><input type="color" id="quick-color" oninput="updateStyle('color', this.value)" class="w-8 h-8 rounded-full border-2 border-white shadow-sm overflow-hidden p-0 cursor-pointer"></div><button onclick="deleteActive()" class="bg-red-50 text-red-600 px-4 py-1 rounded-full text-xs font-bold border border-red-100 flex items-center gap-1 hover:bg-red-100"><i class="fas fa-trash-alt"></i> حذف</button></div>
                </div>
                <div class="preview-area shadow-inner bg-[#f4f4f4]" onclick="deselect(event)">
                    <div id="card" onclick="event.stopPropagation()">
                        <div id="card-gradient"></div><div id="snap-guide-v"></div><div id="snap-guide-h"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Bottom Nav (Fixed) -->
    <div class="tab-nav" id="bottom-nav">
        <!-- Reordered based on "Mshaf - Qibla - Designer" -->
        <button class="tab-btn" id="btn-reader" onclick="switchMode('reader')">
            <i class="fas fa-quran"></i>
            <span>المصحف</span>
        </button>
        <!-- UPDATED: Added ID for JS targeting -->
        <button class="tab-btn" id="btn-qibla" onclick="getQibla()">
            <i class="fas fa-kaaba"></i>
            <span>القبلة</span>
        </button>
        <button class="tab-btn active" id="btn-designer" onclick="switchMode('designer')">
            <i class="fas fa-palette"></i>
            <span>المصمم</span>
        </button>
    </div>

    <!-- Updated Qibla Direction Modal (Professional & Responsive) -->
    <div id="qibla-modal" style="display:none; position:fixed; inset:0; background:rgba(21, 40, 30, 0.98); z-index:100000; align-items:center; justify-content:center; flex-direction:column; padding:20px; backdrop-filter:blur(8px);">
        
        <div class="w-full max-w-sm flex flex-col items-center gap-6 animate-pulse" id="qibla-calibrating" style="display:none;">
            <i class="fas fa-compass fa-spin text-4xl text-[#c5a059]"></i>
            <p class="text-white text-sm">جاري معايرة البوصلة...</p>
        </div>

        <div id="qibla-content" class="w-full max-w-md flex flex-col items-center gap-8 relative">
            <!-- Header -->
            <div class="text-center">
                <h2 class="text-3xl font-bold text-[#c5a059] font-serif mb-1">اتجاه القبلة</h2>
                <p class="text-xs text-gray-400">حرّك الجوال حتى تشير الكعبة للأعلى</p>
            </div>

            <!-- Compass -->
            <div class="qibla-compass-container">
                <div class="qibla-compass-rim"></div>
                
                <!-- The Dial (Rotates with Phone Heading) -->
                <div class="compass-dial" id="compass-dial">
                    <!-- Cardinal Points -->
                    <div class="cardinal-point cp-n">ش</div>
                    <div class="cardinal-point cp-e">ق</div>
                    <div class="cardinal-point cp-s">ج</div>
                    <div class="cardinal-point cp-w">غ</div>

                    <!-- Needle with Kaaba (Points to Qibla relative to North) -->
                    <div class="qibla-needle-container" id="qibla-needle-container">
                        <div class="qibla-needle">
                            <i class="fas fa-kaaba kaaba-pointer"></i>
                        </div>
                    </div>
                </div>

                <!-- Center Pin -->
                <div class="compass-center"></div>
            </div>

            <!-- Info Box -->
            <div class="w-full bg-white/10 backdrop-blur-md p-5 rounded-2xl border border-white/5 text-center flex justify-between items-center">
                <div class="text-right">
                    <p class="text-[10px] text-gray-400">درجة القبلة</p>
                    <p class="text-xl font-bold text-[#c5a059]" id="qibla-degree">--°</p>
                </div>
                <div class="h-8 w-[1px] bg-white/10"></div>
                <div class="text-left">
                    <p class="text-[10px] text-gray-400">المسافة</p>
                    <p class="text-xl font-bold text-white" id="qibla-dist">-- كم</p>
                </div>
            </div>
            
            <p id="start-compass-btn" style="display:none;" class="text-center w-full">
                <button onclick="requestCompassPermission()" class="bg-[#c5a059] text-[#1a472a] font-bold py-2 px-6 rounded-full text-sm hover:scale-105 transition">تفعيل البوصلة</button>
            </p>

            <button onclick="stopQiblaTracking(); document.getElementById('qibla-modal').style.display='none'" class="mt-4 text-white/50 hover:text-white text-sm border-b border-transparent hover:border-white transition pb-1">إغلاق</button>
            
            <p class="calibration-msg">يرجى تحريك الهاتف على شكل ٨ للمعايرة</p>
        </div>
    </div>

    <script>
        // Updated to RAW GitHub to handle spaces correctly
        const SVG_BASE_URL = 'https://raw.githubusercontent.com/xzervzxs-wq/Sellam_bot/main/quran-svg-pages/';
        const TOTAL_PAGES = 604;
        
        let currentPage = parseInt(localStorage.getItem('lastPage')) || 1;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let idleTimeout;
        let selectedAyahData = null;
        let isImmersive = false;
        let isNavigating = false;
        let pageAyahsData = [];
        let searchTimeout;
        let allSurahs = []; 
        let currentDesignerSurahData = null;

        // --- QURAN PAGE COORDINATES (Interactive Verses) ---
        // Will be populated from external JSON
        let quranCoordinates = {};

        // Juz Names Array
        const JUZ_NAMES = [
            "الأول", "الثاني", "الثالث", "الرابع", "الخامس", "السادس", "السابع", "الثامن", "التاسع", "العاشر",
            "الحادي عشر", "الثاني عشر", "الثالث عشر", "الرابع عشر", "الخامس عشر", "السادس عشر", "السابع عشر", "الثامن عشر", "التاسع عشر", "العشرون",
            "الحادي والعشرون", "الثاني والعشرون", "الثالث والعشرون", "الرابع والعشرون", "الخامس والعشرون", "السادس والعشرون", "السابع والعشرون", "الثامن والعشرون", "التاسع والعشرون", "الثلاثون"
        ];

        // Tafsir Settings
        let currentTafsir = 'ar.jalalayn';
        const tafsirs = {
            'ar.jalalayn': { name: 'تفسير الجلالين', author: 'جلال الدين المحلي والسيوطي' },
            'ar.ibnkathir': { name: 'تفسير ابن كثير', author: 'الإمام ابن كثير' },
            'ar.muyassar': { name: 'أيسر التفاسير', author: 'أبو بكر الجزائري' }, 
            'ar.baghawi': { name: 'فتح القدير', author: 'محمد بن علي الشوكاني' } 
        };

        // --- Audio Settings ---
        // تم تغيير الافتراضي للعفاسي لضمان العمل، وتم تصحيح معرفات السديس والشريم
        let currentReciter = 'ar.alafasy';
        let audioPlayer = new Audio();
        let isAudioPlaying = false;
        // Promise variable to track play requests
        let playPromise = undefined;
        
        const reciters = {
            'ar.alhudhaify': 'علي الحذيفي',
            'ar.abdurrahmaansudais': 'عبد الرحمن السديس', // تم التصحيح
            'ar.saoodshuraym': 'سعود الشريم', // تم التصحيح
            'ar.minshawi': 'محمد صديق المنشاوي',
            'ar.alafasy': 'مشاري العفاسي',
            'ar.ahmedajamy': 'أحمد بن علي العجمي'
        };

        window.onload = async () => {
            applyTheme();
            setupGestures();
            initProgressStrip(); // Initialize Juz circles

            // 1. Fetch Coordinates from External JSON
            // Added timestamp to prevent caching issues so updates appear instantly
            try {
                const coordRes = await fetch('https://raw.githubusercontent.com/xzervzxs-wq/Sellam_bot/main/ayat_map?v=' + Date.now());
                if (coordRes.ok) {
                    quranCoordinates = await coordRes.json();
                    console.log("Coordinates loaded successfully");
                } else {
                    console.error("Failed to load coordinates");
                }
            } catch (e) {
                console.error("Error fetching coordinates:", e);
            }

            // 2. Load Page (After coordinates are ready)
            loadPage(currentPage);

            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                allSurahs = data.data; 
                
                const quickSel = document.getElementById('quick-surah-picker');
                const designerSel = document.getElementById('surah-select');
                
                let options = '<option value="">السورة...</option>';
                data.data.forEach(s => {
                    options += `<option value="${s.number}">${s.number}. ${s.name}</option>`;
                });
                
                if (quickSel) quickSel.innerHTML = options;
                if (designerSel) designerSel.innerHTML = options;
                
                checkBookmark();
                renderTafsirMenu();
                renderReciterMenu(); // Init reciter menu
                resizeCardToFit();

            } catch(e){}
            setTimeout(() => document.getElementById('startup-overlay').remove(), 800);
        };

        function initProgressStrip() {
            const container = document.getElementById('immersive-progress-strip');
            let html = '';
            for (let i = 1; i <= 30; i++) {
                html += `
                    <div class="juz-circle-container" id="juz-item-${i}">
                        <div class="juz-circle" data-juz="${i}">${i}</div>
                        ${i < 30 ? '<div class="juz-line"></div>' : ''}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function removeTashkeel(text) {
            return text.replace(/[\u064B-\u065F\u0670]/g, ""); 
        }

        function handleSearch(query) {
            clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('search-results');
            if (!query || query.length < 2) { 
                resultsDiv.style.display = 'none';
                return;
            }
            
            const cleanQuery = removeTashkeel(query).trim();

            searchTimeout = setTimeout(async () => {
                let htmlResults = '';

                const matchedSurahs = allSurahs.filter(s => removeTashkeel(s.name).includes(cleanQuery));
                if (matchedSurahs.length > 0) {
                    htmlResults += matchedSurahs.map(s => `
                        <div class="search-result-item search-header-result" onclick="goToSurahStart(${s.number})">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-book-open text-green-700"></i>
                                <div class="search-result-text font-bold text-green-900">${s.name}</div>
                            </div>
                            <div class="search-result-info">سورة كاملة</div>
                        </div>
                    `).join('');
                }

                try {
                    const res = await fetch(`https://api.alquran.cloud/v1/search/${cleanQuery}/all/quran-simple-clean`);
                    const data = await res.json();
                    
                    if (data.data && data.data.matches && data.data.matches.length > 0) {
                        const matches = data.data.matches.slice(0, 30); 
                        htmlResults += matches.map(match => `
                            <div class="search-result-item" onclick="goToSearchPage(${match.surah.number}, ${match.numberInSurah})">
                                <div>
                                    <div class="search-result-text">${match.text.substring(0, 50)}...</div>
                                    <div class="search-result-info">سورة ${match.surah.name} - الآية ${match.numberInSurah}</div>
                                </div>
                                <i class="fas fa-chevron-left text-gray-300"></i>
                            </div>
                        `).join('');
                    } 
                } catch (e) { console.error("API Search error", e); }

                if (htmlResults.length > 0) {
                    resultsDiv.innerHTML = htmlResults;
                    resultsDiv.style.display = 'flex';
                } else {
                    resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-500">لا توجد نتائج</div>';
                    resultsDiv.style.display = 'flex';
                }

            }, 500);
        }
        
        async function goToSurahStart(surahNumber) {
            if(!surahNumber) return;
             goToSearchPage(surahNumber, 1);
        }

        async function goToSearchPage(surahNum, ayahNum) {
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surahNum}:${ayahNum}/quran-uthmani`); 
                const data = await res.json();
                const page = data.data.page;
                
                document.getElementById('search-results').style.display = 'none';
                document.getElementById('quran-search-input').value = '';
                
                switchMode('reader');
                loadPage(page);
            } catch(e) { alert("جاري الانتقال..."); }
        }
        
        function toggleBookmark() {
            const savedBookmark = localStorage.getItem('bookmark');
            if (savedBookmark == currentPage) {
                localStorage.removeItem('bookmark');
            } else {
                localStorage.setItem('bookmark', currentPage);
            }
            checkBookmark();
        }

        function checkBookmark() {
            const savedBookmark = localStorage.getItem('bookmark');
            const btn = document.getElementById('bookmark-btn');
            if(btn) {
                if (savedBookmark == currentPage) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        async function loadPage(num, direction = 'none') {
            if(isNavigating) return;
            if(num < 1) num = 1; if(num > TOTAL_PAGES) num = TOTAL_PAGES;
            
            const container = document.getElementById('quran-slider-container');
            const paddedNum = String(num).padStart(3, '0');
            const url = `${SVG_BASE_URL}${paddedNum}.svg`;

            isNavigating = true;

            const slide = document.createElement('div');
            slide.className = 'quran-page-slide';
            
            // --- UPDATED LOADING LOGIC FOR INTERACTIVE PAGES ---
            if (quranCoordinates[paddedNum]) {
                // If this page has coordinates, we fetch the SVG code and inject it INLINE
                try {
                    const response = await fetch(url);
                    const svgText = await response.text();
                    slide.innerHTML = svgText;
                    
                    // Fix SVG attributes to be responsive
                    const svgElement = slide.querySelector('svg');
                    if (svgElement) {
                        svgElement.setAttribute('width', '100%');
                        svgElement.setAttribute('height', '100%');
                        svgElement.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                    }

                    // Apply interaction logic for this page
                    enableInlineInteractions(paddedNum, slide);

                } catch (e) {
                    // Fallback if fetch fails
                    handleImageError({style:{}}, num, slide); 
                }
            } else {
                // Normal loading (Image tag) for pages without coordinates
                slide.innerHTML = `<img src="${url}" draggable="false" alt="صفحة ${num}" onload="this.classList.add('loaded')" onerror="handleImageError(this, ${num})">`;
            }

            if(direction === 'next') slide.style.transform = 'translateX(-100%)';
            else if(direction === 'prev') slide.style.transform = 'translateX(100%)';
            else slide.style.transform = 'translateX(0)';

            container.appendChild(slide);
            void slide.offsetWidth; 

            const oldSlide = container.firstElementChild;
            if (direction !== 'none' && oldSlide && oldSlide !== slide) {
                slide.style.transform = 'translateX(0)';
                if (direction === 'next') oldSlide.style.transform = 'translateX(100%)';
                else oldSlide.style.transform = 'translateX(-100%)';
                setTimeout(() => { if(oldSlide) oldSlide.remove(); isNavigating = false; }, 200);
            } else {
                if(oldSlide && oldSlide !== slide) oldSlide.remove();
                isNavigating = false;
            }

            currentPage = num;
            localStorage.setItem('lastPage', currentPage); 
            checkBookmark(); 
            fetchPageData(num);
            preloadPage(num + 1);
            preloadPage(num - 1);
        }

        // --- NEW FUNCTION: Enable interactions on Inline SVG ---
        function enableInlineInteractions(paddedNum, container) {
            const mappings = quranCoordinates[paddedNum];
            if (!mappings) return;

            Object.keys(mappings).forEach(pathId => {
                const element = container.querySelector(`#${pathId}`);
                if (element) {
                    element.classList.add('interactive-path');
                    
                    // Add Click Handler
                    element.addEventListener('click', (e) => {
                        // FIX: If we were swiping, do not trigger click
                        if(isDraggingGesture) return; 

                        e.stopPropagation(); // Stop global click events (like hiding menus)
                        
                        const data = mappings[pathId];
                        // Find the text for this ayah from the loaded page data
                        let ayahText = '...';
                        let surahName = '...';
                        if (pageAyahsData) {
                            const ayahObj = pageAyahsData.find(a => a.surah.number === data.surah && a.numberInSurah === data.ayah);
                            if (ayahObj) {
                                ayahText = ayahObj.text.replace(/'/g, "\\'");
                                surahName = ayahObj.surah.name;
                            }
                        }
                        
                        // NEW: Open Action Menu instead of direct Tafsir
                        showAyahOptions(data.surah, data.ayah, surahName, ayahText);
                    });

                    // Add Touch Start (for better mobile response)
                    element.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); // Prevent immersive toggle
                    }, {passive: false});
                }
            });
        }

        // --- NEW: Ayah Options & Audio Functions ---
        function showAyahOptions(surah, ayah, surahName, text) {
            // Save selection
            selectedAyahData = { surahNum: surah, ayahNum: ayah, text: text, surahName: surahName };
            
            // UI Reset
            document.getElementById('ayah-modal-subtitle').innerText = `${surahName} - آية ${ayah}`;
            document.getElementById('ayah-options-initial').style.display = 'grid';
            document.getElementById('audio-player-view').style.display = 'none';
            document.getElementById('reciter-menu').style.display = 'none';
            
            // Stop any playing audio
            audioPlayer.pause();
            isAudioPlaying = false;
            updatePlayIcon();

            const modal = document.getElementById('ayah-options-modal');
            modal.style.display = 'flex';
        }

        function closeAyahOptions() {
            document.getElementById('ayah-options-modal').style.display = 'none';
            
            // Safe pause logic
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    audioPlayer.pause();
                }).catch(e => {});
            } else {
                audioPlayer.pause();
            }
            isAudioPlaying = false; // Reset state
        }

        function openSelectedTafsir() {
            closeAyahOptions();
            // Open normal Tafsir
            selectVerseForTafsir(0, selectedAyahData.surahNum, selectedAyahData.ayahNum, selectedAyahData.text);
        }

        function switchToAudioMode() {
            document.getElementById('ayah-options-initial').style.display = 'none';
            document.getElementById('audio-player-view').style.display = 'flex';
            
            // Update Reciter Name Display
            document.getElementById('current-reciter-name').innerText = reciters[currentReciter];
            
            playAudio();
        }

        function togglePlayPause() {
            if (isAudioPlaying) {
                // Safe Pause
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        audioPlayer.pause();
                        isAudioPlaying = false;
                        updatePlayIcon();
                    })
                    .catch(error => {
                        // Play was prevented, so we don't need to pause really, but let's reset state
                        isAudioPlaying = false;
                        updatePlayIcon();
                    });
                } else {
                    audioPlayer.pause();
                    isAudioPlaying = false;
                    updatePlayIcon();
                }
            } else {
                // Play
                playPromise = audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        isAudioPlaying = true;
                        updatePlayIcon();
                    })
                    .catch(error => {
                        console.error(error);
                        isAudioPlaying = false;
                        updatePlayIcon();
                    });
                }
            }
        }

        function updatePlayIcon() {
            const icon = document.getElementById('main-play-icon');
            icon.className = isAudioPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        async function playAudio() {
            if(!selectedAyahData) return;
            
            // Construct URL
            // Using Al Quran Cloud API directly provides MP3
            const surah = selectedAyahData.surahNum;
            const ayah = selectedAyahData.ayahNum;
            const edition = currentReciter;
            
            // Show loading state if needed (simple icon change)
            const icon = document.getElementById('main-play-icon');
            icon.className = 'fas fa-spinner fa-spin';

            try {
                // Fetch direct audio URL
                // Format: http://api.alquran.cloud/v1/ayah/{surah}:{ayah}/{edition}
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/${edition}`);
                const data = await res.json();
                
                if(data.data && data.data.audio) {
                    audioPlayer.src = data.data.audio;
                    
                    // Safe Play Logic
                    playPromise = audioPlayer.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            // Automatic playback started!
                            isAudioPlaying = true;
                            updatePlayIcon();
                        })
                        .catch(error => {
                            if (error.name === 'AbortError') {
                                console.log('Playback interrupted (AbortError)');
                            } else {
                                console.error('Playback failed', error);
                                isAudioPlaying = false;
                                updatePlayIcon();
                            }
                        });
                    }
                    
                    audioPlayer.onended = () => {
                        isAudioPlaying = false;
                        updatePlayIcon();
                    };
                } else {
                    alert('عذراً، التلاوة غير متوفرة لهذا القارئ حالياً');
                    updatePlayIcon();
                }
            } catch(e) {
                console.error(e);
                alert('خطأ في تشغيل الصوت');
                updatePlayIcon();
            }
        }

        function renderReciterMenu() {
            const menu = document.getElementById('reciter-menu');
            menu.innerHTML = Object.keys(reciters).map(key => `
                <div class="tafsir-source-item ${key === currentReciter ? 'active' : ''}" onclick="changeReciter('${key}')">
                    <span class="ts-name">${reciters[key]}</span>
                </div>
            `).join('');
        }

        function toggleReciterMenu() {
            const menu = document.getElementById('reciter-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function changeReciter(key) {
            currentReciter = key;
            document.getElementById('current-reciter-name').innerText = reciters[key];
            toggleReciterMenu();
            renderReciterMenu(); // re-render to update active class
            
            // If playing, restart with new reciter
            if(document.getElementById('audio-player-view').style.display === 'flex') {
                playAudio();
            }
        }

        // --- SMART FALLBACK HANDLER ---
        function handleImageError(img, num, slideElement = null) {
            const padded = String(num).padStart(3, '0');
            
            // Check if it's the inline fallback
            if(slideElement) {
                 // Inline fetch failed, try adding image manually
                 slideElement.innerHTML = `<img src="${SVG_BASE_URL}${padded}.svg" draggable="false" alt="صفحة ${num}" onload="this.classList.add('loaded')" onerror="handleImageError(this, ${num})">`;
                 return;
            }

            // Check what failed
            if (img.src.includes(SVG_BASE_URL)) {
                // It was the SVG source.
                if (img.src.includes(padded + '.svg')) {
                    // Try unpadded SVG
                    img.src = `${SVG_BASE_URL}${num}.svg`;
                } else {
                    // Unpadded SVG failed too. Switch to PNG fallback.
                    console.warn(`SVG failed for page ${num}, switching to PNG fallback.`);
                    img.src = `https://surahquran.com/img/pages-quran/page${padded}.png`;
                }
            } else {
                // The PNG fallback failed too?
                console.error("All image sources failed for page", num);
                img.style.display = 'none'; // Hide broken image icon
                const errDiv = document.createElement('div');
                errDiv.className = 'absolute inset-0 flex items-center justify-center text-red-500 font-bold';
                errDiv.innerText = 'خطأ في تحميل الصفحة';
                if(!img.parentElement.querySelector('.text-red-500')) {
                    img.parentElement.appendChild(errDiv);
                }
            }
        }

        function preloadPage(num) {
            if(num < 1 || num > TOTAL_PAGES) return;
            const padded = String(num).padStart(3, '0');
            const img = new Image();
            img.src = `${SVG_BASE_URL}${padded}.svg`;
        }

        async function fetchPageData(num) {
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/page/${num}/quran-uthmani`);
                const data = await res.json();
                pageAyahsData = data.data.ayahs;
                
                // Update Page Info Bar
                if(pageAyahsData && pageAyahsData.length > 0) {
                    const firstAyah = pageAyahsData[0];
                    // FIX: Removed 'سورة ' prefix to avoid duplication
                    document.getElementById('surah-display').innerText = firstAyah.surah.name;
                    
                    // Display Juz as Text
                    const juzIndex = firstAyah.juz - 1;
                    const juzText = JUZ_NAMES[juzIndex] || firstAyah.juz;
                    document.getElementById('juz-display').innerText = 'الجزء ' + juzText;
                    
                    document.getElementById('page-num-display').innerText = 'صفحة ' + num;
                    
                    updateProgressBar(firstAyah.juz);
                }
            } catch(e) {}
        }
        
        function updateProgressBar(currentJuz) {
            const strip = document.getElementById('immersive-progress-strip');
            if(!strip) return;
            
            let activeContainer = null;

            // Loop through all circles
            for(let i = 1; i <= 30; i++) {
                const circleContainer = document.getElementById(`juz-item-${i}`);
                if(!circleContainer) continue;
                
                const circle = circleContainer.querySelector('.juz-circle');
                const line = circleContainer.querySelector('.juz-line');
                
                // Reset classes
                circle.classList.remove('completed', 'active');
                if(line) line.classList.remove('filled');
                
                if (i < currentJuz) {
                    circle.classList.add('completed');
                    if(line) line.classList.add('filled');
                } else if (i === currentJuz) {
                    circle.classList.add('active');
                    activeContainer = circleContainer;
                }
            }

            // Scroll Logic to center the active Juz
            if(activeContainer) {
                // Calculate position to center the active item
                // offsetLeft is relative to the scrolling container since it's flex
                // We want: center of item = center of visible strip
                const centerPos = activeContainer.offsetLeft - (strip.clientWidth / 2) + (activeContainer.offsetWidth / 2);
                
                // Execute scroll immediately so it's ready when shown
                strip.scrollTo({
                    left: centerPos,
                    behavior: 'smooth'
                });
            }
        }

        function convertToArabicNums(num) {
            const arabicNums = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
            return num.toString().split('').map(d => arabicNums[d]).join('');
        }

        function nextPage() { if(currentPage < TOTAL_PAGES) loadPage(currentPage + 1, 'next'); }
        function prevPage() { if(currentPage > 1) loadPage(currentPage - 1, 'prev'); }

        // --- UPDATED QIBLA COMPASS LOGIC ---
        let qiblaTracker = { lat: 0, lon: 0, qiblaDir: 0 };
        let deviceOrientationHandler = null;

        function getQibla() {
            // UI Updates: Highlight Qibla Tab
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-qibla').classList.add('active');

            document.getElementById('qibla-modal').style.display = 'flex';
            document.getElementById('qibla-calibrating').style.display = 'flex';
            document.getElementById('qibla-content').style.display = 'none';

            if(!navigator.geolocation) {
                alert('المتصفح لا يدعم تحديد الموقع');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    qiblaTracker.lat = latitude;
                    qiblaTracker.lon = longitude;
                    qiblaTracker.qiblaDir = calculateQibla(latitude, longitude);
                    
                    document.getElementById('qibla-degree').textContent = Math.round(qiblaTracker.qiblaDir) + '°';
                    document.getElementById('qibla-dist').textContent = calculateDistance(latitude, longitude).toFixed(0) + ' كم';
                    
                    document.getElementById('qibla-calibrating').style.display = 'none';
                    document.getElementById('qibla-content').style.display = 'flex';
                    
                    initQiblaTracking();
                },
                (error) => {
                    alert('يرجى السماح بتحديد الموقع لمعرفة اتجاه القبلة');
                    document.getElementById('qibla-modal').style.display = 'none';
                }
            );
        }

        function calculateDistance(lat1, lon1) {
            const kaabaLat = 21.422487;
            const kaabaLon = 39.826206;
            const R = 6371; // km
            const dLat = (kaabaLat - lat1) * Math.PI / 180;
            const dLon = (kaabaLon - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(kaabaLat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function initQiblaTracking() {
            // Check if iOS (requires permission)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                 document.getElementById('start-compass-btn').style.display = 'block';
            } else {
                 document.getElementById('start-compass-btn').style.display = 'none';
                 startCompassListener();
            }
        }
        
        function requestCompassPermission() {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        document.getElementById('start-compass-btn').style.display = 'none';
                        startCompassListener();
                    } else {
                        alert('تم رفض إذن البوصلة');
                    }
                })
                .catch(console.error);
        }

        function startCompassListener() {
             deviceOrientationHandler = (event) => {
                let heading = 0;
                
                // iOS Webkit
                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading;
                } 
                // Android / Non-Webkit (absolute)
                else if (event.alpha !== null) {
                   heading = 360 - event.alpha;
                }

                // Smooth rotation of the Compass Dial (North stays North)
                // If phone rotates right (heading increases), Dial must rotate left (negative)
                const dial = document.getElementById('compass-dial');
                dial.style.transform = `rotate(${-heading}deg)`;
                
                // The Qibla Needle is inside the Dial.
                // It just needs to point to the Qibla Angle relative to North (0 on the dial).
                // Since the Dial is already rotating to match North, we just set the needle to Qibla Angle.
                const needle = document.getElementById('qibla-needle-container');
                needle.style.transform = `rotate(${qiblaTracker.qiblaDir}deg)`;
            };
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', deviceOrientationHandler, true);
            }
        }

        function stopQiblaTracking() {
            if(deviceOrientationHandler) {
                window.removeEventListener('deviceorientation', deviceOrientationHandler, true);
                deviceOrientationHandler = null;
            }
        }

        function calculateQibla(lat, lon) {
            const kaabLat = 21.4225;
            const kaabLon = 39.8262;
            
            const latRad = lat * Math.PI / 180;
            const kaabLatRad = kaabLat * Math.PI / 180;
            const lonDiffRad = (kaabLon - lon) * Math.PI / 180;
            
            const y = Math.sin(lonDiffRad);
            const x = Math.cos(latRad) * Math.tan(kaabLatRad) - Math.sin(latRad) * Math.cos(lonDiffRad);
            
            let angle = Math.atan2(y, x) * 180 / Math.PI;
            return (angle + 360) % 360;
        }

        // Global Flag to Block Clicks during Swipe
        let isDraggingGesture = false;

        function setupGestures() {
            const reader = document.getElementById('reader-view');
            const container = document.getElementById('quran-slider-container');
            let startX = 0;
            let currentX = 0;
            let startY = 0;
            let isDragging = false;
            let pressTimer;
            let lastTap = 0; // متغير لحساب وقت النقر المزدوج

            // Touch Start
            reader.addEventListener('touchstart', e => {
                // Ignore touches on UI elements
                if(e.target.closest('#verse-list-sheet') || e.target.closest('#tafsir-modal') || e.target.closest('#ayah-options-modal') || e.target.closest('.tab-nav') || e.target.closest('.top-search-bar')) return;
                
                // Stop any current transition immediately
                const currentSlide = container.querySelector('.quran-page-slide');
                if(currentSlide) {
                    currentSlide.style.transition = 'none';
                }

                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                currentX = startX;
                isDragging = false;
                isDraggingGesture = false; 

                // Long press logic (for menu/hint)
                pressTimer = setTimeout(() => { 
                    if(!isImmersive && !isDragging) { openVerseSheet(); showHint(); } 
                }, 500);
            }, {passive: false});

            // Touch Move
            reader.addEventListener('touchmove', e => {
                 if(e.target.closest('#verse-list-sheet') || e.target.closest('#tafsir-modal') || e.target.closest('#ayah-options-modal') || e.target.closest('.tab-nav') || e.target.closest('.top-search-bar')) return;

                const x = e.touches[0].clientX;
                const y = e.touches[0].clientY;
                const deltaX = x - startX;
                const deltaY = y - startY;

                // Determine if scrolling horizontal (Drag detection)
                if (!isDragging) {
                    // Threshold adjusted to 20px (balanced feel)
                    if (Math.abs(deltaX) > 20 && Math.abs(deltaX) > Math.abs(deltaY)) {
                        isDragging = true;
                        isDraggingGesture = true; // Block clicks
                        clearTimeout(pressTimer); // Cancel long press
                    }
                }

                // If Dragging, Move the Slide Visually
                if (isDragging) {
                    e.preventDefault(); // Stop vertical scroll/zoom
                    currentX = x;
                    const currentSlide = container.querySelector('.quran-page-slide');
                    if(currentSlide) {
                        currentSlide.style.transform = `translateX(${deltaX}px)`;
                    }
                }
            }, {passive: false});

            // Touch End
            reader.addEventListener('touchend', e => {
                if(e.target.closest('#verse-list-sheet') || e.target.closest('#tafsir-modal') || e.target.closest('#ayah-options-modal') || e.target.closest('.tab-nav') || e.target.closest('.top-search-bar')) return;
                
                clearTimeout(pressTimer);
                
                const currentSlide = container.querySelector('.quran-page-slide');
                // Re-enable transition for smooth snap back or exit
                if(currentSlide) currentSlide.style.transition = 'transform 0.3s ease-out';

                const diff = currentX - startX;
                const threshold = window.innerWidth * 0.25; // Adjusted to 25% for easier page flip

                if (isDragging) {
                    // --- Logic for Swipe ---
                    if (Math.abs(diff) > threshold) {
                        if (diff > 0) nextPage(); 
                        else prevPage();
                    } else {
                        // Snap back if threshold not met
                        if(currentSlide) currentSlide.style.transform = 'translateX(0)';
                    }
                } else {
                    // --- Logic for Tap (Double Tap) ---
                    const now = new Date().getTime();
                    const timeDiff = now - lastTap;
                    
                    // إذا كان الفرق بين النقرتين أقل من 300 ملي ثانية ولم يكن هناك سحب
                    if (timeDiff < 300 && timeDiff > 0) {
                        toggleImmersiveMode();
                    }
                    
                    lastTap = now;
                }

                isDragging = false;
                setTimeout(() => { isDraggingGesture = false; }, 50);
            });
            
            // REMOVED: Click listeners for nav zones as they are removed
            // document.querySelector('.nav-right').onclick = () => !isImmersive && prevPage();
            // document.querySelector('.nav-left').onclick = () => !isImmersive && nextPage();
        }

        function showHint() {
            const hint = document.getElementById('click-hint');
            hint.style.opacity = '1';
            setTimeout(() => hint.style.opacity = '0', 1000);
        }

        function toggleImmersiveMode() {
            isImmersive = !isImmersive;
            document.body.classList.toggle('immersive-mode', isImmersive);
        }

        function toggleVerseSheet() {
            const sheet = document.getElementById('verse-list-sheet');
            if (sheet.classList.contains('active')) {
                closeVerseSheet();
            } else {
                openVerseSheet();
            }
        }

        function openVerseSheet() {
            const sheet = document.getElementById('verse-list-sheet');
            const list = document.getElementById('verse-list-content');
            document.getElementById('btn-tafsir-toggle').classList.add('active');
            
            if(pageAyahsData.length > 0) {
                list.innerHTML = pageAyahsData.map((ayah, index) => `
                    <div class="verse-item" onclick="selectVerseForTafsir(${ayah.number}, ${ayah.surah.number}, ${ayah.numberInSurah}, '${ayah.text.replace(/'/g, "\\'")}', this)">
                        <span class="text-[#c5a059] ml-2 text-sm">(${ayah.numberInSurah})</span> ${ayah.text}
                    </div>
                `).join('');
            } else { list.innerHTML = '<div class="text-center py-4">جاري تحميل الآيات...</div>'; }
            sheet.classList.add('active');
        }

        function closeVerseSheet() { 
            document.getElementById('verse-list-sheet').classList.remove('active'); 
            document.getElementById('btn-tafsir-toggle').classList.remove('active');
        }

        async function selectVerseForTafsir(globalNum, surahNum, ayahNum, text) {
            selectedAyahData = { text, surahNum, ayahNum };
            closeVerseSheet();
            const modal = document.getElementById('tafsir-modal');
            modal.style.display = 'flex';
            document.getElementById('tafsir-content').innerText = 'جاري جلب التفسير...';
            renderTafsirMenu();
            document.getElementById('tafsir-title').innerText = tafsirs[currentTafsir].name;
            fetchTafsirContent();
        }
        
        async function fetchTafsirContent() {
             if (!selectedAyahData) return;
             const { surahNum, ayahNum } = selectedAyahData;
             document.getElementById('tafsir-content').innerText = 'جاري جلب التفسير...';
             
             try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surahNum}:${ayahNum}/${currentTafsir}`);
                const data = await res.json();
                document.getElementById('tafsir-content').innerHTML = `
                    <div class="font-bold text-[#c5a059] mb-2 text-center">سورة ${data.data.surah.name} - آية ${ayahNum}</div>
                    <div class="text-justify leading-loose">${data.data.text}</div>
                `;
            } catch(e) { document.getElementById('tafsir-content').innerText = 'خطأ في التحميل أو المصدر غير متوفر'; }
        }
        
        function renderTafsirMenu() {
            const menu = document.getElementById('tafsir-sources-menu');
            menu.innerHTML = Object.keys(tafsirs).map(key => `
                <div class="tafsir-source-item ${key === currentTafsir ? 'active' : ''}" onclick="changeTafsir('${key}')">
                    <span class="ts-name">${tafsirs[key].name}</span>
                    <span class="ts-author">${tafsirs[key].author}</span>
                </div>
            `).join('');
        }

        function toggleTafsirMenu() {
            const menu = document.getElementById('tafsir-sources-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        function changeTafsir(key) {
            currentTafsir = key;
            document.getElementById('tafsir-title').innerText = tafsirs[key].name;
            toggleTafsirMenu(); renderTafsirMenu(); fetchTafsirContent(); 
        }

        function closeTafsir() { 
            document.getElementById('tafsir-modal').style.display = 'none'; 
            document.getElementById('tafsir-sources-menu').style.display = 'none';
        }
        
        function designFromReader() {
            if(!selectedAyahData) return;
            closeTafsir(); switchMode('designer');
            setTimeout(() => { addTextToCanvas(selectedAyahData.text + (selectedAyahData.text.includes('﴿') ? '' : ` ﴿${selectedAyahData.ayahNum}﴾`), true); }, 500);
        }

        function switchMode(mode) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            
            const body = document.body;
            
            if(mode === 'reader'){
                document.getElementById('reader-view').classList.add('active');
                document.getElementById('btn-reader').classList.add('active'); 
                if(localStorage.getItem('darkMode') === 'true') body.classList.add('dark-mode');
                body.classList.remove('designer-mode');
                body.classList.add('reader-mode');
            } else {
                document.getElementById('designer-view').classList.add('active');
                document.getElementById('btn-designer').classList.add('active'); 
                body.classList.remove('dark-mode'); 
                body.classList.remove('reader-mode');
                body.classList.add('designer-mode');
                resizeCardToFit();
            }

            // ADDED: Close Qibla modal if open when switching modes
            const qiblaModal = document.getElementById('qibla-modal');
            if (qiblaModal && qiblaModal.style.display !== 'none') {
                qiblaModal.style.display = 'none';
                stopQiblaTracking();
            }
        }

        function toggleDarkMode() { 
            if(!document.getElementById('reader-view').classList.contains('active')) {
                alert("الوضع الليلي متاح فقط في المصحف");
                return;
            }
            isDarkMode = !isDarkMode; 
            localStorage.setItem('darkMode', isDarkMode); 
            applyTheme();
        }
        
        function applyTheme() {
            const icon = document.getElementById('dark-mode-icon');
            const isReader = document.getElementById('reader-view').classList.contains('active');
            
            if(isDarkMode && isReader){ 
                document.body.classList.add('dark-mode'); 
                icon.className='fas fa-sun'; 
            } else { 
                document.body.classList.remove('dark-mode'); 
                icon.className='fas fa-moon'; 
            }
        }
        
        function handleGlobalClick(e) {
            if(!e.target.closest('.tafsir-settings-btn') && !e.target.closest('#tafsir-sources-menu')) {
                document.getElementById('tafsir-sources-menu').style.display = 'none';
            }
            if(!e.target.closest('.audio-settings-btn') && !e.target.closest('#reciter-menu')) {
                document.getElementById('reciter-menu').style.display = 'none';
            }
            if(!e.target.closest('#verse-list-sheet') && !e.target.closest('.quran-page-slide') && !e.target.closest('#tafsir-modal') && !e.target.closest('#ayah-options-modal') && !e.target.closest('.tab-nav') && !e.target.closest('.top-search-bar')) {
               // click outside logic
            }
            deselect(e);
        }

        // --- FULL DESIGNER LOGIC ---
        let activeEl, undoStack=[], redoStack=[];
        let isTransparent = false; let hasGradient = false; let eraserMode = false; let magicMode = false; let eraserSize = 30; let magicTolerance = 30; let eraserCanvas = null;

        function saveState() { const card = document.getElementById('card'); undoStack.push(card.innerHTML); if (undoStack.length > 20) undoStack.shift(); redoStack = []; }
        function undoAction() { if (undoStack.length === 0) return; const card = document.getElementById('card'); redoStack.push(card.innerHTML); card.innerHTML = undoStack.pop(); rebindEvents(); deselect(); }
        function redoAction() { if (redoStack.length === 0) return; const card = document.getElementById('card'); undoStack.push(card.innerHTML); card.innerHTML = redoStack.pop(); rebindEvents(); deselect(); }
        function rebindEvents() { document.querySelectorAll('.draggable-el').forEach(el => { el.removeAttribute('data-events-bound'); setupInteract(el); }); }
        function resizeCardToFit() { const container = document.querySelector('.preview-area'); const card = document.getElementById('card'); if(!container || !card) return; card.style.transform = 'none'; const scale = Math.min((container.clientWidth-40)/card.offsetWidth, (container.clientHeight-40)/card.offsetHeight); if(scale<1) card.style.transform = `scale(${scale})`; }
        function createWrapper(type) { const div = document.createElement('div'); div.className = `draggable-el ${type} selected`; div.innerHTML = `<div class="control-btn delete-btn" onclick="removeEl(this.parentNode)"><i class="fas fa-times"></i></div><div class="move-handle"><i class="fas fa-arrows-alt"></i></div><div class="handle resize-nw"></div><div class="handle resize-ne"></div><div class="handle resize-sw"></div><div class="handle resize-se"></div><div class="handle resize-n"></div><div class="handle resize-e"></div><div class="handle resize-s"></div>`; const content = document.createElement('div'); content.className = 'content-wrapper'; content.style.width = '100%'; content.style.height = '100%'; div.appendChild(content); div.insertBefore(content, div.lastChild); return div; }
        
        async function loadDesignerAyahs() { 
            const num = document.getElementById('surah-select').value; 
            if(!num) return; 
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}`); 
            const data = await res.json(); 
            currentDesignerSurahData = data.data; // Store full surah data for range
            
            const sel = document.getElementById('ayah-select'); 
            const selEnd = document.getElementById('ayah-select-end');
            
            let options = '<option value="">الآية...</option>';
            data.data.ayahs.forEach(a => options += `<option value="${a.numberInSurah}" data-text="${a.text}">${a.numberInSurah}</option>`);
            
            sel.innerHTML = options;
            selEnd.innerHTML = options.replace('الآية...', 'إلى...');
        }
        
        function toggleDesignerRangeMode() {
            const isChecked = document.getElementById('range-toggle').checked;
            const endSelect = document.getElementById('ayah-select-end');
            if(isChecked) {
                endSelect.classList.remove('hidden');
            } else {
                endSelect.classList.add('hidden');
            }
        }

        function addAyah() { 
            const sel = document.getElementById('ayah-select'); 
            if(!sel.value) return; 
            
            const isRange = document.getElementById('range-toggle').checked;
            
            if(isRange) {
                const start = parseInt(sel.value);
                const endSelect = document.getElementById('ayah-select-end');
                const end = parseInt(endSelect.value);
                
                if(!end || end < start) {
                    alert('يرجى اختيار آية نهاية صحيحة');
                    return;
                }
                
                let combinedText = "";
                // Get ayahs from stored data. Arrays are 0-indexed, ayah numbers are 1-indexed.
                // Surah ayahs array: index 0 is ayah 1.
                for(let i = start; i <= end; i++) {
                    const ayahObj = currentDesignerSurahData.ayahs[i-1];
                    combinedText += ayahObj.text + " ﴿" + ayahObj.numberInSurah + "﴾ ";
                }
                addTextToCanvas(combinedText, true);
            } else {
                // Single mode
                const text = sel.options[sel.selectedIndex].getAttribute('data-text'); 
                addTextToCanvas(text.trim() + ' ﴿' + sel.value + '﴾', true); 
            }
            saveState(); 
        }

        function addText() { const wrapper = createWrapper('text-layer'); wrapper.style.top='50%'; wrapper.style.left='50%'; wrapper.innerHTML = wrapper.innerHTML.replace('<div class="content-wrapper"', '<div class="content-wrapper"><div contenteditable="true" class="extra-text">نص جديد</div>'); document.getElementById('card').appendChild(wrapper); selectEl(wrapper); setupInteract(wrapper); saveState(); }
        function addTextToCanvas(txt, isQ) { const wrapper = createWrapper('text-layer'); wrapper.style.color = '#2d3748'; wrapper.style.fontSize = isQ ? '24px' : '24px'; wrapper.style.fontFamily = isQ ? "'Amiri', serif" : "'Cairo', sans-serif"; wrapper.style.fontWeight = isQ ? '500' : '600'; wrapper.style.top='50%'; wrapper.style.left='50%'; const textDiv = document.createElement('div'); textDiv.className = isQ ? 'ayah-text' : 'extra-text'; textDiv.contentEditable = true; textDiv.innerText = txt; if(isQ) { const span = document.createElement('div'); span.innerText = currentDesignerSurahData ? currentDesignerSurahData.name : ""; span.style.fontSize = '0.6em'; span.style.marginTop = '10px'; span.style.opacity = '0.7'; textDiv.appendChild(span); } wrapper.querySelector('.content-wrapper').appendChild(textDiv); document.getElementById('card').appendChild(wrapper); selectEl(wrapper); setupInteract(wrapper); saveState(); }
        function addImageLayer(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const wrapper = document.createElement('div'); wrapper.className = 'draggable-el image-layer bg-image is-locked'; const img = document.createElement('img'); img.src = e.target.result; wrapper.appendChild(img); document.getElementById('card').appendChild(wrapper); saveState(); }; reader.readAsDataURL(input.files[0]); input.value = ''; } }
        function addRegularImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const wrapper = createWrapper('image-layer'); wrapper.style.width = '200px'; wrapper.style.height = '200px'; const img = document.createElement('img'); img.src = e.target.result; wrapper.querySelector('.content-wrapper').appendChild(img); document.getElementById('card').appendChild(wrapper); selectEl(wrapper); setupInteract(wrapper); saveState(); }; reader.readAsDataURL(input.files[0]); input.value = ''; } }
        function selectEl(el) { if(activeEl) activeEl.classList.remove('selected'); activeEl=el; el.classList.add('selected'); document.getElementById('quick-props').classList.add('active'); if(el.classList.contains('text-layer')) { document.getElementById('top-font-controls').classList.add('active'); document.getElementById('frame-controls').classList.remove('active'); document.getElementById('top-font-size').value = parseInt(window.getComputedStyle(el).fontSize); document.getElementById('quick-color').value = rgbToHex(el.style.color || '#2d3748'); } else if (el.classList.contains('frame-layer')) { document.getElementById('frame-controls').classList.add('active'); document.getElementById('top-font-controls').classList.remove('active'); let bg = (el.dataset.shape === 'triangle') ? el.querySelector('.content-wrapper').style.backgroundColor : el.style.backgroundColor; document.getElementById('border-color').value = rgbToHex(el.style.borderColor || '#000000'); document.getElementById('border-width').value = parseInt(el.style.borderWidth) || 0; document.getElementById('bg-color').value = rgbToHex(bg || 'transparent'); document.getElementById('quick-props').classList.remove('active'); } else { document.getElementById('top-font-controls').classList.remove('active'); document.getElementById('frame-controls').classList.remove('active'); } }
        function deselect(e) { if(e && e.target.closest('.draggable-el')) return; if(activeEl) activeEl.classList.remove('selected'); activeEl=null; document.querySelectorAll('.controls-row').forEach(r => r.classList.remove('active')); exitEraserMode(); document.getElementById('shape-menu-content').classList.add('hidden'); document.getElementById('size-menu-content').classList.add('hidden'); }
        function setupInteract(el) { if(el.hasAttribute('data-events-bound')) return; el.setAttribute('data-events-bound', 'true'); el.addEventListener('mousedown', startInteract); el.addEventListener('touchstart', startInteract, {passive: false}); function startInteract(e) { if (el.classList.contains('is-locked') || eraserMode) return; if (e.target.classList.contains('handle')) { e.preventDefault(); e.stopPropagation(); initResize(e, el, e.target); return; } if (e.target.closest('.control-btn')) return; selectEl(el); e.preventDefault(); let startX = (e.type === 'touchstart') ? e.touches[0].clientX : e.clientX; let startY = (e.type === 'touchstart') ? e.touches[0].clientY : e.clientY; let elemLeft = el.offsetLeft; let elemTop = el.offsetTop; const onMove = (ev) => { ev.preventDefault(); let curX = (ev.type === 'touchmove') ? ev.touches[0].clientX : ev.clientX; let curY = (ev.type === 'touchmove') ? ev.touches[0].clientY : ev.clientY; el.style.left = (elemLeft + curX - startX) + 'px'; el.style.top = (elemTop + curY - startY) + 'px'; }; const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onUp); saveState(); }; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); document.addEventListener('touchmove', onMove, {passive: false}); document.addEventListener('touchend', onUp); } }
        function initResize(e, el, handle) { let startX = (e.type === 'touchstart') ? e.touches[0].clientX : e.clientX; let startY = (e.type === 'touchstart') ? e.touches[0].clientY : e.clientY; let startWidth = parseInt(document.defaultView.getComputedStyle(el).width, 10); let startHeight = parseInt(document.defaultView.getComputedStyle(el).height, 10); let startLeft = el.offsetLeft; let startTop = el.offsetTop; const doResize = (ev) => { ev.preventDefault(); let curX = (ev.type === 'touchmove') ? ev.touches[0].clientX : ev.clientX; let curY = (ev.type === 'touchmove') ? ev.touches[0].clientY : ev.clientY; let diffX = curX - startX; let diffY = curY - startY; let newW = startWidth, newH = startHeight, newL = startLeft, newT = startTop; if (handle.classList.contains('resize-se')) { newW = startWidth + diffX; newH = startHeight + diffY; } else if (handle.classList.contains('resize-sw')) { newW = startWidth - diffX; newH = startHeight + diffY; newL = startLeft + diffX; } else if (handle.classList.contains('resize-ne')) { newW = startWidth + diffX; newH = startHeight - diffY; newT = startTop + diffY; } else if (handle.classList.contains('resize-nw')) { newW = startWidth - diffX; newH = startHeight - diffY; newL = startLeft + diffX; newT = startTop + diffY; } if (newW > 20) { el.style.width = newW + 'px'; el.style.left = newL + 'px'; } if (newH > 20) { el.style.height = newH + 'px'; el.style.top = newT + 'px'; } }; const stopResize = () => { document.removeEventListener('mousemove', doResize); document.removeEventListener('mouseup', stopResize); document.removeEventListener('touchmove', doResize); document.removeEventListener('touchend', stopResize); saveState(); }; document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', stopResize); document.addEventListener('touchmove', doResize, {passive: false}); document.addEventListener('touchend', stopResize); }
        function removeEl(el) { el.remove(); deselect(); saveState(); }
        function deleteActive() { if(activeEl) removeEl(activeEl); }
        function updateStyle(prop, val) { if(!activeEl) return; activeEl.style[prop]=val; saveState(); }
        function rgbToHex(rgb) { if(!rgb || rgb==='transparent') return '#ffffff'; if(rgb.startsWith('#')) return rgb; const sep = rgb.indexOf(',') > -1 ? ',' : ' '; const parts = rgb.substr(4).split(')')[0].split(sep); let r = (+parts[0]).toString(16), g = (+parts[1]).toString(16), b = (+parts[2]).toString(16); return "#" + (r.length==1?"0"+r:r) + (g.length==1?"0"+g:g) + (b.length==1?"0"+b:b); }
        function toggleGradient() { hasGradient = !hasGradient; document.getElementById('card-gradient').style.display = hasGradient ? 'block' : 'none'; document.getElementById('grad-controls').classList.toggle('active', hasGradient); document.getElementById('btn-grad').classList.toggle('border-[#c5a059]', hasGradient); saveState(); }
        function setGradientColor(c) { const end = c==='white' ? 'rgba(255,255,255,0.95)' : 'rgba(0,0,0,0.95)'; const start = c==='white' ? 'rgba(255,255,255,0)' : 'rgba(0,0,0,0)'; document.getElementById('card-gradient').style.background = `linear-gradient(to top, ${end}, ${start})`; saveState(); }
        function setGradientOpacity(v) { document.getElementById('card-gradient').style.opacity = v; saveState(); }
        function toggleBg() { isTransparent = !isTransparent; document.getElementById('card').style.backgroundColor = isTransparent ? 'transparent' : 'white'; document.getElementById('btn-bg').classList.toggle('bg-[#1a472a]', isTransparent); document.getElementById('btn-bg').classList.toggle('text-white', isTransparent); saveState(); }
        function toggleShapeMenu() { document.getElementById('shape-menu-content').classList.toggle('hidden'); document.getElementById('size-menu-content').classList.add('hidden'); }
        function toggleSizeMenu() { document.getElementById('size-menu-content').classList.toggle('hidden'); document.getElementById('shape-menu-content').classList.add('hidden'); }
        function setCardSize(w, h, l) { const card = document.getElementById('card'); card.style.width = w+'px'; card.style.height = h+'px'; document.getElementById('size-label').innerText = l; document.getElementById('size-menu-content').classList.add('hidden'); resizeCardToFit(); saveState(); }
        function addExtraText() { addText(); }
        function addFrame() { const w = createWrapper('frame-layer'); w.style.borderColor='#1a472a'; w.style.borderWidth='2px'; w.style.width='200px'; w.style.height='200px'; document.getElementById('card').appendChild(w); selectEl(w); setupInteract(w); saveState(); }
        function addShape(type) { const w = createWrapper('frame-layer'); w.style.width='150px'; w.style.height='150px'; w.dataset.shape = type; if(type === 'square') { w.style.backgroundColor='#c5a059'; w.style.borderRadius='0'; } else if(type === 'circle') { w.style.backgroundColor='#c5a059'; w.style.borderRadius='50%'; } else if(type === 'triangle') { w.style.backgroundColor='transparent'; const content = w.querySelector('.content-wrapper'); content.style.backgroundColor = '#c5a059'; content.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)'; content.style.width = '100%'; content.style.height = '100%'; } document.getElementById('card').appendChild(w); document.getElementById('shape-menu-content').classList.add('hidden'); selectEl(w); setupInteract(w); saveState(); }
        function updateProgress(percent, text) { const bar = document.getElementById('export-progress'); const pText = document.getElementById('progress-text'); const status = document.getElementById('export-status'); if(bar) bar.style.width = percent + '%'; if(pText) pText.innerText = percent + '%'; if(status) status.innerText = text; }
        async function checkIfImageLoaded(imgElement) {
            return new Promise(async (resolve) => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 100;
                    canvas.height = 100;
                    ctx.drawImage(imgElement, 0, 0, 100, 100);
                    
                    const imageData = ctx.getImageData(10, 10, 80, 80);
                    const data = imageData.data;
                    
                    let nonWhiteCount = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] < 250 || data[i+1] < 250 || data[i+2] < 250) {
                            nonWhiteCount++;
                        }
                    }
                    
                    const hasContent = nonWhiteCount > (data.length / 4) * 0.1;
                    resolve(hasContent);
                } catch(e) {
                    resolve(true);
                }
            });
        }

        async function exportCard() { deselect(); const card = document.getElementById('card'); const overlay = document.getElementById('export-overlay'); const modal = document.getElementById('save-modal'); const imgPreview = document.getElementById('save-img'); overlay.style.display = 'flex'; updateProgress(10, "جاري تحضير العناصر..."); const oldT = card.style.transform; try { card.style.transform = 'scale(1)'; document.querySelectorAll('.handle, .control-btn').forEach(e => e.style.display = 'none'); await document.fonts.ready; updateProgress(30, "جاري معالجة الصور..."); const imgs = card.querySelectorAll('img'); await Promise.all(Array.from(imgs).map(img => { if (img.complete) return Promise.resolve(); return new Promise(r => { img.onload = r; img.onerror = r; }); })); updateProgress(50, "جاري المعالجة الأولية..."); void card.offsetHeight; await new Promise(r => setTimeout(r, 500)); updateProgress(90, "إنشاء الصورة النهائية..."); await htmlToImage.toPng(card, { quality: 0.1 }); let url = await htmlToImage.toPng(card, { quality: 1.0, pixelRatio: 3, backgroundColor: '#ffffff', width: card.offsetWidth, height: card.offsetHeight, cacheBust: true, style: { transform: 'none', margin: 0 } }); imgPreview.src = url; await new Promise(r => { if(imgPreview.complete) { r(); } else { imgPreview.onload = r; imgPreview.onerror = r; } }); const hasContent = await checkIfImageLoaded(imgPreview); if (!hasContent) { await new Promise(r => setTimeout(r, 1500)); url = await htmlToImage.toPng(card, { quality: 1.0, pixelRatio: 3, backgroundColor: '#ffffff', width: card.offsetWidth, height: card.offsetHeight, cacheBust: true, style: { transform: 'none', margin: 0 } }); imgPreview.src = url; await new Promise(r => { if(imgPreview.complete) { r(); } else { imgPreview.onload = r; imgPreview.onerror = r; } }); } updateProgress(100, "تم!"); setTimeout(() => { overlay.style.display = 'none'; modal.style.display = 'flex'; }, 300); } catch(e) { console.error(e); alert('حدث خطأ بسيط في التصدير. حاول مرة أخرى.'); overlay.style.display = 'none'; } finally { card.style.transform = oldT; } }
        function downloadImage() { const link = document.createElement('a'); link.download = `quran-design-${Date.now()}.png`; link.href = document.getElementById('save-img').src; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        function toggleEraserMode() {} function updateEraserSize() {} function toggleMagicMode() {} function updateMagicTolerance() {} function exitEraserMode() {}
    </script>
</body>
</html>