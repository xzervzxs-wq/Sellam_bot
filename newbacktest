import requests
import pandas as pd
import io
import time
import sys
import os
import pytz
import json
import re
import yfinance as yf # ğŸ‘ˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø¢Ù…Ù† Ù„Ù„ÙÙ„ÙˆØª
from datetime import datetime, timedelta
from dotenv import load_dotenv
import databento as db
import concurrent.futures

# ==============================================================================
# ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
# ==============================================================================
load_dotenv()

EODHD_API_KEY = os.getenv("EODHD_API_KEY")
FMP_API_KEY = os.getenv("FMP_API_KEY")
DATABENTO_API_KEY = os.getenv("DATABENTO_API_KEY")

TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±Ø¹Ø© (3 Ø¹Ù…Ø§Ù„ = ØªÙˆØ§Ø²Ù† ÙˆØ£Ù…Ø§Ù†)
MAX_WORKERS = 3
REQUEST_DELAY = 0.5

FINVIZ_COOKIE = """chartsTheme=dark; notice-newsletter=show; .ASPXAUTH=C7E2E86BC876CD078E1DC69C25671D062A909C67501ECF211333FAAD7F54A40FE9B6772EF4E88ED21E26C6C99BCAE5C39C5C8D598CD73357A5FCB4B556AD83E55002A827606EFFFE1F1315C9E8A4E05BC99B517D7E533905EE95F029D8FE0B930EC18E2E5F5037693AE688694BFDFDD82DADE25BA4063B448D18DDC85EAB40FD9D717716F2FEABA2A813D932072BFF5C6F723BACD8D3E4CA5161C3B1E0FF3088C9CC8AA7E67C3A4C94EA5122A68D9ADC7F85B091D98A31BF66F654490F1F7601FA7E420E3ECAF266BF62C1A7C9733A57BC866F92; survey_dialog_cohort=0; customColors=%7B%22light%22%3A%7B%7D%2C%22dark%22%3A%7B%7D%7D; customColorsExpiration=12%2F12%2F2025%208%3A11%3A59%20PM"""

FINVIZ_HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Cookie": FINVIZ_COOKIE
}

SHARIAH_FILE = "shariah_stocks_master.json"
FLOAT_CACHE_FILE = "float_cache.json"

# ==============================================================================
# ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ğŸ§¹
# ==============================================================================
def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r', encoding='utf-8') as f: return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f: json.dump(data, f, indent=4)
    except: pass

shariah_db = load_json_file(SHARIAH_FILE)
float_cache = load_json_file(FLOAT_CACHE_FILE)

# ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© dict * float)
def clean_float_value(val):
    if val is None: return 0

    # 1. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø§Ù…ÙˆØ³ (Dict)ØŒ Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø±Ù‚Ù…
    if isinstance(val, dict):
        val = val.get('value') or val.get('float') or 0

    # 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Øµ (String) Ù…Ø«Ù„ '100M' Ø£Ùˆ '1.5B'
    if isinstance(val, str):
        val = val.upper().replace(',', '')
        try:
            if 'M' in val: return float(re.findall(r"[\d\.]+", val)[0]) * 1_000_000
            if 'B' in val: return float(re.findall(r"[\d\.]+", val)[0]) * 1_000_000_000
            if 'K' in val: return float(re.findall(r"[\d\.]+", val)[0]) * 1_000
            return float(val)
        except: return 0

    # 3. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…
    if isinstance(val, (int, float)):
        return val

    return 0

def fmt_shares(n):
    if not isinstance(n, (int, float)): return "N/A"
    if n >= 1_000_000: return f"{n/1_000_000:.1f}M".replace(".0M", "M")
    if n >= 1_000: return f"{n/1_000:.1f}K"
    return str(int(n))

def send_telegram(message):
    if not TELEGRAM_BOT_TOKEN: return
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": message, "parse_mode": "Markdown"}
        requests.post(url, json=payload, timeout=5)
    except: pass

def get_shariah_label(symbol):
    data = shariah_db.get(symbol)
    if data and data.get('status') == 'halal': return "âœ… Ø­Ù„Ø§Ù„"
    return "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±"

def evaluate_liquidity(volume, float_val):
    if float_val == 0: return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", 0
    rotation_pct = (volume / float_val) * 100
    if rotation_pct >= 5.0: return "ğŸ”¥ğŸ”¥ Ø§Ù†ÙØ¬Ø§Ø± (Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹)", rotation_pct
    elif rotation_pct >= 2.0: return "ğŸ”¥ Ù†Ø§Ø± (Ù…Ù…ØªØ§Ø²)", rotation_pct
    elif rotation_pct >= 0.5: return "âœ… Ø¬ÙŠØ¯ (Ù†Ø´Ø·)", rotation_pct
    else: return "ğŸ’¤ Ø¶Ø¹ÙŠÙ (Ø®Ø·Ø±)", rotation_pct

# =========================================
# ğŸ› ï¸ Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙ„ÙˆØª (Ø¬Ø¯ÙŠØ¯Ø©)
# =========================================
def clean_float_value(val):
    """ØªØ³ØªØ®Ø±Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„ÙÙ„ÙˆØª Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù†ØµØ§Ù‹ Ø£Ùˆ Ù‚Ø§Ù…ÙˆØ³Ø§Ù‹"""
    if val is None: return 0

    # 1. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø§Ù…ÙˆØ³ (Dict) Ù…Ø«Ù„ {'value': 123}
    if isinstance(val, dict):
        val = val.get('value') or val.get('float') or 0

    # 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Øµ (String) Ù…Ø«Ù„ '100M' Ø£Ùˆ '1.5B'
    if isinstance(val, str):
        val = val.upper().replace(',', '')
        try:
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Regex Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ÙˆØ­Ø¯Ø©
            import re
            if 'M' in val: return float(re.findall(r"[\d\.]+", val)[0]) * 1_000_000
            if 'B' in val: return float(re.findall(r"[\d\.]+", val)[0]) * 1_000_000_000
            if 'K' in val: return float(re.findall(r"[\d\.]+", val)[0]) * 1_000
            return float(val)
        except: return 0

    # 3. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ø¬Ø§Ù‡Ø²
    if isinstance(val, (int, float)):
        return val

    return 0

# ==============================================================================
# ğŸ’ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Safe Sources)
# ==============================================================================

# 1. Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ù…Ù† Yahoo (Ø¢Ù…Ù† ÙˆÙ…Ø¬Ø§Ù†ÙŠ) + ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´
def get_float_shares_safe(symbol):
    global float_cache

    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£ÙˆÙ„Ø§Ù‹ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚ÙŠÙ…Ø©
    if symbol in float_cache:
        val = clean_float_value(float_cache[symbol]) # ğŸ‘ˆ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if val > 0: return val

    # Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† ÙŠØ§Ù‡Ùˆ ÙØ§ÙŠÙ†Ù†Ø³
    try:
        ticker = yf.Ticker(symbol)
        info = ticker.info
        val = info.get('floatShares')
        if not val: val = info.get('sharesOutstanding')

        if val:
            # Ù†Ø®Ø²Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø§Ù… ÙƒÙ…Ø§ Ù‡ÙŠØŒ ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ ÙŠØªÙ… Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
            float_cache[symbol] = val
            save_json_file(FLOAT_CACHE_FILE, float_cache)
            return clean_float_value(val) # Ù†Ø±Ø¬Ø¹ Ù‚ÙŠÙ…Ø© Ù†Ø¸ÙŠÙØ©
    except: pass

    return 0

# 2. Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Databento (Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©)
def get_databento_data(symbol, target_time):
    """Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Databento - Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 Ù„Ù„ÙŠÙˆÙ…"""
    try:
        time.sleep(REQUEST_DELAY)

        if not DATABENTO_API_KEY:
            return pd.DataFrame(), "No Databento API Key"

        client = db.Historical(DATABENTO_API_KEY)

        # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯
        ny_tz = pytz.timezone('America/New_York')
        start_time = target_time.replace(hour=9, minute=30, second=0, microsecond=0)
        end_time = target_time.replace(hour=10, minute=0, second=0, microsecond=0)

        data = client.timeseries.get_range(
            dataset="XNAS.ITCH",  # Nasdaq dataset
            symbols=[symbol],
            schema="ohlcv-5m",  # Ø´Ù…ÙˆØ¹ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø©
            start=start_time.isoformat(),
            end=end_time.isoformat(),
        )

        if data.df.empty:
            return pd.DataFrame(), "No Data from Databento"

        df = data.df.copy()

        if df.index.tz is None:
            df.index = df.index.tz_localize('UTC')
        df.index = df.index.tz_convert('America/New_York')

        df.rename(columns={'open': 'Open', 'high': 'High', 'low': 'Low', 'close': 'Close', 'volume': 'Volume'}, inplace=True)

        # Ø¥Ø²Ø§Ù„Ø© NaN
        df = df.dropna()

        if df.empty:
            return pd.DataFrame(), "No data in time range"

        return df, "OK"
    except Exception as e:
        return pd.DataFrame(), f"Databento Error: {str(e)}"

# 4. Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† Yahoo Finance (Ù„Ø§ÙŠÙ - Ø§Ù„ÙŠÙˆÙ…)
def get_yfinance_live_data(symbol, target_time):
    """Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Yahoo Finance - Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 Ù„Ù„ÙŠÙˆÙ…"""
    try:
        time.sleep(REQUEST_DELAY)

        # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·
        start_date = target_time.date()
        end_date = (target_time + timedelta(days=1)).date()

        df = yf.download(symbol, start=start_date, end=end_date, interval='5m', prepost=False, progress=False, auto_adjust=False)

        if df.empty:
            return pd.DataFrame(), "No Data from Yahoo"

        # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§ØªØŒ Ù†Ø¨Ø³Ø·Ù‡Ø§
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)

        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù„Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ
        if df.index.tz is None:
            df.index = df.index.tz_localize('America/New_York', ambiguous='infer', nonexistent='shift_forward')
        else:
            df.index = df.index.tz_convert('America/New_York')

        # ÙÙ„ØªØ± Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 ÙÙ‚Ø·
        mask = (df.index.time >= datetime.strptime('09:30', '%H:%M').time()) & \
               (df.index.time <= datetime.strptime('10:00', '%H:%M').time())
        df = df[mask]

        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        df.rename(columns={'Open': 'Open', 'High': 'High', 'Low': 'Low', 'Close': 'Close', 'Volume': 'Volume'}, inplace=True)

        # Ø¥Ø²Ø§Ù„Ø© NaN
        df = df.dropna()

        if df.empty:
            return pd.DataFrame(), "No data in time range"

        return df, "OK"

    except Exception as e:
        return pd.DataFrame(), f"Yahoo Error: {str(e)}"
def get_eodhd_data(symbol, target_time):
    """Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† EODHD - Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 ÙÙ‚Ø·"""
    try:
        time.sleep(REQUEST_DELAY)

        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø¨Ø§Ù„Ù€ timestamps
        ny_tz = pytz.timezone('America/New_York')
        start_time = target_time.replace(hour=9, minute=30, second=0, microsecond=0)
        end_time = target_time.replace(hour=10, minute=0, second=0, microsecond=0)

        from_ts = int(start_time.timestamp())
        to_ts = int(end_time.timestamp())

        # Ø§Ø³ØªØ®Ø¯Ø§Ù… intraday endpoint Ù…Ù† EODHD
        url = f"https://eodhd.com/api/intraday/{symbol}.US"
        params = {
            'api_token': EODHD_API_KEY,
            'interval': '5m',
            'from': from_ts,
            'to': to_ts,
            'fmt': 'json'
        }

        r = requests.get(url, params=params, timeout=15)
        if r.status_code != 200:
            return pd.DataFrame(), f"EODHD API Error: {r.status_code}"

        data = r.json()
        if not data or not isinstance(data, list):
            return pd.DataFrame(), "No Data from EODHD"

        df = pd.DataFrame(data)

        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if 'datetime' in df.columns:
            df['datetime'] = pd.to_datetime(df['datetime'])
        elif 'timestamp' in df.columns:
            df['datetime'] = pd.to_datetime(df['timestamp'], unit='s')
        else:
            return pd.DataFrame(), "No datetime column"

        df = df.set_index('datetime').sort_index()

        # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙˆÙ‚ÙŠØª Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ
        if df.index.tz is None:
            df.index = df.index.tz_localize('UTC')
        df.index = df.index.tz_convert('America/New_York')

        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        df.rename(columns={
            'open': 'Open',
            'high': 'High',
            'low': 'Low',
            'close': 'Close',
            'volume': 'Volume'
        }, inplace=True)

        if df.empty:
            return pd.DataFrame(), "No data in time range"

        return df, "OK"

    except Exception as e:
        return pd.DataFrame(), f"EODHD Error: {str(e)}"
def get_fmp_intraday_data(symbol, target_time):
    """Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† FMP API - Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 Ù„Ù„ÙŠÙˆÙ…"""
    try:
        time.sleep(REQUEST_DELAY)

        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        date_str = target_time.strftime('%Y-%m-%d')

        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ URL Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† FMP Documentation
        url = "https://financialmodelingprep.com/stable/historical-chart/5min"
        params = {
            'symbol': symbol,
            'apikey': FMP_API_KEY,
            'from': date_str,
            'to': date_str
        }

        r = requests.get(url, params=params, timeout=15)

        if r.status_code != 200:
            return pd.DataFrame(), f"FMP API Error: {r.status_code}"

        data = r.json()
        if not data or not isinstance(data, list):
            return pd.DataFrame(), "No Data from FMP"

        df = pd.DataFrame(data)

        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if 'date' in df.columns:
            df['datetime'] = pd.to_datetime(df['date'])
        elif 'timestamp' in df.columns:
            df['datetime'] = pd.to_datetime(df['timestamp'])
        else:
            return pd.DataFrame(), "No datetime column"

        df = df.set_index('datetime').sort_index()

        # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙˆÙ‚ÙŠØª Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ
        if df.index.tz is None:
            df.index = df.index.tz_localize('UTC')
        df.index = df.index.tz_convert('America/New_York')

        # ÙÙ„ØªØ± Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 ÙÙ‚Ø·
        mask = (df.index.time >= datetime.strptime('09:30', '%H:%M').time()) & \
               (df.index.time <= datetime.strptime('10:00', '%H:%M').time())
        df = df[mask]

        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        df.rename(columns={'open': 'Open', 'high': 'High', 'low': 'Low', 'close': 'Close', 'volume': 'Volume'}, inplace=True)

        # Ø¥Ø²Ø§Ù„Ø© NaN
        df = df.dropna()

        if df.empty:
            return pd.DataFrame(), "No data in time range"

        return df, "OK"

    except Exception as e:
        return pd.DataFrame(), f"FMP Error: {str(e)}"
    # ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø²Ø¯Ù†Ø§ Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ù† 3 Ø¥Ù„Ù‰ 10 Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ 200 Ø´Ù…Ø¹Ø©
    start_timestamp = int((target_time - timedelta(days=10)).timestamp())

    url = f"https://eodhd.com/api/intraday/{symbol}.US?api_token={EODHD_API_KEY}&interval=5m&fmt=json&from={start_timestamp}"
    try:
        time.sleep(REQUEST_DELAY)
        r = requests.get(url, timeout=10)
        if r.status_code != 200: return pd.DataFrame(), f"API Error: {r.status_code}"
        data = r.json()
        if not data or not isinstance(data, list): return pd.DataFrame(), "No Data/Bad JSON"

        df = pd.DataFrame(data)
        if 'timestamp' in df.columns: df['date'] = pd.to_datetime(df['timestamp'], unit='s', utc=True)
        elif 'datetime' in df.columns: df['date'] = pd.to_datetime(df['datetime'], utc=True)

        df = df.set_index('date').sort_index()
        df.index = df.index.tz_convert('America/New_York')
        df.rename(columns={'open': 'Open', 'high': 'High', 'low': 'Low', 'close': 'Close', 'volume': 'Volume'}, inplace=True)
        return df, "OK"
    except Exception as e: return pd.DataFrame(), f"Exception: {str(e)}"

# ==============================================================================
# ğŸ§  Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ù„Ù… (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ)
# ==============================================================================
# ==============================================================================
# ğŸ§  Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ (Scoring Engine: Golden vs Flexible)
# ==============================================================================
def check_ladder_pattern_final(df_window, float_val):
    # Ù†Ø­ØªØ§Ø¬ 3 Ø´Ù…ÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
    if len(df_window) < 3: return False, 0, 0, "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©"

    # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙÙˆÙ Ø¥Ù„Ù‰ dictionaries Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Series Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    candles = [row.to_dict() if hasattr(row, 'to_dict') else dict(row) for _, row in df_window.iterrows()]
    c1, c2 = candles[0], candles[1]

    # ---------------------------------------------------------
    # ğŸ“Š Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    # ---------------------------------------------------------
    def get_candle_metrics(row):
        o, c = row['Open'], row['Close']
        h, l = row['High'], row['Low']
        if pd.isna(o) or pd.isna(c) or pd.isna(h) or pd.isna(l):
            return 0, 0, False, 0, 0, 0, 0
        body = abs(c - o)
        body_pct = (body / o * 100) if o > 0 else 0
        total_range = h - l
        upper_wick = h - max(o, c)
        wick_ratio = (upper_wick / total_range) if total_range > 0 else 0
        is_green = c > o
        return body_pct, wick_ratio, is_green, l, o, c, h

    b1, w1, g1, l1, o1, c1_close, h1 = get_candle_metrics(c1)
    b2, w2, g2, l2, o2, c2_close, h2 = get_candle_metrics(c2)

    # =========================================================
    # ğŸ’¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· (The Scoring System)
    # Start Score: 100 -> Deduct based on ugliness
    # =========================================================
    score = 100
    tag = ""

    # 1. ÙÙ„ØªØ± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Hard Rules - Ù„Ø§ Ù†Ù‚Ø§Ø´ ÙÙŠÙ‡Ø§)
    if not (g1 and g2): return False, 0, 0, "Ø¨Ø¯Ø§ÙŠØ© Ø­Ù…Ø±Ø§Ø¡"
    if (b1 + b2) < 0.8: return False, 0, 0, "Ø²Ø®Ù… Ù…ÙŠØª (<0.8%)"
    if w1 > 0.50: return False, 0, 0, f"Ø°ÙŠÙ„ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ ({w1:.2f})"

    # 2. Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ "Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©"

    # Ø£) Ø®ØµÙ… Ø§Ù„Ø°ÙŠÙˆÙ„ (Penalize Wicks)
    # Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ† (SIDU/MVIS) Ø°ÙŠÙˆÙ„Ù‡Ù… 0.0. NBIS Ø°ÙŠÙ„Ù‡ Ø·ÙˆÙŠÙ„.
    # ÙƒÙ„ 0.1 Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ø°ÙŠÙ„ ØªØ®ØµÙ… 5 Ù†Ù‚Ø§Ø·
    max_wick = max(w1, w2)
    if max_wick > 0.15:
        penalty = int((max_wick - 0.15) * 40) # Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø®ØµÙ…
        score -= penalty
        # tag += f"| Ø°ÙŠÙ„ -{penalty}"

    # Ø¨) Ø®ØµÙ… Ø§Ù„Ø²Ø®Ù… Ø§Ù„Ø¶Ø¹ÙŠÙ (Penalize Weak Body)
    # NBY ÙƒØ§Ù† Ù…Ø¬Ù…ÙˆØ¹Ù‡ 9%. Ø¥Ø°Ø§ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø£Ù‚Ù„ Ù…Ù† 1.5% Ù†Ø®ØµÙ…
    total_body = b1 + b2
    if total_body < 1.5:
        score -= 10
    elif total_body > 4.0:
        score += 5 # Ø¨ÙˆÙ†Øµ Ù„Ù„Ø§Ù†ÙØ¬Ø§Ø± Ø§Ù„Ù‚ÙˆÙŠ

    # ---------------------------------------------------------
    # ğŸ›¡ï¸ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± (Path Tracking)
    # ---------------------------------------------------------
    start_price = o1
    try:
        current_price = float(candles[-1]['Close'])
        morning_high = float(df_window['High'].max())
    except (ValueError, TypeError):
        return False, 0, 0, "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©"

    if current_price <= start_price: return False, 0, 0, "ÙØ´Ù„ Ø§Ù„ØµØ¹ÙˆØ¯"

    for i in range(1, len(candles)):
        curr_row = candles[i]
        prev_row = candles[i-1]

        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ float Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© Series
        try:
            curr_l = float(curr_row['Low'])
            prev_l = float(prev_row['Low'])
            curr_o = float(curr_row['Open'])
            curr_c = float(curr_row['Close'])
            prev_o = float(prev_row['Open'])
        except (ValueError, TypeError):
            continue

        # Ø¬) ÙØ­Øµ ÙƒØ³Ø± Ø§Ù„Ù‚Ø§Ø¹ (The RIVN Filter)
        if curr_l < prev_l:
            drop_pct = abs(curr_l - prev_l) / prev_l * 100

            # â›” Hard Rule: ÙƒØ³Ø± Ø¹Ù†ÙŠÙ
            if drop_pct > 0.35: return False, 0, 0, "ÙƒØ³Ø± Ù‚Ø§Ø¹ Ø¹Ù†ÙŠÙ"

            # âš ï¸ Soft Penalty: ÙƒØ³Ø± Ø¨Ø³ÙŠØ· (ØªØ°Ø¨Ø°Ø¨)
            # RIVN ÙƒØ³Ø± Ø§Ù„Ù‚Ø§Ø¹ Ø¨Ù†Ø³Ø¨Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ Ù„Ø°Ù„Ùƒ Ù‡Ùˆ Ù†Ø§Ø¬Ø­ Ù„ÙƒÙ† Ù„ÙŠØ³ 100/100
            score -= 15
            # tag += "| ÙƒØ³Ø± Ù‚Ø§Ø¹"

        # Ø¯) Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
        if curr_c < curr_o:
            if curr_c < prev_o: return False, 0, 0, "Ø§Ø¨ØªÙ„Ø§Ø¹ Ø³Ù„Ø¨ÙŠ"
            score -= 5 # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ØªÙ‚Ù„Ù„ Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹

    # ---------------------------------------------------------
    # ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    # ---------------------------------------------------------
    score = max(0, min(100, score)) # Ø­ØµØ± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ÙŠÙ† 0 Ùˆ 100

    if score >= 90:
        final_tag = "ğŸ’ Ø°Ù‡Ø¨ÙŠ (Golden)" # Ù…Ø«Ù„ NBY, SIDU
    elif score >= 75:
        final_tag = "âœ… Ù‚ÙˆÙŠ/Ù…Ø±Ù† (Strong)" # Ù…Ø«Ù„ RIVN, NBIS
    else:
        final_tag = "âš ï¸ Ù…Ù‚Ø¨ÙˆÙ„ (Weak)" # Ù…Ø«Ù„ CCL Ø¨Ø°ÙŠÙˆÙ„

    return True, score, morning_high, final_tag

# ==============================================================================
# âš¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„ÙØ±Ø¯ÙŠ
# ==============================================================================
def process_stock(ticker, target_time):
    try:
        # ØªØ¬Ø±Ø¨Ø© FMP Premium Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙØ¶Ù„)
        df, status = get_fmp_intraday_data(ticker, target_time)

        # Ø¥Ø°Ø§ ÙØ´Ù„ FMPØŒ Ø¬Ø±Ø¨ Databento
        if df.empty:
            df, status = get_databento_data(ticker, target_time)

        # Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§Ø«Ù†ÙŠÙ†ØŒ Ø§Ø³ØªØ®Ø¯Ù… Yahoo Finance ÙƒØ¢Ø®Ø± Ø®ÙŠØ§Ø±
        if df.empty:
            df, status = get_yfinance_live_data(ticker, target_time)
        if df.empty: return None, f"{ticker}: {status}"

        day_data = df[df.index.date == target_time.date()]
        if day_data.empty: return None, f"{ticker}: No Today Data"

        cutoff_mask = day_data.index <= target_time
        setup = day_data[cutoff_mask]

        if len(setup) < 3: return None, f"{ticker}: Not Enough Candles (<3)"

        # ğŸš€ Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„Ø¢Ù…Ù†
        float_val = get_float_shares_safe(ticker)

        is_valid, score, morning_high, reason = check_ladder_pattern_final(setup, float_val)

        if is_valid:
            pattern_tag = reason  # Ø§Ù„Ø¢Ù† reason Ù‡Ùˆ Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ø«Ù„ "ğŸ’ Ø°Ù‡Ø¨ÙŠ (Golden)"
            if "Ø«Ù‚ÙŠÙ„" in pattern_tag: return None, f"{ticker}: Heavy"

            total_vol = setup['Volume'].sum()
            liq_status, liq_pct = evaluate_liquidity(total_vol, float_val)
            if liq_pct < 0.2: return None, f"{ticker}: Dead Liq ({liq_pct:.2f}%)"

            current_price = setup['Close'].iloc[-1]

            # SMA 200
            full_history_until_now = df[df.index <= target_time]
            sma_msg = ""
            if len(full_history_until_now) >= 200:
                sma200 = full_history_until_now['Close'].rolling(window=200).mean().iloc[-1]
                diff_pct = ((current_price - sma200) / sma200) * 100
                if abs(diff_pct) <= 5.0:
                    pos = "ÙÙˆÙ‚" if current_price > sma200 else "ØªØ­Øª"
                    sma_msg = f"\nğŸ”¥ **ØªÙ†Ø¨ÙŠÙ‡:** Ø§Ù„Ø³Ø¹Ø± ÙŠÙ„Ø§Ù…Ø³ SMA200 ({pos} Ø§Ù„Ù…ØªÙˆØ³Ø·: ${sma200:.2f})"

            if current_price >= morning_high * 0.99:
                action_text = "ğŸš€ **Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±** (Ø§Ø®ØªØ±Ø§Ù‚)"
            else:
                buy_stop = morning_high + 0.01
                if current_price < 1.0: buy_stop = morning_high + 0.0001
                action_text = f"âœ‹ **Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚ (Buy Stop): ${buy_stop:.4f}**"

            shariah_status = get_shariah_label(ticker)
            flag = "ğŸ‡ºğŸ‡¸"

            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ©
            score_emoji = "â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸" if score >= 90 else ("â­ï¸â­ï¸â­ï¸" if score >= 75 else "â­ï¸")

            msg = (
                f"ğŸªœ **Ø³Ù„Ù… ØµØ§Ø¹Ø¯ ({pattern_tag})**\n"
                f"ğŸ”‹ **Ø§Ù„Ù‚ÙˆØ©:** {score}% {score_emoji}\n\n"
                f"ğŸ† Ø§Ù„Ø³Ù‡Ù…: *{ticker}* {flag}\n"
                f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± (10:00): *${current_price:.4f}*\n"
                f"ğŸ¯ Ø§Ù„Ù‚Ù…Ø©: *${morning_high:.4f}*\n"
                f"ğŸ’§ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: {liq_status} *({liq_pct:.1f}%)*\n"
                f"ğŸª¶ Ø§Ù„ÙÙ„ÙˆØª: *{fmt_shares(float_val)}*\n"
                f"âš–ï¸ Ø§Ù„Ø­ÙƒÙ…: *{shariah_status}*"
                f"{sma_msg}\n"
                f"---------------------------\n"
                f"{action_text}"
            )
            return msg, "OK"
        else:
            return None, f"{ticker}: {reason}"
    except Exception as e:
        return None, f"{ticker}: Error {str(e)}"

# ==============================================================================
# ğŸš€ Main Loop
# ==============================================================================
def get_finviz_elite_list():
    print("ğŸ“¡ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… ($0.02 - $11 + Float < 15M) Ù…Ù† Finviz Elite...")
    url = (
        "https://elite.finviz.com/export.ashx?v=111"
        "&f=sh_price_u11,sh_float_u15,sh_curvol_o50,ta_change_u"
        "&o=-volume"
    )
    try:
        response = requests.get(url, headers=FINVIZ_HEADERS, timeout=15)
        if response.status_code == 200:
            csv_data = io.StringIO(response.text)
            df = pd.read_csv(csv_data)
            if 'Ticker' in df.columns and 'Price' in df.columns:
                # ÙÙ„ØªØ± Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† 0.02$ Ø¥Ù„Ù‰ 11$
                df = df[(df['Price'] >= 0.02) & (df['Price'] <= 11.0)]
                top_300 = df['Ticker'].head(300).tolist()
                print(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(top_300)} Ø³Ù‡Ù… (Ø§Ù„Ø³Ø¹Ø±: $0.02 - $11).")
                return top_300
    except: pass
    return []

def get_trading_day_target(current_time_ny):
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆÙ‚Øª 10:00 ØµØ¨Ø§Ø­Ø§Ù‹ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø¢Ø®Ø± ÙŠÙˆÙ… ØªØ¯Ø§ÙˆÙ„"""
    cutoff_hour, cutoff_minute = 10, 0

    check_date = current_time_ny

    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ø³Ø¨Øª Ø£Ùˆ Ø£Ø­Ø¯ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø¬Ù…Ø¹Ø©
    while check_date.weekday() > 4:  # 5=Ø³Ø¨Øª, 6=Ø£Ø­Ø¯
        check_date -= timedelta(days=1)

    target_time = check_date.replace(hour=cutoff_hour, minute=cutoff_minute, second=0, microsecond=0)

    # Ø¥Ø°Ø§ Ù„Ø³Ø§ Ù…Ø§ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø¹Ø§Ø´Ø±Ø© ØµØ¨Ø§Ø­Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ø£Ù…Ø³
    if check_date.date() == current_time_ny.date() and current_time_ny < target_time:
        check_date -= timedelta(days=1)
        while check_date.weekday() > 4:
            check_date -= timedelta(days=1)
        target_time = check_date.replace(hour=cutoff_hour, minute=cutoff_minute, second=0, microsecond=0)

    print(f"ğŸ“… ØªØ­Ù„ÙŠÙ„ Ø´Ù…ÙˆØ¹ {check_date.strftime('%Y-%m-%d %A')} Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 ØµØ¨Ø§Ø­Ø§Ù‹...")

    return target_time

def main():
    print("="*50)
    print("ğŸ›¡ï¸ HYBRID BOT (Type-Safe Mode)")
    print("="*50)

    ny_tz = pytz.timezone('America/New_York')
    target_time = get_trading_day_target(datetime.now(ny_tz))
    print(f"ğŸ“… ÙˆÙ‚Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„: {target_time.strftime('%Y-%m-%d %H:%M')}")

    market_list = get_finviz_elite_list()
    if not market_list:
        print("âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø£ÙŠ Ø£Ø³Ù‡Ù….")
        return

    print(f"ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ (3 Workers)...")

    matches = 0
    successful_stocks = []  # Ù„Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ø§Ø¬Ø­Ø©

    with concurrent.futures.ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        future_to_stock = {executor.submit(process_stock, ticker, target_time): ticker for ticker in market_list}

        for i, future in enumerate(concurrent.futures.as_completed(future_to_stock), 1):
            stock = future_to_stock[future]
            try:
                msg, status = future.result()
                if msg:
                    send_telegram(msg)
                    print(f"âœ… {stock}: Ù…Ù‚Ø¨ÙˆÙ„")
                    matches += 1
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚ÙˆØ© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    import re
                    score_match = re.search(r'Ø§Ù„Ù‚ÙˆØ©:\*\* (\d+)%', msg)
                    if score_match:
                        score = int(score_match.group(1))
                        successful_stocks.append((stock, score))
                else:
                    # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¨Ø¨ Ù„ØªØ·Ù…Ø¦Ù†
                    print(f"âš ï¸ {status}")

            except Exception as exc: pass

    print(f"\nğŸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {matches}")

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    if successful_stocks:
        # ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ© (Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„)
        successful_stocks.sort(key=lambda x: x[1], reverse=True)

        summary = "ğŸ“Š *Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ÙŠÙˆÙ…*\n"
        summary += f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {target_time.strftime('%Y-%m-%d')}\n"
        summary += f"âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…: {matches}\n\n"

        for stock, score in successful_stocks:
            stars = "â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸" if score >= 90 else ("â­ï¸â­ï¸â­ï¸" if score >= 75 else "â­ï¸")
            summary += f"â€¢ *{stock}*: {score}% {stars}\n"

        send_telegram(summary)
        print(f"\nâœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…")

if __name__ == "__main__":
    main()