<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒØ§Ø´Ù Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ - Ø§Ù„Ù…ØµØ­Ù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
    <script async src="https://unpkg.com/tesseract.js@v2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a472a 0%, #2d6a4f 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        canvas {
            border-radius: 15px;
            border: 2px solid #c5a059;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
        }
        .ayah-box {
            background: white;
            border-left: 4px solid #c5a059;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ayah-box:hover {
            background: #f5f5f5;
            transform: translateX(-4px);
        }
        .ayah-box.selected {
            background: #fff3cd;
            border-left-color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 bg-white/20 text-white px-6 py-3 rounded-full backdrop-blur">
                <i class="fas fa-circle text-2xl text-orange-400"></i>
                <h1 class="text-3xl font-bold">ÙƒØ§Ø´Ù Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ØªÙØ§Ø­ÙŠØ©</h1>
                <i class="fas fa-quran text-2xl text-[#c5a059]"></i>
            </div>
        </div>

        <!-- Main Container -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Upload Section -->
            <div class="lg:col-span-1 glass-panel p-8">
                <h2 class="text-2xl font-bold text-[#1a472a] mb-6">
                    <i class="fas fa-upload text-[#c5a059]"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                </h2>

                <div class="border-3 border-dashed border-[#c5a059] rounded-xl p-6 text-center cursor-pointer hover:bg-[#fdfbf7] transition" id="drop-zone">
                    <input type="file" id="image-input" class="hidden" accept="image/*">
                    <i class="fas fa-image text-4xl text-[#c5a059] mb-3"></i>
                    <p class="font-bold text-[#1a472a]">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§</p>
                    <p class="text-sm text-gray-600 mt-2">PNG, JPG Ù…Ø¯Ø¹ÙˆÙ…Ø©</p>
                </div>

                <!-- Settings -->
                <div class="mt-6 space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø­Ø³Ø§Ø³ÙŠØ© ÙƒØ´Ù Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±</label>
                        <input type="range" id="sensitivity" min="10" max="100" value="50" class="w-full accent-[#c5a059]">
                        <span id="sensitivity-value" class="text-sm text-gray-600">50</span>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-[#1a472a] mb-2">Ù†Ø·Ø§Ù‚ Hue (Ø§Ù„Ù„ÙˆÙ†)</label>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰:</label>
                                <input type="range" id="hue-min" min="0" max="180" value="0" class="w-full accent-orange-500">
                                <span id="hue-min-value" class="text-xs text-gray-600">0</span>
                            </div>
                            <div>
                                <label class="text-xs">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰:</label>
                                <input type="range" id="hue-max" min="0" max="180" value="30" class="w-full accent-orange-500">
                                <span id="hue-max-value" class="text-xs text-gray-600">30</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <button id="process-btn" disabled class="w-full mt-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:shadow-lg transition disabled:opacity-50">
                    <i class="fas fa-circle-notch"></i>
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØ´Ù
                </button>

                <!-- Method Selection -->
                <div class="mt-4">
                    <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙƒØ´Ù</label>
                    <select id="detection-method" class="w-full p-2 border-2 border-orange-500 rounded-lg text-sm">
                        <option value="hough">Hough Circle (Ø£Ø³Ø±Ø¹)</option>
                        <option value="contour">Contour Detection (Ø£Ø¯Ù‚)</option>
                    </select>
                </div>

                <!-- Loading -->
                <div id="loading" class="hidden mt-6 text-center">
                    <div class="animate-spin inline-block">
                        <i class="fas fa-spinner text-3xl text-green-500"></i>
                    </div>
                    <p id="progress-text" class="mt-2 font-bold text-[#1a472a]">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ´Ù...</p>
                </div>

                <!-- Stats -->
                <div id="stats" class="hidden mt-8 bg-[#fdfbf7] p-4 rounded-lg border border-[#efe9d9] space-y-2">
                    <div class="flex justify-between">
                        <span class="font-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±:</span>
                        <span id="circles-count" class="text-green-600 font-bold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-bold">Ø§Ù„ÙˆÙ‚Øª:</span>
                        <span id="process-time" class="text-[#c5a059] font-bold">-</span>
                    </div>
                </div>
            </div>

            <!-- Preview & Detection -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Original Image -->
                <div class="glass-panel p-6">
                    <h3 class="font-bold text-[#1a472a] mb-3">
                        <i class="fas fa-image text-[#c5a059]"></i> Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                    </h3>
                    <div id="original-container" class="bg-gray-200 rounded-lg flex items-center justify-center min-h-[300px]">
                        <p class="text-gray-500">Ø­Ù…Ù„ ØµÙˆØ±Ø© Ù„ØªØ±Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©</p>
                    </div>
                </div>

                <!-- Processed Image with Circles -->
                <div class="glass-panel p-6">
                    <h3 class="font-bold text-[#1a472a] mb-3">
                        <i class="fas fa-circle text-orange-400"></i> Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ù…ÙƒØªØ´ÙØ©
                    </h3>
                    <div id="processed-container" class="bg-gray-200 rounded-lg flex items-center justify-center min-h-[300px]">
                        <p class="text-gray-500">Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button id="download-processed" disabled class="flex-1 bg-[#c5a059] text-white py-2 rounded-lg font-bold disabled:opacity-50">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden mt-8 glass-panel p-8">
            <h2 class="text-2xl font-bold text-[#1a472a] mb-6">
                <i class="fas fa-list text-[#c5a059]"></i> Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©
                <span id="ayah-count-badge" class="bg-green-500 text-white px-3 py-1 rounded-full text-lg ml-2">0</span>
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8">
                <!-- Ayahs List -->
                <div class="lg:col-span-2">
                    <div id="ayahs-list" class="space-y-2 max-h-[500px] overflow-y-auto">
                    </div>
                </div>

                <!-- Stats Panel -->
                <div class="bg-[#fdfbf7] p-6 rounded-lg border border-[#efe9d9] space-y-3">
                    <h4 class="font-bold text-[#1a472a] mb-4">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
                    <div class="flex justify-between">
                        <span class="text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢ÙŠØ§Øª:</span>
                        <span id="stat-total" class="font-bold text-green-600">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ù…:</span>
                        <span id="stat-avg-size" class="font-bold text-[#c5a059]">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Ø£ÙƒØ¨Ø± Ø¢ÙŠØ©:</span>
                        <span id="stat-max" class="font-bold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Ø£ØµØºØ± Ø¢ÙŠØ©:</span>
                        <span id="stat-min" class="font-bold">-</span>
                    </div>
                </div>
            </div>

            <!-- JSON Export -->
            <div class="bg-[#fdfbf7] p-6 rounded-xl border border-[#efe9d9]">
                <h3 class="font-bold text-[#1a472a] mb-3">
                    <i class="fas fa-code text-[#c5a059]"></i> Ø¨ÙŠØ§Ù†Ø§Øª JSON
                </h3>
                <div class="bg-white border-2 border-[#c5a059] rounded-lg p-4 font-mono text-xs max-h-[250px] overflow-y-auto">
                    <pre id="json-output">{ }</pre>
                </div>
                <div class="flex gap-3 mt-4">
                    <button id="copy-json" class="flex-1 bg-[#1a472a] text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-[#0f2a1a]">
                        <i class="fas fa-copy"></i> Ù†Ø³Ø®
                    </button>
                    <button id="download-json" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-green-700">
                        <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedImage = null;
        let imageData = null;
        let detectedCircles = [];
        let processStartTime = 0;

        // Drag & Drop
        const dropZone = document.getElementById('drop-zone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('drop', (e) => {
            handleFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = file;
                imageData = e.target.result;
                
                const preview = document.getElementById('original-container');
                preview.innerHTML = `<img src="${imageData}" style="max-height: 400px; border-radius: 15px;">`;
                
                document.getElementById('process-btn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Detect Circles Button
        document.getElementById('process-btn').addEventListener('click', () => {
            if (!imageData) return;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('process-btn').disabled = true;
            processStartTime = Date.now();

            // ØªØ´ØºÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø­Ø¬Ø¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            setTimeout(() => {
                const method = document.getElementById('detection-method').value;
                if (method === 'hough') {
                    detectGreenCircles();
                } else {
                    detectCirclesByContour();
                }
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('process-btn').disabled = false;
            }, 100);
        });

        function detectGreenCircles() {
            const img = new Image();
            img.onload = () => {
                // Ø¥Ù†Ø´Ø§Ø¡ canvas Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ OpenCV Mat
                let src = cv.imread(canvas);
                let hsv = new cv.Mat();
                cv.cvtColor(src, hsv, cv.COLOR_BGR2HSV);

                // ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„ØªÙØ§Ø­ÙŠ/Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ (HSV)
                // Ø§Ù„ØªÙØ§Ø­ÙŠ: H=0-30, S>80, V>100
                const hueMin = parseInt(document.getElementById('hue-min').value);
                const hueMax = parseInt(document.getElementById('hue-max').value);
                
                let lowerOrange = cv.matFromArray(3, 1, cv.CV_8U, [hueMin, 80, 100]);
                let upperOrange = cv.matFromArray(3, 1, cv.CV_8U, [hueMax, 255, 255]);

                let mask = new cv.Mat();
                cv.inRangeS(hsv, lowerOrange, upperOrange, mask);

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡ Ø¨Ù‚ÙˆØ© Ø£ÙƒØ¨Ø±
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(7, 7));
                cv.morphologyEx(mask, mask, cv.MORPH_CLOSE, kernel);
                cv.morphologyEx(mask, mask, cv.MORPH_OPEN, kernel);
                
                // Dilation Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
                let kernel2 = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(5, 5));
                cv.dilate(mask, mask, kernel2, new cv.Point(-1, -1), 2);

                // ÙƒØ´Ù Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Hough Circle
                let circles = new cv.Mat();
                const sensitivity = parseInt(document.getElementById('sensitivity').value);

                cv.HoughCircles(
                    mask,
                    circles,
                    cv.HOUGH_GRADIENT,
                    1,          // resolution divisor
                    40,         // Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
                    150,        // Ø¹ØªØ¨Ø© Canny
                    15,         // Ø¹ØªØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ² (Ø£Ù‚Ù„ = Ø£ÙƒØ«Ø± Ø­Ø³Ø§Ø³ÙŠØ©)
                    5,          // Ø£ØµØºØ± Ø¯Ø§Ø¦Ø±Ø©
                    150         // Ø£ÙƒØ¨Ø± Ø¯Ø§Ø¦Ø±Ø©
                );

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
                detectedCircles = [];
                for (let i = 0; i < circles.cols; i++) {
                    const x = circles.data32F[i * 3];
                    const y = circles.data32F[i * 3 + 1];
                    const radius = circles.data32F[i * 3 + 2];

                    detectedCircles.push({
                        id: i + 1,
                        x: Math.round(x),
                        y: Math.round(y),
                        radius: Math.round(radius),
                        width: Math.round(radius * 2),
                        height: Math.round(radius * 2)
                    });
                }

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ù…Ù† Ø£Ø¹Ù„Ù‰ Ù„Ø£Ø³ÙÙ„
                detectedCircles.sort((a, b) => a.y - b.y);
                
                // Ø±Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                drawCirclesOnImage(img, canvas);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                document.getElementById('circles-count').innerText = detectedCircles.length;
                document.getElementById('stats').classList.remove('hidden');
                
                const elapsed = ((Date.now() - processStartTime) / 1000).toFixed(2);
                document.getElementById('process-time').innerText = elapsed + 's';

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                if (detectedCircles.length > 0) {
                    displayDetectedCircles();
                } else {
                    alert('âš ï¸ Ù„Ù… ÙŠØªÙ… ÙƒØ´Ù Ø¯ÙˆØ§Ø¦Ø±! Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù†Ø·Ø§Ù‚ Hue');
                }

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                src.delete();
                hsv.delete();
                lowerOrange.delete();
                upperOrange.delete();
                mask.delete();
                kernel.delete();
                kernel2.delete();
                circles.delete();
            };
            img.src = imageData;
        }

        function drawCirclesOnImage(img, sourceCanvas) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            // Ø±Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø¨Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ©
            detectedCircles.forEach((circle, index) => {
                // Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
                ctx.strokeStyle = '#ff6b35';  // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù‚ÙˆÙŠ
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI);
                ctx.stroke();

                // Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©
                ctx.fillStyle = '#ff6b35';
                ctx.font = 'bold 20px Arial';
                ctx.fillText(circle.id, circle.x - 8, circle.y + 6);

                // Ø§Ù„Ù…Ø±ÙƒØ²
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });

            const processedContainer = document.getElementById('processed-container');
            processedContainer.innerHTML = `<img src="${canvas.toDataURL()}" style="max-height: 400px; border-radius: 15px;">`;
            
            document.getElementById('download-processed').disabled = false;
            document.getElementById('download-processed').onclick = () => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL();
                a.download = 'detected_circles.png';
                a.click();
            };
        }

        function detectCirclesByContour() {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                let src = cv.imread(canvas);
                let hsv = new cv.Mat();
                cv.cvtColor(src, hsv, cv.COLOR_BGR2HSV);

                // Ù†Ø·Ø§Ù‚ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„ØªÙØ§Ø­ÙŠ
                const hueMin = parseInt(document.getElementById('hue-min').value);
                const hueMax = parseInt(document.getElementById('hue-max').value);
                
                let lowerOrange = cv.matFromArray(3, 1, cv.CV_8U, [hueMin, 80, 100]);
                let upperOrange = cv.matFromArray(3, 1, cv.CV_8U, [hueMax, 255, 255]);

                let mask = new cv.Mat();
                cv.inRangeS(hsv, lowerOrange, upperOrange, mask);

                // ØªÙ†Ø¸ÙŠÙ Ù‚ÙˆÙŠ
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(7, 7));
                cv.morphologyEx(mask, mask, cv.MORPH_CLOSE, kernel);
                cv.morphologyEx(mask, mask, cv.MORPH_OPEN, kernel);

                // ÙƒØ´Ù Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(mask, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);

                detectedCircles = [];
                let circleId = 1;

                for (let i = 0; i < contours.size(); i++) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    
                    // ØªØµÙÙŠØ© Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙˆØ§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
                    if (area < 200 || area > 10000) continue;

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£ÙØ¶Ù„
                    let moment = cv.moments(cnt);
                    let cx = moment.m10 / moment.m00;
                    let cy = moment.m01 / moment.m00;
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ØµØºØ± Ø¯Ø§Ø¦Ø±Ø© Ù…Ø­ÙŠØ·Ø©
                    let center = new cv.Point(cx, cy);
                    let radius = Math.sqrt(area / Math.PI);

                    // ØªØµÙÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
                    if (radius < 5) continue;

                    detectedCircles.push({
                        id: circleId++,
                        x: Math.round(cx),
                        y: Math.round(cy),
                        radius: Math.round(radius),
                        width: Math.round(radius * 2),
                        height: Math.round(radius * 2)
                    });

                    cnt.delete();
                }

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
                detectedCircles.sort((a, b) => a.y - b.y);

                drawCirclesOnImage(img, canvas);

                document.getElementById('circles-count').innerText = detectedCircles.length;
                document.getElementById('stats').classList.remove('hidden');
                
                const elapsed = ((Date.now() - processStartTime) / 1000).toFixed(2);
                document.getElementById('process-time').innerText = elapsed + 's';

                if (detectedCircles.length > 0) {
                    displayDetectedCircles();
                } else {
                    alert('âš ï¸ Ù„Ù… ÙŠØªÙ… ÙƒØ´Ù Ø¯ÙˆØ§Ø¦Ø±! Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù†Ø·Ø§Ù‚ Hue');
                }

                src.delete();
                hsv.delete();
                lowerOrange.delete();
                upperOrange.delete();
                mask.delete();
                kernel.delete();
                contours.delete();
                hierarchy.delete();
            };
            img.src = imageData;
        }

        
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('ayah-count-badge').innerText = detectedCircles.length;
            document.getElementById('stat-total').innerText = detectedCircles.length;

            const sizes = detectedCircles.map(c => c.radius * 2);
            const avgSize = Math.round(sizes.reduce((a, b) => a + b) / sizes.length);
            document.getElementById('stat-avg-size').innerText = avgSize + 'px';
            document.getElementById('stat-max').innerText = Math.max(...sizes) + 'px';
            document.getElementById('stat-min').innerText = Math.min(...sizes) + 'px';

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
            const list = document.getElementById('ayahs-list');
            list.innerHTML = detectedCircles.map(circle => `
                <div class="ayah-box" onclick="highlightCircle(${circle.id})">
                    <div class="font-bold text-green-600">Ø¢ÙŠØ© ${circle.id}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        Ø§Ù„Ù…ÙˆÙ‚Ø¹: (${circle.x}, ${circle.y})
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        Ø§Ù„Ù‚Ø·Ø±: ${circle.radius * 2}px
                    </div>
                </div>
            `).join('');

            // JSON
            const jsonData = {
                timestamp: new Date().toISOString(),
                total_circles: detectedCircles.length,
                circles: detectedCircles
            };
            document.getElementById('json-output').innerText = JSON.stringify(jsonData, null, 2);
        }

        function highlightCircle(id) {
            document.querySelectorAll('.ayah-box').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // Copy & Download JSON
        document.getElementById('copy-json').addEventListener('click', () => {
            const json = document.getElementById('json-output').innerText;
            navigator.clipboard.writeText(json).then(() => {
                alert('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!');
            });
        });

        document.getElementById('download-json').addEventListener('click', () => {
            const json = document.getElementById('json-output').innerText;
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'circles_data.json';
            a.click();
        });

        // Sliders
        document.getElementById('sensitivity').addEventListener('input', (e) => {
            document.getElementById('sensitivity-value').innerText = e.target.value;
        });

        document.getElementById('hue-min').addEventListener('input', (e) => {
            document.getElementById('hue-min-value').innerText = e.target.value;
        });

        document.getElementById('hue-max').addEventListener('input', (e) => {
            document.getElementById('hue-max-value').innerText = e.target.value;
        });

        // Wait for OpenCV
        function onOpenCvReady() {
            console.log('âœ… OpenCV Ø¬Ø§Ù‡Ø²!');
        }
    </script>
</body>
</html>
