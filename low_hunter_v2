import requests
import sys
import os
from datetime import datetime
from dotenv import load_dotenv
import yfinance as yf
import time

# ==============================================================================
# ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
# ==============================================================================
load_dotenv()

TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

# ==============================================================================
# ğŸ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
# ==============================================================================
MAX_FLOAT = 10_000_000         # ÙÙ„ÙˆØª Ø£Ù‚Ù„ Ù…Ù† 10 Ù…Ù„ÙŠÙˆÙ†
MAX_DISTANCE_FROM_LOW = 15     # Ø£Ù‚ØµÙ‰ Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹: 15%
MIN_VOLUME = 50_000            # Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙÙˆÙ„ÙŠÙˆÙ…

# Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ù‡Ù… Low Float Ù…Ø¹Ø±ÙˆÙØ© + Ø£Ø³Ù‡Ù… Ù†Ø´Ø·Ø©
LOW_FLOAT_STOCKS = [
    # Penny stocks Ù…Ø¹Ø±ÙˆÙØ©
    'CLOV', 'SOFI', 'PLTR', 'NIO', 'LCID', 'RIVN', 'FSR', 'GOEV',
    'TLRY', 'ACB', 'SNDL', 'CGC', 'HEXO', 'GRWG',
    'BB', 'NOK', 'WISH', 'CENN', 'FFIE', 'NKLA',
    'PLUG', 'FCEL', 'BE', 'BLDP', 'HYLN',
    'SPCE', 'RKLB', 'ASTR', 'RDW', 'ASTS',
    'DNA', 'IONQ', 'RGTI', 'QUBT',
    'LAZR', 'LIDR', 'MVIS', 'VLDR',
    'WKHS', 'RIDE', 'ARVL', 'PSNY',
    'OPEN', 'RDFN', 'COMP', 'EXPI',
    'CRSP', 'EDIT', 'NTLA', 'BEAM',
    'AI', 'BIGC', 'SNOW', 'PATH',
    # Ø£Ø³Ù‡Ù… Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ø³Ø¹Ø±
    'AMC', 'GME', 'BBBY', 'EXPR', 'KOSS',
    'NAKD', 'CTRM', 'ZOM', 'IDEX', 'GEVO',
    'OCGN', 'BNGO', 'SENS', 'CLVS', 'TRVN',
    'MARA', 'RIOT', 'HUT', 'BITF', 'HIVE',
    'DPST', 'FAZ', 'LABU', 'LABD', 'NUGT',
    'JNUG', 'DUST', 'DRIP', 'GUSH',
    # Ø£Ø³Ù‡Ù… ØªØ­Øª $10
    'F', 'SNAP', 'PINS', 'HOOD', 'COIN',
    'DKNG', 'PENN', 'SKLZ', 'PTRA',
    'TELL', 'RIG', 'SWN', 'AR', 'RRC',
    'AAL', 'UAL', 'DAL', 'SAVE', 'JBLU',
    # Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯
    'XELA', 'PROG', 'ATER', 'BBIG', 'SPRT',
    'IRNT', 'TMC', 'SDC', 'BODY', 'TALK'
]

def log(msg):
    print(f"[{datetime.now().strftime('%H:%M:%S')}] {msg}")
    sys.stdout.flush()

def send_telegram(message):
    if not TELEGRAM_BOT_TOKEN: return
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": message, "parse_mode": "Markdown"}
        resp = requests.post(url, json=payload, timeout=10)
        if not resp.json().get('ok'):
            log(f"âŒ Ø®Ø·Ø£ ØªÙ„ÙŠØ¬Ø±Ø§Ù…: {resp.json()}")
    except Exception as e:
        log(f"âŒ Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„: {e}")

def format_float(num):
    """ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ„ÙˆØª Ø¨Ø´ÙƒÙ„ Ù…Ù‚Ø±ÙˆØ¡"""
    if not num: return "N/A"
    if num >= 1_000_000_000:
        return f"{num/1_000_000_000:.2f}B"
    if num >= 1_000_000:
        return f"{num/1_000_000:.2f}M"
    elif num >= 1_000:
        return f"{num/1_000:.0f}K"
    return str(int(num))

def run_support_hunter_strategy():
    log("ğŸ”µ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø£Ø³Ù‡Ù… Ø¹Ø¨Ø± Yahoo Finance...")
    log(f"   ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ù„ÙØ­Øµ: {len(LOW_FLOAT_STOCKS)}")
    
    final_matches = []
    checked = 0
    
    for symbol in LOW_FLOAT_STOCKS:
        checked += 1
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info
            
            # ØªØ¬Ø§Ù‡Ù„ ETFs
            quote_type = info.get('quoteType', '')
            if quote_type in ['ETF', 'MUTUALFUND', 'INDEX']:
                continue
            
            price = info.get('currentPrice') or info.get('regularMarketPrice') or info.get('previousClose', 0)
            year_low = info.get('fiftyTwoWeekLow', 0)
            volume = info.get('volume', 0) or info.get('regularMarketVolume', 0)
            float_shares = info.get('floatShares', 0)
            
            if not price or not year_low or price <= 0:
                continue
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
            distance = ((price - year_low) / year_low) * 100
            
            # ÙÙ„ØªØ±Ø©
            if distance <= MAX_DISTANCE_FROM_LOW:
                # ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„ÙÙ„ÙˆØª Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
                if float_shares == 0 or float_shares <= MAX_FLOAT:
                    final_matches.append({
                        'symbol': symbol,
                        'price': price,
                        'year_low': year_low,
                        'float': float_shares,
                        'distance': distance,
                        'volume': volume,
                        'change': info.get('regularMarketChangePercent', 0)
                    })
                    log(f"   ğŸ¯ {symbol} | ${price:.2f} | Dist: {distance:.1f}% | Float: {format_float(float_shares)}")
            
            # ØªÙ‚Ø¯Ù… ÙƒÙ„ 20 Ø³Ù‡Ù…
            if checked % 20 == 0:
                log(f"   â³ ØªÙ… ÙØ­Øµ {checked}/{len(LOW_FLOAT_STOCKS)} Ø³Ù‡Ù…...")
                
        except Exception as e:
            continue
    
    # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
    final_matches.sort(key=lambda x: x['distance'])
    
    if final_matches:
        log(f"âœ… ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ {len(final_matches)} Ø³Ù‡Ù… Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹.")
        
        # ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ…
        high_vol = [s for s in final_matches if s['volume'] >= MIN_VOLUME]
        
        if high_vol:
            msg = "ğŸ”¥ğŸ’ *ØµÙŠØ§Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†* ğŸ’ğŸ”¥\n"
            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            msg += f"ğŸ“… {datetime.now().strftime('%H:%M')} | ğŸ¯ Near Low\n"
            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            
            for s in high_vol[:10]:
                icon = "ğŸ”¥" if s['distance'] < 5 else "âœ…"
                chg_icon = "ğŸ“ˆ" if s['change'] >= 0 else "ğŸ“‰"
                msg += f"{icon} *{s['symbol']}* | ${s['price']:.2f}\n"
                msg += f"ğŸ“‰ Ù‚Ø§Ø¹: ${s['year_low']:.2f} | ğŸ“ {s['distance']:.1f}%\n"
                msg += f"ğŸª¶ {format_float(s['float'])} | ğŸ“Š Vol: {format_float(s['volume'])}\n"
                msg += f"{chg_icon} Change: {s['change']:.1f}%\n"
                msg += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
            
            msg += f"\nâœ… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {len(high_vol)} Ø³Ù‡Ù…"
            send_telegram(msg)
            log("ğŸ“¬ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù….")
        else:
            log("âš ï¸ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ÙƒÙ† Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… Ø¶Ø¹ÙŠÙ Ø¬Ø¯Ø§Ù‹.")
            
        # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
        print("\n" + "="*70)
        print(f"ğŸ¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ({len(final_matches)} Ø³Ù‡Ù…):")
        print("="*70)
        print(f"{'Symbol':<8} | {'Price':<8} | {'Low':<8} | {'Dist%':<6} | {'Float':<10} | {'Volume':<10}")
        print("-"*70)
        for s in final_matches[:20]:
            print(f"  {s['symbol']:<6} | ${s['price']:<6.2f} | ${s['year_low']:<6.2f} | {s['distance']:<5.1f}% | {format_float(s['float']):<9} | {format_float(s['volume'])}")
        print("="*70)

    else:
        log("ğŸ¢ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ù‡Ù… Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹.")

# ==============================================================================
# Ø§Ù„ØªØ´ØºÙŠÙ„
# ==============================================================================
def main():
    print("="*50)
    print("ğŸ¤– LOW FLOAT HUNTER v2 (Yahoo Finance)")
    print("="*50)
    run_support_hunter_strategy()
    print("âœ… Done.")

if __name__ == "__main__":
    main()
