import pandas as pd
import warnings
from datetime import datetime, time
import requests
import os
import json
import time as time_module
import pytz
from dotenv import load_dotenv
from concurrent.futures import ThreadPoolExecutor

# =========================================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ´ØºÙŠÙ„ (FMP STABLE VERSION)
# =========================================================
load_dotenv()
API_KEY = os.getenv("FMP_API_KEY", "AzN1tXfit4MUgxLSvWO73Wusjz8f2v21")

TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

warnings.simplefilter(action='ignore', category=FutureWarning)
FLOAT_CACHE_FILE = "float_cache.json"
SHARIAH_FILE = "shariah_stocks_master.json"
CANDLES_DATA_FILE = "candles_data.json"
SUCCESSFUL_PATTERNS_FILE = "successful_patterns.json"

# ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±Ø¹ÙŠØ©
def load_shariah_db():
    if os.path.exists(SHARIAH_FILE):
        try:
            with open(SHARIAH_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except: return {}
    return {}

shariah_db = load_shariah_db()
print(f"ğŸ•Œ ØªÙ… ØªØ­Ù…ÙŠÙ„ {len(shariah_db)} Ø³Ù‡Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±Ø¹ÙŠØ©.")

# =========================================================
# 2. Ø£Ø¯ÙˆØ§Øª Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# =========================================================
def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r') as f:
                return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f:
            json.dump(data, f, indent=4)
    except: pass

float_data_store = load_json_file(FLOAT_CACHE_FILE)

def get_country_flag(symbol):
    try:
        url = f"https://financialmodelingprep.com/stable/profile/{symbol}"
        params = {'apikey': API_KEY}
        data = requests.get(url, params=params, timeout=5).json()
        if data and isinstance(data, list) and len(data) > 0:
            country = data[0].get('country', 'US')
            if len(country) == 2:
                return "".join([chr(ord(c.upper()) + 127397) for c in country])
    except: pass
    return "ğŸ‡ºğŸ‡¸"

def get_float_shares(symbol):
    global float_data_store
    val = float_data_store.get(symbol)
    if isinstance(val, (int, float)) and val > 0:
        return val

    try:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„ÙÙ„ÙˆØª Ù…Ù† FMP Stable
        url = f"https://financialmodelingprep.com/stable/shares-float"
        params = {'symbol': symbol, 'apikey': API_KEY}
        data = requests.get(url, params=params, timeout=5).json()
        if data and isinstance(data, list) and len(data) > 0:
            float_val = data[0].get('floatShares', 0)
            # ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„ÙŠØ³Øª None
            if float_val:
                try:
                    val = float(float_val)
                    if val > 0:
                        float_data_store[symbol] = val
                        save_json_file(FLOAT_CACHE_FILE, float_data_store)
                        return val
                except (ValueError, TypeError):
                    return 0
    except Exception as e:
        pass
    return 0

def get_fmp_data(symbol, target_date):
    """Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ 1 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† FMP ÙˆØªØ¬Ù…ÙŠØ¹Ù‡Ø§ Ø¥Ù„Ù‰ 5 Ø¯Ù‚Ø§Ø¦Ù‚"""
    try:
        date_str = target_date.strftime('%Y-%m-%d')
        # Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© (1-minute candles)
        url = "https://financialmodelingprep.com/stable/historical-chart/1min"
        params = {
            'symbol': symbol,
            'apikey': API_KEY,
            'from': date_str,
            'to': date_str
        }

        r = requests.get(url, params=params, timeout=10)
        if r.status_code != 200:
            return pd.DataFrame()

        data = r.json()
        if not data or not isinstance(data, list):
            return pd.DataFrame()

        df = pd.DataFrame(data)
        if df.empty:
            return pd.DataFrame()

        df['date'] = pd.to_datetime(df['date'])
        df = df.set_index('date').sort_index()

        # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙˆÙ‚ÙŠØª Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ
        if df.index.tz is None:
            df.index = df.index.tz_localize('UTC')
        df.index = df.index.tz_convert('America/New_York')

        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        df.rename(columns={'open': 'Open', 'high': 'High', 'low': 'Low',
                          'close': 'Close', 'volume': 'Volume'}, inplace=True)
        
        # ØªØ¬Ù…ÙŠØ¹ Ø´Ù…ÙˆØ¹ 1-Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ù„Ù‰ Ø´Ù…ÙˆØ¹ 5-Ø¯Ù‚Ø§Ø¦Ù‚
        df_5min = df.resample('5T').agg({
            'Open': 'first',
            'High': 'max',
            'Low': 'min',
            'Close': 'last',
            'Volume': 'sum'
        }).dropna()
        
        return df_5min
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª {symbol}: {str(e)}")
        return pd.DataFrame()

def get_screener_stocks():
    """Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† Finviz Elite"""
    FINVIZ_COOKIE = """chartsTheme=dark; notice-newsletter=show; .ASPXAUTH=C7E2E86BC876CD078E1DC69C25671D062A909C67501ECF211333FAAD7F54A40FE9B6772EF4E88ED21E26C6C99BCAE5C39C5C8D598CD73357A5FCB4B556AD83E55002A827606EFFFE1F1315C9E8A4E05BC99B517D7E533905EE95F029D8FE0B930EC18E2E5F5037693AE688694BFDFDD82DADE25BA4063B448D18DDC85EAB40FD9D717716F2FEABA2A813D932072BFF5C6F723BACD8D3E4CA5161C3B1E0FF3088C9CC8AA7E67C3A4C94EA5122A68D9ADC7F85B091D98A31BF66F654490F1F7601FA7E420E3ECAF266BF62C1A7C9733A57BC866F92; survey_dialog_cohort=0; customColors=%7B%22light%22%3A%7B%7D%2C%22dark%22%3A%7B%7D%7D; customColorsExpiration=12%2F12%2F2025%208%3A11%3A59%20PM"""

    FINVIZ_HEADERS = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Cookie": FINVIZ_COOKIE
    }

    try:
        import io
        url = (
            "https://elite.finviz.com/export.ashx?v=111"
            "&f=sh_price_u11,sh_float_u15,sh_curvol_o50,ta_change_u"
            "&o=-volume"
        )

        response = requests.get(url, headers=FINVIZ_HEADERS, timeout=15)
        if response.status_code == 200:
            csv_data = io.StringIO(response.text)
            df = pd.read_csv(csv_data)
            if 'Ticker' in df.columns and 'Price' in df.columns:
                df = df[(df['Price'] >= 0.02) & (df['Price'] <= 11.0)]
                tickers = df['Ticker'].head(300).tolist()
                print(f"âœ… ØªÙ… Ø¬Ù„Ø¨ {len(tickers)} Ø³Ù‡Ù… Ù…Ù† Finviz Elite")
                return tickers
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù…: {str(e)}")

    return []

# =========================================================
# 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ÙØ±Ø²
# =========================================================
def evaluate_liquidity(volume, float_val):
    if not float_val or float_val == 0:
        return "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±", 0
    rotation_pct = (volume / float_val) * 100
    if rotation_pct >= 5.0:
        return "ğŸ”¥ğŸ”¥ Ø§Ù†ÙØ¬Ø§Ø±", rotation_pct
    elif rotation_pct >= 2.0:
        return "ğŸ”¥ Ù…Ù…ØªØ§Ø²", rotation_pct
    elif rotation_pct >= 0.5:
        return "âœ… Ù†Ø´Ø·", rotation_pct
    return "ğŸ’¤ Ø¶Ø¹ÙŠÙ", rotation_pct

def get_shariah_label(symbol):
    data = shariah_db.get(symbol)
    return "âœ… Ø­Ù„Ø§Ù„" if data and data.get('status') == 'halal' else "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±"

def check_ladder_pattern(df_window, float_val):
    """
    ÙØ­Øµ Ù†Ù…Ø· Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ - Ù†ÙØ³ Ø§Ù„Ø´Ø±ÙˆØ· Ù…Ù† backtest_strategies.py
    
    Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (4 Ø´Ø±ÙˆØ· ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ­Ù‚Ù‚ Ø¬Ù…ÙŠØ¹Ø§Ù‹):
    1. Ø§Ù„Ø´Ù…Ø¹Ø© 2: Close > Open (Ø®Ø¶Ø±Ø§Ø¡)
    2. Ø§Ù„Ø´Ù…Ø¹Ø© 3: Close > Open (Ø®Ø¶Ø±Ø§Ø¡)
    3. High3 >= High2 >= High1 (Ù‚Ù…Ù… ØµØ§Ø¹Ø¯Ø©)
    4. Low3 >= Low2 >= Low1 (Ù‚ÙŠØ¹Ø§Ù† ØµØ§Ø¹Ø¯Ø©)
    """
    if len(df_window) < 3:
        return False, 0, 0, "Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ù„ÙŠÙ„Ø©"

    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 3 Ø´Ù…ÙˆØ¹
        recent = df_window.tail(3).reset_index(drop=True)
        candles = recent.to_dict('records')
        
        c1 = candles[0]  # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„Ø£Ù‚Ø¯Ù…)
        c2 = candles[1]  # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
        c3 = candles[2]  # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø§Ù„Ø£Ø­Ø¯Ø«)
        
        # Ø§Ù„Ø´Ø±Ø· 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ù…Ø¹ØªÙŠÙ† Ø§Ù„Ø£Ø®ÙŠØ±ØªÙŠÙ† Ø®Ø¶Ø±Ø§ÙˆØªÙŠÙ†
        if not (c2['Close'] > c2['Open'] and c3['Close'] > c3['Open']):
            return False, 0, 0, "Ø´Ù…ÙˆØ¹ Ø­Ù…Ø±Ø§Ø¡"
        
        # Ø§Ù„Ø´Ø±Ø· 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ù…Ù… Ø§Ù„ØµØ§Ø¹Ø¯Ø©
        if not (c3['High'] >= c2['High'] and c2['High'] >= c1['High']):
            return False, 0, 0, "Ù‚Ù…Ù… ØºÙŠØ± ØµØ§Ø¹Ø¯Ø©"
        
        # Ø§Ù„Ø´Ø±Ø· 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† Ø§Ù„ØµØ§Ø¹Ø¯Ø©
        if not (c3['Low'] >= c2['Low'] and c2['Low'] >= c1['Low']):
            return False, 0, 0, "Ù‚ÙŠØ¹Ø§Ù† ØºÙŠØ± ØµØ§Ø¹Ø¯Ø©"
        
        # Ø§Ù„Ø´Ø±Ø· 4: Ø­Ø³Ø§Ø¨ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¨Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ù…Ù†Ø·Ù‚ÙŠ
        high_range = c3['High'] - c1['High']
        low_range = c3['Low'] - c1['Low']
        strength = 0
        # Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        strength += 15 if c2['Close'] > c2['Open'] else 0
        strength += 15 if c3['Close'] > c3['Open'] else 0
        strength += 15 if (c3['High'] >= c2['High'] and c2['High'] >= c1['High']) else 0
        strength += 15 if (c3['Low'] >= c2['Low'] and c2['Low'] >= c1['Low']) else 0
        # Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ù…Ø·
        body1 = abs(c1['Close'] - c1['Open'])
        body2 = abs(c2['Close'] - c2['Open'])
        body3 = abs(c3['Close'] - c3['Open'])
        avg_body = (body1 + body2 + body3) / 3
        wick1 = c1['High'] - c1['Low'] - body1
        wick2 = c2['High'] - c2['Low'] - body2
        wick3 = c3['High'] - c3['Low'] - body3
        avg_wick = (wick1 + wick2 + wick3) / 3
        # Ø£Ø¬Ø³Ø§Ù… ØµØºÙŠØ±Ø© ÙˆÙ†Ø¸ÙŠÙØ©
        if avg_body > 0 and avg_body < (c1['Close'] * 0.01):
            strength += 10
        # Ø´Ù…ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø°ÙŠÙˆÙ„ Ø·ÙˆÙŠÙ„Ø©
        if avg_wick < (c1['Close'] * 0.005):
            strength += 10
        # Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù‚ÙˆÙŠØ©
        if body1 > 0 and body1 > (c1['Close'] * 0.005):
            strength += 10
        # Ø®ØµÙ… Ø¥Ø°Ø§ ÙÙŠÙ‡ ØªÙ‚Ù„Ø¨Ø§Øª ÙƒØ¨ÙŠØ±Ø©
        if avg_wick > (c1['Close'] * 0.03):
            strength -= 10
        # Ø®ØµÙ… Ø¥Ø°Ø§ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹
        if body1 < (c1['Close'] * 0.002):
            strength -= 10
        # ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‚ÙˆØ© Ø¨ÙŠÙ† 0 Ùˆ 100
        strength = max(0, min(100, int(strength)))
        
        morning_high = c3['High']
        return True, strength, morning_high, "Ù†Ù…ÙˆØ°Ø¬ Ø³Ù„ÙŠÙ…"

    except Exception as e:
        return False, 0, 0, f"Ø®Ø·Ø£: {str(e)}"

def send_telegram(message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…"""
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {
            'chat_id': TELEGRAM_CHAT_ID,
            'text': message,
            'parse_mode': 'Markdown'
        }
        requests.post(url, json=payload, timeout=5)
    except Exception as e:
        print(f"âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…: {str(e)}")

# =========================================================
# 4. ÙˆØ¸ÙŠÙØ© ÙØ­Øµ Ø§Ù„Ø³Ù‡Ù… Ø§Ù„ÙˆØ§Ø­Ø¯ (Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠ)
# =========================================================
def analyze_stock(symbol, now_ny):
    """ÙØ­Øµ Ø³Ù‡Ù… ÙˆØ§Ø­Ø¯ - ØªØ´ØºÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ø¢Ù…Ù†"""
    try:
        df = get_fmp_data(symbol, now_ny)
        if df.empty:
            return None

        # ÙÙ„ØªØ± Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† 9:30 Ø¥Ù„Ù‰ 10:00 (Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„ÙŠ)
        mask = (df.index.time >= time(9, 30)) & (df.index.time <= time(10, 0))
        setup = df[mask]

        if setup.empty or len(setup) < 3:
            return None

        # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ ÙÙŠ Ù…Ù„Ù Ù…Ø³ØªÙ‚Ù„
        candles_dict = {
            symbol: [
                {
                    'time': str(idx),
                    'open': float(row['Open']),
                    'high': float(row['High']),
                    'low': float(row['Low']),
                    'close': float(row['Close']),
                    'volume': float(row['Volume'])
                }
                for idx, row in setup.iterrows()
            ]
        }

        float_val = get_float_shares(symbol)
        is_valid, strength, high, reason = check_ladder_pattern(setup, float_val)

        if is_valid:
            vol_sum = setup['Volume'].sum()
            liq_msg, liq_pct = evaluate_liquidity(vol_sum, float_val)

            # Ù„Ø§ Ù†Ø³ØªØ¨Ø¹Ø¯ Ø§Ù„Ø³Ù‡Ù… Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ùˆ ÙÙ„ÙˆØª
            # ÙÙ‚Ø· Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ„ÙˆØª Ù…ØªÙˆÙØ± ÙˆØ¶Ø¹ÙŠÙ Ø¬Ø¯Ø§Ù‹
            if float_val > 0 and liq_pct < 0.2:
                return None

            current_p = float(setup['Close'].iloc[-1])
            shariah = get_shariah_label(symbol)
            flag = get_country_flag(symbol)

            action = "ğŸš€ Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±" if current_p >= high * 0.99 else f"âœ‹ Ù…Ø¹Ù„Ù‚: ${high+0.01:.3f}"
            stars = "â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸" if strength >= 90 else ("â­ï¸â­ï¸â­ï¸" if strength >= 70 else "â­ï¸")

            msg = (
                f"ğŸªœ **Ø³Ù„Ù… ØµØ§Ø¹Ø¯**\n"
                f"ğŸ”‹ **Ø§Ù„Ù‚ÙˆØ©:** {strength}% {stars}\n\n"
                f"ğŸ†: *{symbol}* {flag}\n"
                f"ğŸ’µ: ${current_p:.3f} | ğŸ¯: ${high:.3f}\n"
                f"ğŸ’§: {liq_msg} ({liq_pct:.1f}%)\n"
                f"âš–ï¸: {shariah}\n"
                f"---------------------------\n"
                f"{action}"
            )

            # Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹
            return (symbol, strength, msg, candles_dict, {
                'symbol': symbol,
                'strength': strength,
                'current_price': current_p,
                'high': high,
                'liquidity': liq_msg,
                'liquidity_pct': liq_pct,
                'shariah': shariah,
                'flag': flag,
                'candles': candles_dict[symbol]
            })
    except Exception as e:
        pass
    
    return None

# =========================================================
# 5. Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# =========================================================
def wait_for_10_02_am():
    """
    Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø© 10:02 AM Ù…Ù† Ø¢Ø®Ø± ÙŠÙˆÙ… ØªØ¯Ø§ÙˆÙ„ (weekday ÙÙ‚Ø·)
    - Ø¥Ø°Ø§ Ø´ØºÙ„Øª Ù‚Ø¨Ù„ 10:02 AM â†’ Ø§Ù†ØªØ¸Ø±
    - Ø¥Ø°Ø§ Ø´ØºÙ„Øª Ø¨Ø¹Ø¯ 10:02 AM â†’ Ø¬Ù„Ø¨ Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
    - Ø§Ù„ÙˆÙŠÙƒÙ†Ø¯ (Ø§Ù„Ø³Ø¨Øª/Ø§Ù„Ø£Ø­Ø¯) â†’ Ø§Ù†ØªØ¸Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ
    """
    ny_tz = pytz.timezone('America/New_York')
    target_time = time(10, 2, 0)  # 10:02:00 AM
    
    while True:
        now_ny = datetime.now(ny_tz)
        current_time = now_ny.time()
        current_day = now_ny.weekday()  # 0=Ø§Ù„Ø§Ø«Ù†ÙŠÙ†ØŒ 5=Ø§Ù„Ø¬Ù…Ø¹Ø©ØŒ 6=Ø§Ù„Ø³Ø¨Øª
        is_weekend = current_day >= 5  # Ø§Ù„Ø³Ø¨Øª Ø£Ùˆ Ø§Ù„Ø£Ø­Ø¯
        
        # âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… weekday (Ø§Ù„Ø§Ø«Ù†ÙŠÙ†-Ø§Ù„Ø¬Ù…Ø¹Ø©)
        if not is_weekend:
            # Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ²Ù†Ø§ Ø§Ù„Ø³Ø§Ø¹Ø© 10:02 â†’ Ø´ØªØºÙ‘Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…
            if current_time >= target_time:
                print(f"âœ… Ø§Ù„ÙŠÙˆÙ… ÙŠÙˆÙ… ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ¬Ø§ÙˆØ²Ù†Ø§ 10:02 AM! Ø§Ù„ÙˆÙ‚Øª: {current_time}")
                print(f"ğŸ”™ Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø© 10:02 AM Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…...")
                return now_ny.date()
            
            # Ø¥Ø°Ø§ Ù„Ù… Ù†ØµÙ„ 10:02 Ø¨Ø¹Ø¯ â†’ Ø§Ù†ØªØ¸Ø±
            else:
                wait_seconds = (
                    datetime.combine(now_ny.date(), target_time) - 
                    datetime.combine(now_ny.date(), current_time)
                ).total_seconds()
                print(f"â³ Ø§Ù„ÙŠÙˆÙ… weekday - Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ 10:02 AM... ({int(wait_seconds)} Ø«Ø§Ù†ÙŠØ©)")
                time_module.sleep(min(60, wait_seconds))
        
        # âŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙŠÙƒÙ†Ø¯ (Ø§Ù„Ø³Ø¨Øª Ø£Ùˆ Ø§Ù„Ø£Ø­Ø¯)
        else:
            days_until_monday = (7 - current_day) % 7
            if days_until_monday == 0:
                days_until_monday = 7
            
            print(f"â° Ø§Ù„ÙŠÙˆÙ… ÙˆÙŠÙƒÙ†Ø¯ ({['Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯'][current_day]})")
            print(f"â³ Ø§Ù„Ø³ÙˆÙ‚ Ù…ØºÙ„Ù‚ - Ø³Ù†Ù†ØªØ¸Ø± {days_until_monday} Ø£ÙŠØ§Ù… Ø­ØªÙ‰ ÙŠÙˆÙ… Ø§Ù„ØªØ¯Ø§ÙˆÙ„...")
            time_module.sleep(86400)  # Ø§Ù†ØªØ¸Ø± 24 Ø³Ø§Ø¹Ø©

def main():
    ny_tz = pytz.timezone('America/New_York')
    
    print("="*50)
    print(f"ğŸ›¡ï¸ MORNING SCANNER (FMP 1-MIN TO 5-MIN)")
    print("="*50)
    print("â° Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...")
    print("ğŸ“ Ø³ÙŠØ¨Ø¯Ø£ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© 10:02 AM Ø¨ØªÙˆÙ‚ÙŠØª Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ")
    
    # Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ Ø§Ù„Ø³Ø§Ø¹Ø© 10:02 AM
    target_date = wait_for_10_02_am()
    
    now_ny = datetime.now(ny_tz)
    print("="*50)
    print(f"ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„!")
    print(f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {now_ny.strftime('%Y-%m-%d %A')}")
    print(f"â° Ø§Ù„ÙˆÙ‚Øª: {now_ny.strftime('%H:%M:%S')} NY")
    print("="*50)

    # Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù‡Ù…
    tickers = get_screener_stocks()
    if not tickers:
        print("âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø£ÙŠ Ø£Ø³Ù‡Ù…")
        return

    print(f"\nğŸš€ Ø¨Ø¯Ø¡ ÙØ­Øµ {len(tickers)} Ø³Ù‡Ù… Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ...")
    matches = 0
    successful_stocks = []
    all_candles = {}

    # ÙØ­Øµ Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ (10 Ø£Ø³Ù‡Ù… ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª)
    with ThreadPoolExecutor(max_workers=10) as executor:
        results = list(executor.map(lambda s: analyze_stock(s, now_ny), tickers))
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    for res in results:
        if res:
            symbol, strength, msg, candles_dict, success_data = res
            send_telegram(msg)
            print(f"âœ… {symbol}: Ù…Ù‚Ø¨ÙˆÙ„ ({strength}%)")
            matches += 1
            successful_stocks.append(success_data)
            all_candles.update(candles_dict)
            time_module.sleep(0.3)

    # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹
    save_json_file(CANDLES_DATA_FILE, all_candles)
    print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ ÙÙŠ {CANDLES_DATA_FILE}")
    
    # Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
    if successful_stocks:
        save_json_file(SUCCESSFUL_PATTERNS_FILE, successful_stocks)
        print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ø§Ø¬Ø­Ø© ÙÙŠ {SUCCESSFUL_PATTERNS_FILE}")

    print(f"\n\nğŸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {matches}")

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ
    if successful_stocks:
        successful_stocks.sort(key=lambda x: x['strength'], reverse=True)

        summary = "ğŸ“Š *Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ÙŠÙˆÙ…*\n"
        summary += f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {target_date}\n"
        summary += f"âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…: {matches}\n\n"

        for stock in successful_stocks:
            stars = "â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸" if stock['strength'] >= 90 else ("â­ï¸â­ï¸â­ï¸" if stock['strength'] >= 70 else "â­ï¸")
            summary += f"â€¢ *{stock['symbol']}*: {stock['strength']}% {stars}\n"

        send_telegram(summary)
        print(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…")

if __name__ == "__main__":
    main()
