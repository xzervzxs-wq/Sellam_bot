import requests
import pandas as pd
import json
import os
import time
from datetime import datetime
import pytz
from dotenv import load_dotenv

# ==============================================================================
# ğŸ” ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
# ==============================================================================
load_dotenv()

API_KEY = os.getenv("FMP_API_KEY")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

if not API_KEY:
    print("âŒ Ø®Ø·Ø£: FMP_API_KEY ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„Ù .env")
    exit()

# ==============================================================================
# âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª (Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©) - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ
# ==============================================================================
CACHE_FILE = "float_cache.json"
TARGET_TIME = "14:27"  # Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª (Ø¨ØªÙˆÙ‚ÙŠØª Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ)

# ==============================================================================
# 1ï¸âƒ£ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ø´
# ==============================================================================
def load_cache():
    if os.path.exists(CACHE_FILE):
        try:
            with open(CACHE_FILE, 'r') as f: return json.load(f)
        except: return {}
    return {}

def save_cache(cache_data):
    with open(CACHE_FILE, 'w') as f: json.dump(cache_data, f, indent=4)

# ==============================================================================
# 2ï¸âƒ£ ØµØ§Ø¦Ø¯ Ø§Ù„Ù€ 50 Ø³Ù‡Ù… (Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ ÙÙ‚Ø·)
# ==============================================================================
def get_guaranteed_50_list():
    float_cache = load_cache()
    print(f"ğŸ“¦ Ø§Ù„ÙƒØ§Ø´ Ø¬Ø§Ù‡Ø² ({len(float_cache)} Ø³Ù‡Ù…). Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠØ©...")

    url = (f"https://financialmodelingprep.com/stable/company-screener"
           f"?priceMoreThan=0.02&priceLowerThan=10&volumeMoreThan=150000"
           f"&isEtf=false&exchange=nasdaq,nyse,amex&isActivelyTrading=true&limit=1000&apikey={API_KEY}")
    
    try:
        results = requests.get(url, timeout=20).json()
        if not results: return []
        
        results.sort(key=lambda x: x.get('volume', 0) if isinstance(x.get('volume'), (int, float)) else 0, reverse=True)
        
        final_list = []
        for item in results:
            if len(final_list) >= 50: break
            
            sym = item.get('symbol')
            # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø·ÙˆÙŠÙ„Ø© (warrants/rights)
            if len(sym) > 5: continue 
            
            if sym in float_cache:
                f_shares = float_cache[sym]
            else:
                try:
                    f_url = f"https://financialmodelingprep.com/stable/shares-float?symbol={sym}&apikey={API_KEY}"
                    f_data = requests.get(f_url, timeout=1.5).json()
                    if f_data and isinstance(f_data, list):
                        f_shares = f_data[0].get('floatShares') or 0
                    else:
                        f_shares = 0
                    float_cache[sym] = f_shares
                    time.sleep(0.05)
                except: f_shares = 0

            if not isinstance(f_shares, (int, float)): continue

            if 0 < f_shares <= 150_000_000:
                final_list.append({'symbol': sym, 'float': f_shares})
                print(f"âœ… {len(final_list)}/50: {sym} (Float: {f_shares/1_000_000:.1f}M)")

        save_cache(float_cache)
        return final_list
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø³ÙƒØ±ÙŠÙ†Ø±: {e}")
        return []

# ==============================================================================
# 3ï¸âƒ£ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø³Ù„Ù… (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ
# ==============================================================================
def analyze_stock(stock_data):
    ticker = stock_data['symbol']
    float_shares = stock_data['float']
    
    print(f"ğŸ” ÙØ­Øµ {ticker} ... ", end="")
    
    url = f"https://financialmodelingprep.com/stable/historical-chart/1min?symbol={ticker}&apikey={API_KEY}"
    
    try:
        response = requests.get(url, timeout=10)
        data = response.json()
        
        if not data or (isinstance(data, dict) and "Error Message" in data):
            print("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")
            return

        df = pd.DataFrame(data)
        df['date'] = pd.to_datetime(df['date'])
        df.set_index('date', inplace=True)
        df.sort_index(inplace=True)

        # âœ…âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‡Ù…: ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹
        cols = ['open', 'high', 'low', 'close', 'volume']
        for col in cols:
            df[col] = pd.to_numeric(df[col], errors='coerce')
        
        # Ø­Ø°Ù Ø£ÙŠ ØµÙÙˆÙ ÙÙŠÙ‡Ø§ Ù‚ÙŠÙ… NaN Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
        df.dropna(inplace=True)

        if df.index.tz is None:
            df.index = df.index.tz_localize('America/New_York')
        else:
            df.index = df.index.tz_convert('America/New_York')
            
        today = datetime.now(pytz.timezone('America/New_York')).date()
        df_today = df[df.index.date == today]
        
        if df_today.empty:
            print(f"âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©")
            return

        # ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ - Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ Ù…Ù† 13:55 Ø¥Ù„Ù‰ 14:25
        target_df = df_today.between_time('13:55', '14:25')
        if target_df.empty: 
            print("âš ï¸ Ø®Ø§Ø±Ø¬ Ø§Ù„ÙˆÙ‚Øª")
            return

        df_5m = target_df.resample('5min').agg({
            'open': 'first', 'high': 'max', 'low': 'min', 'close': 'last', 'volume': 'sum'
        }).dropna()

        if len(df_5m) < 3: 
            print("â­ï¸ Ø£Ù‚Ù„ Ù…Ù† 3 Ø´Ù…ÙˆØ¹")
            return

        c1, c2, c3 = df_5m.iloc[-3], df_5m.iloc[-2], df_5m.iloc[-1]
        
        is_ladder = (
            c3['high'] >= c2['high'] and
            c2['high'] >= c1['high'] and
            c3['low'] >= c2['low']
        )
        
        body = abs(c3['close'] - c3['open'])
        wick = c3['high'] - max(c3['open'], c3['close'])
        
        if is_ladder and (body > 0 and wick/body < 2):
            print("ğŸ”¥ ÙØ±ØµØ©!") 
            send_telegram_alert(ticker, df_5m, float_shares)
        else:
            print("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù…ÙˆØ°Ø¬")

    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„ØªØ­Ù„ÙŠÙ„: {e}")

# ==============================================================================
# 4ï¸âƒ£ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©)
# ==============================================================================
def send_telegram_alert(ticker, df, float_shares):
    try:
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ø£Ø±Ù‚Ø§Ù… ØµØ§ÙÙŠØ© (Native Python Types)
        current_close = float(df.iloc[-1]['close'])
        high_of_day = float(df['high'].max())
        total_vol = float(df['volume'].sum())
        float_shares = float(float_shares)
        
        # ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±
        if float_shares == 0: float_shares = 1 

        rot = (total_vol / float_shares) * 100
        
        status = "Ø¬ÙŠØ¯"
        if rot > 20: status = "Ø§Ù†ÙØ¬Ø§Ø± (Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹)"
        elif rot > 10: status = "Ù†Ø§Ø± (Ù…Ù…ØªØ§Ø²)"
        
        if current_close >= high_of_day * 0.995:
            action = "ğŸš€ Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± (Ø§Ø®ØªØ±Ø§Ù‚)"
        else:
            stop_price = high_of_day + 0.01
            action = f"âœ‹ Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚ (Buy Stop): ${stop_price:.4f}"

        msg = f"""> FMP ( Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ ): Ø³Ù„Ù… ØµØ§Ø¹Ø¯ (Ù†Ø¸ÙŠÙ)

 Ø§Ù„Ø³Ù‡Ù…: {ticker}
 Ø§Ù„Ø³Ø¹Ø±: ${current_close:.3f}
 Ø§Ù„Ù‚Ù…Ø©: ${high_of_day:.3f}
 Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: {status} ({rot:.1f}%)
 Ø§Ù„ÙÙ„ÙˆØª ğŸª¶: {float_shares/1_000_000:.1f}M
 â° Ø§Ù„ÙˆÙ‚Øª: 13:55-14:25
-----------------------
 {action}"""

        if TELEGRAM_TOKEN and CHAT_ID:
            # ØªØ­ÙˆÙŠÙ„ CHAT_ID Ù„Ù†Øµ Ù„Ù„ØªØ£ÙƒØ¯
            requests.post(f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage", 
                          json={"chat_id": str(CHAT_ID), "text": msg}, timeout=5)
            print(f"ğŸ“¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù€ {ticker}")
        else:
            print("\n" + msg + "\n")

    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")

# ==============================================================================
# ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ
# ==============================================================================
def run_bot():
    ny_tz = pytz.timezone('America/New_York')
    print(f"ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± {TARGET_TIME} Ø¨ØªÙˆÙ‚ÙŠØª Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ...")
    
    while True:
        current_time = datetime.now(ny_tz).strftime("%H:%M")
        print(f"â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: {current_time}")
        if current_time >= TARGET_TIME:
            print("ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø¨ÙˆØª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±!")
            break
        time.sleep(10)

    tickers = get_guaranteed_50_list()
    
    if not tickers:
        print("âŒ Ù„Ù… Ù†Ø¬Ø¯ Ø£Ø³Ù‡Ù…."); return

    print(f"\nğŸ§  Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ {len(tickers)} Ø³Ù‡Ù… Ø¨Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø³Ù„Ù… (13:55-14:25)...")
    
    for stock in tickers:
        analyze_stock(stock)
        time.sleep(0.1) 

    print("ğŸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ.")

if __name__ == "__main__":
    run_bot()