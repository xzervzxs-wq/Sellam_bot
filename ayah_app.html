<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=4.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#1c1c1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ÿ¢Ÿäÿ© - ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÖÿØŸäŸÜÿ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg: #1c1c1e;
            --bg-light: #2c2c2e;
            --text: #ffffff;
            --text-dim: rgba(255,255,255,0.6);
            --accent: #d4af37;
            --accent-glow: rgba(212, 175, 55, 0.3);
            --page-bg: #fef8e8;
        }

        html, body {
            height: 100%;
            background: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* ===== APP CONTAINER ===== */
        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* ===== MUSHAF CONTAINER ===== */
        .mushaf {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            overflow: hidden;
        }

        .page-frame {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .page-img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 16px);
            width: auto;
            height: auto;
            object-fit: contain;
        }

        /* ===== AYAH OVERLAY - Clickable areas ===== */
        .ayah-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }

        .line-area {
            flex: 1;
            cursor: pointer;
            position: relative;
        }

        .line-area::after {
            content: '';
            position: absolute;
            inset: 2px 8%;
            border-radius: 4px;
            background: transparent;
            transition: background 0.2s;
        }

        .line-area.highlighted::after {
            background: var(--accent-glow);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { background: rgba(212, 175, 55, 0.25); }
            50% { background: rgba(212, 175, 55, 0.4); }
        }

        /* ===== TOP BAR ===== */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            background: linear-gradient(to bottom, var(--bg), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .top-bar.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .top-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: var(--bg-light);
            border: none;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-info {
            text-align: center;
        }

        .surah-title {
            color: var(--accent);
            font-size: 17px;
            font-weight: 600;
        }

        .page-number {
            color: var(--text-dim);
            font-size: 13px;
            margin-top: 2px;
        }

        /* ===== BOTTOM BAR ===== */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: linear-gradient(to top, var(--bg), transparent);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }

        .bottom-bar.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .progress-container {
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: var(--bg-light);
            border: none;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
        }

        .nav-btn.primary {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: var(--accent);
            color: var(--bg);
        }

        /* ===== AYAH ACTION SHEET ===== */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-light);
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .action-sheet.visible {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 12px auto;
        }

        .ayah-display {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .ayah-text-display {
            font-family: 'Amiri', serif;
            font-size: 24px;
            line-height: 2;
            color: var(--text);
            margin-bottom: 12px;
        }

        .ayah-reference {
            color: var(--accent);
            font-size: 14px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--accent);
        }

        .action-btn span {
            font-size: 11px;
            color: var(--text-dim);
        }

        .tafsir-section {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tafsir-title {
            color: var(--accent);
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tafsir-content {
            color: var(--text);
            font-size: 16px;
            line-height: 1.9;
            text-align: justify;
        }

        .tafsir-loading {
            text-align: center;
            color: var(--text-dim);
            padding: 30px;
        }

        /* ===== INDEX SHEET ===== */
        .index-sheet {
            position: fixed;
            inset: 0;
            background: var(--bg);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 300;
            display: flex;
            flex-direction: column;
        }

        .index-sheet.visible {
            transform: translateX(0);
        }

        .index-header {
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .index-title {
            color: var(--text);
            font-size: 20px;
            font-weight: 600;
        }

        .index-close {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: var(--bg-light);
            border: none;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
        }

        .index-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 16px;
        }

        .surah-item {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }

        .surah-num {
            width: 36px;
            height: 36px;
            background: var(--bg-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 14px;
            font-weight: 600;
            margin-left: 12px;
        }

        .surah-details {
            flex: 1;
        }

        .surah-name {
            color: var(--text);
            font-size: 16px;
        }

        .surah-meta {
            color: var(--text-dim);
            font-size: 12px;
            margin-top: 2px;
        }

        .surah-page {
            color: var(--text-dim);
            font-size: 13px;
        }

        /* ===== PAGE SLIDER ===== */
        .slider-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-light);
            padding: 24px;
            padding-bottom: max(24px, env(safe-area-inset-bottom));
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 250;
        }

        .slider-sheet.visible {
            transform: translateY(0);
        }

        .slider-value {
            text-align: center;
            font-size: 48px;
            font-weight: 300;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .page-slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            background: transparent;
            direction: ltr;
        }

        .page-slider::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .page-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            margin-top: -12px;
            cursor: pointer;
        }

        /* ===== BACKDROP ===== */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 150;
        }

        .backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* ===== LOADING ===== */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 48px;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .loading-title {
            font-family: 'Amiri', serif;
            font-size: 28px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .loading-sub {
            color: var(--text-dim);
            font-size: 14px;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-light);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 400;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== SWIPE INDICATORS ===== */
        .swipe-indicator {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 30px;
            color: var(--accent);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .swipe-indicator.left { right: 20px; }
        .swipe-indicator.right { left: 20px; }
        .swipe-indicator.visible { opacity: 0.6; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Mushaf Display -->
        <div class="mushaf" id="mushaf">
            <div class="page-frame" id="pageFrame">
                <img class="page-img" id="pageImg" src="" alt="">
                <div class="ayah-overlay" id="ayahOverlay"></div>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar" id="topBar">
            <button class="top-btn" id="menuBtn">‚ò∞</button>
            <div class="page-info">
                <div class="surah-title" id="surahTitle">ÿ≥Ÿàÿ±ÿ© ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©</div>
                <div class="page-number" id="pageNumber">ÿµŸÅÿ≠ÿ© Ÿ°</div>
            </div>
            <button class="top-btn" id="settingsBtn">‚öô</button>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar" id="bottomBar">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="juzInfo">ÿßŸÑÿ¨ÿ≤ÿ° Ÿ°</span>
                    <span id="hizbInfo">ÿßŸÑÿ≠ÿ≤ÿ® Ÿ°</span>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">‚Üí</button>
                <button class="nav-btn primary" id="sliderBtn">üìñ</button>
                <button class="nav-btn" id="nextBtn">‚Üê</button>
            </div>
        </div>

        <!-- Swipe Indicators -->
        <div class="swipe-indicator left" id="swipeLeft">‚Üê</div>
        <div class="swipe-indicator right" id="swipeRight">‚Üí</div>

        <!-- Backdrop -->
        <div class="backdrop" id="backdrop"></div>

        <!-- Ayah Action Sheet -->
        <div class="action-sheet" id="actionSheet">
            <div class="sheet-handle"></div>
            <div class="ayah-display">
                <div class="ayah-text-display" id="ayahTextDisplay"></div>
                <div class="ayah-reference" id="ayahReference"></div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="playBtn">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <span>ÿßÿ≥ÿ™ŸÖÿßÿπ</span>
                </button>
                <button class="action-btn" id="bookmarkBtn">
                    <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
                    <span>ÿπŸÑÿßŸÖÿ©</span>
                </button>
                <button class="action-btn" id="copyBtn">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    <span>ŸÜÿ≥ÿÆ</span>
                </button>
                <button class="action-btn" id="shareBtn">
                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    <span>ŸÖÿ¥ÿßÿ±ŸÉÿ©</span>
                </button>
            </div>
            <div class="tafsir-section">
                <div class="tafsir-title">üìñ ÿ™ŸÅÿ≥Ÿäÿ± ÿßŸÑŸÖŸäÿ≥ÿ±</div>
                <div class="tafsir-content" id="tafsirContent">
                    <div class="tafsir-loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±...</div>
                </div>
            </div>
        </div>

        <!-- Index Sheet -->
        <div class="index-sheet" id="indexSheet">
            <div class="index-header">
                <div class="index-title">ŸÅŸáÿ±ÿ≥ ÿßŸÑÿ≥Ÿàÿ±</div>
                <button class="index-close" id="indexClose">‚úï</button>
            </div>
            <div class="index-list" id="indexList"></div>
        </div>

        <!-- Page Slider Sheet -->
        <div class="slider-sheet" id="sliderSheet">
            <div class="slider-value" id="sliderValue">Ÿ°</div>
            <input type="range" class="page-slider" id="pageSlider" min="1" max="604" value="1">
        </div>

        <!-- Toast -->
        <div class="toast" id="toast"></div>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-logo">Ô∑Ω</div>
            <div class="loading-title">ÿ¢Ÿäÿ©</div>
            <div class="loading-sub">ŸÖÿµÿ≠ŸÅ ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑŸÖŸÜŸàÿ±ÿ©</div>
        </div>
    </div>

    <script>
        // ========== CONFIG ==========
        const CDN = 'https://www.mp3quran.net/api/quran_pages_arabic/';
        const TOTAL = 604;
        const LINES = 15;

        // ========== STATE ==========
        let page = 1;
        let ui = false;
        let ayat = [];
        let selected = null;
        let startX = 0, curX = 0, dragging = false;

        // ========== SURAHS ==========
        const surahs = [
            {n:1,name:"ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",p:1,ayat:7,type:"ŸÖŸÉŸäÿ©"},
            {n:2,name:"ÿßŸÑÿ®ŸÇÿ±ÿ©",p:2,ayat:286,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:3,name:"ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ",p:50,ayat:200,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:4,name:"ÿßŸÑŸÜÿ≥ÿßÿ°",p:77,ayat:176,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:5,name:"ÿßŸÑŸÖÿßÿ¶ÿØÿ©",p:106,ayat:120,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:6,name:"ÿßŸÑÿ£ŸÜÿπÿßŸÖ",p:128,ayat:165,type:"ŸÖŸÉŸäÿ©"},
            {n:7,name:"ÿßŸÑÿ£ÿπÿ±ÿßŸÅ",p:151,ayat:206,type:"ŸÖŸÉŸäÿ©"},
            {n:8,name:"ÿßŸÑÿ£ŸÜŸÅÿßŸÑ",p:177,ayat:75,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:9,name:"ÿßŸÑÿ™Ÿàÿ®ÿ©",p:187,ayat:129,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:10,name:"ŸäŸàŸÜÿ≥",p:208,ayat:109,type:"ŸÖŸÉŸäÿ©"},
            {n:11,name:"ŸáŸàÿØ",p:221,ayat:123,type:"ŸÖŸÉŸäÿ©"},
            {n:12,name:"ŸäŸàÿ≥ŸÅ",p:235,ayat:111,type:"ŸÖŸÉŸäÿ©"},
            {n:13,name:"ÿßŸÑÿ±ÿπÿØ",p:249,ayat:43,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:14,name:"ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ",p:255,ayat:52,type:"ŸÖŸÉŸäÿ©"},
            {n:15,name:"ÿßŸÑÿ≠ÿ¨ÿ±",p:262,ayat:99,type:"ŸÖŸÉŸäÿ©"},
            {n:16,name:"ÿßŸÑŸÜÿ≠ŸÑ",p:267,ayat:128,type:"ŸÖŸÉŸäÿ©"},
            {n:17,name:"ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°",p:282,ayat:111,type:"ŸÖŸÉŸäÿ©"},
            {n:18,name:"ÿßŸÑŸÉŸáŸÅ",p:293,ayat:110,type:"ŸÖŸÉŸäÿ©"},
            {n:19,name:"ŸÖÿ±ŸäŸÖ",p:305,ayat:98,type:"ŸÖŸÉŸäÿ©"},
            {n:20,name:"ÿ∑Ÿá",p:312,ayat:135,type:"ŸÖŸÉŸäÿ©"},
            {n:21,name:"ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°",p:322,ayat:112,type:"ŸÖŸÉŸäÿ©"},
            {n:22,name:"ÿßŸÑÿ≠ÿ¨",p:332,ayat:78,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:23,name:"ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ",p:342,ayat:118,type:"ŸÖŸÉŸäÿ©"},
            {n:24,name:"ÿßŸÑŸÜŸàÿ±",p:350,ayat:64,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:25,name:"ÿßŸÑŸÅÿ±ŸÇÿßŸÜ",p:359,ayat:77,type:"ŸÖŸÉŸäÿ©"},
            {n:26,name:"ÿßŸÑÿ¥ÿπÿ±ÿßÿ°",p:367,ayat:227,type:"ŸÖŸÉŸäÿ©"},
            {n:27,name:"ÿßŸÑŸÜŸÖŸÑ",p:377,ayat:93,type:"ŸÖŸÉŸäÿ©"},
            {n:28,name:"ÿßŸÑŸÇÿµÿµ",p:385,ayat:88,type:"ŸÖŸÉŸäÿ©"},
            {n:29,name:"ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™",p:396,ayat:69,type:"ŸÖŸÉŸäÿ©"},
            {n:30,name:"ÿßŸÑÿ±ŸàŸÖ",p:404,ayat:60,type:"ŸÖŸÉŸäÿ©"},
            {n:31,name:"ŸÑŸÇŸÖÿßŸÜ",p:411,ayat:34,type:"ŸÖŸÉŸäÿ©"},
            {n:32,name:"ÿßŸÑÿ≥ÿ¨ÿØÿ©",p:415,ayat:30,type:"ŸÖŸÉŸäÿ©"},
            {n:33,name:"ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®",p:418,ayat:73,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:34,name:"ÿ≥ÿ®ÿ£",p:428,ayat:54,type:"ŸÖŸÉŸäÿ©"},
            {n:35,name:"ŸÅÿßÿ∑ÿ±",p:434,ayat:45,type:"ŸÖŸÉŸäÿ©"},
            {n:36,name:"Ÿäÿ≥",p:440,ayat:83,type:"ŸÖŸÉŸäÿ©"},
            {n:37,name:"ÿßŸÑÿµÿßŸÅÿßÿ™",p:446,ayat:182,type:"ŸÖŸÉŸäÿ©"},
            {n:38,name:"ÿµ",p:453,ayat:88,type:"ŸÖŸÉŸäÿ©"},
            {n:39,name:"ÿßŸÑÿ≤ŸÖÿ±",p:458,ayat:75,type:"ŸÖŸÉŸäÿ©"},
            {n:40,name:"ÿ∫ÿßŸÅÿ±",p:467,ayat:85,type:"ŸÖŸÉŸäÿ©"},
            {n:41,name:"ŸÅÿµŸÑÿ™",p:477,ayat:54,type:"ŸÖŸÉŸäÿ©"},
            {n:42,name:"ÿßŸÑÿ¥Ÿàÿ±Ÿâ",p:483,ayat:53,type:"ŸÖŸÉŸäÿ©"},
            {n:43,name:"ÿßŸÑÿ≤ÿÆÿ±ŸÅ",p:489,ayat:89,type:"ŸÖŸÉŸäÿ©"},
            {n:44,name:"ÿßŸÑÿØÿÆÿßŸÜ",p:496,ayat:59,type:"ŸÖŸÉŸäÿ©"},
            {n:45,name:"ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©",p:499,ayat:37,type:"ŸÖŸÉŸäÿ©"},
            {n:46,name:"ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ",p:502,ayat:35,type:"ŸÖŸÉŸäÿ©"},
            {n:47,name:"ŸÖÿ≠ŸÖÿØ",p:507,ayat:38,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:48,name:"ÿßŸÑŸÅÿ™ÿ≠",p:511,ayat:29,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:49,name:"ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™",p:515,ayat:18,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:50,name:"ŸÇ",p:518,ayat:45,type:"ŸÖŸÉŸäÿ©"},
            {n:51,name:"ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™",p:520,ayat:60,type:"ŸÖŸÉŸäÿ©"},
            {n:52,name:"ÿßŸÑÿ∑Ÿàÿ±",p:523,ayat:49,type:"ŸÖŸÉŸäÿ©"},
            {n:53,name:"ÿßŸÑŸÜÿ¨ŸÖ",p:526,ayat:62,type:"ŸÖŸÉŸäÿ©"},
            {n:54,name:"ÿßŸÑŸÇŸÖÿ±",p:528,ayat:55,type:"ŸÖŸÉŸäÿ©"},
            {n:55,name:"ÿßŸÑÿ±ÿ≠ŸÖŸÜ",p:531,ayat:78,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:56,name:"ÿßŸÑŸàÿßŸÇÿπÿ©",p:534,ayat:96,type:"ŸÖŸÉŸäÿ©"},
            {n:57,name:"ÿßŸÑÿ≠ÿØŸäÿØ",p:537,ayat:29,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:58,name:"ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©",p:542,ayat:22,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:59,name:"ÿßŸÑÿ≠ÿ¥ÿ±",p:545,ayat:24,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:60,name:"ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©",p:549,ayat:13,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:61,name:"ÿßŸÑÿµŸÅ",p:551,ayat:14,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:62,name:"ÿßŸÑÿ¨ŸÖÿπÿ©",p:553,ayat:11,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:63,name:"ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ",p:554,ayat:11,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:64,name:"ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ",p:556,ayat:18,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:65,name:"ÿßŸÑÿ∑ŸÑÿßŸÇ",p:558,ayat:12,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:66,name:"ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ",p:560,ayat:12,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:67,name:"ÿßŸÑŸÖŸÑŸÉ",p:562,ayat:30,type:"ŸÖŸÉŸäÿ©"},
            {n:68,name:"ÿßŸÑŸÇŸÑŸÖ",p:564,ayat:52,type:"ŸÖŸÉŸäÿ©"},
            {n:69,name:"ÿßŸÑÿ≠ÿßŸÇÿ©",p:566,ayat:52,type:"ŸÖŸÉŸäÿ©"},
            {n:70,name:"ÿßŸÑŸÖÿπÿßÿ±ÿ¨",p:568,ayat:44,type:"ŸÖŸÉŸäÿ©"},
            {n:71,name:"ŸÜŸàÿ≠",p:570,ayat:28,type:"ŸÖŸÉŸäÿ©"},
            {n:72,name:"ÿßŸÑÿ¨ŸÜ",p:572,ayat:28,type:"ŸÖŸÉŸäÿ©"},
            {n:73,name:"ÿßŸÑŸÖÿ≤ŸÖŸÑ",p:574,ayat:20,type:"ŸÖŸÉŸäÿ©"},
            {n:74,name:"ÿßŸÑŸÖÿØÿ´ÿ±",p:575,ayat:56,type:"ŸÖŸÉŸäÿ©"},
            {n:75,name:"ÿßŸÑŸÇŸäÿßŸÖÿ©",p:577,ayat:40,type:"ŸÖŸÉŸäÿ©"},
            {n:76,name:"ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ",p:578,ayat:31,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:77,name:"ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™",p:580,ayat:50,type:"ŸÖŸÉŸäÿ©"},
            {n:78,name:"ÿßŸÑŸÜÿ®ÿ£",p:582,ayat:40,type:"ŸÖŸÉŸäÿ©"},
            {n:79,name:"ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™",p:583,ayat:46,type:"ŸÖŸÉŸäÿ©"},
            {n:80,name:"ÿπÿ®ÿ≥",p:585,ayat:42,type:"ŸÖŸÉŸäÿ©"},
            {n:81,name:"ÿßŸÑÿ™ŸÉŸàŸäÿ±",p:586,ayat:29,type:"ŸÖŸÉŸäÿ©"},
            {n:82,name:"ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±",p:587,ayat:19,type:"ŸÖŸÉŸäÿ©"},
            {n:83,name:"ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ",p:587,ayat:36,type:"ŸÖŸÉŸäÿ©"},
            {n:84,name:"ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ",p:589,ayat:25,type:"ŸÖŸÉŸäÿ©"},
            {n:85,name:"ÿßŸÑÿ®ÿ±Ÿàÿ¨",p:590,ayat:22,type:"ŸÖŸÉŸäÿ©"},
            {n:86,name:"ÿßŸÑÿ∑ÿßÿ±ŸÇ",p:591,ayat:17,type:"ŸÖŸÉŸäÿ©"},
            {n:87,name:"ÿßŸÑÿ£ÿπŸÑŸâ",p:591,ayat:19,type:"ŸÖŸÉŸäÿ©"},
            {n:88,name:"ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©",p:592,ayat:26,type:"ŸÖŸÉŸäÿ©"},
            {n:89,name:"ÿßŸÑŸÅÿ¨ÿ±",p:593,ayat:30,type:"ŸÖŸÉŸäÿ©"},
            {n:90,name:"ÿßŸÑÿ®ŸÑÿØ",p:594,ayat:20,type:"ŸÖŸÉŸäÿ©"},
            {n:91,name:"ÿßŸÑÿ¥ŸÖÿ≥",p:595,ayat:15,type:"ŸÖŸÉŸäÿ©"},
            {n:92,name:"ÿßŸÑŸÑŸäŸÑ",p:595,ayat:21,type:"ŸÖŸÉŸäÿ©"},
            {n:93,name:"ÿßŸÑÿ∂ÿ≠Ÿâ",p:596,ayat:11,type:"ŸÖŸÉŸäÿ©"},
            {n:94,name:"ÿßŸÑÿ¥ÿ±ÿ≠",p:596,ayat:8,type:"ŸÖŸÉŸäÿ©"},
            {n:95,name:"ÿßŸÑÿ™ŸäŸÜ",p:597,ayat:8,type:"ŸÖŸÉŸäÿ©"},
            {n:96,name:"ÿßŸÑÿπŸÑŸÇ",p:597,ayat:19,type:"ŸÖŸÉŸäÿ©"},
            {n:97,name:"ÿßŸÑŸÇÿØÿ±",p:598,ayat:5,type:"ŸÖŸÉŸäÿ©"},
            {n:98,name:"ÿßŸÑÿ®ŸäŸÜÿ©",p:598,ayat:8,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:99,name:"ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©",p:599,ayat:8,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:100,name:"ÿßŸÑÿπÿßÿØŸäÿßÿ™",p:599,ayat:11,type:"ŸÖŸÉŸäÿ©"},
            {n:101,name:"ÿßŸÑŸÇÿßÿ±ÿπÿ©",p:600,ayat:11,type:"ŸÖŸÉŸäÿ©"},
            {n:102,name:"ÿßŸÑÿ™ŸÉÿßÿ´ÿ±",p:600,ayat:8,type:"ŸÖŸÉŸäÿ©"},
            {n:103,name:"ÿßŸÑÿπÿµÿ±",p:601,ayat:3,type:"ŸÖŸÉŸäÿ©"},
            {n:104,name:"ÿßŸÑŸáŸÖÿ≤ÿ©",p:601,ayat:9,type:"ŸÖŸÉŸäÿ©"},
            {n:105,name:"ÿßŸÑŸÅŸäŸÑ",p:601,ayat:5,type:"ŸÖŸÉŸäÿ©"},
            {n:106,name:"ŸÇÿ±Ÿäÿ¥",p:602,ayat:4,type:"ŸÖŸÉŸäÿ©"},
            {n:107,name:"ÿßŸÑŸÖÿßÿπŸàŸÜ",p:602,ayat:7,type:"ŸÖŸÉŸäÿ©"},
            {n:108,name:"ÿßŸÑŸÉŸàÿ´ÿ±",p:602,ayat:3,type:"ŸÖŸÉŸäÿ©"},
            {n:109,name:"ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ",p:603,ayat:6,type:"ŸÖŸÉŸäÿ©"},
            {n:110,name:"ÿßŸÑŸÜÿµÿ±",p:603,ayat:3,type:"ŸÖÿØŸÜŸäÿ©"},
            {n:111,name:"ÿßŸÑŸÖÿ≥ÿØ",p:603,ayat:5,type:"ŸÖŸÉŸäÿ©"},
            {n:112,name:"ÿßŸÑÿ•ÿÆŸÑÿßÿµ",p:604,ayat:4,type:"ŸÖŸÉŸäÿ©"},
            {n:113,name:"ÿßŸÑŸÅŸÑŸÇ",p:604,ayat:5,type:"ŸÖŸÉŸäÿ©"},
            {n:114,name:"ÿßŸÑŸÜÿßÿ≥",p:604,ayat:6,type:"ŸÖŸÉŸäÿ©"}
        ];

        // ========== UTILITIES ==========
        const $ = id => document.getElementById(id);
        const toAr = n => n.toString().replace(/\d/g, d => 'Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'[d]);
        const imgUrl = p => CDN + String(p).padStart(3, '0') + '.png';
        const getSurah = () => surahs.filter(s => page >= s.p).pop() || surahs[0];
        const getJuz = () => Math.ceil(page / 20);

        // Load saved
        const saved = localStorage.getItem('ayah_page');
        if (saved) page = parseInt(saved);

        // ========== LOAD PAGE ==========
        function loadPage(p) {
            page = Math.max(1, Math.min(TOTAL, p));
            const img = $('pageImg');
            img.src = imgUrl(page);
            img.onload = () => {
                $('loadingScreen').classList.add('hidden');
                createOverlay();
            };
            updateUI();
            localStorage.setItem('ayah_page', page);
        }

        function updateUI() {
            const s = getSurah();
            $('surahTitle').textContent = 'ÿ≥Ÿàÿ±ÿ© ' + s.name;
            $('pageNumber').textContent = 'ÿµŸÅÿ≠ÿ© ' + toAr(page);
            $('progressFill').style.width = (page / TOTAL * 100) + '%';
            $('juzInfo').textContent = 'ÿßŸÑÿ¨ÿ≤ÿ° ' + toAr(getJuz());
            $('hizbInfo').textContent = 'ÿßŸÑÿ≠ÿ≤ÿ® ' + toAr(Math.ceil(page / 10));
            $('sliderValue').textContent = toAr(page);
            $('pageSlider').value = page;
        }

        // ========== CREATE OVERLAY ==========
        function createOverlay() {
            const overlay = $('ayahOverlay');
            overlay.innerHTML = '';
            for (let i = 0; i < LINES; i++) {
                const line = document.createElement('div');
                line.className = 'line-area';
                line.dataset.line = i + 1;
                line.onclick = () => onLineClick(i + 1);
                overlay.appendChild(line);
            }
        }

        // ========== LINE CLICK ==========
        async function onLineClick(lineNum) {
            // Clear previous highlights
            document.querySelectorAll('.line-area').forEach(l => l.classList.remove('highlighted'));
            
            // Highlight this line
            const line = document.querySelector(`[data-line="${lineNum}"]`);
            line.classList.add('highlighted');
            
            // Load ayat for this page
            if (ayat.length === 0 || ayat[0]?.page_number !== page) {
                try {
                    const res = await fetch(`https://api.quran.com/api/v4/verses/by_page/${page}?language=ar&words=true&word_fields=line_number&fields=text_uthmani`);
                    const data = await res.json();
                    ayat = data.verses;
                } catch (e) {
                    toast('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¢Ÿäÿßÿ™');
                    return;
                }
            }
            
            // Find ayah for this line
            const ayah = ayat.find(a => a.words?.some(w => w.line_number === lineNum));
            if (ayah) {
                showAyahSheet(ayah, lineNum);
            }
        }

        // ========== SHOW AYAH SHEET ==========
        async function showAyahSheet(ayah, lineNum) {
            selected = ayah;
            
            // Highlight all lines of this ayah
            document.querySelectorAll('.line-area').forEach(l => l.classList.remove('highlighted'));
            const lines = new Set();
            ayah.words?.forEach(w => w.line_number && lines.add(w.line_number));
            lines.forEach(ln => {
                document.querySelector(`[data-line="${ln}"]`)?.classList.add('highlighted');
            });
            
            const [sNum, vNum] = ayah.verse_key.split(':');
            const surah = surahs.find(s => s.n == sNum);
            
            $('ayahTextDisplay').textContent = ayah.text_uthmani;
            $('ayahReference').textContent = `ÿ≥Ÿàÿ±ÿ© ${surah.name} - ÿßŸÑÿ¢Ÿäÿ© ${toAr(vNum)}`;
            $('tafsirContent').innerHTML = '<div class="tafsir-loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±...</div>';
            
            $('backdrop').classList.add('visible');
            $('actionSheet').classList.add('visible');
            hideUI();
            
            // Load tafsir
            try {
                const res = await fetch(`https://api.quran.com/api/v4/tafsirs/93/by_ayah/${ayah.verse_key}`);
                const data = await res.json();
                if (data.tafsir?.text) {
                    $('tafsirContent').textContent = data.tafsir.text.replace(/<[^>]*>/g, '');
                } else {
                    $('tafsirContent').textContent = 'ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
                }
            } catch (e) {
                $('tafsirContent').textContent = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±';
            }
        }

        function closeSheet() {
            $('backdrop').classList.remove('visible');
            $('actionSheet').classList.remove('visible');
            $('sliderSheet').classList.remove('visible');
            document.querySelectorAll('.line-area').forEach(l => l.classList.remove('highlighted'));
            selected = null;
        }

        // ========== UI TOGGLE ==========
        function toggleUI() {
            ui = !ui;
            $('topBar').classList.toggle('visible', ui);
            $('bottomBar').classList.toggle('visible', ui);
        }

        function hideUI() {
            ui = false;
            $('topBar').classList.remove('visible');
            $('bottomBar').classList.remove('visible');
        }

        // ========== NAVIGATION ==========
        function next() { loadPage(page + 1); }
        function prev() { loadPage(page - 1); }
        function goTo(p) { loadPage(p); closeIndex(); closeSheet(); }

        // ========== INDEX ==========
        function showIndex() {
            $('indexList').innerHTML = surahs.map(s => `
                <div class="surah-item" onclick="goTo(${s.p})">
                    <div class="surah-num">${s.n}</div>
                    <div class="surah-details">
                        <div class="surah-name">${s.name}</div>
                        <div class="surah-meta">${s.type} ¬∑ ${s.ayat} ÿ¢Ÿäÿ©</div>
                    </div>
                    <div class="surah-page">${s.p}</div>
                </div>
            `).join('');
            $('indexSheet').classList.add('visible');
        }

        function closeIndex() {
            $('indexSheet').classList.remove('visible');
        }

        // ========== SLIDER ==========
        function showSlider() {
            $('sliderSheet').classList.add('visible');
            $('backdrop').classList.add('visible');
        }

        // ========== TOAST ==========
        function toast(msg) {
            $('toast').textContent = msg;
            $('toast').classList.add('visible');
            setTimeout(() => $('toast').classList.remove('visible'), 2000);
        }

        // ========== ACTIONS ==========
        $('copyBtn').onclick = () => {
            if (selected) {
                navigator.clipboard?.writeText(selected.text_uthmani);
                toast('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ© ‚úì');
            }
        };

        $('bookmarkBtn').onclick = () => {
            localStorage.setItem('ayah_bookmark', page);
            toast('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÑÿßŸÖÿ© ‚úì');
        };

        $('playBtn').onclick = () => {
            if (selected) {
                const [s, v] = selected.verse_key.split(':');
                const audio = new Audio(`https://cdn.islamic.network/quran/audio/128/ar.alafasy/${selected.id}.mp3`);
                audio.play();
                toast('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ...');
            }
        };

        $('shareBtn').onclick = () => {
            if (selected && navigator.share) {
                navigator.share({
                    title: 'ÿ¢Ÿäÿ© ŸÖŸÜ ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ',
                    text: selected.text_uthmani
                });
            }
        };

        // ========== EVENTS ==========
        $('menuBtn').onclick = showIndex;
        $('indexClose').onclick = closeIndex;
        $('prevBtn').onclick = prev;
        $('nextBtn').onclick = next;
        $('sliderBtn').onclick = showSlider;
        $('backdrop').onclick = closeSheet;

        $('pageSlider').oninput = (e) => {
            $('sliderValue').textContent = toAr(e.target.value);
        };
        $('pageSlider').onchange = (e) => {
            goTo(parseInt(e.target.value));
        };

        // ========== TOUCH ==========
        const mushaf = $('mushaf');

        mushaf.ontouchstart = (e) => {
            if (e.target.closest('.action-sheet, .index-sheet, .slider-sheet')) return;
            startX = e.touches[0].clientX;
            curX = startX;
            dragging = true;
        };

        mushaf.ontouchmove = (e) => {
            if (!dragging) return;
            curX = e.touches[0].clientX;
            const diff = curX - startX;
            $('swipeLeft').classList.toggle('visible', diff < -50 && page < TOTAL);
            $('swipeRight').classList.toggle('visible', diff > 50 && page > 1);
        };

        mushaf.ontouchend = () => {
            dragging = false;
            $('swipeLeft').classList.remove('visible');
            $('swipeRight').classList.remove('visible');
            const diff = curX - startX;
            if (Math.abs(diff) > 80) {
                diff > 0 ? prev() : next();
            } else if (Math.abs(diff) < 10) {
                if (!$('actionSheet').classList.contains('visible')) {
                    toggleUI();
                }
            }
        };

        // ========== KEYBOARD ==========
        document.onkeydown = (e) => {
            if (e.key === 'ArrowLeft') next();
            if (e.key === 'ArrowRight') prev();
            if (e.key === 'Escape') { closeSheet(); closeIndex(); }
        };

        // ========== INIT ==========
        loadPage(page);
    </script>
</body>
</html>
