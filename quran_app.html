<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a472a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>القرآن الكريم | تطبيق متكامل</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <link id="fa-stylesheet" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link id="google-fonts" href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@400;700&family=El+Messiri:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@400;700&family=Lalezar&family=Mada:wght@400;700&family=Reem+Kufi:wght@400;700&family=Tajawal:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold-primary: #c5a059;
            --green-deep: #1a472a;
            --bg-main: #fdfbf7;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-main); 
            color: #2d3748; 
            user-select: none;
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior: none;
            background-image: radial-gradient(var(--gold-primary) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Glassmorphism Panels --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -10px rgba(26, 71, 42, 0.15);
        }

        /* --- Canvas Area --- */
        .preview-area {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b4975a' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            border-radius: 24px;
            min-height: 60vh; 
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; 
            border: 2px dashed var(--gold-primary);
            position: relative;
            transition: all 0.3s;
            padding: 20px;
        }

        #card {
            background-color: white; 
            position: relative; 
            box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2); 
            overflow: hidden; 
            margin: auto; direction: rtl; 
            width: 378px; height: 672px; 
            transform-origin: center;
            transition: width 0.3s, height 0.3s;
        }

        /* --- Z-INDEX & LAYERING SYSTEM --- */
        .image-layer.bg-image { 
            width: 100% !important; height: 100% !important; 
            top: 0 !important; left: 0 !important; transform: none !important; 
            border: none !important; pointer-events: none; 
            z-index: 1 !important;
        }
        #card-gradient { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            height: 70%; 
            background: linear-gradient(to top, rgba(255,255,255,0.95), transparent); 
            pointer-events: none; 
            display: none;
            z-index: 10 !important; 
        }
        .frame-layer, .image-layer:not(.bg-image) { z-index: 20; }
        .text-layer { z-index: 50; }
        .draggable-el.selected { z-index: 100 !important; }
        #eraser-canvas, #snap-guide-v, #snap-guide-h { z-index: 200 !important; }

        /* --- Element Styling --- */
        .draggable-el { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            cursor: grab; touch-action: none; 
            border: 1px solid transparent;
        }
        .draggable-el:active { cursor: grabbing; }
        .draggable-el.selected { border: 1px dashed var(--gold-primary); }
        .draggable-el.is-locked { cursor: default; }
        .draggable-el.selected.is-locked { border-color: #ef4444; border-style: dotted; }

        /* --- Handles --- */
        .handle { position: absolute; background: white; border: 1px solid var(--gold-primary); width: 12px; height: 12px; border-radius: 50%; z-index: 101; display: none; }
        .draggable-el.selected .handle { display: block; }
        .resize-nw { top: -6px; left: -6px; }
        .resize-ne { top: -6px; right: -6px; }
        .resize-sw { bottom: -6px; left: -6px; }
        .resize-se { bottom: -6px; right: -6px; }
        .resize-n { top: -6px; left: 50%; transform: translateX(-50%); }
        .resize-e { top: 50%; right: -6px; transform: translateY(-50%); }
        .resize-s { bottom: -6px; left: 50%; transform: translateX(-50%); }

        .control-btn { position: absolute; width: 28px; height: 28px; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 102; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .delete-btn { top: -35px; left: -10px; background: #ef4444; }
        .move-handle { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 40px; height: 28px; background: var(--green-deep); border-radius: 8px; cursor: move; display: none; align-items: center; justify-content: center; z-index: 102; color: var(--gold-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .draggable-el.selected .control-btn, .draggable-el.selected .move-handle { display: flex; }
        .draggable-el.is-locked .control-btn, .draggable-el.is-locked .handle, .draggable-el.is-locked .move-handle { display: none !important; }

        .ayah-text, .extra-text { 
            line-height: 1.8; display: block; white-space: pre-wrap; outline: none; 
            background: transparent; border: none; text-align: center; width: 100%; 
            resize: none; overflow: visible; 
            user-select: text !important; -webkit-user-select: text !important;
            touch-action: pan-x pan-y !important; 
        }
        .image-layer img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        /* --- Controls Toolbar --- */
        .controls-row {
            width: 100%; margin-top: 0.5rem; padding: 0.8rem;
            border-top: 1px solid rgba(180, 151, 90, 0.2);
            display: none; flex-wrap: wrap; align-items: center; gap: 0.8rem;
            background: #faf9f6; border-radius: 12px;
        }
        .controls-row.active { display: flex; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-tool {
            background: white; border: 1px solid #efe9d9; color: var(--green-deep);
            padding: 8px; border-radius: 12px; font-weight: bold; font-size: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-tool:active { transform: scale(0.95); background: #f0fdf4; }
        
        #eraser-canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        .cursor-crosshair { cursor: crosshair !important; }
        .cursor-alias { cursor: alias !important; }
        
        #snap-guide-v, #snap-guide-h {
            position: absolute; background: #ef4444; display: none; pointer-events: none;
        }
        #snap-guide-v { top: 0; bottom: 0; left: 50%; width: 1px; }
        #snap-guide-h { left: 0; right: 0; top: 50%; height: 1px; }

        /* Progress Bar Styles */
        .progress-container { width: 80%; max-width: 300px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #c5a059; transition: width 0.3s ease; border-radius: 3px; }

        /* Navigation Bar */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(26, 71, 42, 0.98);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center;
            padding: 10px 0; padding-bottom: calc(10px + env(safe-area-inset-bottom));
            z-index: 9999;
            border-top: 2px solid var(--gold-primary);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: rgba(255,255,255,0.6); font-size: 10px; gap: 4px;
            transition: all 0.3s; cursor: pointer; padding: 5px 15px;
        }
        .nav-item i { font-size: 22px; }
        .nav-item.active { color: var(--gold-primary); }
        .nav-item:hover { color: var(--gold-primary); }

        /* App Sections */
        .app-section { display: none; min-height: 100vh; padding-bottom: 100px; }
        .app-section.active { display: block; }

        /* Mushaf Styles */
        .mushaf-container {
            max-width: 100%; margin: 0 auto; padding: 10px;
        }
        .mushaf-page {
            background: #fef9e7;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 3px solid var(--gold-primary);
            font-family: 'Scheherazade New', 'Amiri', serif;
            line-height: 2.2;
            font-size: 22px;
            text-align: justify;
            direction: rtl;
        }
        .mushaf-page .ayah {
            display: inline;
        }
        .mushaf-page .ayah-number {
            display: inline-block;
            position: relative;
            font-size: 18px;
            color: var(--gold-primary);
            font-family: 'Scheherazade New', 'Amiri', serif;
            vertical-align: middle;
            margin: 0 2px;
            direction: ltr;
        }
        .mushaf-page .ayah-number::before {
            content: '۝';
            font-size: 28px;
            position: relative;
        }
        .mushaf-page .ayah-number span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -55%);
            font-size: 12px;
            font-weight: normal;
            color: var(--green-deep);
            font-family: 'Scheherazade New', 'Amiri', serif;
        }

        /* Special First Pages - Fatiha & Baqarah */
        .mushaf-page.first-page {
            background: linear-gradient(135deg, #fef9e7 0%, #fdfaf2 50%, #fef9e7 100%);
            border: none;
            padding: 25px 20px;
            text-align: center;
            min-height: 500px;
            position: relative;
            border-radius: 0;
            box-shadow: none;
        }
        .mushaf-page.first-page::before {
            content: '';
            position: absolute;
            top: 8px; left: 8px; right: 8px; bottom: 8px;
            border: 3px solid var(--gold-primary);
            border-radius: 0;
            pointer-events: none;
        }
        .mushaf-page.first-page::after {
            content: '';
            position: absolute;
            top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid var(--gold-primary);
            border-radius: 0;
            pointer-events: none;
        }
        .mushaf-page.first-page .ayah {
            display: inline;
            font-size: 1.1em;
            line-height: 2.8;
        }
        .mushaf-page.first-page .ayah-number {
            display: inline-block;
        }
        .mushaf-page.first-page .ayah-number::before {
            font-size: 32px;
        }
        .mushaf-page.first-page .ayah-number span {
            font-size: 12px;
        }
        
        /* Ornamental Frame for First Pages */
        .ornament-frame {
            position: relative;
            padding: 25px 15px;
            margin: 15px 0;
        }
        .ornament-top, .ornament-bottom {
            text-align: center;
            color: var(--gold-primary);
            font-size: 20px;
            letter-spacing: 3px;
            margin: 10px 0;
        }
        .ornament-top::before {
            content: '❋ ❋ ❋ ❋ ❋ ❋ ❋';
        }
        .ornament-bottom::before {
            content: '❋ ❋ ❋ ❋ ❋ ❋ ❋';
        }
        
        .surah-name-box {
            background: linear-gradient(135deg, var(--green-deep) 0%, #1e5631 50%, var(--green-deep) 100%);
            color: white;
            padding: 12px 50px;
            border-radius: 0;
            display: inline-block;
            margin: 10px 0;
            font-family: 'Scheherazade New', 'Amiri', serif;
            font-size: 24px;
            box-shadow: 0 3px 10px rgba(26,71,42,0.3);
            border: 2px solid var(--gold-primary);
            position: relative;
        }
        .surah-name-box::before, .surah-name-box::after {
            content: '۞';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold-primary);
            font-size: 18px;
        }
        .surah-name-box::before { left: 15px; }
        .surah-name-box::after { right: 15px; }
        
        .surah-info-badge {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 8px 0;
            font-size: 11px;
            color: var(--green-deep);
        }
        .surah-info-badge span {
            background: rgba(197, 160, 89, 0.15);
            padding: 4px 12px;
            border-radius: 10px;
            border: 1px solid rgba(197, 160, 89, 0.3);
        }

        .page-number-display {
            text-align: center;
            padding: 8px 15px;
            font-weight: bold;
            color: var(--green-deep);
            font-size: 13px;
            background: linear-gradient(90deg, transparent, rgba(197, 160, 89, 0.15), transparent);
            border-radius: 0;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Corner Ornaments */
        .corner-ornament {
            position: absolute;
            width: 30px; height: 30px;
            color: var(--gold-primary);
            font-size: 16px;
        }
        .corner-ornament.top-right { top: 20px; right: 20px; }
        .corner-ornament.top-left { top: 20px; left: 20px; }
        .corner-ornament.bottom-right { bottom: 20px; right: 20px; }
        .corner-ornament.bottom-left { bottom: 20px; left: 20px; }

        /* Mushaf Basic Controls */
        .mushaf-basic-controls {
            position: fixed;
            bottom: 80px;
            left: 0; right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(26, 71, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            transition: all 0.3s ease;
        }
        .mushaf-basic-controls .nav-btn {
            width: 50px; height: 50px;
            background: var(--gold-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .mushaf-basic-controls .nav-btn:disabled {
            opacity: 0.4;
        }
        .basic-controls-center {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .basic-controls-center .ctrl-btn {
            width: 45px; height: 45px;
            background: rgba(255,255,255,0.1);
            color: var(--gold-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .basic-controls-center .page-num {
            color: white;
            font-size: 18px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        /* ==================== MUSHAF STYLES ==================== */
        .mushaf-container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: #0a0a0a;
        }

        .mushaf-page-wrapper {
            display: flex;
            height: 100%;
            transition: transform 0.4s ease-out;
        }

        .mushaf-page {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
        }

        .mushaf-page img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .mushaf-page-num {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #c5a059;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mushaf-page-num.show { opacity: 1; }

        .mushaf-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 300;
        }

        .mushaf-loading i {
            font-size: 60px;
            color: #c5a059;
            margin-bottom: 15px;
            display: block;
        }

        .mushaf-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 40px 20px 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 200;
        }

        .mushaf-bottom-bar.show { transform: translateY(0); }

        .mushaf-slider-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .mushaf-slider-row input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            direction: ltr;
        }

        .mushaf-slider-row input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #c5a059;
            border-radius: 50%;
            cursor: pointer;
        }

        .mushaf-slider-info {
            color: white;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
        }

        .mushaf-btns {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mushaf-btn {
            background: rgba(197, 160, 89, 0.2);
            color: #c5a059;
            border: 1px solid rgba(197, 160, 89, 0.3);
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mushaf-btn:active {
            background: #c5a059;
            color: #000;
        }

        /* Index Panel */
        .mushaf-index-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 320px;
            max-width: 85vw;
            background: white;
            z-index: 300;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .mushaf-index-panel.show {
            transform: translateX(0);
        }

        .mip-header {
            padding: 20px;
            background: var(--green-deep);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mip-header h3 { font-size: 18px; }
        .mip-header button {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .mip-tabs {
            display: flex;
            padding: 10px;
            gap: 10px;
            background: #f5f5f5;
        }
        .mip-tab {
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: var(--green-deep);
        }
        .mip-tab.active {
            background: var(--green-deep);
            color: white;
            border-color: var(--green-deep);
        }

        .mip-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .mip-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mip-item:active {
            background: #f0f0f0;
        }
        .mip-item-num {
            width: 40px;
            height: 40px;
            background: var(--green-deep);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        .mip-item-name {
            flex: 1;
            font-weight: bold;
            color: var(--green-deep);
        }
        .mip-item-page {
            color: var(--gold-primary);
            font-weight: bold;
            font-size: 14px;
        }

        /* Tafsir Panel */
        .tafsir-bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            max-height: 70vh;
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .tafsir-bottom-panel.visible {
            transform: translateY(0);
        }

        .tbp-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tbp-header h3 {
            color: var(--green-deep);
            font-size: 18px;
        }
        .tbp-header button {
            width: 36px;
            height: 36px;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
        }

        .tbp-ayah-select {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
        }
        .tbp-ayah-btn {
            padding: 10px;
            background: var(--green-deep);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .tbp-ayah-btn:active {
            background: var(--gold-primary);
        }

        .tbp-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .tbp-ayah-text {
            background: linear-gradient(135deg, var(--green-deep), #2d5a3d);
            color: white;
            padding: 20px;
            border-radius: 16px;
            font-size: 22px;
            line-height: 2;
            text-align: center;
            margin-bottom: 15px;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        .tbp-tafsir-text {
            color: #333;
            font-size: 16px;
            line-height: 1.9;
            text-align: justify;
        }

        .mushaf-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .mushaf-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Night mode for mushaf */
        .mushaf-night .mushaf-image-container {
            background: #0a0a0a;
        }
        .mushaf-night .mushaf-page-slide img {
            filter: invert(0.9) hue-rotate(180deg);
        }

        /* Toast for mushaf */
        .mushaf-toast {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: var(--green-deep);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
        }
        .mushaf-toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Nav Bar Hide/Show */
        .nav-bar.hidden {
            transform: translateY(100%);
        }
        .nav-bar {
            transition: transform 0.3s ease;
        }
        .surah-header {
            text-align: center; padding: 20px;
            background: linear-gradient(135deg, var(--green-deep), #2d5a3d);
            color: white; border-radius: 12px; margin-bottom: 15px;
        }
        .surah-header h2 { font-size: 28px; margin-bottom: 5px; font-family: 'Amiri', serif; }
        .surah-header span { font-size: 14px; color: var(--gold-primary); }
        .bismillah {
            text-align: center; font-size: 28px; margin: 20px 0;
            color: var(--green-deep); font-family: 'Scheherazade New', serif;
        }
        .page-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: white; border-radius: 12px; margin: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .page-nav button {
            background: var(--green-deep); color: white;
            padding: 10px 20px; border-radius: 8px; font-weight: bold;
        }
        .page-nav button:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-weight: bold; color: var(--green-deep); }
        .mushaf-controls {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 10px; border-radius: 12px; margin-bottom: 10px;
        }
        .juz-badge {
            background: var(--gold-primary); color: white;
            padding: 5px 15px; border-radius: 20px;
            font-size: 12px; font-weight: bold;
        }

        /* Qibla Styles */
        .qibla-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 80vh; padding: 20px; text-align: center;
        }
        .compass-wrapper {
            position: relative; width: 300px; height: 300px;
            margin: 20px 0;
        }
        .compass {
            width: 100%; height: 100%;
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
            border-radius: 50%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2), inset 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            border: 8px solid var(--gold-primary);
        }
        .compass-rose {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; height: 90%;
            transition: transform 0.5s ease-out;
        }
        .direction-mark {
            position: absolute; font-weight: bold;
            font-size: 14px; color: var(--green-deep);
        }
        .direction-mark.north { top: 15px; left: 50%; transform: translateX(-50%); color: #c5a059; font-size: 18px; }
        .direction-mark.south { bottom: 15px; left: 50%; transform: translateX(-50%); }
        .direction-mark.east { right: 15px; top: 50%; transform: translateY(-50%); }
        .direction-mark.west { left: 15px; top: 50%; transform: translateY(-50%); }
        .qibla-arrow {
            position: absolute; top: 50%; left: 50%;
            width: 6px; height: 45%;
            background: linear-gradient(to top, transparent, var(--green-deep));
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            border-radius: 3px;
            transition: transform 0.5s ease-out;
        }
        .qibla-arrow::before {
            content: ''; position: absolute; top: -15px; left: 50%;
            transform: translateX(-50%);
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid var(--green-deep);
        }
        .qibla-kaaba {
            position: absolute; top: 5px; left: 50%;
            transform: translateX(-50%);
            font-size: 24px; color: var(--gold-primary);
        }
        .compass-center {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            background: var(--gold-primary);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .qibla-info {
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 350px; width: 100%;
        }
        .qibla-degree {
            font-size: 48px; font-weight: bold;
            color: var(--green-deep);
        }
        .location-info {
            font-size: 14px; color: #666; margin-top: 10px;
        }
        .calibrate-btn {
            background: var(--green-deep); color: white;
            padding: 12px 30px; border-radius: 25px;
            font-weight: bold; margin-top: 20px;
            display: flex; align-items: center; gap: 10px;
        }
    </style>
</head>
<body class="min-h-screen pb-10" onclick="deselect(event)">

    <!-- Hidden Font Loader -->
    <div id="hidden-font-loader" style="opacity:0; position:absolute; pointer-events:none;">
        <span style="font-family: 'Amiri', serif;">أ</span>
        <span style="font-family: 'Cairo', sans-serif;">أ</span>
        <span style="font-family: 'Aref Ruqaa', serif;">أ</span>
        <span style="font-family: 'Scheherazade New', serif;">أ</span>
    </div>

    <!-- Start Overlay -->
    <div id="startup-overlay" style="position:fixed; inset:0; background:#1a472a; z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition:opacity 0.5s;">
        <i class="fas fa-kaaba text-[#c5a059] text-6xl mb-4 animate-pulse"></i>
        <div class="text-white font-bold text-xl mt-4 font-serif">القرآن الكريم</div>
        <div class="text-[#c5a059] text-sm">تطبيق متكامل</div>
    </div>
    
    <!-- Export Overlay with Progress Bar -->
    <div id="export-overlay" style="display:none; position:fixed; inset:0; background:rgba(26,71,42,0.98); z-index:100000; flex-direction:column; justify-content:center; align-items:center;">
        <div class="text-[#c5a059] font-bold text-xl mb-2">جاري تجهيز التصميم</div>
        <div class="text-white text-xs opacity-90 mb-4" id="export-status">يرجى الانتظار قليلاً...</div>
        
        <div class="progress-container">
            <div class="progress-bar" id="export-progress"></div>
        </div>
        <div class="text-[#c5a059] text-[10px] mt-2 font-bold" id="progress-text">0%</div>
    </div>
    
    <!-- Save Modal -->
    <div id="save-modal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.95); z-index:100000; align-items:center; justify-content:center; flex-direction:column; padding:20px; backdrop-filter:blur(5px);">
        <div class="glass-panel p-6 rounded-2xl max-w-lg w-full flex flex-col items-center gap-4 border-none bg-white/10">
            <div class="text-white font-bold text-lg">✨ تم إنشاء التصميم</div>
            <img id="save-img" alt="تصميم" class="rounded-xl shadow-2xl max-h-[60vh] w-auto border-4 border-white/20">
            <div class="flex flex-col w-full gap-3">
                <button onclick="downloadImage()" class="bg-[#c5a059] text-white py-3 rounded-xl font-bold w-full shadow-lg">
                    <i class="fas fa-download"></i> حفظ في الاستوديو
                </button>
                <button onclick="document.getElementById('save-modal').style.display='none'" class="bg-white/10 text-white w-full py-3 rounded-xl font-bold">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- ==================== QIBLA SECTION ==================== -->
    <section id="qibla-section" class="app-section">
        <div class="qibla-container">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-[#1a472a] mb-2">اتجاه القبلة</h1>
                <p class="text-gray-500 text-sm">حدد اتجاه القبلة من موقعك</p>
            </div>
            
            <div class="compass-wrapper">
                <div class="compass">
                    <div class="compass-rose" id="compass-rose">
                        <div class="direction-mark north">ش</div>
                        <div class="direction-mark south">ج</div>
                        <div class="direction-mark east">شـ</div>
                        <div class="direction-mark west">غ</div>
                    </div>
                    <div class="qibla-arrow" id="qibla-arrow">
                        <i class="fas fa-kaaba qibla-kaaba"></i>
                    </div>
                    <div class="compass-center"></div>
                </div>
            </div>

            <div class="qibla-info">
                <div class="qibla-degree" id="qibla-degree">--°</div>
                <p class="text-gray-600 font-bold">اتجاه القبلة</p>
                <div class="location-info" id="location-info">
                    <i class="fas fa-location-dot text-[#c5a059]"></i>
                    <span id="user-location">جاري تحديد الموقع...</span>
                </div>
                <p class="text-xs text-gray-400 mt-3">المسافة إلى مكة: <span id="distance-to-mecca">--</span> كم</p>
            </div>

            <button onclick="calibrateQibla()" class="calibrate-btn">
                <i class="fas fa-sync-alt"></i>
                إعادة المعايرة
            </button>
            
            <p class="text-xs text-gray-400 mt-4 text-center max-w-xs">
                تأكد من تفعيل خدمة الموقع والبوصلة في جهازك للحصول على نتائج دقيقة
            </p>
        </div>
    </section>

    <!-- ==================== MUSHAF SECTION ==================== -->
    <section id="mushaf-section" class="app-section active">
        <div class="mushaf-image-container" id="mushaf-image-container">
            <!-- Page Wrapper for swipe -->
            <div class="mushaf-pages-wrapper" id="mushaf-pages-wrapper">
                <div class="mushaf-page-slide prev-page" id="prev-page-slide"></div>
                <div class="mushaf-page-slide current-page" id="current-page-slide">
                    <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
                </div>
                <div class="mushaf-page-slide next-page" id="next-page-slide"></div>
            </div>
            
            <!-- Page indicator -->
            <div class="page-number-badge" id="page-number-badge">
                <span id="mushaf-page-num">١</span> / ٦٠٤
            </div>
            
            <!-- Surah name overlay -->
            <div class="surah-name-overlay" id="surah-name-overlay">
                <span id="current-surah-display">سورة الفاتحة</span>
            </div>
        </div>
        
        <!-- Bottom controls - appears on tap -->
        <div class="mushaf-bottom-bar" id="mushaf-bottom-bar">
            <div class="mushaf-slider-container">
                <input type="range" class="mushaf-slider" id="mushaf-slider" min="1" max="604" value="1">
            </div>
            <div class="mushaf-quick-btns">
                <button onclick="showMushafIndex()" class="mqb"><i class="fas fa-list"></i></button>
                <button onclick="mushafBookmark()" class="mqb"><i class="fas fa-bookmark"></i></button>
                <button onclick="goToMushafBookmark()" class="mqb"><i class="fas fa-book-open"></i></button>
                <button onclick="showTafsirSelector()" class="mqb"><i class="fas fa-book"></i></button>
                <button onclick="toggleMushafNightMode()" class="mqb" id="mushaf-night-btn"><i class="fas fa-moon"></i></button>
            </div>
        </div>
        
        <!-- Index Panel -->
        <div class="mushaf-index-panel" id="mushaf-index-panel">
            <div class="mip-header">
                <h3>فهرس المصحف</h3>
                <button onclick="closeMushafIndex()"><i class="fas fa-times"></i></button>
            </div>
            <div class="mip-tabs">
                <button class="mip-tab active" onclick="switchMushafTab('surahs', this)">السور</button>
                <button class="mip-tab" onclick="switchMushafTab('juz', this)">الأجزاء</button>
            </div>
            <div class="mip-list" id="mip-list"></div>
        </div>
        
        <!-- Tafsir Panel -->
        <div class="tafsir-bottom-panel" id="tafsir-bottom-panel">
            <div class="tbp-header">
                <h3>تفسير الجلالين</h3>
                <button onclick="closeTafsirPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div class="tbp-ayah-select" id="tbp-ayah-select"></div>
            <div class="tbp-content" id="tbp-content"></div>
        </div>
        
        <!-- Overlay -->
        <div class="mushaf-overlay" id="mushaf-overlay" onclick="closeMushafPanels()"></div>
    </section>

    <!-- ==================== DESIGNER SECTION ==================== -->
    <section id="designer-section" class="app-section active">
    <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
        
        <!-- Sidebar Tools -->
        <div class="lg:col-span-4 glass-panel p-5 rounded-3xl flex flex-col gap-5 h-fit relative z-50" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between border-b border-[#efe9d9] pb-3">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-[#1a472a] rounded-xl flex items-center justify-center text-[#c5a059] shadow-lg"><i class="fas fa-quran text-2xl"></i></div>
                    <div>
                        <h1 class="font-bold text-[#1a472a] text-xl font-serif">المصمم القرآني</h1>
                        <p class="text-[11px] text-[#c5a059] font-bold">النسخة الاحترافية</p>
                    </div>
                </div>
            </div>

            <!-- Quran Selector -->
            <div class="bg-[#fdfbf7] p-4 rounded-2xl border border-[#efe9d9] space-y-3">
                <select id="surah-select" onchange="loadAyahs()" class="w-full p-3 bg-white border border-[#efe9d9] rounded-xl text-sm outline-none text-[#1a472a]"><option>اختر السورة...</option></select>
                <div class="flex gap-2">
                    <select id="ayah-select" class="flex-[3] p-3 bg-white border border-[#efe9d9] rounded-xl text-sm outline-none text-[#1a472a]"><option>رقم الآية...</option></select>
                    <button onclick="addAyah()" class="bg-[#1a472a] text-white py-2 px-4 rounded-xl text-xs font-bold whitespace-nowrap">إضافة</button>
                </div>
                <div class="pt-2 border-t border-dashed border-[#efe9d9]">
                    <button onclick="toggleRangeMode()" class="text-xs text-[#c5a059] font-bold flex items-center gap-1"><i class="fas fa-layer-group"></i> آيات متعددة</button>
                    <div id="range-ayah-container" class="hidden flex gap-2 mt-2">
                        <input type="number" id="ayah-from" placeholder="من" class="w-full p-2 rounded-lg border border-[#efe9d9] text-center">
                        <input type="number" id="ayah-to" placeholder="إلى" class="w-full p-2 rounded-lg border border-[#efe9d9] text-center">
                        <button onclick="addMultipleAyahs()" class="bg-[#c5a059] text-white w-10 rounded-lg"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </div>

            <!-- Quick Tools -->
            <div class="grid grid-cols-4 gap-2">
                <label class="btn-tool cursor-pointer col-span-2 flex-row justify-center gap-2 bg-[#1a472a] text-white">
                    <i class="far fa-image text-white"></i> <span>خلفية</span>
                    <input type="file" onchange="addImageLayer(this)" class="hidden" accept="image/*">
                </label>
                <label class="btn-tool cursor-pointer">
                    <i class="fas fa-camera"></i> صورة
                    <input type="file" onchange="addRegularImage(this)" class="hidden" accept="image/*">
                </label>
                <button onclick="addExtraText()" class="btn-tool"><i class="fas fa-font"></i> نص</button>
                <button onclick="addFrame()" class="btn-tool"><i class="far fa-square"></i> إطار</button>
                
                <button onclick="toggleShapeMenu()" class="btn-tool relative">
                    <i class="fas fa-shapes"></i> أشكال
                </button>

                <button onclick="toggleSizeMenu()" class="btn-tool col-span-2 flex-row justify-center gap-2">
                    <i class="fas fa-crop-alt"></i> مقاس <span id="size-label" class="text-[10px] text-gray-500 font-normal">Story</span>
                </button>
            </div>
            
            <div id="shape-menu-content" class="hidden bg-white p-3 rounded-xl border border-[#efe9d9] absolute top-full left-0 right-0 z-50 shadow-xl mt-2 flex gap-2 justify-center">
                <button onclick="addShape('square')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-square text-[#1a472a]"></i> مربع</button>
                <button onclick="addShape('circle')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-circle text-[#1a472a]"></i> دائرة</button>
                <button onclick="addShape('triangle')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold flex flex-col items-center"><i class="fas fa-play text-[#1a472a] -rotate-90"></i> مثلث</button>
            </div>

            <div id="size-menu-content" class="hidden bg-white p-3 rounded-xl border border-[#efe9d9] absolute top-full left-0 right-0 z-50 shadow-xl mt-2">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setCardSize(378, 672, 'Story')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Story</button>
                    <button onclick="setCardSize(400, 400, 'Square')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Square</button>
                    <button onclick="setCardSize(378, 500, 'Post')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Post</button>
                </div>
            </div>
        </div>

        <!-- Workspace -->
        <div class="lg:col-span-8 flex flex-col gap-4">
            
            <!-- Floating Toolbar -->
            <div class="glass-panel p-3 rounded-2xl flex flex-wrap items-center justify-between gap-2 sticky top-2 z-30" onclick="event.stopPropagation()">
                <div class="flex items-center gap-2 bg-[#fdfbf7] p-1 rounded-xl border border-[#efe9d9]">
                    <button onclick="undoAction()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-[#1a472a]"><i class="fas fa-undo"></i></button>
                    <button onclick="redoAction()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white text-[#1a472a]"><i class="fas fa-redo"></i></button>
                </div>

                <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                    <button id="btn-grad" onclick="toggleGradient()" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a] flex items-center gap-2">
                        <i class="fas fa-adjust text-[#c5a059]"></i> تدرج
                    </button>
                    <button onclick="toggleBg()" id="btn-bg" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a]">شفافية</button>
                    <button id="btn-eraser" onclick="toggleEraserMode()" class="px-3 py-2 rounded-lg text-xs font-bold bg-white border border-[#efe9d9] text-[#1a472a] flex items-center gap-2">
                        <i class="fas fa-eraser text-[#c5a059]"></i> الممحاة
                    </button>
                </div>

                <!-- Sub-Panels -->
                <div id="grad-controls" class="controls-row">
                    <span class="text-[10px] font-bold">اللون:</span>
                    <button onclick="setGradientColor('black')" class="w-6 h-6 rounded bg-black border border-gray-300"></button>
                    <button onclick="setGradientColor('white')" class="w-6 h-6 rounded bg-white border border-gray-300"></button>
                    <input type="range" min="0" max="1" step="0.1" value="0.8" oninput="setGradientOpacity(this.value)" class="w-20 accent-[#c5a059]">
                </div>

                <!-- Eraser Controls -->
                <div id="eraser-controls" class="controls-row">
                    <span class="text-[10px] font-bold">حجم:</span>
                    <input type="range" min="5" max="100" value="30" oninput="updateEraserSize(this.value)" class="w-20 accent-[#1a472a]">
                    <div class="w-px h-4 bg-gray-300 mx-2"></div>
                    <button id="btn-magic" onclick="toggleMagicMode()" class="px-2 py-1 rounded bg-white border border-[#efe9d9] text-[10px] font-bold flex items-center gap-1">
                        <i class="fas fa-magic"></i> سحرية
                    </button>
                    <div id="magic-tol-wrap" class="hidden items-center gap-1">
                        <span class="text-[10px]">دقة:</span>
                        <input type="range" min="1" max="100" value="30" oninput="updateMagicTolerance(this.value)" class="w-16 accent-[#c5a059]">
                    </div>
                    <button onclick="exitEraserMode()" class="bg-gray-200 px-3 py-1 rounded text-[10px] font-bold">إنهاء</button>
                </div>

                <!-- Frame Controls -->
                <div id="frame-controls" class="controls-row">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold">لون الحد:</span>
                        <input type="color" id="border-color" oninput="updateStyle('borderColor', this.value)" class="w-6 h-6 rounded border border-gray-300 cursor-pointer p-0">
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-[10px] font-bold">سمك:</span>
                        <input type="range" id="border-width" min="0" max="20" value="2" oninput="updateStyle('borderWidth', this.value + 'px')" class="w-16 accent-[#c5a059]">
                    </div>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold">تعبئة:</span>
                        <input type="color" id="bg-color" oninput="updateStyle('backgroundColor', this.value)" class="w-6 h-6 rounded border border-gray-300 cursor-pointer p-0">
                    </div>
                </div>

                <div id="top-font-controls" class="controls-row justify-between">
                    <div class="flex items-center gap-2 flex-1">
                        <i class="fas fa-text-height text-[#c5a059]"></i>
                        <input type="range" id="top-font-size" min="10" max="150" value="35" oninput="updateStyle('fontSize', this.value + 'px')" class="w-full accent-[#1a472a]">
                    </div>
                    <select id="top-font-family" onchange="updateStyle('fontFamily', this.value)" class="bg-white border border-[#efe9d9] rounded-lg text-xs font-bold py-1 px-2 outline-none text-[#1a472a] max-w-[100px]">
                        <option value="'Amiri', serif">النسخ (أميري)</option>
                        <option value="'Aref Ruqaa', serif">الرقعة</option>
                        <option value="'Cairo', sans-serif">كايرو</option>
                        <option value="'Tajawal', sans-serif">تجوال</option>
                        <option value="'Reem Kufi', sans-serif">كوفي</option>
                    </select>
                </div>

                <div id="quick-props" class="controls-row justify-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold">لون العنصر:</span>
                        <input type="color" id="quick-color" oninput="updateStyle('color', this.value)" class="w-8 h-8 rounded-full border-2 border-white shadow-sm overflow-hidden p-0 cursor-pointer">
                    </div>
                    <button onclick="deleteActive()" class="bg-red-50 text-red-600 px-4 py-1 rounded-full text-xs font-bold border border-red-100 flex items-center gap-1 hover:bg-red-100">
                        <i class="fas fa-trash-alt"></i> حذف
                    </button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="preview-area shadow-inner bg-[#f4f4f4]" onclick="deselect(event)">
                <div id="card" onclick="event.stopPropagation()">
                    <div id="card-gradient"></div>
                    <!-- Snap Guides -->
                    <div id="snap-guide-v"></div>
                    <div id="snap-guide-h"></div>
                </div>
            </div>

            <!-- Mobile Export Button -->
            <button onclick="exportCard()" class="fixed bottom-6 left-6 z-50 bg-[#c5a059] text-white w-16 h-16 rounded-full shadow-2xl flex flex-col items-center justify-center hover:scale-110 transition md:hidden border-4 border-white">
                <i class="fas fa-save text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold leading-none">حفظ</span>
            </button>
            
            <!-- Desktop Export -->
            <button onclick="exportCard()" class="hidden md:flex bg-[#1a472a] text-white w-full py-4 rounded-xl shadow-lg font-bold text-lg hover:bg-[#143620] items-center justify-center gap-2 transition">
                <i class="fas fa-file-export text-[#c5a059]"></i> حفظ التصميم النهائي
            </button>
        </div>
    </div>
    </section>

    <!-- ==================== BOTTOM NAVIGATION ==================== -->
    <nav class="nav-bar" id="nav-bar">
        <div class="nav-item" onclick="switchSection('qibla')">
            <i class="fas fa-compass"></i>
            <span>القبلة</span>
        </div>
        <div class="nav-item active" onclick="switchSection('mushaf')">
            <i class="fas fa-book-quran"></i>
            <span>المصحف</span>
        </div>
        <div class="nav-item" onclick="switchSection('designer')">
            <i class="fas fa-palette"></i>
            <span>المصمم</span>
        </div>
    </nav>

    <script>
        // ==================== MUSHAF VARIABLES - UPDATED FOR SVG ====================
        const SVG_BASE_URL = 'https://raw.githubusercontent.com/xzervzxs-wq/Sellam_bot/main/quran-svg-pages/';
        const TOTAL_PAGES = 604;
        let currentMushafPage = parseInt(localStorage.getItem('lastPage')) || 1;
        let mushafInitialized = false;
        let isMushafNightMode = false;
        let mushafBarVisible = false;
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;
        
        // Interactive Ayah Coordinates
        let quranCoordinates = {};
        let pageAyahsData = [];
        let selectedAyahData = null;
        
        // Surah data
        const SURAH_START_PAGES = {
            1: 1, 2: 2, 3: 50, 4: 77, 5: 106, 6: 128, 7: 151, 8: 177, 9: 187,
            10: 208, 11: 221, 12: 235, 13: 249, 14: 255, 15: 262, 16: 267,
            17: 282, 18: 293, 19: 305, 20: 312, 21: 322, 22: 332, 23: 342,
            24: 350, 25: 359, 26: 367, 27: 377, 28: 385, 29: 396, 30: 404,
            31: 411, 32: 415, 33: 418, 34: 428, 35: 434, 36: 440, 37: 446,
            38: 453, 39: 458, 40: 467, 41: 477, 42: 483, 43: 489, 44: 496,
            45: 499, 46: 502, 47: 507, 48: 511, 49: 515, 50: 518, 51: 520,
            52: 523, 53: 526, 54: 528, 55: 531, 56: 534, 57: 537, 58: 542,
            59: 545, 60: 549, 61: 551, 62: 553, 63: 554, 64: 556, 65: 558,
            66: 560, 67: 562, 68: 564, 69: 566, 70: 568, 71: 570, 72: 572,
            73: 574, 74: 575, 75: 577, 76: 578, 77: 580, 78: 582, 79: 583,
            80: 585, 81: 586, 82: 587, 83: 587, 84: 589, 85: 590, 86: 591,
            87: 591, 88: 592, 89: 593, 90: 594, 91: 595, 92: 595, 93: 596,
            94: 596, 95: 597, 96: 597, 97: 598, 98: 598, 99: 599, 100: 599,
            101: 600, 102: 600, 103: 601, 104: 601, 105: 601, 106: 602,
            107: 602, 108: 602, 109: 603, 110: 603, 111: 603, 112: 604, 113: 604, 114: 604
        };
        
        const SURAH_NAMES = [
            'الفاتحة', 'البقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف',
            'الأنفال', 'التوبة', 'يونس', 'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر',
            'النحل', 'الإسراء', 'الكهف', 'مريم', 'طه', 'الأنبياء', 'الحج', 'المؤمنون',
            'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت', 'الروم',
            'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص',
            'الزمر', 'غافر', 'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية',
            'الأحقاف', 'محمد', 'الفتح', 'الحجرات', 'ق', 'الذاريات', 'الطور',
            'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر',
            'الممتحنة', 'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم',
            'الملك', 'القلم', 'الحاقة', 'المعارج', 'نوح', 'الجن', 'المزمل', 'المدثر',
            'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات', 'عبس', 'التكوير',
            'الانفطار', 'المطففين', 'الانشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية',
            'الفجر', 'البلد', 'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق',
            'القدر', 'البينة', 'الزلزلة', 'العاديات', 'القارعة', 'التكاثر', 'العصر',
            'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون', 'النصر',
            'المسد', 'الإخلاص', 'الفلق', 'الناس'
        ];
        
        const SURAH_AYAHS = [7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69, 60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24, 13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30, 20, 15, 21, 11, 8, 8, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6];
        
        const JUZ_PAGES = {1: 1, 2: 22, 3: 42, 4: 62, 5: 82, 6: 102, 7: 121, 8: 142, 9: 162, 10: 182, 11: 201, 12: 222, 13: 242, 14: 262, 15: 282, 16: 302, 17: 322, 18: 342, 19: 362, 20: 382, 21: 402, 22: 422, 23: 442, 24: 462, 25: 482, 26: 502, 27: 522, 28: 542, 29: 562, 30: 582};
        
        // ==================== NAVIGATION ====================
        let navBarVisible = true;

        function switchSection(section) {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(section + '-section').classList.add('active');
            document.querySelector(`.nav-item[onclick="switchSection('${section}')"]`).classList.add('active');
            
            // Show/hide nav bar based on section
            if(section === 'mushaf') {
                document.getElementById('nav-bar').classList.add('hidden');
                navBarVisible = false;
            } else {
                document.getElementById('nav-bar').classList.remove('hidden');
                navBarVisible = true;
            }
            
            if(section === 'qibla') initQibla();
            if(section === 'mushaf') {
                if(!mushafInitialized) {
                    initMushaf();
                }
            }
        }

        // ==================== MUSHAF FUNCTIONS ====================
        function initMushaf() {
            mushafInitialized = true;
            
            // Load saved page
            const saved = localStorage.getItem('mushaf_current_page');
            if (saved) currentMushafPage = parseInt(saved);
            
            // Setup touch events
            setupMushafTouch();
            
            // Setup slider
            const slider = document.getElementById('mushaf-slider');
            slider.value = currentMushafPage;
            slider.addEventListener('input', (e) => {
                goToMushafPage(parseInt(e.target.value));
            });
            
            // Render pages
            renderMushafPages();
        }
        
        function setupMushafTouch() {
            const container = document.getElementById('mushaf-image-container');
            
            container.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchCurrentX = touchStartX;
                isSwiping = false;
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;
                touchCurrentX = e.touches[0].clientX;
                const diff = touchStartX - touchCurrentX;
                
                if (Math.abs(diff) > 15) {
                    isSwiping = true;
                    // Move pages with finger
                    const wrapper = document.getElementById('mushaf-pages-wrapper');
                    const baseOffset = -33.333;
                    const movePercent = (diff / window.innerWidth) * 33.333;
                    wrapper.style.transition = 'none';
                    wrapper.style.transform = `translateX(${baseOffset - movePercent}%)`;
                }
            }, { passive: true });
            
            container.addEventListener('touchend', (e) => {
                const diff = touchStartX - touchCurrentX;
                const wrapper = document.getElementById('mushaf-pages-wrapper');
                wrapper.style.transition = 'transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                
                if (Math.abs(diff) > 80) {
                    if (diff > 0 && currentMushafPage < 604) {
                        // Swipe left - next page
                        currentMushafPage++;
                        animatePageTurn('next');
                    } else if (diff < 0 && currentMushafPage > 1) {
                        // Swipe right - prev page
                        currentMushafPage--;
                        animatePageTurn('prev');
                    } else {
                        wrapper.style.transform = 'translateX(-33.333%)';
                    }
                } else {
                    wrapper.style.transform = 'translateX(-33.333%)';
                    
                    // If not swiping, toggle menu on tap
                    if (!isSwiping) {
                        toggleMushafBar();
                    }
                }
                
                touchStartX = 0;
                touchCurrentX = 0;
            });
        }
        
        function animatePageTurn(direction) {
            const wrapper = document.getElementById('mushaf-pages-wrapper');
            
            if (direction === 'next') {
                wrapper.style.transform = 'translateX(-66.666%)';
            } else {
                wrapper.style.transform = 'translateX(0%)';
            }
            
            setTimeout(() => {
                wrapper.style.transition = 'none';
                wrapper.style.transform = 'translateX(-33.333%)';
                renderMushafPages();
                
                setTimeout(() => {
                    wrapper.style.transition = 'transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                }, 50);
            }, 350);
            
            showPageIndicator();
            updateMushafInfo();
            localStorage.setItem('mushaf_current_page', currentMushafPage);
        }
        
        function renderMushafPages() {
            const prevSlide = document.getElementById('prev-page-slide');
            const currentSlide = document.getElementById('current-page-slide');
            const nextSlide = document.getElementById('next-page-slide');
            
            // Previous page
            if (currentMushafPage > 1) {
                prevSlide.innerHTML = `<img src="${getPageImageUrl(currentMushafPage - 1)}" alt="صفحة ${currentMushafPage - 1}">`;
            } else {
                prevSlide.innerHTML = '';
            }
            
            // Current page
            currentSlide.innerHTML = `<img src="${getPageImageUrl(currentMushafPage)}" alt="صفحة ${currentMushafPage}">`;
            
            // Next page
            if (currentMushafPage < 604) {
                nextSlide.innerHTML = `<img src="${getPageImageUrl(currentMushafPage + 1)}" alt="صفحة ${currentMushafPage + 1}">`;
            } else {
                nextSlide.innerHTML = '';
            }
            
            // Preload adjacent pages
            preloadMushafPages();
            updateMushafInfo();
        }
        
        function getPageImageUrl(pageNum) {
            const padded = String(pageNum).padStart(3, '0');
            return `${SVG_BASE_URL}${padded}.svg`;
        }
        
        function preloadMushafPages() {
            [-2, 2, 3].forEach(offset => {
                const pageNum = currentMushafPage + offset;
                if (pageNum >= 1 && pageNum <= 604) {
                    const img = new Image();
                    img.src = getPageImageUrl(pageNum);
                }
            });
        }
        
        function goToMushafPage(pageNum) {
            if (pageNum < 1 || pageNum > 604 || pageNum === currentMushafPage) return;
            currentMushafPage = pageNum;
            renderMushafPages();
            showPageIndicator();
            localStorage.setItem('mushaf_current_page', currentMushafPage);
        }
        
        function updateMushafInfo() {
            // Update slider
            document.getElementById('mushaf-slider').value = currentMushafPage;
            
            // Update page number
            document.getElementById('mushaf-page-num').textContent = toArabicNumber(currentMushafPage);
            
            // Find current surah
            let currentSurah = 1;
            for (let i = 114; i >= 1; i--) {
                if (SURAH_START_PAGES[i] <= currentMushafPage) {
                    currentSurah = i;
                    break;
                }
            }
            document.getElementById('current-surah-display').textContent = 'سورة ' + SURAH_NAMES[currentSurah - 1];
        }
        
        function showPageIndicator() {
            const badge = document.getElementById('page-number-badge');
            const surahOverlay = document.getElementById('surah-name-overlay');
            
            badge.classList.add('visible');
            surahOverlay.classList.add('visible');
            
            setTimeout(() => {
                badge.classList.remove('visible');
                surahOverlay.classList.remove('visible');
            }, 2000);
        }
        
        function toggleMushafBar() {
            mushafBarVisible = !mushafBarVisible;
            document.getElementById('mushaf-bottom-bar').classList.toggle('visible', mushafBarVisible);
            document.getElementById('nav-bar').classList.toggle('hidden', !mushafBarVisible);
        }
        
        // Index functions
        function showMushafIndex() {
            document.getElementById('mushaf-index-panel').classList.add('visible');
            document.getElementById('mushaf-overlay').classList.add('visible');
            populateMushafIndex('surahs');
        }
        
        function closeMushafIndex() {
            document.getElementById('mushaf-index-panel').classList.remove('visible');
            document.getElementById('mushaf-overlay').classList.remove('visible');
        }
        
        function switchMushafTab(tab, btn) {
            document.querySelectorAll('.mip-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            populateMushafIndex(tab);
        }
        
        function populateMushafIndex(type) {
            const list = document.getElementById('mip-list');
            list.innerHTML = '';
            
            if (type === 'surahs') {
                SURAH_NAMES.forEach((name, i) => {
                    const item = document.createElement('div');
                    item.className = 'mip-item';
                    item.innerHTML = `
                        <div class="mip-item-num">${i + 1}</div>
                        <div class="mip-item-name">${name}</div>
                        <div class="mip-item-page">ص ${SURAH_START_PAGES[i + 1]}</div>
                    `;
                    item.onclick = () => {
                        goToMushafPage(SURAH_START_PAGES[i + 1]);
                        closeMushafIndex();
                        closeMushafPanels();
                    };
                    list.appendChild(item);
                });
            } else {
                for (let i = 1; i <= 30; i++) {
                    const item = document.createElement('div');
                    item.className = 'mip-item';
                    item.innerHTML = `
                        <div class="mip-item-num">${i}</div>
                        <div class="mip-item-name">الجزء ${toArabicNumber(i)}</div>
                        <div class="mip-item-page">ص ${JUZ_PAGES[i]}</div>
                    `;
                    item.onclick = () => {
                        goToMushafPage(JUZ_PAGES[i]);
                        closeMushafIndex();
                        closeMushafPanels();
                    };
                    list.appendChild(item);
                }
            }
        }
        
        // Bookmark
        function mushafBookmark() {
            localStorage.setItem('mushaf_bookmark', currentMushafPage);
            showMushafToast('تم حفظ العلامة ✓');
        }
        
        function goToMushafBookmark() {
            const bookmark = localStorage.getItem('mushaf_bookmark');
            if (bookmark) {
                goToMushafPage(parseInt(bookmark));
                showMushafToast('العودة للعلامة المحفوظة');
            } else {
                showMushafToast('لا توجد علامة محفوظة');
            }
        }
        
        // Night mode
        function toggleMushafNightMode() {
            isMushafNightMode = !isMushafNightMode;
            document.getElementById('mushaf-section').classList.toggle('mushaf-night', isMushafNightMode);
            document.querySelector('#mushaf-night-btn i').className = isMushafNightMode ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        // Tafsir
        function showTafsirSelector() {
            // Find current surah
            let currentSurah = 1;
            for (let i = 114; i >= 1; i--) {
                if (SURAH_START_PAGES[i] <= currentMushafPage) {
                    currentSurah = i;
                    break;
                }
            }
            
            const ayahCount = SURAH_AYAHS[currentSurah - 1];
            const container = document.getElementById('tbp-ayah-select');
            container.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--green-deep); font-weight: bold; margin-bottom: 10px;">اختر آية من سورة ${SURAH_NAMES[currentSurah - 1]}</p>`;
            
            for (let i = 1; i <= ayahCount; i++) {
                const btn = document.createElement('button');
                btn.className = 'tbp-ayah-btn';
                btn.textContent = i;
                btn.onclick = () => loadTafsir(currentSurah, i);
                container.appendChild(btn);
            }
            
            document.getElementById('tbp-content').innerHTML = '';
            document.getElementById('tafsir-bottom-panel').classList.add('visible');
            document.getElementById('mushaf-overlay').classList.add('visible');
        }
        
        async function loadTafsir(surahNum, ayahNum) {
            const content = document.getElementById('tbp-content');
            content.innerHTML = '<div style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--gold-primary);"></i></div>';
            
            try {
                const [ayahRes, tafsirRes] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/ayah/${surahNum}:${ayahNum}/ar.uthmani`),
                    fetch(`https://api.alquran.cloud/v1/ayah/${surahNum}:${ayahNum}/ar.jalalayn`)
                ]);
                
                const ayahData = await ayahRes.json();
                const tafsirData = await tafsirRes.json();
                
                content.innerHTML = `
                    <div class="tbp-ayah-text">${ayahData.data.text}</div>
                    <div style="color: var(--gold-primary); font-weight: bold; margin-bottom: 10px;">
                        <i class="fas fa-book-open"></i> تفسير الجلالين
                    </div>
                    <div class="tbp-tafsir-text">${tafsirData.data.text}</div>
                `;
            } catch (e) {
                content.innerHTML = '<div style="text-align: center; color: red; padding: 30px;">حدث خطأ في تحميل التفسير</div>';
            }
        }
        
        function closeTafsirPanel() {
            document.getElementById('tafsir-bottom-panel').classList.remove('visible');
            document.getElementById('mushaf-overlay').classList.remove('visible');
        }
        
        function closeMushafPanels() {
            document.getElementById('mushaf-index-panel').classList.remove('visible');
            document.getElementById('tafsir-bottom-panel').classList.remove('visible');
            document.getElementById('mushaf-overlay').classList.remove('visible');
        }
        
        function showMushafToast(msg) {
            let toast = document.querySelector('.mushaf-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.className = 'mushaf-toast';
                document.getElementById('mushaf-section').appendChild(toast);
            }
            toast.textContent = msg;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 2000);
        }

        // ==================== QIBLA FUNCTIONALITY ====================
        let qiblaAngle = 0;
        let deviceHeading = 0;
        const MECCA_LAT = 21.4225;
        const MECCA_LNG = 39.8262;

        function initQibla() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        qiblaAngle = calculateQibla(lat, lng);
                        const distance = calculateDistance(lat, lng, MECCA_LAT, MECCA_LNG);
                        
                        document.getElementById('qibla-degree').innerText = Math.round(qiblaAngle) + '°';
                        document.getElementById('distance-to-mecca').innerText = Math.round(distance);
                        document.getElementById('user-location').innerText = `خط العرض: ${lat.toFixed(4)} | خط الطول: ${lng.toFixed(4)}`;
                        
                        startCompass();
                    },
                    error => {
                        document.getElementById('user-location').innerText = 'تعذر تحديد الموقع - يرجى تفعيل GPS';
                        document.getElementById('qibla-degree').innerText = '--°';
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function calculateQibla(lat, lng) {
            const phi1 = lat * Math.PI / 180;
            const phi2 = MECCA_LAT * Math.PI / 180;
            const deltaLambda = (MECCA_LNG - lng) * Math.PI / 180;
            
            const y = Math.sin(deltaLambda);
            const x = Math.cos(phi1) * Math.tan(phi2) - Math.sin(phi1) * Math.cos(deltaLambda);
            
            let qibla = Math.atan2(y, x) * 180 / Math.PI;
            return (qibla + 360) % 360;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function startCompass() {
            if (window.DeviceOrientationEvent) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS 13+
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                            }
                        });
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            }
        }

        function handleOrientation(event) {
            let heading;
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } else if (event.alpha) {
                heading = 360 - event.alpha;
            }
            
            if (heading !== undefined) {
                deviceHeading = heading;
                const arrowRotation = qiblaAngle - heading;
                document.getElementById('qibla-arrow').style.transform = 
                    `translate(-50%, -100%) rotate(${arrowRotation}deg)`;
                document.getElementById('compass-rose').style.transform = 
                    `translate(-50%, -50%) rotate(${-heading}deg)`;
            }
        }

        function calibrateQibla() {
            initQibla();
        }

        // ==================== MUSHAF FUNCTIONALITY ====================
        // ==================== DESIGNER VARIABLES ====================
        const DPI_RATIO = 2;
        let activeEl = null;
        let currentSurahName = "";
        let undoStack = [];
        let redoStack = [];
        let isTransparent = false;
        let hasGradient = false;
        
        let eraserMode = false;
        let magicMode = false;
        let eraserSize = 30;
        let magicTolerance = 30;
        let eraserCanvas = null;

        window.onload = async () => {
            await document.fonts.ready;
            await inlineStyles();
            resizeCardToFit();
            window.addEventListener('resize', resizeCardToFit);
            
            // Load Quran Coordinates for Interactive Ayahs
            try {
                const coordRes = await fetch('https://raw.githubusercontent.com/xzervzxs-wq/Sellam_bot/main/ayat_map?v=' + Date.now());
                if (coordRes.ok) {
                    quranCoordinates = await coordRes.json();
                    console.log("✅ Ayah coordinates loaded successfully - 585 pages");
                } else {
                    console.error("❌ Failed to load ayah coordinates");
                }
            } catch (e) {
                console.error("❌ Error fetching coordinates:", e);
            }
            
            // Initialize Mushaf if it's the active section
            if (document.getElementById('mushaf-section').classList.contains('active')) {
                initMushaf();
            }
            
            setTimeout(() => {
                document.getElementById('startup-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('startup-overlay').remove(), 500);
            }, 1000);

            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                const sel = document.getElementById('surah-select');
                data.data.forEach(s => sel.innerHTML += `<option value="${s.number}">${s.number}. ${s.name}</option>`);
            } catch(e) {}
        };

        function resizeCardToFit() {
            const container = document.querySelector('.preview-area');
            const card = document.getElementById('card');
            card.style.transform = 'none';
            const scale = Math.min((container.clientWidth - 40) / card.offsetWidth, (container.clientHeight - 40) / card.offsetHeight);
            if (scale < 1) card.style.transform = `scale(${scale})`;
        }

        async function inlineStyles() {
            const links = [{id:'google-fonts', fa:false}, {id:'fa-stylesheet', fa:true}];
            for (const item of links) {
                try {
                    const el = document.getElementById(item.id);
                    if(!el) continue;
                    const res = await fetch(el.href);
                    let css = await res.text();
                    if(item.fa) css = css.replace(/\.\.\/webfonts/g, el.href.replace('/css/all.min.css','')+'/webfonts');
                    const style = document.createElement('style');
                    style.textContent = css;
                    document.head.appendChild(style);
                    el.remove();
                } catch(e){}
            }
        }

        function saveState() {
            const card = document.getElementById('card');
            undoStack.push(card.innerHTML);
            if (undoStack.length > 20) undoStack.shift();
            redoStack = [];
        }

        function undoAction() {
            if(undoStack.length === 0) return;
            const card = document.getElementById('card');
            redoStack.push(card.innerHTML);
            card.innerHTML = undoStack.pop();
            rebindEvents();
            deselect();
        }

        function redoAction() {
            if(redoStack.length === 0) return;
            const card = document.getElementById('card');
            undoStack.push(card.innerHTML);
            card.innerHTML = redoStack.pop();
            rebindEvents();
            deselect();
        }

        function rebindEvents() {
            document.querySelectorAll('.draggable-el').forEach(el => {
                if(!el.hasAttribute('data-events-bound')) setupInteract(el);
            });
        }

        function createWrapper(type) {
            const div = document.createElement('div');
            div.className = `draggable-el ${type} selected`;
            div.innerHTML = `
                <div class="control-btn delete-btn" onclick="removeEl(this.parentNode)"><i class="fas fa-times"></i></div>
                <div class="move-handle"><i class="fas fa-arrows-alt"></i></div>
                <div class="handle resize-nw"></div><div class="handle resize-ne"></div>
                <div class="handle resize-sw"></div><div class="handle resize-se"></div>
                <div class="handle resize-n"></div><div class="handle resize-e"></div><div class="handle resize-s"></div>
            `;
            const content = document.createElement('div');
            content.className = 'content-wrapper';
            content.style.width = '100%'; content.style.height = '100%';
            div.appendChild(content);
            div.insertBefore(content, div.lastChild); 
            return div;
        }

        async function loadAyahs() {
            const num = document.getElementById('surah-select').value;
            if(!num) return;
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}`);
            const data = await res.json();
            currentSurahName = data.data.name;
            const sel = document.getElementById('ayah-select');
            sel.innerHTML = '<option value="">رقم الآية...</option>';
            data.data.ayahs.forEach(a => sel.innerHTML += `<option value="${a.numberInSurah}" data-text="${a.text}">${a.numberInSurah}</option>`);
        }

        function addAyah() {
            const sel = document.getElementById('ayah-select');
            if(!sel.value) return;
            const text = sel.options[sel.selectedIndex].getAttribute('data-text');
            addTextToCanvas(text.trim() + ' ﴿' + sel.value + '﴾', true);
            saveState();
        }

        function addTextToCanvas(content, isQuran) {
            const wrapper = createWrapper('text-layer');
            wrapper.style.color = '#2d3748';
            wrapper.style.fontSize = isQuran ? '28px' : '24px';
            wrapper.style.fontFamily = isQuran ? "'Amiri', serif" : "'Cairo', sans-serif";
            wrapper.style.fontWeight = isQuran ? '500' : '600';
            
            const textDiv = document.createElement('div');
            textDiv.className = isQuran ? 'ayah-text' : 'extra-text';
            textDiv.contentEditable = true;
            textDiv.innerText = content;
            textDiv.onblur = function() { if(this.innerText.trim() === '') this.innerText = 'نص...'; saveState(); };
            
            if(isQuran) {
                const span = document.createElement('div');
                span.innerText = currentSurahName;
                span.style.fontSize = '0.6em'; span.style.marginTop = '10px'; span.style.opacity = '0.7';
                span.className = 'surah-label';
                textDiv.appendChild(span);
            }
            wrapper.querySelector('.content-wrapper').appendChild(textDiv);
            document.getElementById('card').appendChild(wrapper);
            selectEl(wrapper); setupInteract(wrapper);
        }

        function addImageLayer(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'draggable-el image-layer bg-image is-locked';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    wrapper.appendChild(img);
                    const card = document.getElementById('card');
                    card.appendChild(wrapper);
                    saveState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function addRegularImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = createWrapper('image-layer');
                    wrapper.style.width = '200px'; wrapper.style.height = '200px';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    wrapper.querySelector('.content-wrapper').appendChild(img);
                    document.getElementById('card').appendChild(wrapper);
                    selectEl(wrapper); setupInteract(wrapper); saveState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function setupInteract(el) {
            if(el.hasAttribute('data-events-bound')) return;
            el.setAttribute('data-events-bound', 'true');
            
            let lastTap = 0;
            el.addEventListener('touchend', function(e) {
                const cur = new Date().getTime();
                if (cur - lastTap < 300 && !e.target.closest('.control-btn')) {
                    toggleLock(el); e.preventDefault();
                }
                lastTap = cur;
            });
            el.addEventListener('dblclick', () => toggleLock(el));

            el.addEventListener('mousedown', startDrag);
            el.addEventListener('touchstart', startDrag, {passive: false});

            function startDrag(e) {
                if(el.classList.contains('is-locked')) return;
                if(eraserMode) return; 

                if(e.target.isContentEditable && !e.target.closest('.move-handle')) { selectEl(el); return; }

                const isTouch = e.type === 'touchstart';
                const startX = isTouch ? e.touches[0].clientX : e.clientX;
                const startY = isTouch ? e.touches[0].clientY : e.clientY;

                if(e.target.classList.contains('handle')) {
                    handleResize(e, el, e.target, startX, startY);
                    return;
                }
                if(e.target.closest('.control-btn')) return;

                e.preventDefault(); e.stopPropagation();
                selectEl(el);

                const startLeft = el.offsetLeft;
                const startTop = el.offsetTop;

                function onMove(ev) {
                    ev.preventDefault();
                    const cx = isTouch ? ev.touches[0].clientX : ev.clientX;
                    const cy = isTouch ? ev.touches[0].clientY : ev.clientY;
                    el.style.left = `${startLeft + (cx - startX)}px`;
                    el.style.top = `${startTop + (cy - startY)}px`;
                }

                function onUp() {
                    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
                    document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
                    saveState();
                }
                document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive: false});
                document.addEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
            }
        }

        function handleResize(e, el, handle, startX, startY) {
            const isTouch = e.type === 'touchstart';
            const startW = el.offsetWidth;
            const startH = el.offsetHeight;
            const startLeft = el.offsetLeft;
            const startTop = el.offsetTop;

            function onResize(ev) {
                ev.preventDefault(); ev.stopPropagation();
                const cx = isTouch ? ev.touches[0].clientX : ev.clientX;
                const cy = isTouch ? ev.touches[0].clientY : ev.clientY;
                const dx = cx - startX;
                const dy = cy - startY;

                let newW = startW, newH = startH, newLeft = startLeft, newTop = startTop;

                if (handle.classList.contains('resize-n') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-nw')) {
                    newH = Math.max(30, startH - dy);
                    newTop = startTop - (newH - startH)/2;
                } else if (handle.classList.contains('resize-s') || handle.classList.contains('resize-se') || handle.classList.contains('resize-sw')) {
                    newH = Math.max(30, startH + dy);
                    newTop = startTop + (newH - startH)/2;
                }

                if (handle.classList.contains('resize-e') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-se')) {
                    newW = Math.max(30, startW + dx);
                    newLeft = startLeft + (newW - startW)/2;
                } else if (handle.classList.contains('resize-w') || handle.classList.contains('resize-nw') || handle.classList.contains('resize-sw')) {
                    newW = Math.max(30, startW - dx);
                    newLeft = startLeft - (newW - startW)/2;
                }

                el.style.width = newW + 'px';
                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';

                if(el.classList.contains('text-layer')) {
                    if(!(handle.classList.contains('resize-n') || handle.classList.contains('resize-s'))) {
                        el.style.height = 'auto';
                    } else {
                        el.style.height = newH + 'px';
                    }
                } else {
                    el.style.height = newH + 'px';
                }
            }

            function onUp() {
                document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onResize);
                document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
                saveState();
            }
            document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onResize, {passive: false});
            document.addEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
        }

        function toggleEraserMode() {
            eraserMode = !eraserMode;
            magicMode = false;
            const btn = document.getElementById('btn-eraser');
            const controls = document.getElementById('eraser-controls');
            if(eraserMode) {
                deselect();
                btn.classList.add('border-[#c5a059]', 'bg-[#1a472a]', 'text-white');
                controls.classList.add('active');
                document.getElementById('card').classList.add('cursor-crosshair');
                initEraserCanvas();
            } else {
                exitEraserMode();
            }
        }

        function toggleMagicMode() {
            magicMode = !magicMode;
            const btn = document.getElementById('btn-magic');
            document.getElementById('magic-tol-wrap').style.display = magicMode ? 'flex' : 'none';
            btn.classList.toggle('bg-[#c5a059]', magicMode);
            btn.classList.toggle('text-white', magicMode);
            document.getElementById('card').classList.toggle('cursor-alias', magicMode);
        }

        function exitEraserMode() {
            eraserMode = false; magicMode = false;
            document.getElementById('btn-eraser').classList.remove('border-[#c5a059]', 'bg-[#1a472a]', 'text-white');
            document.getElementById('eraser-controls').classList.remove('active');
            document.getElementById('card').classList.remove('cursor-crosshair', 'cursor-alias');
            if(eraserCanvas) { eraserCanvas.remove(); eraserCanvas = null; }
        }

        function initEraserCanvas() {
            const card = document.getElementById('card');
            if(eraserCanvas) eraserCanvas.remove();
            eraserCanvas = document.createElement('canvas');
            eraserCanvas.width = card.offsetWidth; eraserCanvas.height = card.offsetHeight;
            eraserCanvas.id = 'eraser-canvas';
            
            const ctx = eraserCanvas.getContext('2d', {willReadFrequently:true});
            let isDrawing = false;

            const startDraw = (e) => {
                e.preventDefault();
                if(magicMode) {
                    const rect = eraserCanvas.getBoundingClientRect();
                    const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
                    const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
                    magicErase(x, y);
                    return;
                }
                isDrawing = true;
                saveState();
                moveDraw(e);
            };

            const moveDraw = (e) => {
                if(!isDrawing) return;
                const rect = eraserCanvas.getBoundingClientRect();
                const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
                const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
                
                const images = card.querySelectorAll('.image-layer:not(.bg-image)');
                images.forEach(layer => {
                    const img = layer.querySelector('img');
                    if(!img) return;
                    const lRect = layer.getBoundingClientRect();
                    const cRect = card.getBoundingClientRect();
                    const lx = lRect.left - cRect.left;
                    const ly = lRect.top - cRect.top;
                    
                    if(x >= lx && x <= lx + lRect.width && y >= ly && y <= ly + lRect.height) {
                       if(!layer.canvas) {
                           layer.canvas = document.createElement('canvas');
                           layer.canvas.width = lRect.width; layer.canvas.height = lRect.height;
                           layer.canvas.getContext('2d').drawImage(img,0,0, lRect.width, lRect.height);
                       }
                       const ictx = layer.canvas.getContext('2d');
                       ictx.globalCompositeOperation = 'destination-out';
                       ictx.beginPath();
                       ictx.arc(x-lx, y-ly, eraserSize/2, 0, Math.PI*2);
                       ictx.fill();
                       img.src = layer.canvas.toDataURL();
                    }
                });
            };

            eraserCanvas.addEventListener('mousedown', startDraw);
            eraserCanvas.addEventListener('mousemove', moveDraw);
            eraserCanvas.addEventListener('mouseup', () => isDrawing = false);
            eraserCanvas.addEventListener('touchstart', startDraw, {passive:false});
            eraserCanvas.addEventListener('touchmove', moveDraw, {passive:false});
            eraserCanvas.addEventListener('touchend', () => isDrawing = false);
            card.appendChild(eraserCanvas);
        }

        function magicErase(x, y) {
            saveState();
            const images = document.querySelectorAll('.image-layer:not(.bg-image)');
            images.forEach(layer => {
                const img = layer.querySelector('img');
                const lRect = layer.getBoundingClientRect();
                const cRect = document.getElementById('card').getBoundingClientRect();
                const lx = x - (lRect.left - cRect.left);
                const ly = y - (lRect.top - cRect.top);
                
                if(lx>=0 && lx<lRect.width && ly>=0 && ly<lRect.height) {
                    if(!layer.canvas) {
                        layer.canvas = document.createElement('canvas');
                        layer.canvas.width = lRect.width; layer.canvas.height = lRect.height;
                        layer.canvas.getContext('2d').drawImage(img,0,0, lRect.width, lRect.height);
                    }
                    const ctx = layer.canvas.getContext('2d');
                    const imgData = ctx.getImageData(0,0,lRect.width, lRect.height);
                    const data = imgData.data;
                    const idx = (Math.floor(ly)*lRect.width + Math.floor(lx)) * 4;
                    const tr=data[idx], tg=data[idx+1], tb=data[idx+2];
                    
                    for(let i=0; i<data.length; i+=4) {
                        if(Math.abs(data[i]-tr) + Math.abs(data[i+1]-tg) + Math.abs(data[i+2]-tb) < magicTolerance*3) {
                            data[i+3] = 0;
                        }
                    }
                    ctx.putImageData(imgData, 0, 0);
                    img.src = layer.canvas.toDataURL();
                }
            });
        }

        function updateEraserSize(v) { eraserSize = parseInt(v); }
        function updateMagicTolerance(v) { magicTolerance = parseInt(v); }

        function selectEl(el) {
            if(activeEl) activeEl.classList.remove('selected');
            activeEl = el; activeEl.classList.add('selected');
            document.getElementById('quick-props').classList.add('active');
            
            if(el.classList.contains('text-layer')) {
                document.getElementById('top-font-controls').classList.add('active');
                document.getElementById('frame-controls').classList.remove('active');
                document.getElementById('top-font-size').value = parseInt(window.getComputedStyle(el).fontSize);
                const color = el.style.color || '#2d3748';
                document.getElementById('quick-color').value = rgbToHex(color);
            } else if (el.classList.contains('frame-layer')) {
                document.getElementById('frame-controls').classList.add('active');
                document.getElementById('top-font-controls').classList.remove('active');
                
                // Read color based on shape type
                let bg;
                if(el.dataset.shape === 'triangle') {
                    bg = el.querySelector('.content-wrapper').style.backgroundColor;
                } else {
                    bg = el.style.backgroundColor;
                }
                const bc = el.style.borderColor || '#000000';
                const bw = parseInt(el.style.borderWidth) || 0;
                
                document.getElementById('border-color').value = rgbToHex(bc);
                document.getElementById('border-width').value = bw;
                document.getElementById('bg-color').value = rgbToHex(bg || 'transparent');
                document.getElementById('quick-props').classList.remove('active');
            } else {
                document.getElementById('top-font-controls').classList.remove('active');
                document.getElementById('frame-controls').classList.remove('active');
            }
        }

        function rgbToHex(rgb) {
            if(!rgb || rgb==='transparent') return '#ffffff';
            if(rgb.startsWith('#')) return rgb;
            const sep = rgb.indexOf(',') > -1 ? ',' : ' ';
            const parts = rgb.substr(4).split(')')[0].split(sep);
            let r = (+parts[0]).toString(16), g = (+parts[1]).toString(16), b = (+parts[2]).toString(16);
            if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b;
            return "#" + r + g + b;
        }

        function deselect(e) {
            if(e && (e.target.closest('.draggable-el') || e.target.closest('.glass-panel') || e.target.closest('.controls-row'))) return;
            if(activeEl) activeEl.classList.remove('selected');
            activeEl = null;
            document.querySelectorAll('.controls-row').forEach(r => r.classList.remove('active'));
            exitEraserMode();
            document.getElementById('shape-menu-content').classList.add('hidden');
            document.getElementById('size-menu-content').classList.add('hidden');
        }

        function toggleLock(el) { el.classList.toggle('is-locked'); if(el.classList.contains('is-locked')) deselect(); else selectEl(el); }
        function removeEl(el) { el.remove(); deselect(); saveState(); }
        function deleteActive() { if(activeEl) removeEl(activeEl); }
        
        function updateStyle(prop, val) {
            if(!activeEl) return;
            
            // Triangle special case for background
            if (prop === 'backgroundColor' && activeEl.dataset.shape === 'triangle') {
                activeEl.querySelector('.content-wrapper').style.backgroundColor = val;
            } else {
                activeEl.style[prop] = val;
            }

            if(prop === 'color' || prop === 'borderColor') {
                const label = activeEl.querySelector('.surah-label');
                if(label) label.style.color = val;
            }
            if(prop === 'color') document.getElementById('quick-color').value = val;
            saveState();
        }

        function toggleGradient() {
            hasGradient = !hasGradient;
            document.getElementById('card-gradient').style.display = hasGradient ? 'block' : 'none';
            document.getElementById('grad-controls').classList.toggle('active', hasGradient);
            document.getElementById('btn-grad').classList.toggle('border-[#c5a059]', hasGradient);
        }
        function setGradientColor(c) {
            const end = c==='white' ? 'rgba(255,255,255,0.95)' : 'rgba(0,0,0,0.95)';
            const start = c==='white' ? 'rgba(255,255,255,0)' : 'rgba(0,0,0,0)';
            document.getElementById('card-gradient').style.background = `linear-gradient(to top, ${end}, ${start})`;
        }
        function setGradientOpacity(v) { document.getElementById('card-gradient').style.opacity = v; }
        function toggleBg() {
            isTransparent = !isTransparent;
            document.getElementById('card').style.backgroundColor = isTransparent ? 'transparent' : 'white';
            document.getElementById('btn-bg').classList.toggle('bg-[#1a472a]', isTransparent);
            document.getElementById('btn-bg').classList.toggle('text-white', isTransparent);
        }
        
        function setCardSize(w, h, l) {
            const card = document.getElementById('card');
            card.style.width = w+'px'; card.style.height = h+'px';
            document.getElementById('size-label').innerText = l;
            document.getElementById('size-menu-content').classList.add('hidden');
            resizeCardToFit();
        }
        function toggleSizeMenu() { 
            document.getElementById('size-menu-content').classList.toggle('hidden'); 
            document.getElementById('shape-menu-content').classList.add('hidden'); 
        }
        function toggleShapeMenu() { 
            document.getElementById('shape-menu-content').classList.toggle('hidden'); 
            document.getElementById('size-menu-content').classList.add('hidden'); 
        }
        function toggleRangeMode() { document.getElementById('range-ayah-container').classList.toggle('hidden'); }
        function addExtraText() { addTextToCanvas("نص جديد", false); saveState(); }
        
        function addFrame() {
            const w = createWrapper('frame-layer'); 
            w.style.borderColor='#1a472a'; 
            w.style.borderWidth='2px';
            w.style.width='200px'; w.style.height='200px';
            document.getElementById('card').appendChild(w); selectEl(w); setupInteract(w); saveState();
        }

        // New addShape logic
        function addShape(type) {
            const w = createWrapper('frame-layer');
            w.style.width='150px'; w.style.height='150px';
            w.dataset.shape = type; // Store shape type

            if(type === 'square') {
                w.style.backgroundColor='#c5a059';
                w.style.borderRadius='0';
            } else if(type === 'circle') {
                w.style.backgroundColor='#c5a059';
                w.style.borderRadius='50%';
            } else if(type === 'triangle') {
                w.style.backgroundColor='transparent'; // wrapper transparent
                const content = w.querySelector('.content-wrapper');
                content.style.backgroundColor = '#c5a059';
                content.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                content.style.width = '100%';
                content.style.height = '100%';
            }

            document.getElementById('card').appendChild(w);
            document.getElementById('shape-menu-content').classList.add('hidden');
            selectEl(w); setupInteract(w); saveState();
        }

        function addMultipleAyahs() {
            const f = parseInt(document.getElementById('ayah-from').value);
            const t = parseInt(document.getElementById('ayah-to').value);
            const sel = document.getElementById('ayah-select');
            if(!f || !t || f>t) return alert('خطأ في النطاق');
            let txt = "";
            for(let i=f; i<=t; i++) {
                for(let opt of sel.options) {
                    if(parseInt(opt.value)===i) { txt += opt.getAttribute('data-text').trim() + ' ﴿'+i+'﴾ '; break; }
                }
            }
            addTextToCanvas(txt, true); saveState();
        }

        // --- NEW EXPORT LOGIC WITH PROGRESS BAR & DECODE ---
        function updateProgress(percent, text) {
            document.getElementById('export-progress').style.width = percent + '%';
            document.getElementById('progress-text').innerText = percent + '%';
            document.getElementById('export-status').innerText = text;
        }

        async function exportCard() {
            deselect();
            const card = document.getElementById('card');
            const overlay = document.getElementById('export-overlay');
            const modal = document.getElementById('save-modal');
            const imgPreview = document.getElementById('save-img');
            
            overlay.style.display = 'flex';
            updateProgress(10, "جاري تحضير العناصر...");
            
            const oldT = card.style.transform;
            card.style.transform = 'scale(1)'; 
            document.querySelectorAll('.handle, .control-btn').forEach(e => e.style.display = 'none');

            try {
                // 1. Wait for Fonts
                await document.fonts.ready;
                updateProgress(30, "جاري معالجة الصور...");

                // 2. FORCE DECODE ALL IMAGES
                const imgs = card.querySelectorAll('img');
                const promises = Array.from(imgs).map(img => {
                    if (img.complete) {
                         // Try decoding if supported
                         if (img.decode) return img.decode().catch(() => {}); 
                         return Promise.resolve();
                    }
                    return new Promise(r => { img.onload = () => { if(img.decode) img.decode().catch(()=>{}); r(); }; img.onerror = r; });
                });
                await Promise.all(promises);
                
                updateProgress(50, "جاري المعالجة الأولية...");
                
                // 3. Force Layout Thrash
                void card.offsetHeight; 
                await new Promise(r => setTimeout(r, 500)); // Delay for paint

                // 4. WARM UP CAPTURE (Discarded)
                updateProgress(70, "تحسين الدقة...");
                await htmlToImage.toPng(card, { quality: 0.5, pixelRatio: 1 });
                
                // 5. Short Delay before Final
                await new Promise(r => setTimeout(r, 800)); 

                // 6. FINAL CAPTURE
                updateProgress(90, "إنشاء الصورة النهائية...");
                const url = await htmlToImage.toPng(card, {
                    quality: 1.0, pixelRatio: 3, cacheBust: true, style: { transform: 'none', margin: 0 }
                });

                updateProgress(100, "تم!");
                
                imgPreview.src = url;
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    modal.style.display = 'flex';
                }, 500);

            } catch(e) { 
                console.error(e);
                alert('حدث خطأ بسيط في التصدير، حاول مرة أخرى.'); 
                overlay.style.display = 'none';
            } finally {
                card.style.transform = oldT;
            }
        }
        
        function downloadImage() {
            const link = document.createElement('a');
            link.download = `quran-design-${Date.now()}.png`;
            link.href = document.getElementById('save-img').src;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function showInstallPrompt() { alert("لتثبيت التطبيق:\nآيفون: زر المشاركة -> إضافة للصفحة الرئيسية\nأندرويد: الثلاث نقاط -> تثبيت التطبيق"); }

        // Load saved bookmark on mushaf init
        window.addEventListener('load', () => {
            const savedBookmark = localStorage.getItem('quran_bookmark');
            if (savedBookmark) {
                const bookmark = JSON.parse(savedBookmark);
                console.log('تم العثور على علامة مرجعية:', bookmark.surahName);
            }
        });
    </script>
</body>
</html>
</html>