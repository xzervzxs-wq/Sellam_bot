<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒØ§Ø´Ù Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ØªÙØ§Ø­ÙŠØ© - Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script async src="https://cdn.jsdelivr.net/npm/opencv.js@4.5.1/opencv.js" onload="onOpenCvReady();"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a472a 0%, #2d6a4f 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        canvas {
            border-radius: 15px;
            border: 3px solid #ff5722;
            max-width: 100%;
            height: auto;
        }
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .badge-ready {
            background: #4caf50;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        .badge-loading {
            background: #ff9800;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 bg-white/20 text-white px-6 py-3 rounded-full backdrop-blur">
                <i class="fas fa-circle text-2xl text-red-500"></i>
                <h1 class="text-3xl font-bold">ÙƒØ§Ø´Ù Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ØªÙØ§Ø­ÙŠØ©</h1>
                <i class="fas fa-quran text-2xl text-[#c5a059]"></i>
            </div>
        </div>

        <!-- Main Container -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Control Panel -->
            <div class="glass-panel p-8">
                <h2 class="text-2xl font-bold text-[#1a472a] mb-6">
                    <i class="fas fa-sliders-h text-red-500"></i> Ø§Ù„ØªØ­ÙƒÙ…
                </h2>

                <!-- Page Selector -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© (1-604)</label>
                    <div class="flex gap-2">
                        <input type="number" id="page-num" min="1" max="604" value="4" class="flex-1 p-3 border-2 border-red-500 rounded-lg font-bold text-center">
                        <button id="load-btn" class="bg-gradient-to-r from-red-600 to-orange-600 text-white px-6 rounded-lg font-bold hover:shadow-lg transition">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <!-- Or Upload Local Image -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø£Ùˆ Ø­Ù…Ù‘Ù„ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</label>
                    <label class="block border-3 border-dashed border-red-500 rounded-lg p-4 text-center cursor-pointer hover:bg-red-50 transition">
                        <input type="file" id="image-upload" class="hidden" accept="image/*,.svg">
                        <i class="fas fa-image text-2xl text-red-500 mb-2 block"></i>
                        <span class="text-sm font-bold text-[#1a472a]">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ·</span>
                    </label>
                </div>

                <!-- Detection Settings -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ÙƒØ´Ù</label>
                        <input type="range" id="sensitivity" min="5" max="50" value="15" class="w-full accent-red-500">
                        <div class="text-xs text-gray-600 mt-1">Ø£Ù‚Ù„ = Ø£ÙƒØ«Ø± Ø­Ø³Ø§Ø³ÙŠØ©</div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø­Ø¬Ù… (Ø¨ÙƒØ³Ù„)</label>
                        <input type="range" id="min-radius" min="1" max="100" value="5" class="w-full accent-red-500">
                        <span id="min-val" class="text-xs text-gray-600">5</span>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-[#1a472a] mb-2">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬Ù… (Ø¨ÙƒØ³Ù„)</label>
                        <input type="range" id="max-radius" min="20" max="200" value="80" class="w-full accent-red-500">
                        <span id="max-val" class="text-xs text-gray-600">80</span>
                    </div>
                </div>

                <!-- Color Range -->
                <div class="bg-red-50 p-4 rounded-lg mb-6 border border-red-200">
                    <h3 class="font-bold text-[#1a472a] mb-3 text-sm">ğŸ¨ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±</h3>
                    <div class="space-y-2 text-xs">
                        <div>
                            <label>Hue Ø§Ù„Ø£Ø¯Ù†Ù‰:</label>
                            <input type="range" id="h-min" min="0" max="180" value="0" class="w-full accent-red-500">
                            <span id="h-min-val" class="text-gray-600">0</span>
                        </div>
                        <div>
                            <label>Hue Ø§Ù„Ø£Ù‚ØµÙ‰:</label>
                            <input type="range" id="h-max" min="0" max="180" value="15" class="w-full accent-red-500">
                            <span id="h-max-val" class="text-gray-600">15</span>
                        </div>
                        <div>
                            <label>Saturation Ø§Ù„Ø£Ø¯Ù†Ù‰:</label>
                            <input type="range" id="s-min" min="0" max="255" value="80" class="w-full accent-red-500">
                            <span id="s-min-val" class="text-gray-600">80</span>
                        </div>
                        <div>
                            <label>Value Ø§Ù„Ø£Ø¯Ù†Ù‰:</label>
                            <input type="range" id="v-min" min="0" max="255" value="80" class="w-full accent-red-500">
                            <span id="v-min-val" class="text-gray-600">80</span>
                        </div>
                    </div>
                </div>

                <!-- Detection Button -->
                <button id="detect-btn" class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition disabled:opacity-50">
                    <i class="fas fa-search"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØ´Ù
                </button>

                <!-- Status -->
                <div id="status" class="mt-4 text-center text-sm">
                    <span class="badge-loading">
                        <i class="fas fa-spinner loading"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…...
                    </span>
                </div>
            </div>

            <!-- Preview -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Original -->
                <div class="glass-panel p-6">
                    <h3 class="font-bold text-[#1a472a] mb-3">
                        <i class="fas fa-file-image text-red-500"></i> Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                    </h3>
                    <div id="original-container" class="bg-gray-200 rounded-lg flex items-center justify-center min-h-[400px]">
                        <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>

                <!-- Detected -->
                <div class="glass-panel p-6">
                    <h3 class="font-bold text-[#1a472a] mb-3">
                        <i class="fas fa-check-circle text-red-500"></i> Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ù…ÙƒØªØ´ÙØ©
                    </h3>
                    <div id="detected-container" class="bg-gray-200 rounded-lg flex items-center justify-center min-h-[400px]">
                        <p class="text-gray-500">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
                    </div>
                    <button id="download-detected" disabled class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg font-bold disabled:opacity-50">
                        <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results-section" class="hidden mt-8 glass-panel p-8">
            <h2 class="text-2xl font-bold text-[#1a472a] mb-6">
                <i class="fas fa-list text-red-500"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                <span id="count-badge" class="bg-red-500 text-white px-3 py-1 rounded-full text-lg ml-2">0</span>
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2">
                    <div id="results-list" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
                </div>
                <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                    <h4 class="font-bold text-[#1a472a] mb-4">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                            <span id="stat-total" class="font-bold text-red-600">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ù…:</span>
                            <span id="stat-avg" class="font-bold">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JSON -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h3 class="font-bold text-[#1a472a] mb-3">
                    <i class="fas fa-code text-red-500"></i> JSON
                </h3>
                <textarea id="json-output" class="w-full h-40 p-3 bg-white border-2 border-red-500 rounded-lg font-mono text-xs" readonly></textarea>
                <div class="flex gap-2 mt-4">
                    <button id="copy-json" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold">
                        <i class="fas fa-copy"></i> Ù†Ø³Ø®
                    </button>
                    <button id="download-json" class="flex-1 bg-orange-600 text-white py-2 rounded-lg font-bold">
                        <i class="fas fa-download"></i> Ø­ÙØ¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalCanvas = null;
        let detectedCircles = [];
        let openCvReady = false;

        function onOpenCvReady() {
            openCvReady = true;
            console.log('âœ… OpenCV Ø¬Ø§Ù‡Ø²!');
            document.getElementById('status').innerHTML = 'âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² - Ø­Ù…Ù‘Ù„ ØµÙØ­Ø© Ø§Ù„Ø¢Ù†';
        }

        // Update slider values
        document.getElementById('min-radius').addEventListener('input', (e) => {
            document.getElementById('min-val').textContent = e.target.value;
        });
        document.getElementById('max-radius').addEventListener('input', (e) => {
            document.getElementById('max-val').textContent = e.target.value;
        });
        document.getElementById('h-min').addEventListener('input', (e) => {
            document.getElementById('h-min-val').textContent = e.target.value;
        });
        document.getElementById('h-max').addEventListener('input', (e) => {
            document.getElementById('h-max-val').textContent = e.target.value;
        });
        document.getElementById('s-min').addEventListener('input', (e) => {
            document.getElementById('s-min-val').textContent = e.target.value;
        });
        document.getElementById('v-min').addEventListener('input', (e) => {
            document.getElementById('v-min-val').textContent = e.target.value;
        });

        // Load SVG from GitHub
        document.getElementById('load-btn').addEventListener('click', async () => {
            if (!openCvReady) {
                alert('â³ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹... Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªÙ‡ÙŠØ£');
                return;
            }

            const pageNum = String(document.getElementById('page-num').value).padStart(3, '0');
            const url = `https://raw.githubusercontent.com/batoulapps/quran-svg/main/svg/${pageNum}.svg`;

            document.getElementById('load-btn').disabled = true;
            document.getElementById('status').innerHTML = '<i class="fas fa-spinner loading"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... Ø§Ù†ØªØ¸Ø±!';

            try {
                console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„:', url);
                const response = await fetch(url, { mode: 'cors' });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const svgText = await response.text();
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ SVG');

                // Create img from SVG
                const blob = new Blob([svgText], { type: 'image/svg+xml' });
                const objectUrl = URL.createObjectURL(blob);
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
                    
                    // Create canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    originalCanvas = canvas;

                    // Display
                    document.getElementById('original-container').innerHTML = `<img src="${canvas.toDataURL()}" style="max-height: 500px;">`;
                    document.getElementById('detect-btn').disabled = false;
                    document.getElementById('status').innerHTML = 'âœ… Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© - Ø§Ø¶ØºØ· Ø§Ù„ÙƒØ´Ù';
                    document.getElementById('load-btn').disabled = false;
                    
                    URL.revokeObjectURL(objectUrl);
                };
                
                img.onerror = () => {
                    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
                    document.getElementById('status').innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©';
                    document.getElementById('load-btn').disabled = false;
                };
                
                img.src = objectUrl;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                document.getElementById('status').innerHTML = 'âŒ Ø®Ø·Ø£: ' + error.message;
                document.getElementById('load-btn').disabled = false;
            }
        });

        // Upload local image
        document.getElementById('image-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('status').innerHTML = '<i class="fas fa-spinner loading"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...';

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // Create canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    originalCanvas = canvas;

                    // Display
                    document.getElementById('original-container').innerHTML = `<img src="${canvas.toDataURL()}" style="max-height: 500px;">`;
                    document.getElementById('detect-btn').disabled = false;
                    document.getElementById('status').innerHTML = 'âœ… Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© - Ø§Ø¶ØºØ· Ø§Ù„ÙƒØ´Ù';
                };
                img.onerror = () => {
                    document.getElementById('status').innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Drag & drop
        document.getElementById('image-upload').parentElement.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.style.background = '#ffebee';
        });

        document.getElementById('image-upload').parentElement.addEventListener('dragleave', (e) => {
            e.currentTarget.style.background = '';
        });

        document.getElementById('image-upload').parentElement.addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('image-upload').files = files;
                const event = new Event('change', { bubbles: true });
                document.getElementById('image-upload').dispatchEvent(event);
            }
        });

        // Detect circles
        document.getElementById('detect-btn').addEventListener('click', () => {
            if (!originalCanvas) {
                alert('Ø­Ù…Ù‘Ù„ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }

            if (!openCvReady) {
                alert('â³ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹... Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªÙ‡ÙŠØ£');
                return;
            }

            document.getElementById('detect-btn').disabled = true;
            document.getElementById('status').innerHTML = '<i class="fas fa-spinner loading"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ´Ù... Ø§Ù†ØªØ¸Ø± (Ù‚Ø¯ ÙŠØ£Ø®Ø° ÙˆÙ‚Øª)';

            setTimeout(() => {
                try {
                    detectAppleCircles();
                    document.getElementById('status').innerHTML = 'âœ… ØªÙ… Ø§Ù„ÙƒØ´Ù!';
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£:', error);
                    document.getElementById('status').innerHTML = 'âŒ Ø®Ø·Ø£: ' + error.message;
                }
                document.getElementById('detect-btn').disabled = false;
            }, 100);
        });

        function detectAppleCircles() {
            try {
                let src = cv.imread(originalCanvas);
                let hsv = new cv.Mat();
                cv.cvtColor(src, hsv, cv.COLOR_BGR2HSV);

                // Get color range values
                const hMin = parseInt(document.getElementById('h-min').value);
                const hMax = parseInt(document.getElementById('h-max').value);
                const sMin = parseInt(document.getElementById('s-min').value);
                const vMin = parseInt(document.getElementById('v-min').value);

                let lowerBound = cv.matFromArray(3, 1, cv.CV_8U, [hMin, sMin, vMin]);
                let upperBound = cv.matFromArray(3, 1, cv.CV_8U, [hMax, 255, 255]);

                let mask = new cv.Mat();
                cv.inRangeS(hsv, lowerBound, upperBound, mask);

                // Morphological operations
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(5, 5));
                cv.morphologyEx(mask, mask, cv.MORPH_CLOSE, kernel);
                cv.morphologyEx(mask, mask, cv.MORPH_OPEN, kernel);

                // Find contours
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(mask, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);

                detectedCircles = [];
                const minRadius = parseInt(document.getElementById('min-radius').value);
                const maxRadius = parseInt(document.getElementById('max-radius').value);

                for (let i = 0; i < contours.size(); i++) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    let perimeter = cv.arcLength(cnt, true);

                    // Circularity check (Ø£Ù‚Ù„ ØµØ±Ø§Ù…Ø© Ù„Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ØµØºÙŠØ±Ø©)
                    let circularity = (4 * Math.PI * area) / (perimeter * perimeter);

                    if (circularity > 0.3 && area > 30) {
                        // Find center
                        let M = cv.moments(cnt);
                        if (M.m00 !== 0) {
                            let cx = M.m10 / M.m00;
                            let cy = M.m01 / M.m00;
                            let radius = Math.sqrt(area / Math.PI);

                            if (radius >= minRadius && radius <= maxRadius) {
                                detectedCircles.push({
                                    id: detectedCircles.length + 1,
                                    x: Math.round(cx),
                                    y: Math.round(cy),
                                    radius: Math.round(radius),
                                    area: Math.round(area),
                                    circularity: circularity.toFixed(2)
                                });
                            }
                        }
                    }
                    cnt.delete();
                }

                // Sort by Y position
                detectedCircles.sort((a, b) => a.y - b.y);

                // Draw results
                drawDetectedCircles();
                displayResults();

                // Cleanup
                src.delete();
                hsv.delete();
                lowerBound.delete();
                upperBound.delete();
                mask.delete();
                kernel.delete();
                contours.delete();
                hierarchy.delete();

                document.getElementById('status').innerHTML = `âœ… ØªÙ… ÙƒØ´Ù ${detectedCircles.length} Ø¯Ø§Ø¦Ø±Ø©!`;
            } catch (error) {
                document.getElementById('status').innerHTML = 'âŒ Ø®Ø·Ø£: ' + error.message;
            }
        }

        function drawDetectedCircles() {
            const canvas = originalCanvas.cloneNode(true);
            const ctx = canvas.getContext('2d');

            detectedCircles.forEach((circle) => {
                // Draw circle
                ctx.strokeStyle = '#ff5722';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI);
                ctx.stroke();

                // Draw number
                ctx.fillStyle = '#ff5722';
                ctx.font = 'bold 24px Arial';
                ctx.fillText(circle.id, circle.x - 10, circle.y + 8);

                // Draw center
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(circle.x - 3, circle.y - 3, 6, 6);
            });

            document.getElementById('detected-container').innerHTML = `<img src="${canvas.toDataURL()}" style="max-height: 500px;">`;
            document.getElementById('download-detected').disabled = false;
        }

        function displayResults() {
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('count-badge').textContent = detectedCircles.length;
            document.getElementById('stat-total').textContent = detectedCircles.length;

            if (detectedCircles.length > 0) {
                const avgSize = (detectedCircles.reduce((sum, c) => sum + c.radius, 0) / detectedCircles.length).toFixed(1);
                document.getElementById('stat-avg').textContent = avgSize + 'px';
            }

            const html = detectedCircles.map(c => `
                <div class="bg-white p-3 rounded-lg border-l-4 border-red-500 hover:bg-red-50">
                    <div class="font-bold text-red-600">Ø¯Ø§Ø¦Ø±Ø© #${c.id}</div>
                    <div class="text-xs text-gray-600 mt-1">
                        Ø§Ù„Ù…ÙˆÙ‚Ø¹: (${c.x}, ${c.y}) | Ø§Ù„Ø­Ø¬Ù…: ${c.radius}px | Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${c.area}pxÂ²
                    </div>
                </div>
            `).join('');

            document.getElementById('results-list').innerHTML = html;

            // JSON
            const jsonData = {
                page: document.getElementById('page-num').value,
                timestamp: new Date().toISOString(),
                total_circles: detectedCircles.length,
                circles: detectedCircles
            };

            document.getElementById('json-output').value = JSON.stringify(jsonData, null, 2);
        }

        // Copy & Download
        document.getElementById('copy-json').addEventListener('click', () => {
            const json = document.getElementById('json-output').value;
            navigator.clipboard.writeText(json).then(() => {
                alert('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!');
            });
        });

        document.getElementById('download-json').addEventListener('click', () => {
            const json = document.getElementById('json-output').value;
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `page_${document.getElementById('page-num').value}_circles.json`;
            a.click();
        });

        document.getElementById('download-detected').addEventListener('click', () => {
            const img = document.getElementById('detected-container').querySelector('img');
            const a = document.createElement('a');
            a.href = img.src;
            a.download = `page_${document.getElementById('page-num').value}_detected.png`;
            a.click();
        });
    </script>
</body>
</html>
