import pandas as pd
import warnings
from datetime import datetime, time
import requests
import os
import json
import time as tm
import pytz
import sys
from bs4 import BeautifulSoup
import yfinance as yf
from dotenv import load_dotenv

# =========================================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ´ØºÙŠÙ„
# =========================================================
load_dotenv()

# Ù…ÙØªØ§Ø­ FMP (Ø§Ù„Ø°ÙŠ Ø°ÙƒØ±ØªÙ‡ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·)
API_KEY = "AZN1TXFIT4MUGXLSVWO73WUSJZ8F2V21"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…
TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

# Ø§Ù„ÙƒÙˆÙƒÙŠØ² ÙˆØ§Ù„Ù‡ÙŠØ¯Ø±
FINVIZ_COOKIE = """chartsTheme=dark; notice-newsletter=show; .ASPXAUTH=D330CB967EBE91926315BB9896B542528FF96DB8449F94F13D70816840198C006BFE7A3CF07AC123267CF83332233DAA6683BF667094DA4E899E12522DE82675747491B6F4350E4509C583E3631170A62D3152AC1D06B0829E119643B88B6BDCD3F47CE1F3BD22EFC8D6D838309B4DE85731B7FA14B437E1F3B858A371CA791B8AC3C09A10CD35225E249F3A817831A54209E9B0D90CE1C50B44482DC1FF1075E2A7F75B80B548D294C3873028318046AF1626F9FED7865D8217521A464D229739F4137055A9F5D559A2E58B0C731C9185F567CC; survey_dialog_cohort=0; customColors=%7B%22light%22%3A%7B%7D%2C%22dark%22%3A%7B%7D%7D; customColorsExpiration=12%2F27%2F2025%203%3A58%3A53%20PM"""
FINVIZ_HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
    "Connection": "keep-alive",
    "Cookie": FINVIZ_COOKIE
}

warnings.simplefilter(action='ignore', category=FutureWarning)
FLOAT_CACHE_FILE = "float_cache.json"
SHARIAH_FILE = "shariah_stocks_master.json"

# =========================================================
# 2. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers)
# =========================================================
def get_shariah_status(symbol):
    """Ø¬Ù„Ø¨ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø´Ø±Ø¹ÙŠ Ù„Ù„Ø³Ù‡Ù… Ù…Ù† Ù…Ù„Ù shariah_stocks_master.json"""
    try:
        if os.path.exists(SHARIAH_FILE):
            with open(SHARIAH_FILE, 'r') as f:
                data = json.load(f)
            if symbol in data:
                status = data[symbol].get('status', '')
                if status == 'halal':
                    return 'âœ… Ø­Ù„Ø§Ù„'
                else:
                    return 'ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±'
        return 'ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±'
    except:
        return 'ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±'

def send_telegram(message):
    if not TELEGRAM_BOT_TOKEN: return
    try:
        requests.post(
            f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",
            data={'chat_id': TELEGRAM_CHAT_ID, 'text': message, 'parse_mode': 'Markdown'},
            timeout=5
        )
    except: pass

def fmt_shares(n):
    if not isinstance(n, (int, float)): return "ØºÙŠØ± Ù…ØªØ§Ø­"
    if n >= 1_000_000: return f"{n/1_000_000:.2f}M"
    if n >= 1_000: return f"{n/1_000:.0f}K"
    return str(int(n))

def clean_number(text):
    if not text or text == '-': return 0
    if isinstance(text, (int, float)): return text
    text = str(text).replace(',', '').replace('%', '')
    try:
        if 'M' in text: return float(text.replace('M', '')) * 1_000_000
        if 'B' in text: return float(text.replace('B', '')) * 1_000_000_000
        if 'K' in text: return float(text.replace('K', '')) * 1_000
        return float(text)
    except: return 0

def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r') as f: return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f: json.dump(data, f)
    except: pass

def get_float_shares_fmp(symbol):
    float_data_store = load_json_file(FLOAT_CACHE_FILE)
    val = float_data_store.get(symbol)
    if isinstance(val, dict): val = val.get('value', 0)
    if isinstance(val, (int, float)) and val > 0: return val

    val = None
    try:
        # Ù†Ø¨Ù‚ÙŠ Ù‡Ø°Ø§ v4 Ù„Ø£Ù†Ù‡ Ø®Ø§Øµ Ø¨Ø§Ù„ÙÙ„ÙˆØª
        url = f"https://financialmodelingprep.com/stable/shares-float?symbol={symbol}&apikey={API_KEY}"
        data = requests.get(url, timeout=5).json()
        if data and isinstance(data, list): val = float(data[0].get('floatShares', 0))
    except: pass
    
    val = val if val else 0
    float_data_store[symbol] = val
    save_json_file(FLOAT_CACHE_FILE, float_data_store)
    return val

def scrape_finviz_list(url, limit=30):
    candidates = []
    try:
        resp = requests.get(url, headers=FINVIZ_HEADERS, timeout=15)
        soup = BeautifulSoup(resp.text, 'html.parser')
        table = soup.find('table', {'class': 'screener_table'})
        
        if not table:
            for t in soup.find_all('table'):
                if len(t.find_all('tr')) > 10:
                    table = t
                    break
        if not table: return []

        rows = table.find_all('tr')
        count = 0
        for row in rows[1:]:
            if count >= limit: break
            cells = row.find_all('td')
            if len(cells) >= 10:
                try:
                    ticker = cells[1].get_text().strip()
                    # Ø§Ù„Ø³Ø¹Ø± Ø¹Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 9 Ø£Ùˆ 10 Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø±Ø¶ØŒ Ù‡Ù†Ø§ Ù†Ø£Ø®Ø° Ø§Ù„Ù†Øµ ÙˆÙ†Ù†Ø¸ÙÙ‡
                    price_text = cells[8].get_text().strip() if '$' in cells[8].get_text() else cells[9].get_text().strip()
                    price = clean_number(price_text)
                    
                    if ticker and '.' not in ticker and len(ticker) <= 5:
                        candidates.append({'symbol': ticker, 'price': price})
                        count += 1
                except: continue
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Scrape Finviz: {e}")
    return candidates

# =========================================================
# 3. Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø³Ù„Ù… (Ø§Ù„Ù…ØµØ¯Ø± Finviz -> Ø´Ù…ÙˆØ¹ FMP)
# =========================================================
def get_fmp_candles(symbol):
    # âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Stable Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙƒÙ€ Query Parameter
    url = f"https://financialmodelingprep.com/stable/historical-chart/5min?symbol={symbol}&apikey={API_KEY}"
    
    try:
        r = requests.get(url, timeout=10).json()
        if not r: return pd.DataFrame()
        df = pd.DataFrame(r)
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if 'date' not in df.columns: return pd.DataFrame()
        
        df['date'] = pd.to_datetime(df['date'], errors='coerce')
        df = df.set_index('date').sort_index()
        # ØªÙˆØ­ÙŠØ¯ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Open, High, Low, Close)
        df.columns = df.columns.str.capitalize()
        return df
    except Exception as e:
        # print(f"âš ï¸ Error FMP {symbol}: {e}")
        return pd.DataFrame()

def check_ladder_pattern(df_window):
    """
    ØªØ­Ù„ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©
    Returns: (is_valid, strength, reason, highest_high, is_pending_order)
    - is_pending_order = True Ø¥Ø°Ø§ ØµØ¹Ø¯ Ù„ÙƒÙ† Ø£ØºÙ„Ù‚ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‚Ù…Ø© (Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚)
    """
    if len(df_window) < 3:
        return False, 0, "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©", 0, False

    candles = [row for _, row in df_window.iterrows()]
    start_price = float(candles[0]['Open'])
    current_price = float(candles[-1]['Close'])

    # 1. Ø´Ø±Ø· Ù…Ø¨Ø¯Ø¦ÙŠ: Ù„Ø§Ø²Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    if current_price <= start_price:
        return False, 0, "Ø§Ù„Ø³Ø¹Ø± Ù„Ù… ÙŠØµØ¹Ø¯", 0, False

    highest_high = float(candles[0]['High'])
    prev_low = float(candles[0]['Low'])
    prev_close = float(candles[0]['Close'])

    stagnation_count = 0
    new_highs_count = 0

    for i in range(1, len(candles)):
        row = candles[i]
        c_close = float(row['Close'])
        c_high = float(row['High'])
        c_low = float(row['Low'])
        c_open = float(row['Open'])

        body = abs(c_close - c_open)
        upper_wick = c_high - max(c_open, c_close)

        # ØªØªØ¨Ø¹ Ø§Ù„Ù‚Ù…Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if c_high > highest_high:
            highest_high = c_high
            new_highs_count += 1
            stagnation_count = 0
        else:
            distance_from_high = (highest_high - c_close) / highest_high if highest_high > 0 else 0
            if distance_from_high < 0.015:
                stagnation_count += 0.5
            else:
                stagnation_count += 1

        # ÙÙ‚Ø¯ Ø§Ù„Ø²Ø®Ù…
        if stagnation_count >= 3.5:
            return False, 0, "ÙÙ‚Ø¯ Ø§Ù„Ø²Ø®Ù… (Ø±ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„)", highest_high, False

        # ÙƒØ³Ø± Ù‚Ø§Ø¹ Ø³Ø§Ø¨Ù‚
        if c_close < (prev_low * 0.998):
            return False, 0, f"ÙƒØ³Ø± Ù‚Ø§Ø¹ Ø³Ø§Ø¨Ù‚ (Ø´Ù…Ø¹Ø© {i+1})", highest_high, False

        # Ø°ÙŠÙ„ ØªØµØ±ÙŠÙ
        avg_body_ref = abs(prev_close - prev_low) + 0.01
        if upper_wick > body * 2.5 and upper_wick > avg_body_ref * 1.5:
            return False, 0, "Ø°ÙŠÙ„ ØªØµØ±ÙŠÙ ÙˆØ§Ø¶Ø­", highest_high, False

        prev_low = c_low
        prev_close = c_close

    # Ø­Ø±ÙƒØ© Ø¶Ø¹ÙŠÙØ©
    total_gain_pct = (current_price - start_price) / start_price
    if total_gain_pct < 0.005:
        return False, 0, "Ø­Ø±ÙƒØ© Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹", highest_high, False

    # Ù„Ù… ÙŠØ­Ù‚Ù‚ Ù‚Ù…Ù… Ø¬Ø¯ÙŠØ¯Ø©
    if new_highs_count < 1:
        return False, 0, "Ù„Ù… ÙŠØ­Ù‚Ù‚ Ù‚Ù…Ù… Ø¬Ø¯ÙŠØ¯Ø©", highest_high, False

    # âœ… Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ù‡Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ù…Ø©ØŸ
    if current_price < (highest_high * 0.985):
        # ğŸ”” ØµØ¹Ø¯ Ù„ÙƒÙ† Ø£ØºÙ„Ù‚ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‚Ù…Ø© = Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚
        strength_pct = int((new_highs_count / len(candles)) * 100)
        return False, strength_pct, "Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‚Ù…Ø© (Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚)", highest_high, True

    # âœ… Ù†Ø¬Ø­ ØªÙ…Ø§Ù…Ø§Ù‹ = Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±
    strength_pct = int((new_highs_count / len(candles)) * 100)
    if current_price >= highest_high * 0.995:
        strength_pct = 95

    return True, strength_pct, "Ù†Ù…ÙˆØ°Ø¬ Ù‚ÙˆÙŠ ÙˆÙ…ØªÙ…Ø§Ø³Ùƒ ğŸš€", highest_high, False

def run_ladder_from_finviz(ny_time):
    print("\nğŸš€ [1] ÙØ­Øµ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ (Ù…ØµØ¯Ø± Yahoo Finance)...")
    
    # Ø¬Ù„Ø¨ Ù…Ù† Yahoo Finance Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Finviz
    full_list = []
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        
        # Ù‚Ø§Ø¦Ù…Ø© 1: Most Active
        url1 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=most_actives&count=100"
        r1 = requests.get(url1, headers=headers, timeout=10)
        if r1.status_code == 200:
            data1 = r1.json()
            if 'finance' in data1 and 'result' in data1['finance']:
                quotes = data1['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol')
                    price = q.get('regularMarketPrice', 0)
                    vol = q.get('regularMarketVolume', 0)
                    if sym and 0.02 <= price <= 10.0 and vol >= 500000:
                        full_list.append({'symbol': sym, 'price': price, 'volume': vol})
        
        # Ù‚Ø§Ø¦Ù…Ø© 2: Top Gainers
        url2 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=day_gainers&count=100"
        r2 = requests.get(url2, headers=headers, timeout=10)
        if r2.status_code == 200:
            data2 = r2.json()
            if 'finance' in data2 and 'result' in data2['finance']:
                quotes = data2['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol')
                    price = q.get('regularMarketPrice', 0)
                    vol = q.get('regularMarketVolume', 0)
                    if sym and 0.02 <= price <= 10.0 and vol >= 500000:
                        if not any(s['symbol'] == sym for s in full_list):
                            full_list.append({'symbol': sym, 'price': price, 'volume': vol})
        
        # Ù‚Ø§Ø¦Ù…Ø© 3: Small Cap Gainers (Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù‡Ù… Ø±Ø®ÙŠØµØ©)
        url3 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=small_cap_gainers&count=100"
        r3 = requests.get(url3, headers=headers, timeout=10)
        if r3.status_code == 200:
            data3 = r3.json()
            if 'finance' in data3 and 'result' in data3['finance']:
                quotes = data3['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol')
                    price = q.get('regularMarketPrice', 0)
                    vol = q.get('regularMarketVolume', 0)
                    if sym and 0.02 <= price <= 10.0 and vol >= 200000:  # ÙÙˆÙ„ÙŠÙˆÙ… Ø£Ù‚Ù„ Ù„Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØµØºÙŠØ±Ø©
                        if not any(s['symbol'] == sym for s in full_list):
                            full_list.append({'symbol': sym, 'price': price, 'volume': vol})
        
        # Ù‚Ø§Ø¦Ù…Ø© 4: Undervalued Growth (Ø£Ø³Ù‡Ù… Ù†Ù…Ùˆ Ù…Ù‚ÙŠÙ…Ø© Ø¨Ø£Ù‚Ù„)
        url4 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=undervalued_growth_stocks&count=100"
        r4 = requests.get(url4, headers=headers, timeout=10)
        if r4.status_code == 200:
            data4 = r4.json()
            if 'finance' in data4 and 'result' in data4['finance']:
                quotes = data4['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol')
                    price = q.get('regularMarketPrice', 0)
                    vol = q.get('regularMarketVolume', 0)
                    if sym and 0.02 <= price <= 10.0 and vol >= 200000:
                        if not any(s['symbol'] == sym for s in full_list):
                            full_list.append({'symbol': sym, 'price': price, 'volume': vol})
                            
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Yahoo: {e}")
    
    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
    full_list = list({s['symbol']: s for s in full_list}.values())
    
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 60 Ø³Ù‡Ù…
    if len(full_list) < 60:
        print(f"âš ï¸ ØªØ­Ø°ÙŠØ±: ÙÙ‚Ø· {len(full_list)} Ø³Ù‡Ù… (Ø£Ù‚Ù„ Ù…Ù† 60)ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯")
    else:
        print(f"âœ… ØªÙ… Ø¬Ù…Ø¹ {len(full_list)} Ø³Ù‡Ù… (Ø§Ù„Ù‡Ø¯Ù: 60+)")
    
    print(f"ğŸ”¬ ÙØ­Øµ {len(full_list)} Ø³Ù‡Ù… (Ø´Ù…Ø¹Ø§Øª 5Ø¯)...")
    matches = 0
    pending_orders = 0
    
    for item in full_list:
        ticker = item['symbol']
        try:
            df = get_fmp_candles(ticker)
            if df.empty: continue
            
            # Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            last_ts = df.index[-1]
            if (ny_time.date() - last_ts.date()).days > 1: continue 
            
            # ÙÙ„ØªØ±Ø© Ø´Ù…ÙˆØ¹ 9:30-10:00 ØµØ¨Ø§Ø­Ø§Ù‹
            day_data = df[df.index.date == last_ts.date()]
            setup = day_data.between_time('09:30', '10:00')
            
            if len(setup) < 3:
                # Ø¥Ø°Ø§ Ù…Ø§ ÙƒÙØª Ø´Ù…ÙˆØ¹ Ø§Ù„ØµØ¨Ø§Ø­ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± 6 Ø´Ù…ÙˆØ¹
                setup = df.tail(6)
            
            is_valid, strength, reason, highest_high, is_pending = check_ladder_pattern(setup)
            
            if is_valid or is_pending:
                price = setup['Close'].iloc[-1]
                float_val = get_float_shares_fmp(ticker)
                shariah_status = get_shariah_status(ticker)
                
                # Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ¹ÙˆØ¯ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                start_price = setup['Open'].iloc[0]
                gain_pct = ((price - start_price) / start_price) * 100 if start_price > 0 else 0
                
                # ØªØµÙ†ÙŠÙ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©
                volume = item.get('volume', 0)
                if volume >= 5_000_000:
                    liquidity = "ğŸ”¥ğŸ”¥ Ø§Ù†ÙØ¬Ø§Ø± (Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹)"
                elif volume >= 1_000_000:
                    liquidity = "ğŸ”¥ Ø¹Ø§Ù„ÙŠ"
                elif volume >= 500_000:
                    liquidity = "âš¡ Ù…ØªÙˆØ³Ø·"
                else:
                    liquidity = "ğŸ’§ Ù…Ù†Ø®ÙØ¶"
                
                if is_valid:
                    # âœ… Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±
                    msg = (
                        f"ğŸªœ *Ø³Ù„Ù… ØµØ§Ø¹Ø¯* ğŸªœ\n\n"
                        f"ğŸ† Ø§Ù„Ø³Ù‡Ù…: *{ticker}* ğŸ‡ºğŸ‡¸\n"
                        f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± (10:00): *${price:.4f}*\n"
                        f"ğŸ¯ Ø§Ù„Ù‚Ù…Ø©: *${highest_high:.4f}*\n"
                        f"ğŸ’§ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: {liquidity} ({gain_pct:.1f}%)\n"
                        f"ğŸª¶ Ø§Ù„ÙÙ„ÙˆØª: *{fmt_shares(float_val)}*\n"
                        f"âš–ï¸ Ø§Ù„Ø­ÙƒÙ…: *{shariah_status}*\n"
                        f"---------------------------\n"
                        f"âœ… *Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±* - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ø®ÙˆÙ„!"
                    )
                    send_telegram(msg)
                    print(f"âœ… [Ladder] {ticker} Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±!")
                    matches += 1
                else:
                    # ğŸ”” Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚ (Buy Stop)
                    buy_stop_price = highest_high + 0.0001  # Ø³Ø¹Ø± Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‚Ù…Ø© Ø¨Ø´ÙˆÙŠ
                    msg = (
                        f"ğŸªœ *Ø³Ù„Ù… ØµØ§Ø¹Ø¯* ğŸªœ\n\n"
                        f"ğŸ† Ø§Ù„Ø³Ù‡Ù…: *{ticker}* ğŸ‡ºğŸ‡¸\n"
                        f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø± (10:00): *${price:.4f}*\n"
                        f"ğŸ¯ Ø§Ù„Ù‚Ù…Ø©: *${highest_high:.4f}*\n"
                        f"ğŸ’§ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: {liquidity} ({gain_pct:.1f}%)\n"
                        f"ğŸª¶ Ø§Ù„ÙÙ„ÙˆØª: *{fmt_shares(float_val)}*\n"
                        f"âš–ï¸ Ø§Ù„Ø­ÙƒÙ…: *{shariah_status}*\n"
                        f"---------------------------\n"
                        f"âœ‹ *Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚ (Buy Stop):* *${buy_stop_price:.4f}*"
                    )
                    send_telegram(msg)
                    print(f"ğŸ”” [Ladder] {ticker} Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚ @ ${buy_stop_price:.4f}")
                    pending_orders += 1
                    
        except: continue
    
    if matches == 0 and pending_orders == 0:
        print("âŒ [Ladder] Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ Ø­Ø§Ù„ÙŠØ§Ù‹.")
    else:
        print(f"ğŸ [Ladder] Ø§Ø®ØªØ±Ø§Ù‚: {matches} | Ù…Ø¹Ù„Ù‚: {pending_orders}")

# =========================================================
# 4. Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ØµÙŠØ¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† (Float < 2M + Low 15%)
# =========================================================
def run_bottom_hunter():
    print("\nğŸ”µ [2] ØµÙŠØ¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† (Float < 2M)...")
    # Ø§Ù„Ø±Ø§Ø¨Ø·: ÙÙ„ÙˆØª ØªØ­Øª 2 Ù…Ù„ÙŠÙˆÙ†ØŒ Ø³Ø¹Ø± ØªØ­Øª 20ØŒ Ù…Ø±ØªØ¨ Ø¨Ø§Ù„ÙÙ„ÙˆØª
    url = "https://finviz.com/screener.ashx?v=152&f=sh_float_u2,sh_price_u20&ft=4&o=float"
    
    try:
        resp = requests.get(url, headers=FINVIZ_HEADERS, timeout=15)
        soup = BeautifulSoup(resp.text, 'html.parser')
        table = soup.find('table', {'class': 'screener_table'})
        
        if not table:
             for t in soup.find_all('table'):
                if len(t.find_all('tr')) > 10: table = t; break
        
        candidates = []
        if table:
            rows = table.find_all('tr')
            for row in rows[1:]:
                cells = row.find_all('td')
                if len(cells) >= 10:
                    try:
                        ticker = cells[1].get_text().strip()
                        float_val = clean_number(cells[8].get_text()) # Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙÙ„ÙˆØª
                        price = clean_number(cells[9].get_text())     # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø¹Ø±
                        
                        if ticker and float_val <= 2000000 and price > 0:
                            candidates.append({'symbol': ticker, 'float': float_val, 'price': price})
                    except: continue

        print(f"ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† {len(candidates)} Ø³Ù‡Ù… Ø¹Ø¨Ø± Yahoo (Volume + 52W Low)...")
        final_matches = []
        
        for c in candidates:
            try:
                info = yf.Ticker(c['symbol']).info
                year_low = info.get('fiftyTwoWeekLow', 0)
                vol = info.get('volume', 0) or info.get('regularMarketVolume', 0)
                price = c['price']
                
                if year_low and price and vol:
                    dist = ((price - year_low) / year_low) * 100
                    # Ø§Ù„Ø´Ø±ÙˆØ·: Ù…Ø³Ø§ÙØ© Ø£Ù‚Ù„ Ù…Ù† 15% ÙˆÙÙˆÙ„ÙŠÙˆÙ… Ø£Ø¹Ù„Ù‰ Ù…Ù† 100 Ø£Ù„Ù
                    if dist <= 15 and vol >= 100000:
                         final_matches.append({
                             **c, 
                             'year_low': year_low, 
                             'dist': dist, 
                             'volume': vol
                         })
            except: continue
        
        # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
        final_matches.sort(key=lambda x: x['dist'])
        
        if final_matches:
            msg = "ğŸ”¥ğŸ’ *ØµÙŠØ§Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† (Swing)* ğŸ’ğŸ”¥\n"
            msg += "ğŸ¯ ÙÙ„ÙˆØª < 2M | Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹ 15% | Vol > 100k\n\n"
            for s in final_matches[:10]:
                msg += f"âœ… *{s['symbol']}* | ğŸ’µ ${s['price']}\n"
                msg += f"ğŸ“‰ Ø§Ù„Ù‚Ø§Ø¹: {s['year_low']} | ğŸ“ Ø§Ù„ÙØ±Ù‚: {s['dist']:.1f}%\n"
                msg += f"ğŸª¶ ÙÙ„ÙˆØª: {fmt_shares(s['float'])} | ğŸ“ˆ ÙÙˆÙ„ÙŠÙˆÙ…: {fmt_shares(s['volume'])}\n"
                msg += "---\n"
            send_telegram(msg)
            print(f"ğŸ [Bottom Hunter] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ {len(final_matches)} Ø³Ù‡Ù….")
        else:
            print("âŒ [Bottom Hunter] Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.")

    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Bottom Hunter: {e}")

# =========================================================
# 5. Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© TL Support (Ø£Ø³Ù‡Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù‚ÙˆÙŠ)
# =========================================================
def run_tl_support_strategy():
    print("\nğŸ“ˆ [3] Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¯Ø¹Ù… Ù‚ÙˆÙŠ (Yahoo Finance + Technical)...")
    
    # Ø¨Ù…Ø§ Ø£Ù† Finviz Ù…Ø­Ø¸ÙˆØ±ØŒ Ù†Ø³ØªØ®Ø¯Ù… Yahoo Finance Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø³Ù‡Ù… Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…
    candidates = []
    
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        
        # Ø¬Ù„Ø¨ Ø£Ø³Ù‡Ù… Ù…Ù† Ù‚ÙˆØ§Ø¦Ù… Yahoo Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        urls = [
            "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=most_actives&count=50",
            "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=day_gainers&count=50",
            "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=day_losers&count=50"
        ]
        
        all_symbols = []
        for url in urls:
            try:
                r = requests.get(url, headers=headers, timeout=10)
                if r.status_code == 200:
                    data = r.json()
                    if 'finance' in data and 'result' in data['finance']:
                        quotes = data['finance']['result'][0].get('quotes', [])
                        for q in quotes:
                            sym = q.get('symbol')
                            price = q.get('regularMarketPrice', 0)
                            vol = q.get('regularMarketVolume', 0)
                            change = q.get('regularMarketChangePercent', 0)
                            low52 = q.get('fiftyTwoWeekLow', 0)
                            
                            # ÙÙ„ØªØ±Ø©: Ø³Ø¹Ø± 0.5-20$ØŒ ÙÙˆÙ„ÙŠÙˆÙ… Ø¹Ø§Ù„ÙŠ
                            if sym and 0.5 <= price <= 20.0 and vol >= 500000:
                                # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹ 52 Ø£Ø³Ø¨ÙˆØ¹
                                if low52 > 0:
                                    dist_from_low = ((price - low52) / low52) * 100
                                    # Ø£Ø³Ù‡Ù… Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø¯Ø¹Ù… (10-25% Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹)
                                    if 5 <= dist_from_low <= 25:
                                        if not any(c['symbol'] == sym for c in candidates):
                                            candidates.append({
                                                'symbol': sym,
                                                'price': price,
                                                'volume': vol,
                                                'change': change,
                                                'low52': low52,
                                                'dist_from_low': dist_from_low
                                            })
            except: continue
        
        # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…
        candidates.sort(key=lambda x: x['dist_from_low'])
        candidates = candidates[:15]  # Ø£ÙØ¶Ù„ 15
        
        if candidates:
            msg = "ğŸ“ *Ø£Ø³Ù‡Ù… Ø¹Ù†Ø¯ Ø¯Ø¹Ù… Ù‚ÙˆÙŠ (Support Zone)* ğŸ“\n"
            msg += "ğŸ¯ Ø§Ù„Ø´Ø±ÙˆØ·: Ù‚Ø±ÙŠØ¨ Ù…Ù† Ù‚Ø§Ø¹ 52 Ø£Ø³Ø¨ÙˆØ¹ (5-25%) + Vol > 500k\n"
            msg += "âš ï¸ Ù…Ù†Ø§Ø·Ù‚ Ø¯Ø®ÙˆÙ„ Ø¨ÙˆÙ‚Ù Ø®Ø³Ø§Ø±Ø© Ù‚Ø±ÙŠØ¨.\n\n"
            
            for item in candidates:
                msg += f"ğŸ”¹ *{item['symbol']}* | ğŸ’µ ${item['price']:.2f}\n"
                msg += f"   ğŸ“‰ Ø§Ù„Ù‚Ø§Ø¹: ${item['low52']:.2f} | Ø§Ù„Ù…Ø³Ø§ÙØ©: {item['dist_from_low']:.1f}%\n"
            
            msg += "\nğŸ¤– Yahoo Finance Support Scanner"
            send_telegram(msg)
            print(f"âœ… [Support Zone] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ {len(candidates)} Ø³Ù‡Ù….")
        else:
            print("âŒ [Support Zone] Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.")
            
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Support Strategy: {e}")

# =========================================================
# 6. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# =========================================================
def main():
    print("="*50)
    print("ğŸ›¡ï¸ ULTRA TRADING BOT (Ladder + Bottoms + Patterns)")
    print("="*50)
    
    while True:
        ny_tz = pytz.timezone('America/New_York')
        now_ny = datetime.now(ny_tz)

        # ÙŠØ¹Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ø§Ù‹ NY Ø£Ùˆ (True) Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
        if now_ny.time() >= time(10, 0, 0) or True: 
            print(f"\nâ° Ø§Ù„Ø³Ø§Ø¹Ø© {now_ny.strftime('%H:%M:%S')} NY - Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø©...")
            
            # 1. Ø§Ù„Ø³Ù„Ù… Ø§Ù„Ù„Ø­Ø¸ÙŠ
            run_ladder_from_finviz(now_ny)
            tm.sleep(5)
            
            # 2. ØµÙŠØ¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
            run_bottom_hunter()
            tm.sleep(5)
            
            # 3. Ø¯Ø¹Ù… Ø§Ù„ØªØ±Ù†Ø¯
            run_tl_support_strategy()
            
            print("\nâœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¯ÙˆØ±Ø©. (Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆÙ‚Ù Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±ØŒ Ø£Ø²Ù„ break Ù„Ù„ØªÙƒØ±Ø§Ø±)")
            break 
            
        else:
            print(f"â³ {now_ny.strftime('%H:%M:%S')} NY - Ø§Ù„Ø³ÙˆÙ‚ Ù…ØºÙ„Ù‚...", end='\r')
            tm.sleep(30)

if __name__ == "__main__":
    main()