import pandas as pd

import warnings

from datetime import datetime, time

import requests

import os

import json

import time as tm

import pytz

from dotenv import load_dotenv



# =========================================================

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ´ØºÙŠÙ„

# =========================================================

load_dotenv()

API_KEY = os.getenv('FMP_API_KEY')

EODHD_API_KEY = os.getenv('EODHD_API_KEY')

if not API_KEY and not EODHD_API_KEY:

    API_KEY = "YOUR_FMP_API_KEY_HERE"  # Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙÙŠ .env

    print("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ FMP_API_KEY Ø£Ùˆ EODHD_API_KEY ÙÙŠ .envØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.")



TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"

TELEGRAM_CHAT_ID = "237657512"



warnings.simplefilter(action='ignore', category=FutureWarning)



FLOAT_CACHE_FILE = "float_cache.json"

DAILY_WATCH_FILE = "daily_watch_list.json"



# =========================================================

# 2. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ø´ + ØªÙ†Ø³ÙŠÙ‚)

# =========================================================

def fmt_shares(n):

    if not isinstance(n, (int, float)): return "ØºÙŠØ± Ù…ØªØ§Ø­"

    if n >= 1_000_000: return f"{n/1_000_000:.1f}M".replace(".0M", "M")

    if n >= 1_000: return f"{n/1_000:.1f}K".replace(".0K", "K")

    return str(int(n))



def load_json_file(filename):

    if os.path.exists(filename):

        try:

            with open(filename, 'r') as f: return json.load(f)

        except: return {}

    return {}



def save_json_file(filename, data):

    try:

        with open(filename, 'w') as f: json.dump(data, f)

    except: pass



# ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´

float_data_store = load_json_file(FLOAT_CACHE_FILE)



def get_float_shares(symbol):

    """Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"""

    global float_data_store

    

    # 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø´

    val = float_data_store.get(symbol)

    

    # ğŸ› ï¸ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§: Ù„Ùˆ Ø§Ù„ÙƒØ§Ø´ Ù‚Ø¯ÙŠÙ… (dict)ØŒ Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø±Ù‚Ù… Ù…Ù†Ù‡

    if isinstance(val, dict):

        val = val.get('value', 0)

    

    # Ø¥Ø°Ø§ Ø§Ù„Ù‚ÙŠÙ…Ø© ØµØ§Ù„Ø­Ø© (Ø±Ù‚Ù…)ØŒ Ù†Ø±Ø¬Ø¹Ù‡Ø§

    if isinstance(val, (int, float)) and val > 0:

        return val



    # 2. Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø¬Ù„Ø¨ Ù…Ù† API

    val = None

    try:

        url = f"https://financialmodelingprep.com/api/v4/shares_float?symbol={symbol}&apikey={API_KEY}"

        data = requests.get(url, timeout=5).json()

        if data and isinstance(data, list): val = float(data[0].get('floatShares', 0))

    except: pass

    

    if not val:

        try:

            url = f"https://financialmodelingprep.com/api/v3/profile/{symbol}?apikey={API_KEY}"

            data = requests.get(url, timeout=5).json()

            if data and isinstance(data, list):

                val = float(data[0].get('mktCap', 0)) / float(data[0].get('price', 1))

        except: pass

        

    # Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ÙƒØ±Ù‚Ù… ØµØ§ÙÙŠ)

    val = val if val else 0

    float_data_store[symbol] = val

    save_json_file(FLOAT_CACHE_FILE, float_data_store)

    return val



# =========================================================

# 3. Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…ÙˆØ³Ø¹Ø©: Actives + Gainers)

# =========================================================

def get_watchlist():

    print("ğŸ“¡ Ø³Ø­Ø¨ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙˆÙ‚ (Actives + Gainers)...")

    url_actives = f"https://financialmodelingprep.com/api/v3/stock_market/actives?limit=100&apikey={API_KEY}"

    url_gainers = f"https://financialmodelingprep.com/api/v3/stock_market/gainers?limit=100&apikey={API_KEY}"

    

    candidates = {}

    price_filtered = 0

    volume_filtered = 0

    

    for url in [url_actives, url_gainers]:

        try:

            data = requests.get(url, timeout=10).json()

            print(f"Ù…Ù† {url.split('/')[-2]}: {len(data) if isinstance(data, list) else 0} Ø³Ù‡Ù…")

            if isinstance(data, list):

                for item in data:

                    sym = item.get('symbol')

                    price = float(item.get('price', 0))

                    vol = int(item.get('volume', 0))

                    if (1.0 <= price <= 15.0):

                        price_filtered += 1

                        if vol >= 0:  # Ù„Ù„ØªØ¬Ø±Ø¨Ø©, Ø­Ø¬Ù… >=0

                            volume_filtered += 1

                            candidates[sym] = vol

        except: pass

    

    print(f"Ø¨Ø¹Ø¯ ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø± (1-15$): {price_filtered} Ø³Ù‡Ù…")

    print(f"Ø¨Ø¹Ø¯ ÙÙ„ØªØ± Ø§Ù„Ø­Ø¬Ù… (>=100k): {volume_filtered} Ø³Ù‡Ù…")

    final_list = list(candidates.keys())

    print(f"ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ØªÙ… ØªØ¬Ù…ÙŠØ¹ {len(final_list)} Ø³Ù‡Ù… Ù„Ù„ÙØ­Øµ.")

    return final_list



# =========================================================

# 4. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ (Ù…Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø´Ù…Ø¹Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­)

# =========================================================

def get_fmp_data(symbol):

    url = f"https://financialmodelingprep.com/api/v3/historical-chart/5min/{symbol}?apikey={API_KEY}"

    try:

        r = requests.get(url, timeout=10).json()

        print(f"ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª FMP {symbol}: {len(r) if isinstance(r, list) else 'ØºÙŠØ± Ù‚Ø§Ø¦Ù…Ø©'} Ù†Ù‚Ø·Ø©")

        if not r: return pd.DataFrame()

        df = pd.DataFrame(r)

        try:

            df['date'] = pd.to_datetime(df['date'], errors='coerce')

        except Exception as e:

            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù€ {symbol}: {e}")

            return pd.DataFrame()

        df = df.set_index('date').sort_index()

        df.columns = df.columns.str.capitalize()

        return df

    except Exception as e:

        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ FMP {symbol}: {e}")

        return pd.DataFrame()



def check_ladder_pattern(df_window):

    if len(df_window) < 5: return False, 0, "Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"



    greens = 0

    max_green_body = 0.0001

    candles = [row for _, row in df_window.iterrows()]



    for i, row in enumerate(candles):

        open_p = float(row['Open'])

        close_p = float(row['Close'])

        high_p = float(row['High'])

        

        body = abs(close_p - open_p)

        upper_wick = high_p - max(open_p, close_p)

        

        if close_p > open_p: 

            greens += 1

            max_green_body = max(max_green_body, body)

            # Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ 3.0x

            allowance = 3.0 if i == 0 else 1.5

            if body > 0.01 and upper_wick > (body * allowance):

                return False, 0, f"Ø°ÙŠÙ„ Ø·ÙˆÙŠÙ„ (Ø´Ù…Ø¹Ø© {i+1})"

        else: 

            if body > (max_green_body * 0.6):

                return False, 0, "Ø´Ù…Ø¹Ø© Ø­Ù…Ø±Ø§Ø¡ ÙƒØ¨ÙŠØ±Ø©"



    if greens < 4: return False, 0, f"Ø§Ù„Ø®Ø¶Ø± {greens} ÙÙ‚Ø·"

    

    if df_window['Close'].iloc[-1] <= df_window['Open'].iloc[0]:

        return False, 0, "Ù„Ù… ÙŠØµØ¹Ø¯ Ø§Ù„Ø³Ø¹Ø±"

    

    strength_pct = int((greens / len(df_window)) * 100)

    return True, strength_pct, "Ù†Ù…Ø· Ø³Ù„ÙŠÙ…"



def send_telegram(message):

    if not TELEGRAM_BOT_TOKEN: return

    try:

        requests.post(

            f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",

            data={'chat_id': TELEGRAM_CHAT_ID, 'text': message, 'parse_mode': 'Markdown'},

            timeout=5

        )

    except: pass



# =========================================================

# 5. Ø§Ù„ØªØ´ØºÙŠÙ„

# =========================================================

def main():

    print("ğŸ›¡ï¸ Ø§Ù„Ø¨ÙˆØª Ø¬Ø§Ù‡Ø² (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ø´)... Ø¨Ø§Ù†ØªØ¸Ø§Ø± 10:00 NY")



    while True:

        ny_tz = pytz.timezone('America/New_York')

        now_ny = datetime.now(ny_tz)



        if now_ny.time() >= time(10, 0, 15) or True:

            print("\nğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ...")

            send_telegram("ğŸš€ Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯...")



            market_list = get_watchlist()

            saved_list = load_json_file(DAILY_WATCH_FILE)

            

            # Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† saved_list Ù‡Ùˆ Ù‚Ø§Ø¦Ù…Ø©

            if isinstance(saved_list, dict):

                saved_list = list(saved_list.keys())

            elif not isinstance(saved_list, list):

                saved_list = []

            

            full_list = list(set(market_list + saved_list))

            

            matches = 0

            skipped_old = 0

            skipped_empty = 0

            print(f"ğŸ”¬ ÙØ­Øµ {len(full_list)} Ø³Ù‡Ù…...")



            for ticker in full_list:

                try:

                    df = get_fmp_data(ticker)

                    if df.empty: 

                        skipped_empty += 1

                        continue

                    

                    last_ts = df.index[-1]

                    if (now_ny.date() - last_ts.date()).days > 1: 

                        skipped_old += 1

                        continue 

                    

                    day_data = df[df.index.date == last_ts.date()]

                    setup = day_data.between_time('09:30', '10:00')

                    

                    is_valid, strength, reason = check_ladder_pattern(setup)

                    

                    if is_valid:

                        price = setup['Close'].iloc[-1]

                        float_val = get_float_shares(ticker) # Ù‡Ù†Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙˆØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡

                        

                        msg = (

                            f"ğŸªœ *ÙØ±ØµØ© Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯* ğŸªœ\n\n"

                            f"âœ… Ø§Ù„Ø³Ù‡Ù…: *{ticker}*\n"

                            f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: *${price:.2f}*\n"

                            f"ğŸ’ª Ø§Ù„Ù‚ÙˆØ©: *{strength}%*\n"

                            f"ğŸª¶ Ø§Ù„ÙÙ„ÙˆØª: *{fmt_shares(float_val)}*\n"

                            f"ğŸ•’ Ø§Ù„ØªÙˆÙ‚ÙŠØª: 10:00 NY"

                        )

                        send_telegram(msg)

                        print(f"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ {ticker}")

                        matches += 1

                except Exception as e:

                    print(f"âš ï¸ ØªØ¬Ø§ÙˆØ² {ticker}: {e}")

                    continue



            if matches == 0:

                send_telegram("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ Ø§Ù„ÙŠÙˆÙ….")

                print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ.")

            else:

                print(f"ğŸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ {matches} ÙØ±Øµ.")

            

            print(f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ØªÙ… ÙØ­Øµ ÙØ¹Ù„ÙŠ {len(full_list) - skipped_empty - skipped_old} Ø³Ù‡Ù…ØŒ ØªØ¬Ø§ÙˆØ² {skipped_empty} ÙØ§Ø±ØºØŒ {skipped_old} Ù‚Ø¯ÙŠÙ….")

            

            break

        else:

            print(f"â³ {now_ny.strftime('%H:%M:%S')} NY - Ø§Ù†ØªØ¸Ø§Ø±...", end='\r')

            tm.sleep(10)



if __name__ == "__main__":

    main() 