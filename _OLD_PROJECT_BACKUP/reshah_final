import pandas as pd
import warnings
from datetime import datetime, time
import requests
import os
import json
import time as tm
import pytz
from dotenv import load_dotenv
import yfinance as yf
from concurrent.futures import ThreadPoolExecutor, as_completed

# =========================================================
# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ´ØºÙŠÙ„
# =========================================================
load_dotenv()
API_KEY = os.getenv('FMP_API_KEY', '')  # Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø§Ù„Ø¢Ù†
EODHD_API_KEY = os.getenv('EODHD_API_KEY', '')

TELEGRAM_BOT_TOKEN = "8130586876:AAFZBPEDJ2o-WOyqDOhltG69lnw2YN0-bDg"
TELEGRAM_CHAT_ID = "237657512"

warnings.simplefilter(action='ignore', category=FutureWarning)

FLOAT_CACHE_FILE = "float_cache.json"
DAILY_WATCH_FILE = "daily_watch_list.json"
SHARIAH_FILE = "shariah_stocks_master.json"

# =========================================================
# 2. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ø´ + ØªÙ†Ø³ÙŠÙ‚)
# =========================================================
def fmt_shares(n):
    if not isinstance(n, (int, float)): return "ØºÙŠØ± Ù…ØªØ§Ø­"
    if n >= 1_000_000: return f"{n/1_000_000:.1f}M".replace(".0M", "M")
    if n >= 1_000: return f"{n/1_000:.1f}K".replace(".0K", "K")
    return str(int(n))

def load_json_file(filename):
    if os.path.exists(filename):
        try:
            with open(filename, 'r') as f: return json.load(f)
        except: return {}
    return {}

def save_json_file(filename, data):
    try:
        with open(filename, 'w') as f: json.dump(data, f)
    except: pass

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´
float_data_store = load_json_file(FLOAT_CACHE_FILE)

# âš–ï¸ Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø´Ø±Ø¹ÙŠ
def check_shariah_status(ticker):
    """ÙØ­Øµ Ø­ÙƒÙ… Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠ - Ø­Ù„Ø§Ù„ Ø£Ùˆ ØºÙŠØ± Ù…ØªÙˆÙØ±"""
    try:
        if not os.path.exists(SHARIAH_FILE):
            return "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±"
        
        with open(SHARIAH_FILE, 'r') as f:
            shariah_db = json.load(f)
        
        data = shariah_db.get(ticker)
        if data:
            status = data.get('status', '').lower()
            if 'halal' in status:
                return "âœ… Ø­Ù„Ø§Ù„"
        
        # Ø¥Ø°Ø§ Ø­Ø±Ø§Ù… Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ = ØºÙŠØ± Ù…ØªÙˆÙØ±
        return "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±"
    except:
        return "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±"

# ğŸ¯ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
bottom_hunter_data = {}  # {symbol: {'price': x, 'low52': y, 'float': z}}

# â­ Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ³Ø§Ù…
def calculate_badge(setup_df):
    """Ø­Ø³Ø§Ø¨ ÙˆØ³Ø§Ù… Ø§Ù„Ù‚ÙˆØ© Ù…Ù† Ø§Ù„Ø´Ù…ÙˆØ¹ - Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·"""
    try:
        if len(setup_df) < 2:
            return "", 0
        
        candles = [row for _, row in setup_df.iterrows()]
        
        # 1. ÙØ­Øµ Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±ÙŠØ©: Ù‡Ù„ ÙÙŠÙ‡ Ø´Ù…Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙˆÙ‚ 10%ØŸ
        for row in candles:
            c_open = float(row['Open'])
            c_close = float(row['Close'])
            if c_open > 0:
                candle_change = ((c_close - c_open) / c_open) * 100
                if candle_change >= 10:
                    return f"ğŸ’¥ Ø§Ù†ÙØ¬Ø§Ø±ÙŠØ© {candle_change:.0f}%", -1  # -1 ÙŠØ¹Ù†ÙŠ Ø§Ù†ÙØ¬Ø§Ø±ÙŠØ©
        
        # 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø«Ù„Ø§Ø«Ø©
        score = 0
        
        # Ø´Ø±Ø· 1: Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù…Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© â‰¥ 3
        highest_high = float(candles[0]['High'])
        new_highs_count = 0
        for i in range(1, len(candles)):
            c_high = float(candles[i]['High'])
            if c_high > highest_high:
                highest_high = c_high
                new_highs_count += 1
        if new_highs_count >= 3:
            score += 1
        
        # Ø´Ø±Ø· 2: Ø§Ù„Ø´Ù…Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø®Ø¶Ø±Ø§Ø¡
        if len(candles) >= 2:
            prev_candle = candles[-2]
            if float(prev_candle['Close']) > float(prev_candle['Open']):
                score += 1
        
        # Ø´Ø±Ø· 3: ÙÙˆÙ„ÙŠÙˆÙ… ØªÙ†Ø´ÙŠÙ (Ø¢Ø®Ø± Ø´Ù…Ø¹ØªÙŠÙ† < Ø£ÙˆÙ„ Ø´Ù…Ø¹ØªÙŠÙ†)
        if len(candles) >= 4:
            first_two_vol = float(candles[0]['Volume']) + float(candles[1]['Volume'])
            last_two_vol = float(candles[-2]['Volume']) + float(candles[-1]['Volume'])
            if last_two_vol < first_two_vol:
                score += 1
        
        # Ø¨Ù†Ø§Ø¡ Ù†Øµ Ø§Ù„ÙˆØ³Ø§Ù…
        stars = "â­" * score if score > 0 else ""
        badge_text = f"{stars} {score}/3" if score > 0 else f"{score}/3"
        
        return badge_text, score
    except:
        return "", 0

# =========================================================
# 3. Ø¬Ù„Ø¨ 70 Ø³Ù‡Ù… Ù…Ù† Yahoo Finance (Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ† + Ø§Ù„Ù†Ø´ÙŠØ·ÙŠÙ†)
# =========================================================
def get_watchlist():
    """Ø¬Ù„Ø¨ 70 Ø³Ù‡Ù… Ù…Ù† Yahoo Finance - Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ† ÙˆØ§Ù„Ù†Ø´ÙŠØ·ÙŠÙ†"""
    global float_data_store, bottom_hunter_data
    bottom_hunter_data = {}  # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
    print("ğŸ“¦ Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† Yahoo Finance...")

    full_list = []
    headers = {'User-Agent': 'Mozilla/5.0'}
    
    # Ø§Ù„Ø¨ÙˆØ±ØµØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø·
    allowed_exchanges = ['NMS', 'NYQ', 'NGM', 'NCM', 'NAS', 'NYSE', 'NASDAQ']
    
    def is_valid_stock(q):
        """ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙˆØ·"""
        sym = q.get('symbol', '')
        price = q.get('regularMarketPrice', 0)
        vol = q.get('regularMarketVolume', 0)
        exchange = q.get('exchange', '')
        
        # Ø§Ù„Ø´Ø±ÙˆØ·: 4 Ø­Ø±ÙˆÙ Ø£Ùˆ Ø£Ù‚Ù„ØŒ Ø³Ø¹Ø± 0.02-10ØŒ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø·Ø©ØŒ Ø¨ÙˆØ±ØµØ© Ø£Ù…Ø±ÙŠÙƒÙŠØ©
        return (sym and 
                len(sym) <= 4 and 
                '.' not in sym and
                0.02 <= price <= 10.0 and 
                vol >= 200000 and
                exchange in allowed_exchanges)
    
    try:
        # Ù‚Ø§Ø¦Ù…Ø© 1: Most Active
        print("ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹...")
        url1 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=most_actives&count=100"
        r1 = requests.get(url1, headers=headers, timeout=10)
        if r1.status_code == 200:
            data1 = r1.json()
            if 'finance' in data1 and 'result' in data1['finance']:
                quotes = data1['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    if is_valid_stock(q):
                        sym = q['symbol']
                        full_list.append({
                            'symbol': sym, 
                            'price': q.get('regularMarketPrice', 0), 
                            'volume': q.get('regularMarketVolume', 0), 
                            'change': q.get('regularMarketChangePercent', 0),
                            'exchange': q.get('exchange', '')
                        })
                        # ğŸ¯ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
                        low52 = q.get('fiftyTwoWeekLow', 0)
                        if low52 and low52 > 0:
                            bottom_hunter_data[sym] = {
                                'price': q.get('regularMarketPrice', 0),
                                'low52': low52
                            }
                print(f"   âœ… Most Active: {len(quotes)} Ø³Ù‡Ù…")
        
        # Ù‚Ø§Ø¦Ù…Ø© 2: Top Gainers
        print("ğŸ“ˆ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø±ØªÙØ§Ø¹Ø§Ù‹...")
        url2 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=day_gainers&count=100"
        r2 = requests.get(url2, headers=headers, timeout=10)
        if r2.status_code == 200:
            data2 = r2.json()
            if 'finance' in data2 and 'result' in data2['finance']:
                quotes = data2['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol')
                    if is_valid_stock(q) and not any(s['symbol'] == sym for s in full_list):
                        full_list.append({
                            'symbol': sym, 
                            'price': q.get('regularMarketPrice', 0), 
                            'volume': q.get('regularMarketVolume', 0), 
                            'change': q.get('regularMarketChangePercent', 0),
                            'exchange': q.get('exchange', '')
                        })
                        # ğŸ¯ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
                        low52 = q.get('fiftyTwoWeekLow', 0)
                        if low52 and low52 > 0 and sym not in bottom_hunter_data:
                            bottom_hunter_data[sym] = {
                                'price': q.get('regularMarketPrice', 0),
                                'low52': low52
                            }
                print(f"   âœ… Gainers: {len(quotes)} Ø³Ù‡Ù…")
        
        # Ù‚Ø§Ø¦Ù…Ø© 3: Small Cap Gainers (Ø³ÙŠÙˆÙ„Ø© Ø£Ù‚Ù„ 100k)
        print("ğŸ“Š Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØµØºÙŠØ±Ø© Ø§Ù„Ø±Ø§Ø¨Ø­Ø©...")
        url3 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=small_cap_gainers&count=100"
        r3 = requests.get(url3, headers=headers, timeout=10)
        if r3.status_code == 200:
            data3 = r3.json()
            if 'finance' in data3 and 'result' in data3['finance']:
                quotes = data3['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol', '')
                    price = q.get('regularMarketPrice', 0)
                    vol = q.get('regularMarketVolume', 0)
                    exchange = q.get('exchange', '')
                    # Ø´Ø±ÙˆØ· Ù…Ø®ÙÙØ© Ù„Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØµØºÙŠØ±Ø©
                    if (sym and len(sym) <= 4 and '.' not in sym and
                        0.02 <= price <= 10.0 and vol >= 100000 and
                        exchange in allowed_exchanges and
                        not any(s['symbol'] == sym for s in full_list)):
                        full_list.append({
                            'symbol': sym, 
                            'price': price, 
                            'volume': vol, 
                            'change': q.get('regularMarketChangePercent', 0),
                            'exchange': exchange
                        })
                        # ğŸ¯ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
                        low52 = q.get('fiftyTwoWeekLow', 0)
                        if low52 and low52 > 0 and sym not in bottom_hunter_data:
                            bottom_hunter_data[sym] = {
                                'price': price,
                                'low52': low52
                            }
                print(f"   âœ… Small Cap: {len(quotes)} Ø³Ù‡Ù…")
        
        # Ù‚Ø§Ø¦Ù…Ø© 4: Undervalued Growth
        print("ğŸ’ Ø¬Ù„Ø¨ Ø£Ø³Ù‡Ù… Ø§Ù„Ù†Ù…Ùˆ...")
        url4 = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=undervalued_growth_stocks&count=100"
        r4 = requests.get(url4, headers=headers, timeout=10)
        if r4.status_code == 200:
            data4 = r4.json()
            if 'finance' in data4 and 'result' in data4['finance']:
                quotes = data4['finance']['result'][0].get('quotes', [])
                for q in quotes:
                    sym = q.get('symbol', '')
                    price = q.get('regularMarketPrice', 0)
                    vol = q.get('regularMarketVolume', 0)
                    change = q.get('regularMarketChangePercent', 0)
                    exchange = q.get('exchange', '')
                    # Ù†ÙØ³ Ø§Ù„ÙÙ„Ø§ØªØ±: 4 Ø­Ø±ÙˆÙØŒ Ø³Ø¹Ø± 0.02-10ØŒ Ø¨ÙˆØ±ØµØ© Ø£Ù…Ø±ÙŠÙƒÙŠØ©
                    if (sym and len(sym) <= 4 and '.' not in sym and
                        0.02 <= price <= 10.0 and vol >= 100000 and
                        exchange in allowed_exchanges and
                        not any(s['symbol'] == sym for s in full_list)):
                        full_list.append({'symbol': sym, 'price': price, 'volume': vol, 'change': change, 'exchange': exchange})
                        # ğŸ¯ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†
                        low52 = q.get('fiftyTwoWeekLow', 0)
                        if low52 and low52 > 0 and sym not in bottom_hunter_data:
                            bottom_hunter_data[sym] = {
                                'price': price,
                                'low52': low52
                            }
                print(f"   âœ… Growth: {len(quotes)} Ø³Ù‡Ù…")
        
        # ğŸ†• Ù‚Ø§Ø¦Ù…Ø© 5: Finviz Elite (Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨ÙˆÙ‚Øª Ø§Ù„Ø³ÙˆÙ‚)
        print("ğŸ¯ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† Finviz Elite...")
        try:
            import io
            FINVIZ_COOKIE = """chartsTheme=dark; notice-newsletter=show; .ASPXAUTH=C7E2E86BC876CD078E1DC69C25671D062A909C67501ECF211333FAAD7F54A40FE9B6772EF4E88ED21E26C6C99BCAE5C39C5C8D598CD73357A5FCB4B556AD83E55002A827606EFFFE1F1315C9E8A4E05BC99B517D7E533905EE95F029D8FE0B930EC18E2E5F5037693AE688694BFDFDD82DADE25BA4063B448D18DDC85EAB40FD9D717716F2FEABA2A813D932072BFF5C6F723BACD8D3E4CA5161C3B1E0FF3088C9CC8AA7E67C3A4C94EA5122A68D9ADC7F85B091D98A31BF66F654490F1F7601FA7E420E3ECAF266BF62C1A7C9733A57BC866F92; survey_dialog_cohort=0"""
            FINVIZ_HEADERS = {
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                "Cookie": FINVIZ_COOKIE
            }
            # ÙÙ„ØªØ±: Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† 11ØŒ ÙÙ„ÙˆØª Ø£Ù‚Ù„ Ù…Ù† 15MØŒ Ø­Ø¬Ù… Ø£ÙƒØ«Ø± Ù…Ù† 50kØŒ ØªØºÙŠØ± Ø¥ÙŠØ¬Ø§Ø¨ÙŠ
            finviz_url = (
                "https://elite.finviz.com/export.ashx?v=111"
                "&f=sh_price_u11,sh_float_u15,sh_curvol_o50,ta_change_u"
                "&o=-volume"
            )
            r_finviz = requests.get(finviz_url, headers=FINVIZ_HEADERS, timeout=15)
            if r_finviz.status_code == 200 and 'Ticker' in r_finviz.text:
                csv_data = io.StringIO(r_finviz.text)
                df_finviz = pd.read_csv(csv_data)
                # ÙÙ„ØªØ±Ø© Ø¥Ø¶Ø§ÙÙŠØ©
                df_finviz = df_finviz[
                    (df_finviz['Price'] >= 0.02) & 
                    (df_finviz['Price'] <= 10) & 
                    (df_finviz['Volume'] >= 200000)
                ]
                finviz_count = 0
                for _, row in df_finviz.iterrows():
                    sym = str(row.get('Ticker', ''))
                    if sym and len(sym) <= 4 and '.' not in sym:
                        if not any(s['symbol'] == sym for s in full_list):
                            full_list.append({
                                'symbol': sym,
                                'price': float(row.get('Price', 0)),
                                'volume': int(row.get('Volume', 0)),
                                'change': float(str(row.get('Change', '0%')).replace('%', '') or 0),
                                'exchange': 'FINVIZ'
                            })
                            finviz_count += 1
                print(f"   âœ… Finviz Elite: {finviz_count} Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯")
            else:
                print(f"   âš ï¸ Finviz: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„")
        except Exception as e:
            print(f"   âš ï¸ Finviz Error: {e}")
        
        # âŒ Ù„Ø§ Ù†Ø¬Ù„Ø¨ Ù…Ù† Day Losers Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
                            
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Yahoo: {e}")
    
    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
    full_list = list({s['symbol']: s for s in full_list}.values())
    
    # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
    full_list.sort(key=lambda x: x.get('change', 0), reverse=True)
    
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 100 Ø³Ù‡Ù…
    if len(full_list) < 100:
        print(f"âš ï¸ ØªØ­Ø°ÙŠØ±: ÙÙ‚Ø· {len(full_list)} Ø³Ù‡Ù… (Ø£Ù‚Ù„ Ù…Ù† 100)")
    else:
        print(f"âœ… ØªÙ… Ø¬Ù…Ø¹ {len(full_list)} Ø³Ù‡Ù… (Ø§Ù„Ù‡Ø¯Ù: 100+)")
    
    # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ù‡Ù…
    for i, item in enumerate(full_list[:100]):
        print(f"ğŸ“Œ {i+1}/100: {item['symbol']} (${item['price']:.2f}, +{item['change']:.1f}%)")
    
    # Ø¥Ø±Ø¬Ø§Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù…ÙˆØ² ÙÙ‚Ø·
    return [s['symbol'] for s in full_list[:100]]

# =========================================================
# 4. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ (Ø±Ø§Ø¨Ø· FMP Ø§Ù„Ø¬Ø¯ÙŠØ¯ stable)
# =========================================================
def get_fmp_data(symbol):
    # ğŸ”¥ Ø±Ø§Ø¨Ø· FMP Ø§Ù„Ø¬Ø¯ÙŠØ¯ (stable)
    url = f"https://financialmodelingprep.com/stable/historical-chart/5min?symbol={symbol}&apikey={API_KEY}"
    try:
        r = requests.get(url, timeout=10).json()
        if not r: return pd.DataFrame()
        df = pd.DataFrame(r)
        try:
            df['date'] = pd.to_datetime(df['date'], errors='coerce')
        except Exception as e:
            return pd.DataFrame()
        df = df.set_index('date').sort_index()
        df.columns = df.columns.str.capitalize()
        return df
    except Exception as e:
        return pd.DataFrame()

# =========================================================
# 5. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ (Ù†Ø³Ø®Ø© Ù…ÙˆØ²ÙˆÙ†Ø© Ø¨Ø§Ù„Ø°Ù‡Ø¨)
# =========================================================
def check_ladder_pattern(df_window):
    # Ù†Ø­ØªØ§Ø¬ 3 Ø´Ù…Ø¹Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
    if len(df_window) < 3:
        return False, 0, "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©", 0, False

    candles = [row for _, row in df_window.iterrows()]

    start_price = float(candles[0]['Open'])
    current_price = float(candles[-1]['Close'])

    # 1. Ø´Ø±Ø· Ù…Ø¨Ø¯Ø¦ÙŠ: Ù„Ø§Ø²Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    if current_price <= start_price:
        return False, 0, "Ø§Ù„Ø³Ø¹Ø± Ù„Ù… ÙŠØµØ¹Ø¯", 0, False

    highest_high = float(candles[0]['High'])
    prev_low = float(candles[0]['Low'])
    prev_close = float(candles[0]['Close'])

    stagnation_count = 0  # Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù„
    new_highs_count = 0
    valid_candles = 0

    for i in range(1, len(candles)):
        row = candles[i]
        c_close = float(row['Close'])
        c_high = float(row['High'])
        c_low = float(row['Low'])
        c_open = float(row['Open'])

        body = abs(c_close - c_open)
        upper_wick = c_high - max(c_open, c_close)

        # ğŸŸ¢ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ù…Ø© ÙˆØ§Ù„Ø±ÙƒÙˆØ¯ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù€ LPCN)
        if c_high > highest_high:
            highest_high = c_high
            new_highs_count += 1
            stagnation_count = 0 # ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ø£Ù†Ù‡ Ø§Ø®ØªØ±Ù‚
        else:
            # Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ù‡Ù„ Ù‡Ùˆ Ø±ÙƒÙˆØ¯ "Ù…ÙŠØª" ÙˆÙ„Ø§ Ø§Ø³ØªØ±Ø§Ø­Ø© "Ù…Ø­Ø§Ø±Ø¨"ØŸ

            # Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø£Ø¹Ù„Ù‰ Ù‚Ù…Ø© ÙˆØµÙ„Ù‡Ø§
            distance_from_high = (highest_high - c_close) / highest_high

            # Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ù…Ø© (Ø£Ù‚Ù„ Ù…Ù† 1.5% ÙØ±Ù‚) Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ø§Ø³ØªØ±Ø§Ø­Ø© Ù…Ø³Ù…ÙˆØ­Ø©
            # ÙˆÙ†Ù…Ø´ÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯ (0.5) Ø¨Ø¯Ù„ (1)
            if distance_from_high < 0.015:
                stagnation_count += 0.5
            else:
                stagnation_count += 1 # Ø±ÙƒÙˆØ¯ Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‚Ù…Ø©

        # ğŸ›‘ Ø­Ø¯ Ø§Ù„Ø·Ø±Ø¯ (ISPO ÙŠÙˆØµÙ„ Ù‡Ù†Ø§ Ø¨Ø³Ø±Ø¹Ø©)
        # Ø±ÙØ¹Ù†Ø§Ù‡ Ù„Ù€ 3.5 Ø¹Ø´Ø§Ù† Ù†Ø¹Ø·ÙŠ ÙØ±ØµØ© Ù„Ù„ÙŠ Ø¬Ø§Ù„Ø³ ÙŠØ¬Ù…Ø¹ Ø¹Ø²Ù…
        if stagnation_count >= 3.5:
            return False, 0, "ÙÙ‚Ø¯ Ø§Ù„Ø²Ø®Ù… (Ø±ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„)", highest_high, False

        # ğŸ›‘ ÙÙ„ØªØ± Ø§Ù„ÙƒØ³Ø± (Higher Lows) - Ø¨Ù…Ø±ÙˆÙ†Ø© Ø¨Ø³ÙŠØ·Ø©
        # LPCN Ø£Ø­ÙŠØ§Ù†Ø§ ÙŠÙ†Ø²Ù„ Ø°ÙŠÙ„Ù‡ Ø´ÙˆÙŠØŒ ÙØ³Ù…Ø­Ù†Ø§ Ø¨Ù€ 0.2% Ø³Ù…Ø§Ø­ÙŠØ©
        if c_close < (prev_low * 0.998):
            return False, 0, f"ÙƒØ³Ø± Ù‚Ø§Ø¹ Ø³Ø§Ø¨Ù‚ (Ø´Ù…Ø¹Ø© {i+1})", highest_high, False

        # ğŸ›‘ ÙÙ„ØªØ± Ø§Ù„Ø°ÙŠÙˆÙ„ "Ø§Ù„Ø®Ø¨ÙŠØ«Ø©" (Ø²ÙŠ JDST)
        # Ø¥Ø°Ø§ Ø§Ù„Ø°ÙŠÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ ÙˆØ§Ù„Ø¬Ø³Ù… ØµØºÙŠØ±
        avg_body_ref = abs(prev_close - prev_low) + 0.01
        if upper_wick > body * 2.5 and upper_wick > avg_body_ref * 1.5:
             return False, 0, "Ø°ÙŠÙ„ ØªØµØ±ÙŠÙ ÙˆØ§Ø¶Ø­", highest_high, False

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
        prev_low = c_low
        prev_close = c_close
        valid_candles += 1

    # ğŸ¯ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„
    # 1. Ø§Ù„Ù‚ÙˆØ©: Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ù…Ø©
    distance_from_peak = (highest_high - current_price) / highest_high
    is_pending = False
    
    if current_price < (highest_high * 0.985):
        # Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‚Ù…Ø© - Ù„ÙƒÙ† Ù‡Ù„ ØµØ¹Ø¯ Ø£ØµÙ„Ø§Ù‹ØŸ
        total_gain = (highest_high - start_price) / start_price
        if total_gain >= 0.03 and new_highs_count >= 2:
            # ØµØ¹Ø¯ Ø¨Ù‚ÙˆØ© Ù„ÙƒÙ† Ø£ØºÙ„Ù‚ Ø¨Ø¹ÙŠØ¯ â†’ Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚
            is_pending = True
        else:
            return False, 0, "Ø¥ØºÙ„Ø§Ù‚ Ø¶Ø¹ÙŠÙ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù‚Ù…Ø©", highest_high, False

    # 2. Ø§Ù„Ù†Ù…Ùˆ: Ù‡Ù„ ØªØ­Ø±Ùƒ Ø§Ù„Ø³Ø¹Ø± ÙØ¹Ù„Ø§Ù‹ØŸ (Ø¹Ø´Ø§Ù† Ù†ØµÙŠØ¯ ISPO Ù„Ùˆ Ù…Ø´Ù‰ Ø§Ù„Ø¹Ø¯Ø§Ø¯)
    total_gain_pct = (current_price - start_price) / start_price
    if total_gain_pct < 0.005 and not is_pending: # Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ØªØ­Ø±Ùƒ 0.5% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
        return False, 0, "Ø­Ø±ÙƒØ© Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹", highest_high, False

    # 3. Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù…Ù…: Ù„Ø§Ø²Ù… Ø³ÙˆØ§ Ù‚Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
    if new_highs_count < 1:
        return False, 0, "Ù„Ù… ÙŠØ­Ù‚Ù‚ Ù‚Ù…Ù… Ø¬Ø¯ÙŠØ¯Ø©", highest_high, False

    strength_pct = int((new_highs_count / len(candles)) * 100)
    # Ø¨ÙˆÙ†Øµ Ù„Ù€ LPCN: Ø¥Ø°Ø§ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‡Ø§ÙŠØŒ Ø¹Ø·Ù‡Ø§ 100%
    if current_price >= highest_high * 0.995:
        strength_pct = 95

    return True, strength_pct, "Ù†Ù…ÙˆØ°Ø¬ Ù‚ÙˆÙŠ ÙˆÙ…ØªÙ…Ø§Ø³Ùƒ ğŸš€", highest_high, is_pending

def get_country_flag(country_code):
    """ØªØ­ÙˆÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù„Ø¯ Ø¥Ù„Ù‰ Ø¹Ù„Ù…"""
    flags = {
        'US': 'ğŸ‡ºğŸ‡¸', 'USA': 'ğŸ‡ºğŸ‡¸', 'UNITED STATES': 'ğŸ‡ºğŸ‡¸',
        'CN': 'ğŸ‡¨ğŸ‡³', 'CHINA': 'ğŸ‡¨ğŸ‡³',
        'IL': 'ğŸ‡®ğŸ‡±', 'ISRAEL': 'ğŸ‡®ğŸ‡±',
        'GB': 'ğŸ‡¬ğŸ‡§', 'UK': 'ğŸ‡¬ğŸ‡§', 'UNITED KINGDOM': 'ğŸ‡¬ğŸ‡§',
        'CA': 'ğŸ‡¨ğŸ‡¦', 'CANADA': 'ğŸ‡¨ğŸ‡¦',
        'JP': 'ğŸ‡¯ğŸ‡µ', 'JAPAN': 'ğŸ‡¯ğŸ‡µ',
        'KR': 'ğŸ‡°ğŸ‡·', 'SOUTH KOREA': 'ğŸ‡°ğŸ‡·',
        'DE': 'ğŸ‡©ğŸ‡ª', 'GERMANY': 'ğŸ‡©ğŸ‡ª',
        'FR': 'ğŸ‡«ğŸ‡·', 'FRANCE': 'ğŸ‡«ğŸ‡·',
        'AU': 'ğŸ‡¦ğŸ‡º', 'AUSTRALIA': 'ğŸ‡¦ğŸ‡º',
        'BR': 'ğŸ‡§ğŸ‡·', 'BRAZIL': 'ğŸ‡§ğŸ‡·',
        'IN': 'ğŸ‡®ğŸ‡³', 'INDIA': 'ğŸ‡®ğŸ‡³',
        'MX': 'ğŸ‡²ğŸ‡½', 'MEXICO': 'ğŸ‡²ğŸ‡½',
        'SG': 'ğŸ‡¸ğŸ‡¬', 'SINGAPORE': 'ğŸ‡¸ğŸ‡¬',
        'HK': 'ğŸ‡­ğŸ‡°', 'HONG KONG': 'ğŸ‡­ğŸ‡°',
        'TW': 'ğŸ‡¹ğŸ‡¼', 'TAIWAN': 'ğŸ‡¹ğŸ‡¼',
        'NL': 'ğŸ‡³ğŸ‡±', 'NETHERLANDS': 'ğŸ‡³ğŸ‡±',
        'CH': 'ğŸ‡¨ğŸ‡­', 'SWITZERLAND': 'ğŸ‡¨ğŸ‡­',
        'IE': 'ğŸ‡®ğŸ‡ª', 'IRELAND': 'ğŸ‡®ğŸ‡ª',
        'KY': 'ğŸ‡°ğŸ‡¾', 'CAYMAN ISLANDS': 'ğŸ‡°ğŸ‡¾',
        'BM': 'ğŸ‡§ğŸ‡²', 'BERMUDA': 'ğŸ‡§ğŸ‡²',
        'AR': 'ğŸ‡¦ğŸ‡·', 'ARGENTINA': 'ğŸ‡¦ğŸ‡·',
        'CL': 'ğŸ‡¨ğŸ‡±', 'CHILE': 'ğŸ‡¨ğŸ‡±',
        'CO': 'ğŸ‡¨ğŸ‡´', 'COLOMBIA': 'ğŸ‡¨ğŸ‡´',
        'PE': 'ğŸ‡µğŸ‡ª', 'PERU': 'ğŸ‡µğŸ‡ª',
        'VN': 'ğŸ‡»ğŸ‡³', 'VIETNAM': 'ğŸ‡»ğŸ‡³',
        'TH': 'ğŸ‡¹ğŸ‡­', 'THAILAND': 'ğŸ‡¹ğŸ‡­',
        'MY': 'ğŸ‡²ğŸ‡¾', 'MALAYSIA': 'ğŸ‡²ğŸ‡¾',
        'ID': 'ğŸ‡®ğŸ‡©', 'INDONESIA': 'ğŸ‡®ğŸ‡©',
        'PH': 'ğŸ‡µğŸ‡­', 'PHILIPPINES': 'ğŸ‡µğŸ‡­',
        'SE': 'ğŸ‡¸ğŸ‡ª', 'SWEDEN': 'ğŸ‡¸ğŸ‡ª',
        'NO': 'ğŸ‡³ğŸ‡´', 'NORWAY': 'ğŸ‡³ğŸ‡´',
        'DK': 'ğŸ‡©ğŸ‡°', 'DENMARK': 'ğŸ‡©ğŸ‡°',
        'FI': 'ğŸ‡«ğŸ‡®', 'FINLAND': 'ğŸ‡«ğŸ‡®',
        'RU': 'ğŸ‡·ğŸ‡º', 'RUSSIA': 'ğŸ‡·ğŸ‡º',
        'ZA': 'ğŸ‡¿ğŸ‡¦', 'SOUTH AFRICA': 'ğŸ‡¿ğŸ‡¦',
        'AE': 'ğŸ‡¦ğŸ‡ª', 'UNITED ARAB EMIRATES': 'ğŸ‡¦ğŸ‡ª',
        'SA': 'ğŸ‡¸ğŸ‡¦', 'SAUDI ARABIA': 'ğŸ‡¸ğŸ‡¦',
        'PR': 'ğŸ‡µğŸ‡·', 'PUERTO RICO': 'ğŸ‡µğŸ‡·',
    }
    if not country_code:
        return 'ğŸ³ï¸'
    return flags.get(country_code.upper(), 'ğŸ³ï¸')

def get_stock_info(symbol):
    """Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª ÙˆØ§Ù„Ø¨Ù„Ø¯ Ùˆ RVOL - Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ù…Ù† Yahoo Finance"""
    global float_data_store
    
    # Ø£ÙˆÙ„Ø§Ù‹: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
    cached = float_data_store.get(symbol)
    
    # Ø¥Ø°Ø§ Ø§Ù„ÙƒØ§Ø´ ÙÙŠÙ‡ dict Ù…Ø¹ float Ùˆ country (ÙƒØ§Ù…Ù„)
    if isinstance(cached, dict) and cached.get('float', 0) > 0 and cached.get('country', ''):
        float_val = cached.get('float', 0)
        country = cached.get('country', '')
        # Ù†Ø­ØªØ§Ø¬ Ù†Ø¬Ù„Ø¨ RVOL Ù…Ù† Yahoo (Ù„Ø£Ù†Ù‡ ÙŠØªØºÙŠØ± ÙŠÙˆÙ…ÙŠØ§Ù‹)
        try:
            stock = yf.Ticker(symbol)
            info = stock.info
            volume = info.get('volume', 0) or 0
            avg_volume = info.get('averageVolume', 0) or info.get('averageVolume10days', 0) or 1
            rvol = volume / avg_volume if avg_volume > 0 else 0
            return float_val, country, rvol
        except:
            return float_val, country, 0
    
    # Ø¥Ø°Ø§ Ø§Ù„ÙƒØ§Ø´ ÙÙŠÙ‡ Ø±Ù‚Ù… ÙÙ‚Ø· (Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„Ù‚Ø¯ÙŠÙ…) - Ù†Ø­ØªÙØ¸ Ø¨Ù‡ ÙˆÙ†Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ù„Ø¯
    old_float = 0
    if isinstance(cached, dict):
        old_float = cached.get('float', 0)
    elif isinstance(cached, (int, float)) and cached > 0:
        old_float = cached
    
    # Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¬Ù„Ø¨ Ù…Ù† Yahoo Finance
    try:
        stock = yf.Ticker(symbol)
        info = stock.info
        
        new_float = info.get('floatShares', 0) or 0
        country = info.get('country', '') or ''
        volume = info.get('volume', 0) or 0
        avg_volume = info.get('averageVolume', 0) or info.get('averageVolume10days', 0) or 1
        rvol = volume / avg_volume if avg_volume > 0 else 0
        
        # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        float_val = new_float if new_float > 0 else old_float
        
        # Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        if float_val > 0 or country:
            float_data_store[symbol] = {'float': float_val, 'country': country}
            save_json_file(FLOAT_CACHE_FILE, float_data_store)
            if float_val > 0:
                print(f"   ğŸ’¾ ØªÙ… Ø­ÙØ¸ {symbol}: {fmt_shares(float_val)} | {country}")
        
        return float_val, country, rvol
    except Exception as e:
        pass
    
    # Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„Ù‚Ø¯ÙŠÙ…
    return old_float, '', 0

def send_telegram(message):
    if not TELEGRAM_BOT_TOKEN: return
    try:
        requests.post(
            f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",
            data={'chat_id': TELEGRAM_CHAT_ID, 'text': message, 'parse_mode': 'Markdown'},
            timeout=5
        )
    except: pass

def send_summary(opportunities, target_date):
    """Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ù…Ø±ØªØ¨ Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ÙÙ„ÙˆØª"""
    if not opportunities:
        return
    
    # ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø± + Ø§Ù„Ø£Ù‚Ù„ ÙÙ„ÙˆØª Ù…Ø¹Ø§Ù‹ (Ø­Ø§ØµÙ„ Ø§Ù„Ø¶Ø±Ø¨)
    # Ø§Ù„Ø³Ø¹Ø± Ã— Ø§Ù„ÙÙ„ÙˆØª = Ø§Ù„Ø£Ù‚Ù„ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ù‡Ùˆ Ø§Ù„ÙØ§Ø¦Ø²
    sorted_opps = sorted(opportunities, key=lambda x: x['price'] * x['float'])
    
    # Ø§Ù„Ù…ÙŠØ¯Ø§Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
    medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ']
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    lines = [
        "ğŸ† *Ù…Ù„Ø®Øµ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„* ğŸ†",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        f"ğŸ“… *{target_date}*",
        ""
    ]
    
    direct_count = 0
    pending_count = 0
    shown_tickers = set()  # Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
    
    for i, opp in enumerate(sorted_opps[:10]):  # Ø£ÙˆÙ„ 10 ÙÙ‚Ø·
        medal = medals[i] if i < len(medals) else f"{i+1}."
        pending_mark = " (Ù…Ø¹Ù„Ù‚)" if opp['is_pending'] else ""
        shown_tickers.add(opp['ticker'])
        
        if opp['is_pending']:
            pending_count += 1
        else:
            direct_count += 1
        
        # â­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³Ø§Ù… Ù„Ù„Ù…Ù„Ø®Øµ
        badge_display = ""
        badge_score = opp.get('badge_score', 0)
        badge_text = opp.get('badge_text', '')
        if badge_score == -1:  # Ø§Ù†ÙØ¬Ø§Ø±ÙŠØ©
            badge_display = " ğŸ’¥"
        elif badge_score >= 1:
            badge_display = " " + "â­" * badge_score
        
        # âš–ï¸ Ø¹Ø±Ø¶ "Ø­Ù„Ø§Ù„" ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù„Ø§Ù„
        halal_display = ""
        shariah = opp.get('shariah', '')
        if "Ø­Ù„Ø§Ù„" in shariah:
            halal_display = " Ø­Ù„Ø§Ù„"
        
        line = f"{medal} {opp['ticker']} {opp['flag']}{badge_display}{halal_display}{pending_mark}"
        lines.append(line)
    
    # ğŸŒŸ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù‡Ù… Ø§Ù„ÙˆØ³Ø§Ù… Ø§Ù„Ø¹Ø§Ù„ÙŠ (2/3 Ø£Ùˆ 3/3 Ø£Ùˆ Ø§Ù†ÙØ¬Ø§Ø±ÙŠØ©) Ø§Ù„Ù„ÙŠ Ù…Ø§ Ø¸Ù‡Ø±Øª
    high_badge_opps = [opp for opp in sorted_opps[10:] 
                       if opp['ticker'] not in shown_tickers and 
                       (opp.get('badge_score', 0) >= 2 or opp.get('badge_score', 0) == -1)]
    
    if high_badge_opps:
        lines.append("")
        lines.append("ğŸŒŸ *Ø£ÙˆØ³Ù…Ø© Ù…Ù…ÙŠØ²Ø©:*")
        for opp in high_badge_opps:
            badge_score = opp.get('badge_score', 0)
            if badge_score == -1:
                badge_display = " ğŸ’¥"
            else:
                badge_display = " " + "â­" * badge_score
            pending_mark = " (Ù…Ø¹Ù„Ù‚)" if opp['is_pending'] else ""
            # âš–ï¸ Ø¹Ø±Ø¶ "Ø­Ù„Ø§Ù„" ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù„Ø§Ù„
            halal_display = ""
            shariah = opp.get('shariah', '')
            if "Ø­Ù„Ø§Ù„" in shariah:
                halal_display = " Ø­Ù„Ø§Ù„"
            line = f"   â–¸ {opp['ticker']} {opp['flag']}{badge_display}{halal_display}{pending_mark}"
            lines.append(line)
    
    lines.extend([
        "",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        f"ğŸ“Š *Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:* {len(sorted_opps)} ÙØ±Øµ",
        f"ğŸš€ *Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±:* {direct_count}",
        f"âœ‹ *Ø£ÙˆØ§Ù…Ø± Ù…Ø¹Ù„Ù‚Ø©:* {pending_count}",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        "ğŸ’¡ _Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø± Ã— Ø§Ù„Ø£Ù‚Ù„ ÙÙ„ÙˆØª_"
    ])
    
    summary_msg = "\n".join(lines)
    send_telegram(summary_msg)
    print("ğŸ“¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ")

# =========================================================
# 5.5 ğŸ¯ ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† - Ø±Ø³Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø©
# =========================================================
def send_bottom_hunter_summary(target_date):
    """Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø®Øµ ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† - ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£Ø³Ù‡Ù…"""
    global bottom_hunter_data, float_data_store
    
    print("ğŸ¯ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†...")
    
    # Ø§Ù„Ø´Ø±ÙˆØ·: ÙÙ„ÙˆØª < 2M + Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹ < 10%
    hunters = []
    
    for sym, data in bottom_hunter_data.items():
        try:
            price = data.get('price', 0)
            low52 = data.get('low52', 0)
            
            if not price or not low52 or low52 <= 0:
                continue
            
            # Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹
            above_low_pct = ((price - low52) / low52) * 100
            
            # Ø§Ù„Ø´Ø±Ø· 1: Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹ (Ø£Ù‚Ù„ Ù…Ù† 10% ÙÙˆÙ‚Ù‡)
            if above_low_pct > 10:
                continue
            
            # Ø§Ù„Ø´Ø±Ø· 2: ÙÙ„ÙˆØª Ø£Ù‚Ù„ Ù…Ù† 2 Ù…Ù„ÙŠÙˆÙ†
            # Ø£ÙˆÙ„Ø§Ù‹: Ù†Ù‚Ø±Ø£ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
            float_val = 0
            float_entry = float_data_store.get(sym, 0)
            if isinstance(float_entry, dict):
                float_val = float_entry.get('float', 0)
            else:
                float_val = float_entry
            
            # Ø«Ø§Ù†ÙŠØ§Ù‹: Ù„Ùˆ Ù…Ø§ Ø­ØµÙ„Ù†Ø§ØŒ Ù†Ø¬Ù„Ø¨ Ù…Ù† Yahoo
            if not float_val or float_val <= 0:
                try:
                    stock = yf.Ticker(sym)
                    info = stock.info
                    float_val = info.get('floatShares', 0) or 0
                    # Ù†Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
                    if float_val > 0:
                        float_data_store[sym] = {'float': float_val, 'country': ''}
                        save_json_file(FLOAT_CACHE_FILE, float_data_store)
                except:
                    pass
            
            if not float_val or float_val <= 0 or float_val > 20_000_000:
                continue
            
            hunters.append({
                'symbol': sym,
                'price': price,
                'low52': low52,
                'float': float_val,
                'above_pct': above_low_pct
            })
            print(f"   ğŸ¯ {sym}: ${price:.2f} | ÙÙ„ÙˆØª: {fmt_shares(float_val)} | {above_low_pct:.1f}% ÙÙˆÙ‚ Ø§Ù„Ù‚Ø§Ø¹")
        except:
            continue
    
    # Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù…ØŒ Ù„Ø§ Ù†Ø±Ø³Ù„ Ø´ÙŠ
    if not hunters:
        print("ğŸ¯ ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù…Ø·Ø§Ø¨Ù‚Ø©")
        return
    
    # ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹ (Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹)
    hunters.sort(key=lambda x: x['above_pct'])
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    lines = [
        "ğŸ¯ *ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†* ğŸ¯",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        f"ğŸ“… *{target_date}*",
        ""
    ]
    
    for h in hunters[:5]:  # Ø£ÙˆÙ„ 5 ÙÙ‚Ø·
        lines.append(f"ğŸ“ *{h['symbol']}*")
        lines.append(f"   â”” ğŸ’° ${h['price']:.2f} | ğŸ“¦ {fmt_shares(h['float'])} | ğŸ“‰ {h['above_pct']:.1f}% ÙÙˆÙ‚ Ø§Ù„Ù‚Ø§Ø¹")
        lines.append("")
    
    lines.extend([
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        f"ğŸ“Š *Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:* {len(hunters)} Ø³Ù‡Ù…",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        "âš ï¸ _ÙÙ„ÙˆØª < 20M + Ù‚Ø±ÙŠØ¨ Ù…Ù† Ù‚Ø§Ø¹ 52 Ø£Ø³Ø¨ÙˆØ¹_"
    ])
    
    msg = "\n".join(lines)
    send_telegram(msg)
    print(f"ğŸ¯ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù†: {len(hunters)} Ø³Ù‡Ù…")

# =========================================================
# 6. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
# =========================================================
from datetime import timedelta

def get_trading_date_and_mode():
    """
    ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ‡Ù„ Ù†Ù†ØªØ¸Ø± Ø£Ùˆ Ù†Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©
    
    Returns:
        (target_date, should_wait, message)
    """
    ny_tz = pytz.timezone('America/New_York')
    now_ny = datetime.now(ny_tz)
    
    scan_time = time(10, 3)  # ÙˆÙ‚Øª Ø§Ù„ÙØ­Øµ 10:03
    market_close = time(16, 0)  # Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³ÙˆÙ‚
    
    weekday = now_ny.weekday()  # 0=Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ... 4=Ø§Ù„Ø¬Ù…Ø¹Ø©ØŒ 5=Ø§Ù„Ø³Ø¨ØªØŒ 6=Ø§Ù„Ø£Ø­Ø¯
    current_time = now_ny.time()
    
    # === Ø§Ù„ÙˆÙŠÙƒÙ†Ø¯ (Ø§Ù„Ø³Ø¨Øª Ø£Ùˆ Ø§Ù„Ø£Ø­Ø¯) ===
    if weekday >= 5:
        # Ù†Ø±Ø¬Ø¹ Ù„ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©
        days_back = weekday - 4  # Ø§Ù„Ø³Ø¨Øª=1ØŒ Ø§Ù„Ø£Ø­Ø¯=2
        friday_date = (now_ny - timedelta(days=days_back)).date()
        return friday_date, False, f"ğŸ“… Ø§Ù„ÙˆÙŠÙƒÙ†Ø¯ - Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ Ø§Ù„Ø¬Ù…Ø¹Ø© {friday_date}"
    
    # === ÙŠÙˆÙ… ØªØ¯Ø§ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ (Ø§Ù„Ø§Ø«Ù†ÙŠÙ† - Ø§Ù„Ø¬Ù…Ø¹Ø©) ===
    
    # Ù‚Ø¨Ù„ 10:03 â†’ Ø§Ù†ØªØ¸Ø±
    if current_time < scan_time:
        wait_seconds = (datetime.combine(now_ny.date(), scan_time) - 
                       datetime.combine(now_ny.date(), current_time)).seconds
        return now_ny.date(), True, f"â³ Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ 10:03 NY ({wait_seconds//60} Ø¯Ù‚ÙŠÙ‚Ø©)"
    
    # Ø¨Ø¹Ø¯ 10:03 â†’ Ø´Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ… Ù…Ø¨Ø§Ø´Ø±Ø© (ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ù…Ù† Ø§Ù„ÙŠÙˆÙ…)
    else:
        return now_ny.date(), False, f"ğŸš€ Ø¨Ø¹Ø¯ 10:03 - Ø¬Ù„Ø¨ Ø´Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ… {now_ny.date()}"

def process_single_stock(ticker, target_date):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ù‡Ù… ÙˆØ§Ø­Ø¯ - Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ ThreadPoolExecutor"""
    try:
        df = get_fmp_data(ticker)
        if df.empty:
            return {'status': 'empty', 'ticker': ticker}
        
        # ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù…ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·
        day_data = df[df.index.date == target_date]
        if day_data.empty:
            return {'status': 'wrong_date', 'ticker': ticker}
        
        setup = day_data.between_time('09:30', '10:00')
        if setup.empty:
            return {'status': 'no_setup', 'ticker': ticker}
        
        try:
            is_valid, strength, reason, highest_high, is_pending = check_ladder_pattern(setup)
        except:
            return {'status': 'error', 'ticker': ticker}
        
        if not is_valid:
            return {'status': 'invalid', 'ticker': ticker}
        
        try:
            price = setup['Close'].iloc[-1]
        except:
            return {'status': 'error', 'ticker': ticker}
        
        return {
            'status': 'valid',
            'ticker': ticker,
            'price': price,
            'strength': strength,
            'highest_high': highest_high,
            'is_pending': is_pending,
            'setup': setup
        }
    except:
        return {'status': 'error', 'ticker': ticker}

def run_scan(target_date):
    """ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯ - Ù…Ø¹ 5 workers Ù„Ù„Ø³Ø±Ø¹Ø©"""
    import time as time_module
    start_time = time_module.time()
    
    ny_tz = pytz.timezone('America/New_York')
    now_ny = datetime.now(ny_tz)
    
    print(f"\nğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ù„ØªØ§Ø±ÙŠØ®: {target_date}")
    send_telegram(f"ğŸš€ Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯ - {target_date}")
    
    market_list = get_watchlist()
    saved_list = load_json_file(DAILY_WATCH_FILE)
    
    if isinstance(saved_list, dict):
        saved_list = list(saved_list.keys())
    elif not isinstance(saved_list, list):
        saved_list = []
    
    full_list = list(set(market_list + saved_list))
    
    matches = 0
    skipped_wrong_date = 0
    skipped_empty = 0
    opportunities = []
    
    print(f"ğŸ”¬ ÙØ­Øµ {len(full_list)} Ø³Ù‡Ù… (5 workers)...")
    
    # ğŸš€ Ø§Ø³ØªØ®Ø¯Ø§Ù… 5 workers Ù„Ù„Ø³Ø±Ø¹Ø©
    valid_results = []
    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = {executor.submit(process_single_stock, ticker, target_date): ticker for ticker in full_list}
        
        for future in as_completed(futures):
            try:
                result = future.result()
                if result['status'] == 'empty':
                    skipped_empty += 1
                elif result['status'] == 'wrong_date':
                    skipped_wrong_date += 1
                elif result['status'] == 'valid':
                    valid_results.append(result)
            except:
                continue
    
    print(f"âš¡ ØªÙ… ÙØ­Øµ Ø§Ù„Ø´Ù…ÙˆØ¹ ÙÙŠ {time_module.time() - start_time:.1f} Ø«Ø§Ù†ÙŠØ©")
    print(f"ğŸ“Š ÙˆØ¬Ø¯Ù†Ø§ {len(valid_results)} ÙØ±Øµ Ù…Ø­ØªÙ…Ù„Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª...")
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØµØ§Ù„Ø­Ø© (Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ø¨Ø´ÙƒÙ„ Ù…ØªØ³Ù„Ø³Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±)
    for result in valid_results:
        ticker = result['ticker']
        price = result['price']
        strength = result['strength']
        highest_high = result['highest_high']
        is_pending = result['is_pending']
        
        try:
            # Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„ÙˆØª Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© ÙƒØ§Ù…Ù„Ø©
            try:
                float_val, country, rvol = get_stock_info(ticker)
            except:
                float_val, country, rvol = 0, '', 0
            
            # âŒ ÙÙ„ØªØ± Ø§Ù„ÙÙ„ÙˆØª Ø§Ù„Ø«Ù‚ÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (ÙÙˆÙ‚ 700M)
            if float_val > 700_000_000:
                print(f"   â­ï¸ ØªØ®Ø·ÙŠ {ticker} - ÙÙ„ÙˆØª Ø«Ù‚ÙŠÙ„ Ø¬Ø¯Ø§Ù‹ ({fmt_shares(float_val)})")
                continue
            
            try:
                flag = get_country_flag(country)
            except:
                flag = 'ğŸ³ï¸'
            
            # ØªØ­Ø¯ÙŠØ¯ ÙˆØµÙ Ø§Ù„ÙÙ„ÙˆØª
            float_desc = ""
            try:
                if float_val >= 150_000_000:
                    float_desc = " (Ø«Ù‚ÙŠÙ„)"
                elif float_val > 0 and float_val < 7_000_000:
                    float_desc = " (Ø®ÙÙŠÙ)"
            except:
                pass
            
            # ØªÙ†Ø³ÙŠÙ‚ RVOL
            try:
                rvol_text = f"{rvol:.1f}x" if rvol > 0 else "--"
            except:
                rvol_text = "--"
            
            # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø±
            try:
                if is_pending:
                    buy_stop_price = highest_high + 0.0001
                    order_type = f"âœ‹ *Ø£Ù…Ø± Ù…Ø¹Ù„Ù‚ (Buy Stop):* *${buy_stop_price:.4f}*"
                else:
                    order_type = "ğŸš€ *Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±* - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ø®ÙˆÙ„!"
            except:
                order_type = "ğŸš€ *Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ø¨Ø§Ø´Ø±*"
            
            # Ø¬Ù„Ø¨ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø´Ø±Ø¹ÙŠ
            try:
                shariah = check_shariah_status(ticker)
            except:
                shariah = "ğŸš« ØºÙŠØ± Ù…ØªÙˆÙØ±"
            
            # â­ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ³Ø§Ù…
            try:
                setup_data = result.get('setup')
                badge_text, badge_score = calculate_badge(setup_data) if setup_data is not None else ("", 0)
            except:
                badge_text, badge_score = "", 0
            
            try:
                msg = (
                    f"ğŸªœ *ÙØ±ØµØ© Ø§Ù„Ø³Ù„Ù… Ø§Ù„ØµØ§Ø¹Ø¯* ğŸªœ\n\n"
                    f"ğŸ† Ø§Ù„Ø³Ù‡Ù…: {flag} *{ticker}*\n"
                    f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: *{target_date}*\n"
                    f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: *${price:.4f}*\n"
                    f"ğŸ¯ Ø§Ù„Ù‚Ù…Ø©: *${highest_high:.4f}*\n"
                    f"ğŸ’ª Ø§Ù„Ù‚ÙˆØ©: *{strength}%*\n"
                    f"ğŸª¶ Ø§Ù„ÙÙ„ÙˆØª: *{fmt_shares(float_val)}*{float_desc}\n"
                    f"ğŸ“Š RVOL: *{rvol_text}*\n"
                    f"âš–ï¸ Ø§Ù„Ø­ÙƒÙ…: *{shariah}*\n"
                    f"ğŸ… Ø§Ù„ÙˆØ³Ø§Ù…: *{badge_text}*\n"
                    f"---------------------------\n"
                    f"{order_type}"
                )
                send_telegram(msg)
                print(f"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ {ticker}")
                matches += 1
                
                # Ø­ÙØ¸ Ø§Ù„ÙØ±ØµØ© Ù„Ù„Ù…Ù„Ø®Øµ
                opportunities.append({
                    'ticker': ticker,
                    'flag': flag,
                    'price': price,
                    'float': float_val if float_val else 1,
                    'strength': strength,
                    'is_pending': is_pending,
                    'badge_text': badge_text,
                    'badge_score': badge_score,
                    'shariah': shariah
                })
            except:
                continue  # Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â†’ Ø§Ù„ØªØ§Ù„ÙŠ
        except Exception as e:
            continue
    
    total_time = time_module.time() - start_time
    
    if matches == 0:
        send_telegram(f"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ - {target_date}")
        print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ.")
    else:
        print(f"ğŸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ {matches} ÙØ±Øµ.")
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ
        send_summary(opportunities, target_date)
    
    # ğŸ¯ Ø¥Ø±Ø³Ø§Ù„ ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚ÙŠØ¹Ø§Ù† (Ø±Ø³Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© - ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£Ø³Ù‡Ù…)
    send_bottom_hunter_summary(target_date)
    
    print(f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ÙØ­Øµ ÙØ¹Ù„ÙŠ {len(full_list) - skipped_empty - skipped_wrong_date} Ø³Ù‡Ù…")
    print(f"   - Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª: {skipped_empty}")
    print(f"   - ØªØ§Ø±ÙŠØ® Ø®Ø§Ø·Ø¦: {skipped_wrong_date}")
    print(f"â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ: {total_time:.1f} Ø«Ø§Ù†ÙŠØ©")
    
    return matches

def test_data_sources():
    """Ø§Ø®ØªØ¨Ø§Ø± Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚"""
    
    # Ø£Ø´Ù‡Ø± Ø¹Ø±Ø¨ÙŠØ©
    arabic_months = {
        1: "ÙŠÙ†Ø§ÙŠØ±", 2: "ÙØ¨Ø±Ø§ÙŠØ±", 3: "Ù…Ø§Ø±Ø³", 4: "Ø£Ø¨Ø±ÙŠÙ„",
        5: "Ù…Ø§ÙŠÙˆ", 6: "ÙŠÙˆÙ†ÙŠÙˆ", 7: "ÙŠÙˆÙ„ÙŠÙˆ", 8: "Ø£ØºØ³Ø·Ø³",
        9: "Ø³Ø¨ØªÙ…Ø¨Ø±", 10: "Ø£ÙƒØªÙˆØ¨Ø±", 11: "Ù†ÙˆÙÙ…Ø¨Ø±", 12: "Ø¯ÙŠØ³Ù…Ø¨Ø±"
    }
    
    now = datetime.now()
    date_ar = f"{now.day} {arabic_months[now.month]} {now.year}"
    
    print("\nğŸš€ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ù†Ø¨Ø¯Ø£ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯\n")
    print("ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ø±...\n")
    
    errors = []
    
    # 1. Ø§Ø®ØªØ¨Ø§Ø± FMP
    fmp_ok = False
    try:
        url = f"https://financialmodelingprep.com/stable/historical-chart/5min?symbol=AAPL&apikey={API_KEY}"
        r = requests.get(url, timeout=10)
        if r.status_code == 200 and r.json():
            fmp_ok = True
            print("ğŸ“Š FMP: âœ…")
        else:
            print("ğŸ“Š FMP: âŒ")
            errors.append("FMP Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨")
    except Exception as e:
        print(f"ğŸ“Š FMP: âŒ ({str(e)[:30]})")
        errors.append(f"FMP: {str(e)[:30]}")
    
    # 2. Ø§Ø®ØªØ¨Ø§Ø± Yahoo Finance
    yahoo_ok = False
    try:
        url = "https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?scrIds=most_actives&count=10"
        headers = {'User-Agent': 'Mozilla/5.0'}
        r = requests.get(url, headers=headers, timeout=10)
        if r.status_code == 200:
            data = r.json()
            if 'finance' in data:
                yahoo_ok = True
                print("ğŸ“ˆ Yahoo: âœ…")
            else:
                print("ğŸ“ˆ Yahoo: âŒ")
                errors.append("Yahoo Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©")
        else:
            print("ğŸ“ˆ Yahoo: âŒ")
            errors.append(f"Yahoo status {r.status_code}")
    except Exception as e:
        print(f"ğŸ“ˆ Yahoo: âŒ ({str(e)[:30]})")
        errors.append(f"Yahoo: {str(e)[:30]}")
    
    fmp_status = "âœ…" if fmp_ok else "âŒ"
    yahoo_status = "âœ…" if yahoo_ok else "âŒ"
    
    # 3. Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    print("")
    indices_lines = []
    green_count = 0
    
    indices = [
        ('^IXIC', 'NASDAQ'),
        ('^GSPC', 'S&P 500'),
        ('^DJI', 'Dow Jones')
    ]
    
    for symbol, name in indices:
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info
            change_pct = info.get('regularMarketChangePercent', 0)
            if change_pct is None:
                change_pct = 0
            
            if change_pct >= 0:
                green_count += 1
                color = "ğŸŸ¢"
                sign = "+"
            else:
                color = "ğŸ”´"
                sign = ""
            
            line = f"   {color} {sign}{change_pct:.2f}% {name}"
            indices_lines.append(line)
            print(line)
        except:
            indices_lines.append(f"   âšª -- {name}")
            print(f"   âšª -- {name}")
    
    # ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚
    if green_count >= 2:
        market_status = "ğŸ’š Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡"
    else:
        market_status = "â¤ï¸ Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡"
    
    print(f"\n{market_status}")
    
    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    msg = f"""ğŸš€ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ù†Ø¨Ø¯Ø£ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯
ğŸ“… {date_ar}

ğŸ”§ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ø±:
   ğŸ“Š FMP {fmp_status} | ğŸ“ˆ Yahoo {yahoo_status}

ğŸ“Š ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯ÙŠØ©:
{chr(10).join(indices_lines)}

{market_status}

â° Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø³Ø§Ø¹Ø© 10:03"""
    
    # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    send_telegram(msg)
    
    return fmp_ok and yahoo_ok

def main():
    ny_tz = pytz.timezone('America/New_York')
    
    print("ğŸ›¡ï¸ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ Ø¬Ø§Ù‡Ø²...")
    print("=" * 50)
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆØ¶Ø¹
    target_date, should_wait, message = get_trading_date_and_mode()
    print(message)
    
    if not should_wait:
        # Ù„Ø§ Ø§Ù†ØªØ¸Ø§Ø± â†’ Ù†Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©
        run_scan(target_date)
    else:
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        test_data_sources()
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ 10:03
        print("\nâ³ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...")
        
        while True:
            now_ny = datetime.now(ny_tz)
            scan_time = time(10, 3)
            
            # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙˆØµÙ„Ù†Ø§ Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if now_ny.date() == target_date and now_ny.time() >= scan_time:
                run_scan(target_date)
                break
            
            # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            if now_ny.time() < scan_time:
                remaining = datetime.combine(now_ny.date(), scan_time) - datetime.combine(now_ny.date(), now_ny.time())
                mins = remaining.seconds // 60
                secs = remaining.seconds % 60
                print(f"â³ {now_ny.strftime('%H:%M:%S')} NY - Ù…ØªØ¨Ù‚ÙŠ {mins}:{secs:02d}", end='\r')
            else:
                print(f"â³ {now_ny.strftime('%H:%M:%S')} NY - Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ...", end='\r')
            
            tm.sleep(10)

if __name__ == "__main__":
    main()
