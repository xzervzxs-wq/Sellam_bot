<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>أستوديو القرآن (النسخة الاحترافية)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@400;700&family=El+Messiri:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@400;700&family=Lalezar&family=Mada:wght@400;700&family=Reem+Kufi:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #334155; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #startup-overlay, #export-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        #export-overlay { background: rgba(0,0,0,0.95); z-index: 100000; display: none; }
        
        .spinner { width: 50px; height: 50px; border: 5px solid #334155; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .preview-area {
            background-color: #e2e8f0;
            background-image: linear-gradient(45deg, #cbd5e1 25%, transparent 25%), linear-gradient(-45deg, #cbd5e1 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #cbd5e1 75%), linear-gradient(-45deg, transparent 75%, #cbd5e1 75%);
            background-size: 20px 20px;
            border-radius: 20px; min-height: 350px; display: flex; justify-content: center; align-items: center;
            overflow: auto; border: 2px solid white; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); padding: 20px;
        }

        #card {
            background-color: white; 
            position: relative; 
            border: 2px dashed #64748b;
            box-shadow: 0 0 0 100vmax rgba(203, 213, 225, 0.7); 
            overflow: hidden; margin: auto; direction: rtl; 
            width: 378px; height: 265px; /* 10x7 cm */
            transition: border-color 0.3s;
        }

        .draggable-el { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: move; touch-action: none; transition: transform 0.1s; }
        
        /* حالة القفل */
        .draggable-el.is-locked { cursor: not-allowed; opacity: 0.9; }
        .draggable-el.is-locked::after {
            content: '\f023'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: rgba(239, 68, 68, 0.8); font-size: 24px; pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 999;
        }

        .image-layer { z-index: 5; width: 100%; height: 100%; } 
        .image-layer img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        /* التدرج بدون حدود */
        .gradient-layer { z-index: 10; width: 100%; height: 50%; background: linear-gradient(to top, black, transparent); border: none !important; outline: none !important; }
        
        .frame-layer { z-index: 20; width: 90%; height: 90%; background: transparent; border-style: solid; pointer-events: none; }
        .text-layer { z-index: 30; width: auto; min-width: 100px; text-align: center; padding: 5px; border: 1px solid transparent; }

        .draggable-el.selected { border: 2px dashed #10b981; }
        /* عند التحديد، نخفي أيقونة القفل لعدم التشويش (رغم أنه لا يمكن تحديده وهو مقفل) */
        .draggable-el.selected.is-locked { border-color: #ef4444; } 

        .frame-layer.selected { border-style: dashed !important; border-color: #10b981 !important; }

        .ayah-text { line-height: 1.7; display: block; word-wrap: break-word; pointer-events: none; font-variant-ligatures: normal; text-rendering: optimizeLegibility; }
        .extra-text { outline: none; background: transparent; border: none; text-align: center; width: 100%; resize: none; overflow: hidden; }

        .handle { position: absolute; background: white; border: 2px solid #10b981; display: none; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .resize-handle { bottom: -8px; left: -8px; cursor: nwse-resize; width: 16px; height: 16px; border-radius: 50%; background: #10b981; }
        .width-handle { top: 50%; right: -8px; transform: translateY(-50%); cursor: ew-resize; width: 10px; height: 24px; border-radius: 4px; }
        .height-handle { bottom: -8px; left: 50%; transform: translateX(-50%); cursor: ns-resize; width: 24px; height: 10px; border-radius: 4px; }
        
        .delete-btn { position: absolute; top: -14px; left: -14px; width: 28px; height: 28px; background: #ef4444; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; border: 2px solid white; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .draggable-el.selected .handle, .draggable-el.selected .delete-btn { display: block; }
        .frame-layer { pointer-events: auto; }

        #save-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100000; align-items: center; justify-content: center; flex-direction: column; }
        #save-img { max-width: 90%; max-height: 70vh; border: 2px solid white; box-shadow: 0 10px 50px black; }
        #hidden-font-loader { opacity: 0; pointer-events: none; position: absolute; }
    </style>
</head>
<body class="p-4 min-h-screen bg-slate-100" onclick="deselect(event)">

    <div id="hidden-font-loader">
        <span style="font-family: 'Amiri', serif;">.</span>
        <span style="font-family: 'Cairo', sans-serif;">.</span>
        <span style="font-family: 'Aref Ruqaa', serif;">.</span>
        <span style="font-family: 'El Messiri', sans-serif;">.</span>
        <span style="font-family: 'Lalezar', cursive;">.</span>
        <span style="font-family: 'Mada', sans-serif;">.</span>
        <span style="font-family: 'Almarai', sans-serif;">.</span>
    </div>

    <div id="startup-overlay"><div class="spinner mb-4"></div><div class="text-white font-bold">جاري التجهيز...</div></div>
    <div id="export-overlay"><div class="spinner mb-4"></div><div class="text-white font-bold text-xl">جاري التصدير...</div></div>
    <div id="save-modal">
        <div class="text-white font-bold mb-4 text-center">✨ تم التصدير<br><span class="text-xs text-gray-400">اضغط مطولاً للحفظ</span></div>
        <img id="save-img">
        <button onclick="document.getElementById('save-modal').style.display='none'" class="mt-8 bg-white text-black px-10 py-3 rounded-full font-bold">إغلاق</button>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
        
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 lg:col-span-4 lg:col-start-1 lg:row-start-1" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 border-b pb-4 mb-4">
                <div class="w-10 h-10 bg-emerald-900 rounded-xl flex items-center justify-center text-white"><i class="fas fa-quran"></i></div>
                <div>
                    <h1 class="text-lg font-black text-slate-800">أستوديو القرآن</h1>
                    <p class="text-[10px] text-emerald-600 font-bold">V 3.0 Pro</p>
                </div>
            </div>

            <div class="space-y-3 mb-4">
                <div class="flex gap-2">
                    <select id="surah-select" onchange="loadAyahs()" class="flex-1 p-2 bg-emerald-50 rounded-lg text-xs font-bold outline-none focus:ring-1 focus:ring-emerald-500"><option>السورة...</option></select>
                </div>
                <div class="flex gap-2">
                    <select id="ayah-select" class="flex-[2] p-2 bg-emerald-50 rounded-lg text-xs font-bold outline-none focus:ring-1 focus:ring-emerald-500"><option>الآية...</option></select>
                    <button onclick="addAyah()" class="bg-emerald-600 text-white w-10 rounded-lg hover:bg-emerald-700 flex items-center justify-center" title="إضافة الآية"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2">
                <button onclick="addFrame()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg hover:border-emerald-500 hover:text-emerald-600 text-[10px] font-bold flex flex-col items-center gap-1">
                    <i class="far fa-square text-sm"></i> إطار
                </button>
                <button onclick="addShape()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg hover:border-emerald-500 hover:text-emerald-600 text-[10px] font-bold flex flex-col items-center gap-1">
                    <i class="fas fa-square-full text-sm"></i> مربع
                </button>
                <button onclick="addGradientLayer()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg hover:border-emerald-500 hover:text-emerald-600 text-[10px] font-bold flex flex-col items-center gap-1">
                    <i class="fas fa-adjust text-sm"></i> تدرج
                </button>
                <button onclick="addExtraText()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg hover:border-emerald-500 hover:text-emerald-600 text-[10px] font-bold flex flex-col items-center gap-1">
                    <i class="fas fa-font text-sm"></i> نص
                </button>
                <label class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg hover:border-emerald-500 hover:text-emerald-600 text-[10px] font-bold flex flex-col items-center gap-1 cursor-pointer">
                    <i class="far fa-image text-sm"></i> خلفية
                    <input type="file" onchange="addImageLayer(this)" class="hidden" accept="image/*">
                </label>
            </div>
            
            <div class="mt-4 p-2 bg-yellow-50 rounded text-[10px] text-yellow-700 text-center font-bold border border-yellow-200">
                <i class="fas fa-mouse-pointer"></i> اضغط مرتين (Double Click) لقفل/فتح أي طبقة
            </div>
        </div>

        <div class="lg:col-span-8 lg:col-start-5 lg:row-start-1 lg:row-span-2">
            <div class="preview-area w-full bg-white rounded-3xl border border-slate-200" onclick="event.stopPropagation()">
                <div id="card" onclick="deselect(event)">
                    </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-200 lg:col-span-4 lg:col-start-1 lg:row-start-2 space-y-5" onclick="event.stopPropagation()">
            
            <div id="style-panel" class="transition-all opacity-50 pointer-events-none">
                <div class="flex justify-between items-center mb-3">
                     <label class="text-xs font-black text-slate-700 uppercase">الخصائص</label>
                     <span id="el-type" class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-400">--</span>
                </div>

                <div id="text-controls" class="space-y-3 hidden">
                    <div class="flex gap-2">
                        <select id="font-family" onchange="updateStyle('fontFamily', this.value)" class="flex-1 p-2 bg-slate-50 rounded-lg text-xs font-bold border-none outline-none">
                            <option value="'Amiri', serif">خط أميري (نسخ)</option>
                            <option value="'Aref Ruqaa', serif">خط رقعة</option>
                            <option value="'Cairo', sans-serif">كايرو (حديث)</option>
                            <option value="'Tajawal', sans-serif">تجوال</option>
                            <option value="'Reem Kufi', sans-serif">ريم (كوفي)</option>
                            <option value="'El Messiri', sans-serif">المسيري</option>
                            <option value="'Lalezar', cursive">لاليزار (عريض)</option>
                            <option value="'Mada', sans-serif">مدى</option>
                            <option value="'Almarai', sans-serif">المراعي</option>
                            <option value="'IBM Plex Sans Arabic', sans-serif">IBM Plex</option>
                        </select>
                        <input type="color" id="text-color" oninput="updateStyle('color', this.value)" class="w-8 h-8 rounded cursor-pointer border p-0.5">
                    </div>
                    <div>
                        <span class="text-[10px] font-bold text-slate-400 block mb-1">الحجم</span>
                        <input type="range" id="font-size" min="10" max="150" value="35" oninput="updateStyle('fontSize', this.value + 'px')" class="w-full h-1.5 bg-slate-200 rounded-lg accent-emerald-600">
                    </div>
                </div>

                <div id="frame-controls" class="space-y-3 hidden">
                    <div class="flex gap-2 items-center">
                         <div class="flex flex-col items-center">
                            <span class="text-[8px] font-bold text-slate-400">حدود</span>
                            <input type="color" id="border-color" oninput="updateStyle('borderColor', this.value)" class="w-8 h-8 rounded cursor-pointer border p-0.5">
                         </div>
                         <div class="flex flex-col items-center">
                            <span class="text-[8px] font-bold text-slate-400">تعبئة</span>
                            <input type="color" id="bg-color" value="#ffffff" oninput="updateStyle('backgroundColor', this.value)" class="w-8 h-8 rounded cursor-pointer border p-0.5">
                         </div>
                         <div class="flex-grow flex flex-col justify-center">
                             <span class="text-[9px] font-bold text-slate-400 mb-1">سُمك الإطار</span>
                             <input type="range" id="border-width" min="0" max="15" value="1" oninput="updateStyle('borderWidth', this.value + 'px')" class="w-full h-1.5 bg-slate-200 rounded-lg accent-emerald-600">
                         </div>
                    </div>
                </div>

                 <div id="grad-controls" class="space-y-3 hidden">
                    <div class="flex gap-2 mb-2">
                        <button onclick="updateGradientType('white')" class="flex-1 py-1 text-[10px] border rounded font-bold hover:bg-slate-50">أبيض</button>
                        <button onclick="updateGradientType('black')" class="flex-1 py-1 text-[10px] border bg-slate-800 text-white rounded font-bold">أسود</button>
                    </div>
                    <input type="range" id="grad-opacity" min="0" max="1" step="0.05" oninput="updateGradientOpacity(this.value)" class="w-full h-1.5 bg-slate-200 rounded-lg accent-emerald-600">
                </div>
            </div>

            <div class="border-t pt-4 space-y-4">
                <div class="flex gap-2 items-center justify-center bg-slate-50 p-2 rounded-xl">
                    <input type="number" id="w-cm" value="10" step="0.5" class="w-12 text-center p-1 rounded bg-white text-xs font-bold" oninput="resizeCard()">
                    <span class="text-slate-400 text-xs">×</span>
                    <input type="number" id="h-cm" value="7" step="0.5" class="w-12 text-center p-1 rounded bg-white text-xs font-bold" oninput="resizeCard()">
                    <span class="text-[10px] text-slate-400">سم</span>
                </div>

                <button id="bg-toggle-btn" onclick="toggleBackground()" class="w-full bg-slate-200 text-slate-700 font-bold py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-eye"></i> خلفية بيضاء
                </button>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportCard()" class="bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-black transition flex items-center justify-center gap-2 text-sm">
                        <i class="fas fa-file-export text-emerald-400"></i> Clean
                    </button>
                    <button onclick="exportA4()" class="bg-blue-900 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-950 transition flex items-center justify-center gap-2 text-sm">
                        <i class="fas fa-copy text-blue-300"></i> A4
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const CM_PX = 37.8; 
        let activeEl = null;
        let currentSurah = "";
        let isBackgroundTransparent = false;

        window.onload = async () => {
            await document.fonts.ready;
            setTimeout(() => {
                document.getElementById('startup-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('startup-overlay').remove(), 500);
            }, 800);
            resizeCard();
            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                const sel = document.getElementById('surah-select');
                sel.innerHTML = '<option value="">السورة...</option>';
                data.data.forEach(s => sel.innerHTML += `<option value="${s.number}">${s.number}. ${s.name}</option>`);
            } catch(e) {}
        };

        async function loadAyahs() {
            const num = document.getElementById('surah-select').value;
            if(!num) return;
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}`);
            const data = await res.json();
            currentSurah = data.data.name;
            const sel = document.getElementById('ayah-select');
            sel.innerHTML = '<option value="">الآية...</option>';
            data.data.ayahs.forEach(a => sel.innerHTML += `<option value="${a.numberInSurah}" data-text="${a.text}">آية ${a.numberInSurah}</option>`);
        }

        // --- إضافة العناصر ---
        function addAyah() {
            const sel = document.getElementById('ayah-select');
            if(!sel.value) return;
            const text = sel.options[sel.selectedIndex].getAttribute('data-text');
            const div = createEl('text-layer');
            div.style.color = '#334155';
            div.style.fontSize = '30px';
            div.style.fontFamily = "'Amiri', serif";
            div.innerHTML = `<span class="ayah-text">${text} ﴿${sel.value}﴾</span>${getHandles(true, true)}`;
            document.getElementById('card').appendChild(div);
            selectEl(div);
            initInteract(div, 'text');
        }

        function addExtraText() {
            const div = createEl('text-layer');
            div.style.color = '#334155';
            div.style.fontSize = '24px';
            div.style.fontFamily = "'Cairo', sans-serif";
            // استخدام contenteditable لتسهيل الكتابة
            div.innerHTML = `<div contenteditable="true" class="extra-text" onblur="if(this.innerText.trim()==='') this.innerText='نص إضافي';">نص إضافي</div>${getHandles(true, true)}`;
            document.getElementById('card').appendChild(div);
            selectEl(div);
            initInteract(div, 'text');
        }

        function addFrame() {
            const div = createEl('frame-layer');
            div.style.borderColor = '#334155';
            div.style.borderWidth = '1px';
            div.innerHTML = getHandles(true, true);
            document.getElementById('card').appendChild(div);
            selectEl(div);
            initInteract(div, 'box');
        }

        function addShape() {
            const div = createEl('frame-layer');
            div.style.backgroundColor = '#334155';
            div.style.borderWidth = '0px';
            div.innerHTML = getHandles(true, true);
            document.getElementById('card').appendChild(div);
            selectEl(div);
            initInteract(div, 'box');
        }

        function addGradientLayer() {
            const div = createEl('gradient-layer');
            div.dataset.color = 'black'; 
            div.style.opacity = '0.8';
            div.innerHTML = getHandles(true, true);
            document.getElementById('card').appendChild(div);
            selectEl(div);
            initInteract(div, 'grad');
        }

        function addImageLayer(input) {
            if(!input.files[0]) return;
            const div = createEl('image-layer');
            div.innerHTML = `<img src="${URL.createObjectURL(input.files[0])}"> ${getHandles(true, true)}`;
            const card = document.getElementById('card');
            card.insertBefore(div, card.firstChild);
            selectEl(div);
            initInteract(div, 'box');
            input.value = '';
        }

        function createEl(cls) {
            const div = document.createElement('div');
            div.className = `draggable-el ${cls} selected`;
            div.style.direction = 'rtl';
            
            // خاصية القفل (Double Click)
            div.ondblclick = function(e) {
                e.stopPropagation();
                if(this.classList.contains('is-locked')) {
                    this.classList.remove('is-locked');
                    // flash effect
                    this.style.filter = 'brightness(1.2)';
                    setTimeout(()=>this.style.filter='', 200);
                } else {
                    this.classList.add('is-locked');
                    deselect(e);
                }
            };

            return div;
        }

        function getHandles(w, h) {
            return `<div class="handle resize-handle"></div>${w ? '<div class="handle width-handle"></div>' : ''}${h ? '<div class="handle height-handle"></div>' : ''}<div class="delete-btn" onclick="this.parentElement.remove(); deselect(event)"><i class="fas fa-times"></i></div>`;
        }

        function initInteract(el, type) {
            el.onmousedown = el.ontouchstart = function(e) {
                // إذا كان مقفل، امنع التحريك والتحديد
                if(el.classList.contains('is-locked')) {
                    e.stopPropagation();
                    return; 
                }

                // السماح بالكتابة داخل النص الإضافي
                if(e.target.getAttribute('contenteditable') === 'true') {
                    return;
                }

                if(e.target.classList.contains('handle') || e.target.classList.contains('delete-btn')) return;
                e.preventDefault(); selectEl(el);
                const startX = (e.touches ? e.touches[0].clientX : e.clientX) - el.offsetLeft;
                const startY = (e.touches ? e.touches[0].clientY : e.clientY) - el.offsetTop;
                const move = (ev) => {
                    const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    el.style.left = (cx - startX) + 'px';
                    el.style.top = (cy - startY) + 'px';
                };
                stopEvents(move);
            };

            const wHandle = el.querySelector('.width-handle');
            if(wHandle) {
                wHandle.onmousedown = wHandle.ontouchstart = function(e) {
                    if(el.classList.contains('is-locked')) return;
                    e.stopPropagation(); e.preventDefault();
                    const startX = e.touches ? e.touches[0].clientX : e.clientX;
                    const startW = parseInt(getComputedStyle(el).width);
                    const move = (ev) => {
                        const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                        el.style.width = Math.max(30, startW + (cx - startX)*2) + 'px';
                    };
                    stopEvents(move);
                };
            }

            const hHandle = el.querySelector('.height-handle');
            if(hHandle) {
                hHandle.onmousedown = hHandle.ontouchstart = function(e) {
                    if(el.classList.contains('is-locked')) return;
                    e.stopPropagation(); e.preventDefault();
                    const startY = e.touches ? e.touches[0].clientY : e.clientY;
                    if(type === 'text') {
                        const startSize = parseInt(el.style.fontSize);
                        const move = (ev) => {
                            const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                            const newSize = Math.max(10, startSize + (cy - startY));
                            el.style.fontSize = newSize + 'px';
                            if(activeEl === el) document.getElementById('font-size').value = newSize;
                        };
                        stopEvents(move);
                    } else {
                        const startH = parseInt(getComputedStyle(el).height);
                        const move = (ev) => {
                            const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                            el.style.height = Math.max(20, startH + (cy - startY)) + 'px';
                        };
                        stopEvents(move);
                    }
                };
            }

            const rHandle = el.querySelector('.resize-handle');
            if(rHandle) {
                rHandle.onmousedown = rHandle.ontouchstart = function(e) {
                    if(el.classList.contains('is-locked')) return;
                    e.stopPropagation(); e.preventDefault();
                    const startX = e.touches ? e.touches[0].clientX : e.clientX;
                    if(type === 'text') {
                         const startSize = parseInt(el.style.fontSize);
                         const move = (ev) => {
                             const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                             const newSize = Math.max(10, startSize + (startX - cx)); 
                             el.style.fontSize = newSize + 'px';
                             if(activeEl === el) document.getElementById('font-size').value = newSize;
                         };
                         stopEvents(move);
                    } else {
                        const startW = parseInt(getComputedStyle(el).width);
                        const startH = parseInt(getComputedStyle(el).height);
                        const move = (ev) => {
                            const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                            const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                            el.style.width = Math.max(30, startW - (cx - startX)) + 'px';
                            el.style.height = Math.max(30, startH + (cy - startY)) + 'px';
                        };
                        stopEvents(move);
                    }
                };
            }
        }

        function stopEvents(moveFn) {
            const stop = () => {
                window.removeEventListener('mousemove', moveFn); window.removeEventListener('touchmove', moveFn);
                window.removeEventListener('mouseup', stop); window.removeEventListener('touchend', stop);
            };
            window.addEventListener('mousemove', moveFn); window.addEventListener('touchmove', moveFn);
            window.addEventListener('mouseup', stop); window.addEventListener('touchend', stop);
        }

        function selectEl(el) {
            if(activeEl) { activeEl.classList.remove('selected'); if(activeEl.classList.contains('frame-layer')) activeEl.style.borderStyle='solid'; }
            
            // لا يمكن تحديد عنصر مقفل
            if(el.classList.contains('is-locked')) return;

            activeEl = el;
            activeEl.classList.add('selected');
            if(el.classList.contains('frame-layer')) el.style.borderStyle='dashed';

            const panel = document.getElementById('style-panel');
            panel.classList.remove('opacity-50', 'pointer-events-none');
            
            ['text', 'frame', 'grad'].forEach(k => document.getElementById(k+'-controls').classList.add('hidden'));
            const label = document.getElementById('el-type');

            if(el.classList.contains('text-layer')) {
                document.getElementById('text-controls').classList.remove('hidden');
                label.innerText = "تحرير النص";
                document.getElementById('text-color').value = rgbToHex(el.style.color);
                document.getElementById('font-size').value = parseInt(el.style.fontSize);
                document.getElementById('font-family').value = el.style.fontFamily.replace(/"/g, "'");
            } else if(el.classList.contains('frame-layer')) {
                document.getElementById('frame-controls').classList.remove('hidden');
                label.innerText = "شكل / إطار";
                document.getElementById('border-color').value = rgbToHex(el.style.borderColor);
                document.getElementById('bg-color').value = rgbToHex(el.style.backgroundColor || 'rgba(0,0,0,0)');
                document.getElementById('border-width').value = parseInt(el.style.borderWidth) || 0;
            } else if(el.classList.contains('gradient-layer')) {
                document.getElementById('grad-controls').classList.remove('hidden');
                label.innerText = "تدرج لوني";
                document.getElementById('grad-opacity').value = el.style.opacity || 0.8;
            } else {
                label.innerText = "صورة";
            }
        }

        function deselect(e) {
            if(e.target.closest('.draggable-el') || e.target.closest('.w-full')) return;
            if(activeEl) { activeEl.classList.remove('selected'); if(activeEl.classList.contains('frame-layer')) activeEl.style.borderStyle='solid'; }
            activeEl = null;
            document.getElementById('style-panel').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('el-type').innerText = "--";
        }

        function updateStyle(prop, val) { if(activeEl) activeEl.style[prop] = val; }

        function updateGradientType(color) {
            if(activeEl && activeEl.classList.contains('gradient-layer')) {
                activeEl.dataset.color = color;
                const end = color === 'white' ? 'white' : 'black';
                const start = color === 'white' ? 'rgba(255,255,255,0)' : 'rgba(0,0,0,0)';
                activeEl.style.background = `linear-gradient(to top, ${end}, ${start})`;
            }
        }
        function updateGradientOpacity(val) { if(activeEl && activeEl.classList.contains('gradient-layer')) activeEl.style.opacity = val; }

        function resizeCard() {
            const w = document.getElementById('w-cm').value; const h = document.getElementById('h-cm').value;
            const c = document.getElementById('card'); c.style.width = (w*CM_PX)+'px'; c.style.height = (h*CM_PX)+'px';
        }

        function toggleBackground() {
            isBackgroundTransparent = !isBackgroundTransparent;
            const card = document.getElementById('card');
            const btn = document.getElementById('bg-toggle-btn');
            
            if(isBackgroundTransparent) {
                card.style.backgroundColor = 'transparent';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> خلفية شفافة';
                btn.classList.add('bg-emerald-100', 'text-emerald-700');
                btn.classList.remove('bg-slate-200', 'text-slate-700');
            } else {
                card.style.backgroundColor = 'white';
                btn.innerHTML = '<i class="fas fa-eye"></i> خلفية بيضاء';
                btn.classList.remove('bg-emerald-100', 'text-emerald-700');
                btn.classList.add('bg-slate-200', 'text-slate-700');
            }
        }

        async function exportCard() {
            if(activeEl) { activeEl.classList.remove('selected'); if(activeEl.classList.contains('frame-layer')) activeEl.style.borderStyle='solid'; }
            document.getElementById('export-overlay').style.display = 'flex';
            await document.fonts.ready;
            
            setTimeout(async () => {
                try {
                    const card = document.getElementById('card');
                    
                    // حفظ الحالة الأصلية
                    const originalBorder = card.style.border;
                    const originalBorderColor = card.style.borderColor;
                    
                    // إخفاء الإطار المنقط
                    card.style.border = 'none';
                    
                    const canvas = await html2canvas(card, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: isBackgroundTransparent ? null : '#ffffff',
                        logging: false,
                        removeContainer: true
                    });
                    
                    // إعادة الإطار
                    card.style.border = originalBorder;
                    
                    const dataUrl = canvas.toDataURL('image/png');
                    document.getElementById('save-img').src = dataUrl;
                    document.getElementById('save-modal').style.display = 'flex';
                } catch(e) { 
                    console.error(e);
                    alert('خطأ في التصدير'); 
                } finally { 
                    document.getElementById('export-overlay').style.display = 'none'; 
                }
            }, 800);
        }

        async function exportA4() {
            if(activeEl) { activeEl.classList.remove('selected'); if(activeEl.classList.contains('frame-layer')) activeEl.style.borderStyle='solid'; }
            document.getElementById('export-overlay').style.display = 'flex';
            await document.fonts.ready;
            
            setTimeout(async () => {
                try {
                    // A4 dimensions: 210mm x 297mm at 96 DPI = 794px x 1123px
                    const A4_WIDTH_MM = 210;
                    const A4_HEIGHT_MM = 297;
                    const DPI = 96;
                    const MM_TO_PX = DPI / 25.4;
                    
                    const a4Width = A4_WIDTH_MM * MM_TO_PX * 2;  // scale 2
                    const a4Height = A4_HEIGHT_MM * MM_TO_PX * 2;
                    
                    // Get card dimensions
                    const card = document.getElementById('card');
                    const cardWidth = card.offsetWidth;
                    const cardHeight = card.offsetHeight;
                    const cutMargin = 4; // مسافة القص البسيطة جداً
                    
                    // Calculate how many cards fit
                    const cardsPerRow = Math.floor(a4Width / (cardWidth * 2 + cutMargin * 2));
                    const cardsPerCol = Math.floor(a4Height / (cardHeight * 2 + cutMargin * 2));
                    
                    // Create A4 canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = a4Width;
                    canvas.height = a4Height;
                    const ctx = canvas.getContext('2d');
                    
                    // White background
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, a4Width, a4Height);
                    
                    // Render card to temporary canvas
                    const originalBorder = card.style.border;
                    card.style.border = 'none';
                    
                    const cardCanvas = await html2canvas(card, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: isBackgroundTransparent ? null : '#ffffff',
                        logging: false
                    });
                    
                    card.style.border = originalBorder;
                    
                    // Draw cards in grid
                    let xPos = cutMargin * 2;
                    let yPos = cutMargin * 2;
                    const scaledWidth = cardWidth * 2;
                    const scaledHeight = cardHeight * 2;
                    
                    for(let row = 0; row < cardsPerCol; row++) {
                        for(let col = 0; col < cardsPerRow; col++) {
                            // Draw light gray border (cutting guide)
                            ctx.strokeStyle = '#d1d5db';
                            ctx.lineWidth = 0.8;
                            ctx.strokeRect(xPos - 1, yPos - 1, scaledWidth + 2, scaledHeight + 2);
                            
                            // Draw card
                            ctx.drawImage(cardCanvas, xPos, yPos, scaledWidth, scaledHeight);
                            
                            xPos += scaledWidth + cutMargin * 2;
                        }
                        xPos = cutMargin * 2;
                        yPos += scaledHeight + cutMargin * 2;
                    }
                    
                    const dataUrl = canvas.toDataURL('image/png');
                    document.getElementById('save-img').src = dataUrl;
                    document.getElementById('save-modal').style.display = 'flex';
                } catch(e) {
                    console.error(e);
                    alert('خطأ في التصدير');
                } finally {
                    document.getElementById('export-overlay').style.display = 'none';
                }
            }, 800);
        }

        function rgbToHex(rgb) {
            if(!rgb) return '#334155'; if(rgb.startsWith('#')) return rgb;
            const sep = rgb.indexOf(",") > -1 ? "," : " ";
            const rgbArr = rgb.substr(4).split(")")[0].split(sep);
            let r = (+rgbArr[0]).toString(16), g = (+rgbArr[1]).toString(16), b = (+rgbArr[2]).toString(16);
            if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b;
            return "#" + r + g + b;
        }
    </script>
</body>
</html>