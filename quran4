<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø£Ø³ØªÙˆØ¯ÙŠÙˆ Ø¯Ù„Ø§Ù„ | Dalal Studio</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø®Ø·ÙˆØ· -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link id="fa-stylesheet" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù…ÙƒØªØ¨Ø© Ù…ÙˆØ³Ø¹Ø© - 20 Ø®Ø·) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Baloo+Bhaijaan+2:wght@400;700&family=Cairo:wght@400;700&family=Changa:wght@400;700&family=Droid+Sans:wght@400;700&family=El+Messiri:wght@400;700&family=Gulzar&family=Harmattan:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@400;700&family=Katibeh&family=Kufam:wght@400;700&family=Lalezar&family=Lateef:wght@400;700&family=Lemonada:wght@400;700&family=Mada:wght@400;700&family=Mirza:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&family=Noto+Serif+Arabic:wght@400;700&family=Rakkas&family=Reem+Kufi:wght@400;700&family=Sakkal+Madina:wght@400;700&family=Scheherazade+New:wght@400;700&family=Tajawal:wght@400;700&family=Vazirmatn:wght@400;700&family=Zain:wght@400;700&display=swap" rel="stylesheet" crossorigin="anonymous">

    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¹ØµØ±ÙŠØ© (Ø«ÙŠÙ… Ø¯Ù„Ø§Ù„) */
        :root {
            --paper-bg: #f8fafc;      /* Slate 50 */
            --paper-dark: #e2e8f0;    /* Slate 200 */
            --primary-color: #6366f1; /* Indigo 500 */
            --primary-hover: #4f46e5; /* Indigo 600 */
            --accent-color: #ec4899;  /* Pink 500 */
            --text-dark: #1e293b;     /* Slate 800 */
            --border-color: #cbd5e1;  /* Slate 300 */
        }

        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© */
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--paper-bg); 
            color: var(--text-dark); 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior: none;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #startup-overlay { 
            position: fixed; inset: 0; 
            background: #1e1b4b; 
            z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.3s; 
        }
        #startup-overlay .spinner {
            width: 50px; height: 50px; 
            border: 5px solid #312e81; 
            border-top-color: var(--primary-color); 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }
        #startup-overlay .loading-text {
            color: white; 
            font-weight: bold; 
            font-family: 'Cairo', sans-serif;
            margin-top: 10px;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØµØ¯ÙŠØ± */
        #export-overlay { 
            position: fixed; inset: 0; 
            background: rgba(30, 27, 75, 0.95); 
            z-index: 100000; 
            display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.3s; 
        }
        #export-overlay .spinner { 
            width: 50px; height: 50px; 
            border: 5px solid rgba(255,255,255,0.1); 
            border-top-color: var(--accent-color); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ */
        .preview-area {
            background-color: white;
            border-radius: 20px; min-height: 400px; display: flex; justify-content: center; align-items: flex-start;
            overflow: auto; 
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            padding: 50px; position: relative; /* increased padding for rulers */
        }

        /* Ø­Ø§ÙˆÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ù…Ø³Ø·Ø±Ø© */
        #card-wrapper {
            position: relative;
            margin: 0 auto 40px auto;
            transform-origin: center top;
            transform: scale(var(--card-zoom, 1));
            transition: transform 0.2s ease;
            display: inline-block;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #card {
            background-color: white; 
            position: relative; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            overflow: hidden; 
            /* Ù‡Ø§Ù…Ø´ ÙˆØªØ­ÙˆÙŠÙ„ ØªÙ… Ù†Ù‚Ù„Ù‡Ù…Ø§ Ù„Ù„ØºÙ„Ø§Ù Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø·Ø±Ø© */
            margin: 0;
            transform: none;
            direction: rtl;
            width: 100%; height: 100%;
            flex-shrink: 0; 
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§Ø·Ø± */
        .ruler {
            position: absolute;
            background-color: #f1f5f9;
            pointer-events: none;
            overflow: visible;
            z-index: 50;
            font-family: sans-serif;
            font-size: 8px;
            color: #64748b;
        }
        .ruler-h {
            top: -20px;
            left: 0;
            right: 0;
            height: 20px;
            border-bottom: 1px solid #cbd5e1;
        }
        .ruler-v {
            top: 0;
            left: -20px;
            bottom: 0;
            width: 20px;
            border-right: 1px solid #cbd5e1;
        }
        .tick {
            position: absolute;
            background-color: #cbd5e1;
        }
        .tick-num {
            position: absolute;
            font-size: 10px; /* ØªÙ… Ø§Ù„ØªÙƒØ¨ÙŠØ± */
            font-weight: 900; /* Ø®Ø· Ø£Ø¹Ø±Ø¶ */
            color: #475569;
        }
        /* Vertical Numbers */
        .ruler-v .tick-num {
            transform: rotate(-90deg);
            transform-origin: center;
        }

        /* Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ */
        #card-gradient {
            position: absolute; 
            bottom: 0; left: 0; right: 0; 
            height: 50%; 
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            z-index: 10; 
            pointer-events: none; 
            display: none;
        }

        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ */
        .draggable-el { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            cursor: grab; touch-action: none; 
            border: 1px solid transparent;
        }
        .draggable-el:active { cursor: grabbing; }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„ */
        .draggable-el.is-locked { cursor: default; }

        /* Ø·Ø¨Ù‚Ø§Øª Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¥Ø·Ø§Ø±Ø§Øª */
        .image-layer { z-index: 5; }
        .image-layer.bg-image { width: 100% !important; height: 100% !important; top: 0 !important; left: 0 !important; transform: none !important; }
        .image-layer img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        .frame-layer { z-index: 20; width: 80%; height: 80%; background: transparent; border-style: solid; border-width: 2px; border-color: #334155; pointer-events: auto; box-shadow: 0 0 0 3px transparent; transition: box-shadow 0.2s; }
        
        /* Ø§Ù„Ù†ØµÙˆØµ */
        .text-layer { z-index: 30; width: auto; min-width: 100px; text-align: center; padding: 5px; }
        .user-text { 
            line-height: 1.6; display: block; white-space: pre-wrap; outline: none; 
            background: transparent; border: none; text-align: center; width: 100%; 
            resize: none; overflow: visible; 
            user-select: text !important;
            -webkit-user-select: text !important;
            cursor: text;
            touch-action: auto !important; 
            pointer-events: auto;
        }
        
        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù…Ù‚Ø§Ø¨Ø¶) */
        .draggable-el.selected { border: 1px dashed var(--primary-color); z-index: 100; }
        .draggable-el.selected.is-locked { border-color: #ef4444; border-style: dotted; }
        
        .handle { position: absolute; background: white; border: 2px solid var(--primary-color); width: 18px; height: 18px; border-radius: 50%; z-index: 101; display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .draggable-el.selected .handle { display: block; }
        
        /* Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ø¶ */
        .resize-nw { top: -9px; left: -9px; cursor: nw-resize; }
        .resize-ne { top: -9px; right: -9px; cursor: ne-resize; }
        .resize-sw { bottom: -9px; left: -9px; cursor: sw-resize; }
        .resize-se { bottom: -9px; right: -9px; cursor: se-resize; }
        .resize-n { top: -9px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-e { top: 50%; right: -9px; transform: translateY(-50%); cursor: e-resize; }
        .resize-s { bottom: -9px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        
        .control-btn { position: absolute; width: 28px; height: 28px; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 102; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .delete-btn { top: -40px; left: -14px; background: #ef4444; }
        .move-handle { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); width: 50px; height: 32px; background: var(--primary-color); border-radius: 6px; cursor: move; display: none; align-items: center; justify-content: center; z-index: 102; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .draggable-el.selected .control-btn, .draggable-el.selected .move-handle { display: flex; }
        .draggable-el.is-locked .control-btn, .draggable-el.is-locked .handle, .draggable-el.is-locked .move-handle { display: none !important; }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø­ÙØ¸ */
        #save-modal { display: none; position: fixed; inset: 0; background: rgba(30, 27, 75, 0.95); z-index: 100000; align-items: center; justify-content: center; flex-direction: column; padding: 20px; overflow-y: auto; }
        #save-img { max-width: 100%; max-height: 50vh; border: none; border-radius: 0; box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin-bottom: 20px; }
        
        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„Ø£ØµÙˆÙ„ (Assets) */
        #asset-window {
            position: fixed;
            top: 20%; left: 20%;
            width: 250px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #cbd5e1;
            z-index: 5000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #asset-header {
            background: #1e293b;
            color: white;
            padding: 10px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        #asset-content {
            padding: 10px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .asset-item {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
        }
        .asset-item:hover {
            border-color: #6366f1;
            transform: scale(1.05);
        }
        .asset-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .asset-item-text {
            font-size: 10px;
            color: #1e293b;
            text-align: center;
            padding: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø®ÙÙŠ */
        #hidden-font-loader { opacity: 0; pointer-events: none; position: absolute; top: -9999px; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--paper-bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±Ù†Ø© */
        .controls-row {
            width: 100%;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border-color);
            display: none; 
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            order: 99; 
        }
        .controls-row.active { display: flex; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        input[type="number"], input[type="text"], textarea, select {
            transition: all 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body class="min-h-screen" onclick="deselect(event)">

    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· -->
    <div id="hidden-font-loader">
        <span style="font-family: 'Amiri', serif;">Ø£</span>
        <!-- ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®Ø·ÙˆØ·) ... -->
        <span style="font-family: 'Tajawal', sans-serif;">Ø£</span>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
    <div id="startup-overlay">
        <div class="spinner mb-4"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø£Ø³ØªÙˆØ¯ÙŠÙˆ Ø¯Ù„Ø§Ù„...</div>
    </div>
    
    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© -->
    <div id="asset-window">
        <div id="asset-header">
            <span>ğŸ¨ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ù„Ø¨</span>
            <button onclick="document.getElementById('asset-window').style.display='none'" class="text-white hover:text-red-400"><i class="fas fa-times"></i></button>
        </div>
        <div id="asset-content">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§ -->
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <div id="export-overlay"><div class="spinner mb-4"></div><div class="text-white font-bold text-xl">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©...</div></div>
    
    <div id="save-modal">
        <div class="text-white font-bold mb-4 text-center text-xl">âœ¨ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø·Ø¨Ø§Ø¹Ø© A4</div>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® -->
        <div id="a4-settings" class="flex items-center gap-3 mb-4 bg-white/10 p-3 rounded-xl border border-white/20">
            <label class="text-white text-sm font-bold"><i class="fas fa-copy ml-1"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®:</label>
            <input type="text" inputmode="numeric" id="a4-count" class="w-20 p-2 rounded-lg text-center text-lg font-bold text-[#1e293b] outline-none border-2 border-transparent focus:border-[#ec4899] transition" oninput="this.value = arabicToEnglish(this.value); updateA4Count()" min="1">
            <span class="text-slate-300 text-xs font-bold" id="a4-max-text"></span>
        </div>

        <div class="flex flex-col items-center w-full max-w-2xl">
            <img id="save-img" alt="ØªØµÙ…ÙŠÙ… Ø¯Ù„Ø§Ù„">
            <div class="flex flex-wrap gap-3 justify-center w-full mt-4">
                <button onclick="downloadImage()" class="bg-[#6366f1] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#4f46e5] transition flex items-center gap-2 shadow-lg">
                    <i class="fas fa-image"></i> Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© (PNG)
                </button>
                <button onclick="downloadPDF()" class="bg-[#ef4444] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#dc2626] transition flex items-center gap-2 shadow-lg">
                    <i class="fas fa-file-pdf"></i> Ø­ÙØ¸ ÙƒÙ…Ù„Ù (PDF)
                </button>
                <button onclick="sendToTelegramPDF(this)" class="bg-[#0088cc] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#0077b5] transition flex items-center gap-2 shadow-lg">
                    <i class="fab fa-telegram-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                </button>
                <!-- ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… -->
                <button id="btn-modal-a4" onclick="generateA4Sheet()" class="bg-[#ec4899] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#db2777] transition flex items-center gap-2 shadow-lg hidden">
                    <i class="fas fa-print"></i> Ø­ÙØ¸ ÙƒØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© (A4)
                </button>
                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø·Ø¨Ø§Ø¹Ø© ØµØºÙŠØ±Ø© Ù…Ø³ØªÙ‚Ù„Ø© -->
                <button onclick="printDesignDirect()" class="bg-[#6366f1] text-white p-3 rounded-lg hover:bg-[#4f46e5] transition shadow-lg" title="Ø·Ø¨Ø§Ø¹Ø©">
                    <i class="fas fa-print text-xl"></i>
                </button>
                <button onclick="document.getElementById('save-modal').style.display='none'" class="bg-white text-[#1e293b] px-6 py-3 rounded-xl font-bold hover:bg-slate-100 transition flex items-center gap-2">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
            <p class="text-slate-400 text-xs mt-4 text-center max-w-md leading-relaxed">
                ÙŠØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØµØ§Ù…ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±Ø§Ù‹.
            </p>
        </div>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 h-screen-lg">
        
        <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
        <div class="lg:col-span-4 bg-white p-5 rounded-2xl shadow-md border border-[#cbd5e1] flex flex-col gap-4 h-fit" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 border-b border-[#e2e8f0] pb-3">
                <div class="w-10 h-10 bg-[#6366f1] rounded-xl flex items-center justify-center text-white shadow-md transform rotate-3"><i class="fas fa-palette text-lg"></i></div>
                <div>
                    <h1 class="font-bold text-[#1e293b] text-xl">Ø£Ø³ØªÙˆØ¯ÙŠÙˆ Ø¯Ù„Ø§Ù„</h1>
                    <p class="text-[12px] text-[#6366f1] font-bold">Pro âœ¨ Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
                </div>
            </div>

            <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ -->
            <div class="space-y-2 bg-[#f8fafc] p-3 rounded-xl border border-[#e2e8f0]">
                <label class="text-xs font-bold text-[#1e293b]">Ø¥Ø¶Ø§ÙØ© Ù†ØµÙˆØµ</label>
                <div class="flex flex-col gap-2">
                    <textarea id="user-text-input" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..." class="w-full p-2 bg-white border border-[#cbd5e1] rounded-lg text-sm outline-none focus:border-[#6366f1] text-[#1e293b] resize-none"></textarea>
                    <button onclick="addUserText()" class="bg-[#6366f1] text-white px-4 py-2 rounded-lg hover:bg-[#4f46e5] flex items-center justify-center border border-[#6366f1] text-sm font-bold shadow-sm w-full">
                        <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ
                    </button>
                </div>
            </div>

            <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
            <div class="grid grid-cols-3 gap-2">
                <label class="col-span-2 bg-white border border-dashed border-[#6366f1] py-3 rounded-lg text-[#1e293b] hover:bg-[#f8fafc] text-xs font-bold flex items-center justify-center gap-2 cursor-pointer transition group">
                    <i class="far fa-image text-lg text-[#6366f1] group-hover:scale-110 transition-transform"></i> Ø®Ù„ÙÙŠØ©
                    <input type="file" onchange="addImageLayer(this)" class="hidden" accept="image/*">
                </label>
                <label class="bg-white border border-dashed border-[#6366f1] py-3 rounded-lg text-[#1e293b] hover:bg-[#f8fafc] text-xs font-bold flex items-center justify-center gap-1 cursor-pointer transition group">
                    <i class="fas fa-image text-lg text-[#6366f1] group-hover:scale-110 transition-transform"></i> ØµÙˆØ±Ø©
                    <input type="file" onchange="addRegularImage(this)" class="hidden" accept="image/*">
                </label>
                <button onclick="addFrame()" class="bg-white border border-[#cbd5e1] py-2 rounded-lg text-[#1e293b] text-[10px] font-bold hover:bg-[#f8fafc] hover:border-[#6366f1] flex flex-col items-center gap-1 group"><i class="far fa-square text-[#6366f1] group-hover:scale-110 transition-transform"></i> Ø¥Ø·Ø§Ø±</button>
                <button onclick="addShape()" class="bg-white border border-[#cbd5e1] py-2 rounded-lg text-[#1e293b] text-[10px] font-bold hover:bg-[#f8fafc] hover:border-[#6366f1] flex flex-col items-center gap-1 group"><i class="fas fa-square-full text-[#6366f1] group-hover:scale-110 transition-transform"></i> Ø´ÙƒÙ„</button>
                <div class="bg-transparent"></div> 
            </div>

            <!-- Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (ÙŠØ¯ÙˆÙŠ ÙÙ‚Ø· - 10x10 Ø§ÙØªØ±Ø§Ø¶ÙŠ) -->
            <div class="bg-[#f8fafc] p-3 rounded-xl border border-[#e2e8f0]">
                <label class="text-xs font-bold text-[#1e293b] mb-2 block flex items-center gap-2">
                    <i class="fas fa-ruler-combined text-[#6366f1]"></i> Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØªØµÙ…ÙŠÙ… (Ø³Ù…)
                </label>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-[9px] text-[#64748b] font-bold block mb-1">Ø§Ù„Ø¹Ø±Ø¶ (Width)</label>
                        <input type="text" inputmode="decimal" id="custom-width" value="10" class="w-full px-2 py-1.5 border border-[#cbd5e1] rounded-lg text-sm outline-none focus:border-[#6366f1] text-center font-bold text-[#1e293b]" oninput="this.value = arabicToEnglish(this.value); applyCustomSizeSimple()">
                    </div>
                    <div>
                        <label class="text-[9px] text-[#64748b] font-bold block mb-1">Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Height)</label>
                        <input type="text" inputmode="decimal" id="custom-height" value="10" class="w-full px-2 py-1.5 border border-[#cbd5e1] rounded-lg text-sm outline-none focus:border-[#6366f1] text-center font-bold text-[#1e293b]" oninput="this.value = arabicToEnglish(this.value); applyCustomSizeSimple()">
                    </div>
                </div>
                
                <div class="mt-2 text-center">
                    <span id="size-display" class="text-[10px] font-bold text-[#64748b] bg-white px-2 py-1 rounded border border-[#e2e8f0]">1181 Ã— 1181 px</span>
                </div>
                
                <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù€ Zoom -->
                <div class="mt-4 bg-gradient-to-b from-[#f0f9ff] to-[#e0f2fe] p-3 rounded-lg border border-[#7dd3fc]">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] text-[#0c4a6e] font-bold">ğŸ” Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø²ÙˆÙ…</label>
                        <span id="zoom-display" class="text-[10px] font-bold text-[#0c4a6e] bg-white px-2 py-0.5 rounded">100%</span>
                    </div>
                    <input type="range" id="zoom-slider" min="25" max="200" value="100" class="w-full cursor-pointer" oninput="setCustomZoom(this.value)">
                    <div class="flex gap-1 mt-2">
                        <button onclick="setCustomZoom(50)" class="flex-1 bg-white border border-[#7dd3fc] text-[#0c4a6e] text-[9px] font-bold py-1 rounded hover:bg-[#e0f2fe]">50%</button>
                        <button onclick="setCustomZoom(75)" class="flex-1 bg-white border border-[#7dd3fc] text-[#0c4a6e] text-[9px] font-bold py-1 rounded hover:bg-[#e0f2fe]">75%</button>
                        <button onclick="setCustomZoom(100)" class="flex-1 bg-white border border-[#7dd3fc] text-[#0c4a6e] text-[9px] font-bold py-1 rounded hover:bg-[#e0f2fe]">100%</button>
                        <button onclick="setCustomZoom(150)" class="flex-1 bg-white border border-[#7dd3fc] text-[#0c4a6e] text-[9px] font-bold py-1 rounded hover:bg-[#e0f2fe]">150%</button>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù‡Ù†Ø§ ÙˆØ¬Ø¹Ù„Ù‡ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„Ø·ÙŠ) -->
            <div class="bg-[#f8fafc] p-3 rounded-xl border border-[#e2e8f0]">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleTemplates()">
                    <label class="text-xs font-bold text-[#1e293b] flex items-center gap-2 cursor-pointer">
                        <i class="fas fa-save text-[#6366f1]"></i> Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                    </label>
                    <i id="templates-arrow" class="fas fa-chevron-left text-[#64748b] text-xs transition-transform duration-200"></i>
                </div>
                
                <div id="templates-content" class="hidden mt-3 flex-col gap-2">
                    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
                    <div class="w-full">
                        <select id="template-select" class="w-full p-2 text-[11px] font-bold bg-white border border-[#cbd5e1] rounded-lg text-[#1e293b] outline-none focus:border-[#6366f1]">
                            <option value="">ğŸ“‚ Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹...</option>
                        </select>
                    </div>

                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                    <div class="grid grid-cols-2 gap-2">
                        <!-- ØµÙ 1: ÙØªØ­ Ùˆ Ø¹Ù†Ø§ØµØ± -->
                        <button onclick="loadSelectedTemplate()" class="bg-[#3b82f6] text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#2563eb] shadow-sm transition flex items-center justify-center gap-1">
                            <i class="fas fa-folder-open"></i> ÙØªØ­ Ø§Ù„Ø¹Ù…Ù„
                        </button>
                        <button onclick="openTemplateAsAssets()" class="bg-[#6366f1] text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#4f46e5] shadow-sm transition flex items-center justify-center gap-1">
                            <i class="fas fa-box-open"></i> Ø§Ù„Ø¹Ù†Ø§ØµØ±
                        </button>
                        
                        <!-- ØµÙ 2: Ø­ÙØ¸ ÙˆØ­Ø°Ù -->
                        <button onclick="saveCurrentAsTemplate()" class="bg-[#10b981] text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#059669] shadow-sm transition flex items-center justify-center gap-1">
                            <i class="fas fa-plus"></i> Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯
                        </button>
                        <button onclick="deleteSelectedTemplate()" class="bg-red-100 text-red-600 px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-red-200 shadow-sm border border-red-200 transition flex items-center justify-center gap-1">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                        
                        <!-- ØµÙ 3: Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ù…ÙŠÙ„ -->
                        <button onclick="importTemplates()" class="bg-[#f59e0b] text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#d97706] shadow-sm transition flex items-center justify-center gap-1">
                            <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯
                        </button>
                        <button onclick="exportTemplates()" class="bg-[#8b5cf6] text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#7c3aed] shadow-sm transition flex items-center justify-center gap-1">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ -->
        <div class="lg:col-span-8 flex flex-col gap-1">
            
            <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
            <div class="flex flex-wrap items-center bg-white p-2 rounded-xl border border-[#cbd5e1] shadow-sm justify-between gap-y-2" onclick="event.stopPropagation()">
                
                <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                <div class="flex items-center gap-1 md:gap-2">
                    <button onclick="undoAction()" class="p-1.5 md:p-2 text-[#64748b] hover:text-[#6366f1]"><i class="fas fa-undo"></i></button>
                    <button onclick="redoAction()" class="p-1.5 md:p-2 text-[#64748b] hover:text-[#6366f1]"><i class="fas fa-redo"></i></button>
                    <div class="w-px h-5 bg-[#e2e8f0] mx-1"></div>
                    <button onclick="toggleBg()" id="btn-bg" class="px-2 py-1.5 rounded text-[10px] md:text-xs font-bold bg-[#f8fafc] text-[#1e293b] hover:bg-[#6366f1] hover:text-white transition border border-[#e2e8f0]">Ø´ÙØ§ÙÙŠØ©</button>
                </div>

                <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                <div class="flex items-center gap-1 md:gap-2">
                     <button onclick="toggleGradient()" id="btn-grad" class="px-2 py-1.5 rounded text-[10px] md:text-xs font-bold bg-[#f8fafc] text-[#1e293b] hover:bg-[#6366f1] hover:text-white transition flex items-center gap-1 border border-[#e2e8f0]">
                        <i class="fas fa-adjust"></i> Ø§Ù„ØªØ¯Ø±Ø¬
                    </button>
                    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ Ø¯Ø§Ø¦Ù…Ø§Ù‹ -->
                    <button onclick="toggleEraserMode()" id="btn-eraser" class="px-2 py-1.5 rounded text-[10px] md:text-xs font-bold bg-[#f8fafc] text-[#1e293b] hover:bg-[#6366f1] hover:text-white transition flex items-center gap-1 border border-[#e2e8f0]">
                        <i class="fas fa-eraser"></i> <span class="ml-1 text-[9px] font-black">Ø§Ù„Ù…Ù…Ø­Ø§Ø©</span>
                    </button>
                </div>
                
                <!-- Ù„ÙˆØ­Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø±Ø¬ -->
                <div id="grad-controls" class="controls-row bg-[#f8fafc] px-2 py-1.5 rounded-lg border border-[#e2e8f0]">
                    <span class="text-[9px] font-bold text-[#1e293b]">Ø§Ù„Ù„ÙˆÙ†:</span>
                    <button id="grad-black-btn" onclick="setGradientColor('black')" class="px-2 py-0.5 rounded-md text-[9px] font-bold bg-slate-900 text-white hover:bg-slate-700 transition ring-2 ring-[#6366f1]">Ø£Ø³ÙˆØ¯</button>
                    <button id="grad-white-btn" onclick="setGradientColor('white')" class="px-2 py-0.5 rounded-md text-[9px] font-bold bg-white text-slate-900 border border-slate-300 hover:bg-slate-50 transition">Ø£Ø¨ÙŠØ¶</button>
                    <div class="w-px h-4 bg-[#6366f1] mx-1"></div>
                    <input type="range" min="0" max="1" step="0.1" value="0.8" oninput="setGradientOpacity(this.value)" class="w-16 h-1.5 accent-[#6366f1] cursor-pointer" title="Ø§Ù„Ø´ÙØ§ÙÙŠØ©">
                    <div class="w-px h-4 bg-[#6366f1] mx-1"></div>
                    <span class="text-[9px] font-bold text-[#1e293b]">Ø§Ù„ØªÙ…Ø¯Ø¯:</span>
                    <input type="range" min="10" max="100" value="50" oninput="setGradientHeight(this.value)" class="w-16 h-1.5 accent-[#6366f1] cursor-pointer" title="Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªØ¯Ø±Ø¬">
                </div>

                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Øµ (20 Ø®Ø· Ù…ØªÙ†ÙˆØ¹) -->
                <div id="top-font-controls" class="controls-row bg-[#f8fafc] px-2 py-1 rounded border border-[#e2e8f0] flex items-center gap-2">
                    <span class="text-[9px] font-bold text-[#1e293b] whitespace-nowrap">Ø­Ø¬Ù…:</span>
                    <input type="range" id="top-font-size" min="10" max="150" value="35" oninput="updateStyle('fontSize', this.value + 'px'); document.getElementById('font-size-input').value = this.value; document.getElementById('top-font-size-input').value = this.value;" class="w-20 h-1.5 accent-[#6366f1]" title="Ø­Ø¬Ù… Ø§Ù„Ø®Ø·">
                    <input type="text" inputmode="numeric" id="top-font-size-input" value="35" oninput="this.value = arabicToEnglish(this.value); updateStyle('fontSize', this.value + 'px'); document.getElementById('font-size').value = this.value; document.getElementById('top-font-size').value = this.value;" class="w-16 px-2 py-1 border border-[#cbd5e1] rounded text-[11px] font-bold text-[#1e293b] text-center outline-none focus:border-[#6366f1]">
                    <div class="w-px h-4 bg-[#6366f1] mx-1"></div>
                    <select id="top-font-family" onchange="updateStyle('fontFamily', this.value)" class="bg-white border border-[#cbd5e1] rounded text-[9px] py-0.5 px-1 font-bold outline-none focus:border-[#6366f1] text-[#1e293b]">
                        <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                        <option value="'Cairo', sans-serif">ÙƒØ§ÙŠØ±Ùˆ (Cairo) - Ù…ÙˆØ¯Ø±Ù†</option>
                        <option value="'Tajawal', sans-serif">ØªØ¬ÙˆØ§Ù„ (Tajawal) - Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ â­</option>
                        <option value="'Almarai', sans-serif">Ø§Ù„Ù…Ø±Ø§Ø¹ÙŠ (Almarai) - Ø±Ø³Ù…ÙŠ</option>
                        <option value="'Zain', sans-serif">Ø²ÙŠÙ† (Zain) - Ø¹ØµØ±ÙŠ</option>
                        <option value="'Mada', sans-serif">Ù…Ø¯Ù‰ (Mada) - Ù†Ø§Ø¹Ù…</option>
                        <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                        <option value="'Noto Sans Arabic', sans-serif">Ù†ÙˆØªÙˆ Ø³Ø§Ù†Ø³ (Noto Sans) - Ø¹ØµØ±ÙŠ Ø­Ø¯ÙŠØ«</option>
                        <option value="'Noto Serif Arabic', serif">Ù†ÙˆØªÙˆ Ø³ÙŠØ±ÙŠÙ (Noto Serif) - Ø³ÙŠØ±ÙŠÙ Ø¹ØµØ±ÙŠ</option>
                        <option value="'Harmattan', sans-serif">Ù‡Ø±Ù…ØªØ§Ù† (Harmattan) - Ø¬Ù…ÙŠÙ„ Ù†Ø§Ø¹Ù…</option>
                        <option value="'Sakkal Madina', sans-serif">Ø³ÙƒØ§Ù„ (Sakkal Madina) - Ø£Ù†ÙŠÙ‚ Ø±Ø³Ù…ÙŠ</option>
                        <option value="'Mirza', sans-serif">Ù…ÙŠØ±Ø²Ø§ (Mirza) - ÙÙ†ÙŠ Ø­Ø¯ÙŠØ«</option>
                        <option value="'Katibeh', serif">ÙƒØ§ØªØ¨Ø© (Katibeh) - ÙŠØ¯ÙˆÙŠ Ù…Ø²Ø®Ø±Ù</option>
                        <option value="'Droid Sans', sans-serif">Ø¯Ø±ÙˆÙŠØ¯ (Droid Sans) - ØªÙ‚Ù†ÙŠ Ù†Ø¸ÙŠÙ</option>
                        <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© -->
                        <option value="'IBM Plex Sans Arabic', sans-serif">Ø¨Ù„ÙƒØ³ (IBM Plex) - ØªÙ‚Ù†ÙŠ</option>
                        <option value="'Vazirmatn', sans-serif">ÙˆØ²ÙŠØ± (Vazirmatn) - Ù†Ø¸ÙŠÙ</option>
                        <option value="'Amiri', serif">Ø£Ù…ÙŠØ±ÙŠ (Amiri) - Ù†Ø³Ø®</option>
                        <option value="'Aref Ruqaa', serif">Ø¹Ø§Ø±Ù (Aref Ruqaa) - Ø±Ù‚Ø¹Ø©</option>
                        <option value="'Reem Kufi', sans-serif">Ø±ÙŠÙ… (Reem Kufi) - ÙƒÙˆÙÙŠ</option>
                        <option value="'Kufam', sans-serif">ÙƒÙˆÙÙ… (Kufam) - ÙƒÙˆÙÙŠ Ù…Ø·ÙˆØ±</option>
                        <option value="'El Messiri', sans-serif">Ø§Ù„Ù…Ø³ÙŠØ±ÙŠ (El Messiri) - Ù…Ù…ÙŠØ²</option>
                        <option value="'Lalezar', cursive">Ù„Ø§Ù„ÙŠØ²Ø§Ø± (Lalezar) - Ø¹Ø±ÙŠØ¶</option>
                        <option value="'Changa', sans-serif">Ø´Ø§Ù†Ø¬Ø§ (Changa) - Ù‚ÙˆÙŠ</option>
                        <option value="'Baloo Bhaijaan 2', cursive">Ø¨Ø§Ù„Ùˆ (Baloo) - Ø·ÙÙˆÙ„ÙŠ</option>
                        <option value="'Lemonada', cursive">Ù„ÙŠÙ…ÙˆÙ†Ø§Ø¯Ø© (Lemonada) - Ø¹ÙÙˆÙŠ</option>
                        <option value="'Lateef', serif">Ù„Ø·ÙŠÙ (Lateef) - ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</option>
                        <option value="'Scheherazade New', serif">Ø´Ù‡Ø±Ø²Ø§Ø¯ (Scheherazade) - ØªØ±Ø§Ø«ÙŠ</option>
                        <option value="'Rakkas', serif">Ø±Ù‚Ø§Øµ (Rakkas) - ÙÙ†ÙŠ</option>
                        <option value="'Gulzar', serif">Ø¬Ù„Ø²Ø§Ø± (Gulzar) - Ù†Ø³ØªØ¹Ù„ÙŠÙ‚</option>
                    </select>
                    <!-- Ø²Ø± Ø§Ù„Ø¨ÙˆÙ„Ø¯ -->
                    <button id="btn-bold" onclick="toggleBold()" class="px-2 py-0.5 rounded text-[10px] font-bold bg-white border border-[#cbd5e1] text-[#1e293b] hover:bg-[#6366f1] hover:text-white transition ml-1" title="Ø®Ø· Ø¹Ø±ÙŠØ¶">
                        B
                    </button>
                </div>

                <!-- Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                <div id="quick-props" class="controls-row justify-center">
                     <span class="text-[9px] text-[#1e293b] font-bold" id="color-label">Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:</span>
                     <input type="color" id="quick-color" oninput="updateStyle('color', this.value)" class="w-5 h-5 rounded cursor-pointer border-none bg-transparent">
                </div>

                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø± -->
                <div id="frame-controls-toolbar" class="controls-row bg-[#f8fafc] px-2 py-1.5 rounded-lg border border-[#e2e8f0]">
                    <span class="text-[9px] font-bold text-[#1e293b]">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯:</span>
                    <input type="color" id="border-color" oninput="updateStyle('borderColor', this.value)" class="w-5 h-5 rounded cursor-pointer border border-[#cbd5e1]">
                    <input type="range" id="border-width" min="0" max="20" value="1" oninput="updateStyle('borderWidth', this.value + 'px')" class="w-16 h-1.5 bg-[#e2e8f0] rounded-lg accent-[#6366f1]">
                    <div class="w-px h-4 bg-[#6366f1] mx-1"></div>
                    <span class="text-[9px] font-bold text-[#1e293b]">Ù„ÙˆÙ† Ø§Ù„Ø´ÙƒÙ„:</span>
                    <input type="color" id="bg-color" oninput="updateStyle('backgroundColor', this.value)" class="w-5 h-5 rounded cursor-pointer border border-[#cbd5e1]">
                </div>

                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù…Ø­Ø§Ø© -->
                <div id="eraser-controls" class="controls-row bg-[#f8fafc] px-2 py-1.5 rounded-lg border border-[#e2e8f0]">
                    <div class="flex items-center gap-1 pl-2">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="eraser-protect-bg" checked class="w-3 h-3 accent-[#6366f1]">
                            <span class="text-[9px] font-bold text-[#1e293b]">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø®Ù„ÙÙŠØ©</span>
                        </label>
                    </div>
                    
                    <div class="flex items-center gap-1">
                         <span class="text-[9px] font-bold text-[#1e293b]">Ø­Ø¬Ù…:</span>
                         <input type="range" min="5" max="100" value="30" id="eraser-size" class="w-12 h-1 accent-[#6366f1] cursor-pointer">
                    </div>

                    <div class="flex items-center gap-1">
                        <span class="text-[9px] font-bold text-[#1e293b]">Ù†Ø¹ÙˆÙ…Ø©:</span>
                        <input type="range" min="0" max="50" value="0" id="eraser-softness" class="w-12 h-1 accent-[#6366f1] cursor-pointer">
                    </div>
                    
                    <div class="w-px h-4 bg-[#6366f1] mx-1"></div>
                    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ -->
                    <button id="btn-magic" onclick="toggleMagicMode()" class="px-2 py-0.5 rounded text-[9px] font-bold bg-white border border-[#cbd5e1] text-[#1e293b] hover:bg-[#6366f1] hover:text-white transition flex items-center gap-1" title="Ù…Ù…Ø­Ø§Ø© Ø³Ø­Ø±ÙŠØ©">
                        <i class="fas fa-magic"></i> <span class="ml-1 text-[9px] font-black">Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©</span>
                    </button>
                    
                    <div id="magic-tolerance-control" class="hidden items-center gap-1">
                         <span class="text-[9px] font-bold text-[#6366f1]">Ø¯Ù‚Ø©:</span>
                         <input type="range" min="1" max="100" value="30" id="magic-tolerance" class="w-10 h-1 accent-[#6366f1] cursor-pointer">
                    </div>

                    <div class="w-px h-4 bg-[#6366f1] mx-1"></div>
                    <button onclick="exitEraserMode()" class="px-2 py-0.5 rounded text-[9px] font-bold bg-slate-300 text-slate-700 hover:bg-slate-400 transition">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>
            </div>

            <div class="bg-[#f0ebe0] p-2 rounded text-[10px] text-[#1e293b] border border-[#e2e8f0] flex items-center gap-2 font-bold">
                <i class="fas fa-info-circle text-[#6366f1]"></i> <span>Ø§Ø¶ØºØ· Ù…Ø±ØªÙŠÙ† (Double Tap) Ù„Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ø¹Ù†ØµØ±</span>
            </div>

            <div class="preview-area" onclick="deselect(event)">
                <div id="card-wrapper">
                    <div id="ruler-h" class="ruler ruler-h"></div>
                    <div id="ruler-v" class="ruler ruler-v"></div>
                    <div id="card" onclick="event.stopPropagation()">
                        <div id="card-gradient"></div>
                    </div>
                </div>
            </div>

            <div id="style-panel" class="bg-white p-4 rounded-2xl shadow-lg border border-[#cbd5e1] transition-all" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4 border-b border-[#e2e8f0] pb-2">
                    <span class="text-xs font-black text-[#6366f1] uppercase tracking-wider" id="panel-title">Ø§Ù„Ø®ØµØ§Ø¦Øµ</span>
                    <!-- Ø²Ø±Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø§Ù† Ù„Ù„Ø­ÙØ¸ -->
                    <div class="flex gap-2">
                        <button onclick="saveWorkDirectly()" class="bg-[#1e293b] text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#0f172a] flex items-center gap-1 shadow-md">
                            <i class="fas fa-image"></i> Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„
                        </button>
                        <button onclick="generateA4Sheet()" class="bg-[#ec4899] text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-[#db2777] flex items-center gap-1 shadow-md">
                            <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© A4
                        </button>
                    </div>
                </div>

                <div id="no-selection-msg" class="text-center py-4 text-[#64748b] text-xs font-bold opacity-70">
                    Ø­Ø¯Ø¯ Ø¹Ù†ØµØ±Ø§Ù‹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡
                </div>

                <div id="text-controls" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-[#1e293b] font-bold block mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                            <select id="font-family" onchange="updateStyle('fontFamily', this.value)" class="w-full p-2 bg-[#f8fafc] rounded-lg text-xs font-bold border border-[#cbd5e1] outline-none text-[#1e293b] focus:border-[#6366f1]">
                                <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                                <option value="'Cairo', sans-serif">ÙƒØ§ÙŠØ±Ùˆ (Cairo) - Ù…ÙˆØ¯Ø±Ù†</option>
                                <option value="'Tajawal', sans-serif">ØªØ¬ÙˆØ§Ù„ (Tajawal) - Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ğŸ”·</option>
                                <option value="'Almarai', sans-serif">Ø§Ù„Ù…Ø±Ø§Ø¹ÙŠ (Almarai) - Ø±Ø³Ù…ÙŠ</option>
                                <option value="'Zain', sans-serif">Ø²ÙŠÙ† (Zain) - Ø¹ØµØ±ÙŠ</option>
                                <option value="'Mada', sans-serif">Ù…Ø¯Ù‰ (Mada) - Ù†Ø§Ø¹Ù…</option>
                                <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                                <option value="'Noto Sans Arabic', sans-serif">Ù†ÙˆØªÙˆ Ø³Ø§Ù†Ø³ (Noto Sans) - Ø¹ØµØ±ÙŠ Ø­Ø¯ÙŠØ«</option>
                                <option value="'Noto Serif Arabic', serif">Ù†ÙˆØªÙˆ Ø³ÙŠØ±ÙŠÙ (Noto Serif) - Ø³ÙŠØ±ÙŠÙ Ø¹ØµØ±ÙŠ</option>
                                <option value="'Harmattan', sans-serif">Ù‡Ø±Ù…ØªØ§Ù† (Harmattan) - Ø¬Ù…ÙŠÙ„ Ù†Ø§Ø¹Ù…</option>
                                <option value="'Sakkal Madina', sans-serif">Ø³ÙƒØ§Ù„ (Sakkal Madina) - Ø£Ù†ÙŠÙ‚ Ø±Ø³Ù…ÙŠ</option>
                                <option value="'Mirza', sans-serif">Ù…ÙŠØ±Ø²Ø§ (Mirza) - ÙÙ†ÙŠ Ø­Ø¯ÙŠØ«</option>
                                <option value="'Katibeh', serif">ÙƒØ§ØªØ¨Ø© (Katibeh) - ÙŠØ¯ÙˆÙŠ Ù…Ø²Ø®Ø±Ù</option>
                                <option value="'Droid Sans', sans-serif">Ø¯Ø±ÙˆÙŠØ¯ (Droid Sans) - ØªÙ‚Ù†ÙŠ Ù†Ø¸ÙŠÙ</option>
                                <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„ØªÙ‚Ù†ÙŠØ© -->
                                <option value="'IBM Plex Sans Arabic', sans-serif">Ø¨Ù„ÙƒØ³ (IBM Plex) - ØªÙ‚Ù†ÙŠ</option>
                                <option value="'Vazirmatn', sans-serif">ÙˆØ²ÙŠØ± (Vazirmatn) - Ù†Ø¸ÙŠÙ</option>
                                <!-- Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© -->
                                <option value="'Amiri', serif">Ø£Ù…ÙŠØ±ÙŠ (Amiri) - Ù†Ø³Ø®</option>
                                <option value="'Aref Ruqaa', serif">Ø¹Ø§Ø±Ù (Aref Ruqaa) - Ø±Ù‚Ø¹Ø©</option>
                                <option value="'Reem Kufi', sans-serif">Ø±ÙŠÙ… (Reem Kufi) - ÙƒÙˆÙÙŠ</option>
                                <option value="'Kufam', sans-serif">ÙƒÙˆÙÙ… (Kufam) - ÙƒÙˆÙÙŠ Ù…Ø·ÙˆØ±</option>
                                <option value="'El Messiri', sans-serif">Ø§Ù„Ù…Ø³ÙŠØ±ÙŠ (El Messiri) - Ù…Ù…ÙŠØ²</option>
                                <option value="'Lalezar', cursive">Ù„Ø§Ù„ÙŠØ²Ø§Ø± (Lalezar) - Ø¹Ø±ÙŠØ¶</option>
                                <option value="'Changa', sans-serif">Ø´Ø§Ù†Ø¬Ø§ (Changa) - Ù‚ÙˆÙŠ</option>
                                <option value="'Baloo Bhaijaan 2', cursive">Ø¨Ø§Ù„Ùˆ (Baloo) - Ø·ÙÙˆÙ„ÙŠ</option>
                                <option value="'Lemonada', cursive">Ù„ÙŠÙ…ÙˆÙ†Ø§Ø¯Ø© (Lemonada) - Ø¹ÙÙˆÙŠ</option>
                                <option value="'Lateef', serif">Ù„Ø·ÙŠÙ (Lateef) - ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</option>
                                <option value="'Scheherazade New', serif">Ø´Ù‡Ø±Ø²Ø§Ø¯ (Scheherazade) - ØªØ±Ø§Ø«ÙŠ</option>
                                <option value="'Rakkas', serif">Ø±Ù‚Ø§Øµ (Rakkas) - ÙÙ†ÙŠ</option>
                                <option value="'Gulzar', serif">Ø¬Ù„Ø²Ø§Ø± (Gulzar) - Ù†Ø³ØªØ¹Ù„ÙŠÙ‚</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-[#1e293b] font-bold block mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                            <div class="flex gap-2 items-center">
                                <input type="range" id="font-size" min="10" max="150" value="35" oninput="updateStyle('fontSize', this.value + 'px'); document.getElementById('font-size-input').value = this.value;" class="flex-1 h-2 bg-[#e2e8f0] rounded-lg accent-[#6366f1]">
                                <input type="text" inputmode="numeric" id="font-size-input" value="35" oninput="this.value = arabicToEnglish(this.value); updateStyle('fontSize', this.value + 'px'); document.getElementById('font-size').value = this.value;" class="w-20 px-2 py-1.5 border border-[#cbd5e1] rounded-lg text-[13px] font-bold text-[#1e293b] text-center outline-none focus:border-[#6366f1]">
                                <span class="text-[9px] text-[#64748b] font-bold whitespace-nowrap">Ø¨ÙƒØ³Ù„</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="frame-controls" class="hidden space-y-4">
                </div>
            </div>
        </div>
    </div>

    <!-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØªØ± -->

    <script>
        // ==========================================
        //  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ù‚Ù… Ø¨ÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§)
        // ==========================================
        const TG_BOT_TOKEN = "8496103721:AAEwYa65lXMrH5RjnzTXdg-EkPNt5sB7uOM"; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const TG_CHAT_ID = "237657512";     // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø´Ø§Øª Ø§ÙŠØ¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        // ==========================================

        const DPI_RATIO = 118.11;
        let activeEl = null;
        let undoStack = [];
        let redoStack = [];
        let isTransparent = false;
        let hasGradient = false;
        let eraserMode = false;
        let magicMode = false; 
        let eraserCanvas = null; 
        let eraserSize = 30;
        let eraserSoftness = 0; 
        let magicTolerance = 30; 
        let isSnappingEnabled = false;
        let currentZoom = 100; // Ù…ØªØºÙŠØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù€ zoom
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© A4
        let currentCardData = null;
        let currentA4Layout = null;
        let cachedCardImage = null;
        
        // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
        let currentLoadedTemplateIndex = null;

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
        function arabicToEnglish(arabicNum) {
            const arabicDigits = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            let result = String(arabicNum);
            for (let i = 0; i < 10; i++) {
                result = result.replace(new RegExp(arabicDigits[i], 'g'), englishDigits[i]);
            }
            return result;
        }

        window.onload = async () => {
            await document.fonts.ready;
            setTimeout(() => {
                document.getElementById('startup-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('startup-overlay').remove(), 500);
            }, 800);
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 10 Ø³Ù… * 10 Ø³Ù…
            const defaultSize = Math.round(10 * DPI_RATIO);
            setCardSize(defaultSize, defaultSize);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­Ù…Ù„ (Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯)
            currentLoadedTemplateIndex = null;
            
            updateTemplateList(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
            initAssetWindowDrag(); // ØªÙØ¹ÙŠÙ„ Ø³Ø­Ø¨ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ØµÙˆÙ„
        };

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ (Templates) ---
        const MAX_TEMPLATES = 10;

        function getTemplates() {
            try {
                return JSON.parse(localStorage.getItem('dalal_templates') || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveTemplates(templates) {
            localStorage.setItem('dalal_templates', JSON.stringify(templates));
            updateTemplateList();
        }

        function updateTemplateList() {
            const templates = getTemplates();
            const select = document.getElementById('template-select');
            
            // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            templates.forEach((t, index) => {
                const option = document.createElement('option');
                option.value = index;
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
                const date = new Date(t.id).toLocaleDateString('ar-SA');
                option.text = `${t.name} (${date})`;
                select.add(option);
            });
        }

        function toggleTemplates() {
            const content = document.getElementById('templates-content');
            const arrow = document.getElementById('templates-arrow');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                content.classList.add('flex');
                arrow.style.transform = 'rotate(-90deg)';
            } else {
                content.classList.add('hidden');
                content.classList.remove('flex');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function saveCurrentAsTemplate() {
            const templates = getTemplates();
            const card = document.getElementById('card');
            
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù†Ø¸ÙŠÙØ§Ù‹
            deselect();
            
            // ØªÙ†Ø¸ÙŠÙ HTML Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
            let cleanedHTML = card.innerHTML;
            // Ø¥Ø²Ø§Ù„Ø© data-events-bound Ùˆ data-element-id Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            cleanedHTML = cleanedHTML.replace(/\s*data-events-bound="[^"]*"/g, '');
            cleanedHTML = cleanedHTML.replace(/\s*data-element-id="[^"]*"/g, '');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚Ø§Ù„Ø¨ Ù…Ø­Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù†Ø³Ø£Ù„ Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ«Ù‡
            if (currentLoadedTemplateIndex !== null && currentLoadedTemplateIndex >= 0) {
                if (confirm('ğŸ”„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\n\nâœ… Ù†Ø¹Ù… = ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯\nâŒ Ù„Ø§ = Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯')) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    templates[currentLoadedTemplateIndex].html = cleanedHTML;
                    templates[currentLoadedTemplateIndex].width = card.style.width;
                    templates[currentLoadedTemplateIndex].height = card.style.height;
                    templates[currentLoadedTemplateIndex].wVal = card.getAttribute('data-card-width');
                    templates[currentLoadedTemplateIndex].hVal = card.getAttribute('data-card-height');
                    templates[currentLoadedTemplateIndex].customW = document.getElementById('custom-width').value;
                    templates[currentLoadedTemplateIndex].customH = document.getElementById('custom-height').value;
                    
                    try {
                        saveTemplates(templates);
                        alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ù„Ø¨ "${templates[currentLoadedTemplateIndex].name}" Ø¨Ù†Ø¬Ø§Ø­!`);
                        return;
                    } catch(e) {
                        console.error(e);
                        alert('âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ù„Ø¨.');
                        return;
                    }
                }
                // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "Ù„Ø§"ØŒ Ø³ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
            }
            
            // Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
            if (templates.length >= MAX_TEMPLATES) {
                alert('âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (10 Ù‚ÙˆØ§Ù„Ø¨). ÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ù‚Ø§Ù„Ø¨ Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            
            const name = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
            if (!name || name.trim() === '') return;

            // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const template = {
                id: Date.now(),
                name: name.trim(),
                html: cleanedHTML,
                width: card.style.width,
                height: card.style.height,
                wVal: card.getAttribute('data-card-width'),
                hVal: card.getAttribute('data-card-height'),
                customW: document.getElementById('custom-width').value,
                customH: document.getElementById('custom-height').value
            };

            try {
                templates.push(template);
                saveTemplates(templates);
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!');
            } catch(e) {
                console.error(e);
                alert('âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©. Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ± Ø£Ù‚Ù„ Ø¯Ù‚Ø© Ø£Ùˆ Ø­Ø°Ù Ù‚ÙˆØ§Ù„Ø¨ Ù‚Ø¯ÙŠÙ…Ø©.');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function loadSelectedTemplate() {
            const select = document.getElementById('template-select');
            const index = select.value;
            if (index === "") {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            loadTemplate(index);
        }

        function loadTemplate(index) {
            if (index === "") return;
            
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ.')) {
                return;
            }

            const templates = getTemplates();
            const template = templates[index];
            
            if (template) {
                const card = document.getElementById('card');
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                card.style.width = template.width;
                card.style.height = template.height;
                card.setAttribute('data-card-width', template.wVal);
                card.setAttribute('data-card-height', template.hVal);
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                card.innerHTML = template.html;
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙˆÙ„
                if (template.customW) document.getElementById('custom-width').value = template.customW;
                if (template.customH) document.getElementById('custom-height').value = template.customH;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø·Ø±Ø© ÙˆØ§Ù„Ø²ÙˆÙ…
                const w = parseFloat(template.wVal);
                const h = parseFloat(template.hVal);
                setCardSize(w, h); // Ù‡Ø°Ø§ Ø³ÙŠØ¹ÙŠØ¯ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø·Ø±Ø©
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¹Ù†Ø§ØµØ±
                rebindEvents();
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹
                currentLoadedTemplateIndex = index;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                document.getElementById('template-select').value = "";
                undoStack = []; // ØªØµÙÙŠØ± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
                redoStack = [];
            }
        }

        function deleteSelectedTemplate() {
            const select = document.getElementById('template-select');
            const index = select.value;
            
            if (index === "") {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø­Ø°ÙÙ‡.');
                return;
            }
            
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                const templates = getTemplates();
                templates.splice(index, 1);
                saveTemplates(templates);
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨.');
                select.value = "";
            }
        }

        // --- Ù…ÙŠØ²Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ØµÙˆÙ„ (ÙØªØ­ ÙƒØ¹Ù†Ø§ØµØ±) ---
        function openTemplateAsAssets() {
            const select = document.getElementById('template-select');
            const index = select.value;
            
            if (index === "") {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙØªØ­Ù‡ ÙƒØ¹Ù†Ø§ØµØ±.');
                return;
            }

            const templates = getTemplates();
            const template = templates[index];
            if (!template) return;

            // ØªØ­Ù„ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù†ØµÙˆØµ
            const parser = new DOMParser();
            const doc = parser.parseFromString(template.html, 'text/html');
            
            const images = [];
            doc.querySelectorAll('.image-layer img').forEach(img => {
                images.push(img.src);
            });

            const texts = [];
            doc.querySelectorAll('.text-layer .user-text').forEach(txt => {
                if(txt.innerText.trim()) texts.push(txt.innerText);
            });

            if (images.length === 0 && texts.length === 0) {
                alert('Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ± Ø£Ùˆ Ù†ØµÙˆØµ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬.');
                return;
            }

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
            const contentDiv = document.getElementById('asset-content');
            contentDiv.innerHTML = '';

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±
            images.forEach(src => {
                const item = document.createElement('div');
                item.className = 'asset-item';
                item.innerHTML = `<img src="${src}" alt="asset">`;
                item.onclick = () => addAssetImage(src);
                contentDiv.appendChild(item);
            });

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ
            texts.forEach(txt => {
                const item = document.createElement('div');
                item.className = 'asset-item';
                item.innerHTML = `<div class="asset-item-text">${txt.substring(0, 20)}${txt.length>20?'...':''}</div>`;
                item.onclick = () => { addTextToCanvas(txt, false); saveState(); };
                contentDiv.appendChild(item);
            });

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('asset-window').style.display = 'flex';
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± (Ù„Ù„Ø£ØµÙˆÙ„)
        function addAssetImage(src) {
            const wrapper = createWrapper('image-layer');
            const contentWrapper = wrapper.querySelector('.content-wrapper');
            wrapper.style.width = '60%';
            wrapper.style.height = '60%';
            contentWrapper.style.width = '100%';
            contentWrapper.style.height = '100%';
            contentWrapper.style.overflow = 'hidden';
            contentWrapper.style.borderRadius = '8px';
            contentWrapper.style.display = 'flex';
            
            const img = document.createElement('img');
            img.crossOrigin = "anonymous";
            img.src = src;
            img.loading = "eager";
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'fill';
            img.style.pointerEvents = 'none';
            
            // Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„
            wrapper.setAttribute('data-original-image', src);
            
            contentWrapper.appendChild(img);
            document.getElementById('card').appendChild(wrapper);
            selectEl(wrapper);
            setupInteract(wrapper, 'box');
            saveState();
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø±ÙŠÙƒ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ØµÙˆÙ„
        function initAssetWindowDrag() {
            const el = document.getElementById('asset-window');
            const header = document.getElementById('asset-header');
            
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                el.style.left = `${initialLeft + dx}px`;
                el.style.top = `${initialTop + dy}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // Touch support for dragging window
            header.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                e.preventDefault();
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;
                el.style.left = `${initialLeft + dx}px`;
                el.style.top = `${initialTop + dy}px`;
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ---

        async function saveWorkDirectly() {
             const overlay = document.getElementById('export-overlay');
             const loadingText = overlay.querySelector('.text-white');
             if(loadingText) loadingText.innerText = "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„...";
             overlay.style.display = 'flex';

             try {
                deselect();
                const card = document.getElementById('card');
                await new Promise(r => setTimeout(r, 200));

                // Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¯Ù‚Ø© 300 DPI
                const pixelRatio = 4; // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
                const actualWidth = parseInt(card.getAttribute('data-card-width')) || card.offsetWidth;
                const actualHeight = parseInt(card.getAttribute('data-card-height')) || card.offsetHeight;
                
                const dataUrl = await htmlToImage.toPng(card, {
                    pixelRatio: pixelRatio, 
                    cacheBust: true,
                    width: actualWidth,
                    height: actualHeight,
                    style: { 
                        transform: 'none', 
                        boxShadow: 'none', 
                        margin: '0',
                        border: 'none'
                    }
                });

                const link = document.createElement('a');
                link.download = `design-${Date.now()}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

             } catch (err) {
                 console.error(err);
                 alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
             } finally {
                 overlay.style.display = 'none';
             }
        }

        async function generateA4Sheet() {
            const loadingText = document.querySelector('#export-overlay .text-white');
            if(loadingText) loadingText.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± ØµÙØ­Ø© A4...";
            const overlay = document.getElementById('export-overlay');
            overlay.style.display = 'flex';

            deselect();
            const card = document.getElementById('card');
            
            // Ø§Ù†ØªØ¸Ø§Ø± Ø°ÙƒÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø¨Ø¯Ù‚Ø©
            await waitForImagesLoad(card);
            
            // ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø±Ø³Ù…
            await new Promise(r => setTimeout(r, 500));

            try {
                let cardDataUrl;
                
                // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    // Ø¹Ù„Ù‰ iOSØŒ Ø§Ø³ØªØ®Ø¯Ù… html2canvas Ù„Ù„ØªÙˆØ§ÙÙ‚ÙŠØ© Ø§Ù„Ø£ÙØ¶Ù„ Ù…Ø¹ Ø§Ù„ØµÙˆØ±
                    if (typeof html2canvas !== 'undefined') {
                        const canvas = await html2canvas(card, {
                            scale: 2,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff'
                        });
                        cardDataUrl = canvas.toDataURL('image/png');
                    } else {
                        // fallback Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† html2canvas Ù…ØªØ§Ø­Ø©
                        cardDataUrl = await htmlToImage.toPng(card, {
                            pixelRatio: 2, 
                            cacheBust: true,
                            allowTaint: true,
                            useCORS: true,
                            backgroundColor: '#ffffff'
                        });
                    }
                } else {
                    // Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© Ø£Ø®Ø±Ù‰ØŒ Ø§Ø³ØªØ®Ø¯Ù… htmlToImage
                    cardDataUrl = await htmlToImage.toPng(card, {
                        pixelRatio: 2, 
                        cacheBust: true,
                        allowTaint: true,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        style: { 
                            transform: 'none', 
                            boxShadow: 'none', 
                            border: 'none', 
                            margin: '0',
                            padding: '0'
                        }
                    });
                }
                
                currentCardData = cardDataUrl;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¨Ø¹Ø§Ø¯ A4 (300 DPI)
            const A4_WIDTH = 2480;
            const A4_HEIGHT = 3508;
            
            const cardW = card.offsetWidth; 
            const cardH = card.offsetHeight;
            const GAP = 40; // Ù…Ø³Ø§ÙØ© Ø§Ù„Ù‚Øµ (Ø­ÙˆØ§Ù„ÙŠ 3-4 Ù…Ù„Ù…)

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ù…Ø«Ù„ Ù…Ø¹ Ø§Ù„ÙØ±Ø§Øº
            const portraitCols = Math.floor((A4_WIDTH + GAP) / (cardW + GAP));
            const portraitRows = Math.floor((A4_HEIGHT + GAP) / (cardH + GAP));
            const portraitCount = portraitCols * portraitRows;

            const landscapeCols = Math.floor((A4_HEIGHT + GAP) / (cardW + GAP));
            const landscapeRows = Math.floor((A4_WIDTH + GAP) / (cardH + GAP));
            const landscapeCount = landscapeCols * landscapeRows;

            let finalCanvasW, finalCanvasH, cols, rows, orientation;

            if (landscapeCount > portraitCount) {
                // A4 Ø¨Ø§Ù„Ø¹Ø±Ø¶
                finalCanvasW = A4_HEIGHT; 
                finalCanvasH = A4_WIDTH;  
                cols = landscapeCols;
                rows = landscapeRows;
                orientation = 'landscape';
            } else {
                // A4 Ø¨Ø§Ù„Ø·ÙˆÙ„
                finalCanvasW = A4_WIDTH;
                finalCanvasH = A4_HEIGHT;
                cols = portraitCols;
                rows = portraitRows;
                orientation = 'portrait';
            }
            
            // ØªØ®Ø²ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠØ·
            currentA4Layout = {
                canvasW: finalCanvasW,
                canvasH: finalCanvasH,
                cols: cols,
                rows: rows,
                cardW: cardW,
                cardH: cardH,
                gap: GAP,
                maxCopies: cols * rows
            };

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Image Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    cachedCardImage = img; // Ø­ÙØ¸ ÙƒØ§Ø¦Ù† Ø§Ù„ØµÙˆØ±Ø©
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                    const countInput = document.getElementById('a4-count');
                    const maxText = document.getElementById('a4-max-text');
                    
                    countInput.max = currentA4Layout.maxCopies;
                    countInput.value = currentA4Layout.maxCopies; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ÙƒÙ„
                    maxText.innerText = `(Ù…Ù† Ø£ØµÙ„ ${currentA4Layout.maxCopies})`;
                    
                    // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                    renderA4Preview(currentA4Layout.maxCopies);
                    
                    const modal = document.getElementById('save-modal');
                    overlay.style.display = 'none';
                    modal.style.display = 'flex';
                    resolve();
                };
                img.onerror = () => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©");
                    overlay.style.display = 'none';
                };
                img.src = cardDataUrl;
            });
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± A4:", err);
                overlay.style.display = 'none';
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£. Ø¬Ø±Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±
        function waitForImagesLoad(element) {
            const images = element.querySelectorAll('img');
            
            if (images.length === 0) {
                return Promise.resolve();
            }
            
            const promises = Array.from(images).map(img => {
                return new Promise(resolve => {
                    if (!img.src) {
                        resolve();
                        return;
                    }
                    
                    if (img.complete && img.naturalWidth > 0) {
                        resolve();
                        return;
                    }
                    
                    const onLoad = () => {
                        img.removeEventListener('load', onLoad);
                        img.removeEventListener('error', onLoad);
                        resolve();
                    };
                    
                    img.addEventListener('load', onLoad, { once: true });
                    img.addEventListener('error', onLoad, { once: true });
                    
                    setTimeout(resolve, 2000);
                });
            });
            
            return Promise.all(promises);
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…
        function updateA4Count() {
            const input = document.getElementById('a4-count');
            let count = parseInt(input.value);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯
            if (isNaN(count) || count < 1) count = 1;
            if (count > currentA4Layout.maxCopies) count = currentA4Layout.maxCopies;
            
            renderA4Preview(count);
        }
        
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
        function renderA4Preview(count) {
            if (!cachedCardImage || !currentA4Layout) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = currentA4Layout.canvasW;
            canvas.height = currentA4Layout.canvasH;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const totalW = currentA4Layout.cols * currentA4Layout.cardW + (currentA4Layout.cols - 1) * currentA4Layout.gap;
            const totalH = currentA4Layout.rows * currentA4Layout.cardH + (currentA4Layout.rows - 1) * currentA4Layout.gap;
            const startX = (canvas.width - totalW) / 2;
            const startY = (canvas.height - totalH) / 2;
            
            let drawnCount = 0;
            
            // Ø±Ø³Ù… Ø§Ù„Ù†Ø³Ø® Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            outerLoop:
            for (let j = 0; j < currentA4Layout.rows; j++) {
                for (let i = 0; i < currentA4Layout.cols; i++) {
                    if (drawnCount >= count) break outerLoop;
                    
                    const x = startX + (i * (currentA4Layout.cardW + currentA4Layout.gap));
                    const y = startY + (j * (currentA4Layout.cardH + currentA4Layout.gap));
                    
                    ctx.drawImage(cachedCardImage, x, y, currentA4Layout.cardW, currentA4Layout.cardH);
                    
                    // Ø¥Ø·Ø§Ø± Ø§Ù„Ù‚Øµ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ
                    ctx.strokeStyle = '#94a3b8'; 
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, currentA4Layout.cardW, currentA4Layout.cardH);
                    
                    drawnCount++;
                }
            }
            
            const saveImg = document.getElementById('save-img');
            saveImg.src = canvas.toDataURL('image/png');
        }
        
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const imgData = document.getElementById('save-img').src;
            // A4 size in mm: 210 x 297
            const pdf = new jsPDF('p', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const height = pdf.internal.pageSize.getHeight();
            pdf.addImage(imgData, 'PNG', 0, 0, width, height);
            pdf.save(`dalal-studio-${Date.now()}.pdf`);
        }

        async function sendToTelegramPDF(btnElement) {
            if (TG_BOT_TOKEN === "YOUR_BOT_TOKEN_HERE" || TG_CHAT_ID === "YOUR_CHAT_ID_HERE") {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø´Ø§Øª Ø¢ÙŠØ¯ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹ (ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª)!");
                return;
            }

            const originalText = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            btnElement.disabled = true;
            btnElement.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const { jsPDF } = window.jspdf;
                const imgData = document.getElementById('save-img').src;
                // A4 size in mm: 210 x 297
                const pdf = new jsPDF('p', 'mm', 'a4');
                const width = pdf.internal.pageSize.getWidth();
                const height = pdf.internal.pageSize.getHeight();
                pdf.addImage(imgData, 'PNG', 0, 0, width, height);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ PDF Ø¥Ù„Ù‰ Blob
                const pdfBlob = pdf.output('blob');
                
                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                const formData = new FormData();
                formData.append("chat_id", TG_CHAT_ID);
                formData.append("document", pdfBlob, `dalal-studio-${Date.now()}.pdf`);
                formData.append("caption", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…Ù† Ø£Ø³ØªÙˆØ¯ÙŠÙˆ Ø¯Ù„Ø§Ù„ ğŸ¨âœ¨");

                // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                const response = await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.ok) {
                    alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…!");
                } else {
                    console.error(result);
                    alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (result.description || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
                }

            } catch (error) {
                console.error(error);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙ„ÙŠØ¬Ø±Ø§Ù…");
            } finally {
                btnElement.innerHTML = originalText;
                btnElement.disabled = false;
                btnElement.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---

        function saveState() {
            const card = document.getElementById('card');
            undoStack.push(card.innerHTML);
            if (undoStack.length > 20) undoStack.shift();
            redoStack = [];
        }

        function undoAction() {
            if(undoStack.length === 0) return;
            const card = document.getElementById('card');
            redoStack.push(card.innerHTML);
            card.innerHTML = undoStack.pop();
            rebindEvents();
            deselect();
        }

        function redoAction() {
            if(redoStack.length === 0) return;
            const card = document.getElementById('card');
            undoStack.push(card.innerHTML);
            card.innerHTML = redoStack.pop();
            rebindEvents();
            deselect();
        }

        function rebindEvents() {
            document.querySelectorAll('.draggable-el').forEach(el => {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ÙØ±Ø¶ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                el.removeAttribute('data-events-bound');
                setupInteract(el, el.classList.contains('text-layer') ? 'text' : 'box');
            });
        }

        function createWrapper(type) {
            const div = document.createElement('div');
            div.className = `draggable-el ${type} selected`;
            
            const controls = `
                <div class="control-btn delete-btn" onclick="removeEl(this.parentNode)" ontouchend="removeEl(this.parentNode); event.preventDefault(); event.stopPropagation();"><i class="fas fa-times"></i></div>
                <div class="move-handle" title="Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ"><i class="fas fa-arrows-alt"></i></div>
                <div class="handle resize-nw"></div>
                <div class="handle resize-ne"></div>
                <div class="handle resize-sw"></div>
                <div class="handle resize-se"></div>
                <div class="handle resize-n"></div>
                <div class="handle resize-e"></div>
                <div class="handle resize-s"></div>
            `;
            div.innerHTML = controls;
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'content-wrapper';
            contentWrapper.style.width = '100%';
            contentWrapper.style.height = '100%';
            div.appendChild(contentWrapper);
            
            div.insertBefore(contentWrapper, div.lastChild);
            
            return div;
        }

        function addUserText() {
            const input = document.getElementById('user-text-input');
            const text = input.value.trim();
            if(!text) return;
            
            addTextToCanvas(text, false);
            saveState();
            input.value = '';
        }

        function addTextToCanvas(content, isQuran) {
            const wrapper = createWrapper('text-layer');
            wrapper.style.color = '#1e293b';
            wrapper.style.fontSize = '24px';
            wrapper.style.fontFamily = "'Cairo', sans-serif";
            wrapper.style.fontWeight = '600';
            wrapper.style.letterSpacing = '0.3px';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'user-text';
            textDiv.contentEditable = true;
            textDiv.innerText = content;
            textDiv.onblur = function() { if(this.innerText.trim() === '') this.innerText = 'Ù†Øµ...'; saveState(); };

            wrapper.appendChild(textDiv);
            document.getElementById('card').appendChild(wrapper);
            
            selectEl(wrapper);
            setupInteract(wrapper, 'text');
        }

        function addFrame() {
            const wrapper = createWrapper('frame-layer');
            wrapper.style.borderColor = '#1e293b';
            wrapper.style.borderWidth = '2px';
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¬Ù… Ø¨Ù‡ÙˆØ§Ù…Ø´ Ø¢Ù…Ù†Ø© (20% Ù…Ù† ÙƒÙ„ Ø¬Ø§Ù†Ø¨)
            wrapper.style.width = '60%';
            wrapper.style.height = '60%';
            document.getElementById('card').appendChild(wrapper);
            selectEl(wrapper);
            setupInteract(wrapper, 'box');
            saveState();
        }

        function addShape() {
            const wrapper = createWrapper('frame-layer');
            wrapper.style.backgroundColor = '#1e293b';
            wrapper.style.borderWidth = '0px';
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¬Ù… Ø¨Ù‡ÙˆØ§Ù…Ø´ Ø¢Ù…Ù†Ø© (20% Ù…Ù† ÙƒÙ„ Ø¬Ø§Ù†Ø¨)
            wrapper.style.width = '60%';
            wrapper.style.height = '60%';
            document.getElementById('card').appendChild(wrapper);
            selectEl(wrapper);
            setupInteract(wrapper, 'box');
            saveState();
        }

        function addImageLayer(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'draggable-el image-layer bg-image is-locked';
                    const img = document.createElement('img');
                    img.crossOrigin = "anonymous"; // Ø¥Ø¶Ø§ÙØ© CrossOrigin
                    img.src = e.target.result; 
                    img.loading = "eager";
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.pointerEvents = 'none';
                    wrapper.appendChild(img);
                    const card = document.getElementById('card');
                    const gradient = document.getElementById('card-gradient');
                    if(gradient.nextSibling) card.insertBefore(wrapper, gradient.nextSibling);
                    else card.appendChild(wrapper);
                    setupInteract(wrapper, 'box');
                    saveState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = ''; 
            }
        }

        function addRegularImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = createWrapper('image-layer');
                    const contentWrapper = wrapper.querySelector('.content-wrapper');
                    wrapper.style.width = '60%';
                    wrapper.style.height = '60%';
                    contentWrapper.style.width = '100%';
                    contentWrapper.style.height = '100%';
                    contentWrapper.style.overflow = 'hidden';
                    contentWrapper.style.borderRadius = '8px';
                    contentWrapper.style.display = 'flex';
                    
                    const img = document.createElement('img');
                    img.crossOrigin = "anonymous"; // Ø¥Ø¶Ø§ÙØ© CrossOrigin
                    img.src = e.target.result;
                    img.loading = "eager";
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'fill';
                    img.style.pointerEvents = 'none';
                    img.style.imageRendering = 'high-quality';
                    
                    wrapper.setAttribute('data-original-image', e.target.result);
                    
                    contentWrapper.appendChild(img);
                    document.getElementById('card').appendChild(wrapper);
                    selectEl(wrapper);
                    setupInteract(wrapper, 'box');
                    saveState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function toggleEraserMode() {
            eraserMode = !eraserMode;
            magicMode = false;
            const btn = document.getElementById('btn-eraser');
            const controls = document.getElementById('eraser-controls');
            const magicBtn = document.getElementById('btn-magic');
            const magicControls = document.getElementById('magic-tolerance-control');
            if(magicBtn) {
                magicBtn.classList.remove('bg-[#6366f1]', 'text-white');
                magicBtn.classList.add('bg-white', 'text-[#1e293b]');
                magicControls.classList.add('hidden');
                magicControls.classList.remove('flex');
            }
            if(eraserMode) {
                deselect();
                btn.classList.add('bg-[#6366f1]', 'text-white');
                controls.classList.add('active');
                document.getElementById('card').style.cursor = 'crosshair';
                initEraserCanvas();
                // Disable interaction with other layers while erasing
                document.querySelectorAll('.draggable-el').forEach(el => el.style.pointerEvents = 'none');
            } else {
                exitEraserMode();
            }
        }
        
        function toggleMagicMode() {
            magicMode = !magicMode;
            const btn = document.getElementById('btn-magic');
            const magicControls = document.getElementById('magic-tolerance-control');
            if(magicMode) {
                btn.classList.add('bg-[#6366f1]', 'text-white');
                btn.classList.remove('bg-white', 'text-[#1e293b]');
                document.getElementById('card').style.cursor = 'alias';
                magicControls.classList.remove('hidden');
                magicControls.classList.add('flex');
            } else {
                btn.classList.remove('bg-[#6366f1]', 'text-white');
                btn.classList.add('bg-white', 'text-[#1e293b]');
                document.getElementById('card').style.cursor = 'crosshair';
                magicControls.classList.add('hidden');
                magicControls.classList.remove('flex');
            }
        }

        function exitEraserMode() {
            eraserMode = false;
            magicMode = false;
            const btn = document.getElementById('btn-eraser');
            const controls = document.getElementById('eraser-controls');
            btn.classList.remove('bg-[#6366f1]', 'text-white');
            controls.classList.remove('active');
            document.getElementById('card').style.cursor = 'default';
            if(eraserCanvas) {
                eraserCanvas.remove();
                eraserCanvas = null;
            }
            // Re-enable interaction with other layers
            document.querySelectorAll('.draggable-el').forEach(el => el.style.pointerEvents = '');
        }

        function initEraserCanvas() {
            const card = document.getElementById('card');
            if(eraserCanvas) eraserCanvas.remove();
            eraserCanvas = document.createElement('canvas');
            eraserCanvas.width = card.offsetWidth;
            eraserCanvas.height = card.offsetHeight;
            eraserCanvas.style.position = 'absolute';
            eraserCanvas.style.top = '0';
            eraserCanvas.style.left = '0';
            eraserCanvas.style.cursor = 'crosshair';
            eraserCanvas.style.zIndex = '200';
            const ctx = eraserCanvas.getContext('2d', { willReadFrequently: true });
            let isDrawing = false;
            
            eraserCanvas.addEventListener('mousedown', startErasing);
            eraserCanvas.addEventListener('touchstart', startErasing, { passive: false });
            
            function startErasing(e) {
                e.preventDefault();
                const rect = eraserCanvas.getBoundingClientRect();
                const cardRect = card.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - cardRect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - cardRect.top;
                
                if(magicMode) {
                    saveState();
                    magicErase(x, y, ctx);
                    return;
                }
                isDrawing = true;
                saveState();
                erase(x, y, ctx);
            }
            
            // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Flood Fill)
            function magicErase(x, y, ctx) {
                const protectBg = document.getElementById('eraser-protect-bg').checked;
                const images = Array.from(card.querySelectorAll('.image-layer')).reverse();
                
                for (let imgLayer of images) {
                    if(protectBg && imgLayer.classList.contains('bg-image')) continue;
                    
                    const rect = imgLayer.getBoundingClientRect();
                    const cardRect = card.getBoundingClientRect();
                    const layerLeft = rect.left - cardRect.left;
                    const layerTop = rect.top - cardRect.top;
                    
                    const relX = Math.floor(x - layerLeft);
                    const relY = Math.floor(y - layerTop);
                    const width = rect.width;
                    const height = rect.height;
                    
                    // Check if click is inside this layer
                    if(relX >= 0 && relX < width && relY >= 0 && relY < height) {
                        const img = imgLayer.querySelector('img');
                        if(!img) continue;
                        
                        // Create or use existing canvas
                        if(!imgLayer.magicCanvas) {
                            imgLayer.magicCanvas = document.createElement('canvas');
                            imgLayer.magicCanvas.width = img.naturalWidth || width;
                            imgLayer.magicCanvas.height = img.naturalHeight || height;
                            const magicCtx = imgLayer.magicCanvas.getContext('2d');
                            magicCtx.drawImage(img, 0, 0, imgLayer.magicCanvas.width, imgLayer.magicCanvas.height);
                        }
                        
                        performFloodFill(imgLayer, relX, relY, width, height);
                        break;
                    }
                }
                
                function performFloodFill(imgLayer, clickX, clickY, displayWidth, displayHeight) {
                    const img = imgLayer.querySelector('img');
                    const canvas = imgLayer.magicCanvas;
                    const imgCtx = canvas.getContext('2d', { willReadFrequently: true });
                    const imageData = imgCtx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Scale click position to image coordinates
                    const scaleX = canvas.width / displayWidth;
                    const scaleY = canvas.height / displayHeight;
                    const imgX = Math.floor(clickX * scaleX);
                    const imgY = Math.floor(clickY * scaleY);
                    
                    // Check bounds
                    if(imgX < 0 || imgX >= canvas.width || imgY < 0 || imgY >= canvas.height) return;
                    
                    const startIdx = (imgY * canvas.width + imgX) * 4;
                    const sr = data[startIdx];
                    const sg = data[startIdx + 1];
                    const sb = data[startIdx + 2];
                    const sa = data[startIdx + 3];
                    
                    if(sa === 0) return; // Clicked on transparent
                    
                    const tolerance = magicTolerance;
                    
                    function colorsMatch(r, g, b, a) {
                        if(a === 0) return false;
                        const dr = r - sr;
                        const dg = g - sg;
                        const db = b - sb;
                        return (Math.abs(dr) + Math.abs(dg) + Math.abs(db)) < (tolerance * 3 * 2.55);
                    }
                    
                    // Flood fill using queue
                    const queue = [startIdx];
                    const visited = new Set();
                    visited.add(startIdx);
                    
                    while(queue.length > 0) {
                        const idx = queue.shift();
                        data[idx + 3] = 0; // Make transparent
                        
                        const pixelIndex = idx / 4;
                        const px = pixelIndex % canvas.width;
                        const py = Math.floor(pixelIndex / canvas.width);
                        
                        // Check 4 neighbors
                        const neighbors = [
                            {x: px - 1, y: py},
                            {x: px + 1, y: py},
                            {x: px, y: py - 1},
                            {x: px, y: py + 1}
                        ];
                        
                        for(let neighbor of neighbors) {
                            if(neighbor.x >= 0 && neighbor.x < canvas.width && neighbor.y >= 0 && neighbor.y < canvas.height) {
                                const nIdx = (neighbor.y * canvas.width + neighbor.x) * 4;
                                if(!visited.has(nIdx)) {
                                    visited.add(nIdx);
                                    const nr = data[nIdx];
                                    const ng = data[nIdx + 1];
                                    const nb = data[nIdx + 2];
                                    const na = data[nIdx + 3];
                                    
                                    if(colorsMatch(nr, ng, nb, na)) {
                                        queue.push(nIdx);
                                    }
                                }
                            }
                        }
                    }
                    
                    imgCtx.putImageData(imageData, 0, 0);
                    img.src = canvas.toDataURL();
                }
            }
            
            function erase(x, y, ctx) {
                const protectBg = document.getElementById('eraser-protect-bg').checked;
                const images = card.querySelectorAll('.image-layer');
                images.forEach(imgLayer => {
                    if(protectBg && imgLayer.classList.contains('bg-image')) {
                        return;
                    }
                    const rect = imgLayer.getBoundingClientRect();
                    const cardRect = card.getBoundingClientRect();
                    const relX = rect.left - cardRect.left;
                    const relY = rect.top - cardRect.top;
                    const width = rect.width;
                    const height = rect.height;
                    if(x >= relX && x <= relX + width && y >= relY && y <= relY + height) {
                        const img = imgLayer.querySelector('img');
                        if(img && img.complete) {
                            // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„ØµÙˆØ±Ø©ØŒ Ù„Ø§ Ø§Ù„Ø¨ÙƒØ³Ù„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
                            const naturalWidth = img.naturalWidth || width;
                            const naturalHeight = img.naturalHeight || height;
                            
                            if(!imgLayer.canvas) {
                                imgLayer.canvas = document.createElement('canvas');
                                imgLayer.canvas.width = naturalWidth;
                                imgLayer.canvas.height = naturalHeight;
                                const imgCtx = imgLayer.canvas.getContext('2d');
                                imgCtx.drawImage(img, 0, 0, naturalWidth, naturalHeight);
                            }
                            
                            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                            const scaleX = naturalWidth / width;
                            const scaleY = naturalHeight / height;
                            const scaledX = (x - relX) * scaleX;
                            const scaledY = (y - relY) * scaleY;
                            const scaledSize = (eraserSize / 2) * Math.max(scaleX, scaleY);
                            
                            const imgCtx = imgLayer.canvas.getContext('2d');
                            imgCtx.globalCompositeOperation = 'destination-out';
                            imgCtx.shadowBlur = eraserSoftness * Math.max(scaleX, scaleY);
                            imgCtx.shadowColor = "black";
                            imgCtx.fillStyle = "black";
                            imgCtx.beginPath();
                            imgCtx.arc(scaledX, scaledY, scaledSize, 0, Math.PI * 2);
                            imgCtx.fill();
                            img.src = imgLayer.canvas.toDataURL();
                        }
                    }
                });
            }
            
            eraserCanvas.addEventListener('mousemove', (e) => {
                if(!isDrawing) return;
                const rect = eraserCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                erase(x, y, ctx);
            });
            
            eraserCanvas.addEventListener('touchmove', (e) => {
                if(!isDrawing) return;
                e.preventDefault();
                const rect = eraserCanvas.getBoundingClientRect();
                const x = e.touches[0].clientX - rect.left;
                const y = e.touches[0].clientY - rect.top;
                erase(x, y, ctx);
            });
            
            eraserCanvas.addEventListener('mouseup', () => { isDrawing = false; });
            eraserCanvas.addEventListener('touchend', () => { isDrawing = false; });
            
            card.appendChild(eraserCanvas);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const eraserSizeInput = document.getElementById('eraser-size');
            const eraserSoftnessInput = document.getElementById('eraser-softness');
            const magicToleranceInput = document.getElementById('magic-tolerance');
            
            if(eraserSizeInput) {
                eraserSizeInput.addEventListener('input', (e) => {
                    eraserSize = parseInt(e.target.value);
                    document.getElementById('eraser-size-display').textContent = eraserSize;
                });
            }
            if(eraserSoftnessInput) {
                eraserSoftnessInput.addEventListener('input', (e) => {
                    eraserSoftness = parseInt(e.target.value);
                    document.getElementById('eraser-softness-display').textContent = eraserSoftness;
                });
            }
            if(magicToleranceInput) {
                magicToleranceInput.addEventListener('input', (e) => {
                    magicTolerance = parseInt(e.target.value);
                    document.getElementById('magic-tolerance-display').textContent = magicTolerance;
                });
            }
        });

        function setupInteract(el, type) {
            if(el.hasAttribute('data-events-bound')) return;
            el.setAttribute('data-events-bound', 'true');
            
            let tapCount = 0;
            let tapTimeout;
            let lastClickTime = 0;
            
            function handleDoubleTap() {
                const now = Date.now();
                if (now - lastClickTime < 300) {
                    tapCount++;
                } else {
                    tapCount = 1;
                }
                lastClickTime = now;
                
                if (tapCount === 2) {
                    toggleLock(el);
                    tapCount = 0;
                    lastClickTime = 0;
                    return;
                }
                
                clearTimeout(tapTimeout);
                tapTimeout = setTimeout(() => {
                    tapCount = 0;
                    lastClickTime = 0;
                }, 300);
            }
            
            el.addEventListener('click', function(e) {
                handleDoubleTap();
            });
            
            el.addEventListener('touchend', function(e) {
                if (e.target.closest('.control-btn')) return;
                handleDoubleTap();
            });
            
            el.addEventListener('dblclick', function(e) {
                toggleLock(el);
                e.stopPropagation();
            });

            el.addEventListener('mousedown', startDrag);
            el.addEventListener('touchstart', startDrag, {passive: false});

            function startDrag(e) {
                // Fix for iOS delete button tap - Check this FIRST
                if(e.target.closest('.control-btn')) return;

                if(el.classList.contains('is-locked')) return;
                
                // Content editable check - simple return allows focus
                if(e.target.isContentEditable || e.target.closest('.user-text')) {
                     if (!e.target.classList.contains('move-handle') && !e.target.closest('.move-handle')) {
                          selectEl(el);
                          if (e.type === 'touchstart') {
                              e.target.focus(); 
                          }
                          return;
                      }
                }
                
                const isTouch = e.type === 'touchstart';
                const startX = isTouch ? e.touches[0].clientX : e.clientX;
                const startY = isTouch ? e.touches[0].clientY : e.clientY;
                
                if(e.target.classList.contains('handle')) {
                    handleResize(e, el, e.target, startX, startY);
                    return;
                }
                
                if(el.classList.contains('frame-layer') && e.target === el) {
                    selectEl(el);
                    return;
                }

                e.preventDefault(); 
                e.stopPropagation();
                
                selectEl(el);

                const startLeft = el.offsetLeft;
                const startTop = el.offsetTop;

                function onMove(ev) {
                    ev.preventDefault();
                    const cx = isTouch ? ev.touches[0].clientX : ev.clientX;
                    const cy = isTouch ? ev.touches[0].clientY : ev.clientY;

                    const dx = cx - startX;
                    const dy = cy - startY;

                    let newLeft = startLeft + dx;
                    let newTop = startTop + dy;

                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                    el.style.transform = 'translate(-50%, -50%)';
                }

                function onUp() {
                    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onMove);
                    document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
                    saveState();
                }

                document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onMove, {passive: false});
                document.addEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
            }
        }

        function handleResize(e, el, handle, startX, startY) {
            const isTouch = e.type === 'touchstart';
            const startW = el.offsetWidth;
            const startH = el.offsetHeight;
            const startLeft = el.offsetLeft;
            const startTop = el.offsetTop;
            const startFontSize = parseInt(window.getComputedStyle(el).fontSize);

            function onResize(ev) {
                ev.preventDefault();
                ev.stopPropagation();
                
                const cx = isTouch ? ev.touches[0].clientX : ev.clientX;
                const cy = isTouch ? ev.touches[0].clientY : ev.clientY;
                
                const dx = cx - startX;
                const dy = cy - startY;

                let newW = startW;
                let newH = startH;
                let newLeft = startLeft;
                let newTop = startTop;

                if (handle.classList.contains('resize-n') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-nw')) {
                    let potentialH = startH - dy;
                    newH = Math.max(50, potentialH);
                    newTop = startTop - (newH - startH) / 2;
                } else if (handle.classList.contains('resize-s') || handle.classList.contains('resize-se') || handle.classList.contains('resize-sw')) {
                    let potentialH = startH + dy;
                    newH = Math.max(50, potentialH);
                    newTop = startTop + (newH - startH) / 2;
                }

                if (handle.classList.contains('resize-e') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-se')) {
                    let potentialW = startW + dx;
                    newW = Math.max(50, potentialW);
                    newLeft = startLeft + (newW - startW) / 2;
                } else if (handle.classList.contains('resize-nw') || handle.classList.contains('resize-sw')) { 
                    let potentialW = startW - dx;
                    newW = Math.max(50, potentialW);
                    newLeft = startLeft - (newW - startW) / 2;
                }

                el.style.width = newW + 'px';
                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';

                if(el.classList.contains('text-layer') && (handle.classList.contains('resize-e') || handle.classList.contains('resize-w') || handle.classList.contains('resize-nw') || handle.classList.contains('resize-ne') || handle.classList.contains('resize-sw') || handle.classList.contains('resize-se'))) {
                     if(!(handle.classList.contains('resize-n') || handle.classList.contains('resize-s'))) {
                        el.style.height = 'auto'; 
                     } else {
                        el.style.height = newH + 'px';
                     }
                } else {
                    el.style.height = newH + 'px';
                }
            }

            function onUp() {
                document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', onResize);
                document.removeEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
                saveState();
            }

            document.addEventListener(isTouch ? 'touchmove' : 'mousemove', onResize, {passive: false});
            document.addEventListener(isTouch ? 'touchend' : 'mouseup', onUp);
        }

        function selectEl(el) {
            if(activeEl) activeEl.classList.remove('selected');
            
            activeEl = el;
            activeEl.classList.add('selected');

            const panel = document.getElementById('style-panel');
            panel.classList.remove('opacity-50', 'pointer-events-none');
            
            document.getElementById('quick-props').classList.remove('hidden');
            document.getElementById('quick-props').classList.add('active');
            document.getElementById('no-selection-msg').classList.add('hidden');

            document.getElementById('text-controls').classList.add('hidden');
            document.getElementById('frame-controls').classList.add('hidden');
            document.getElementById('frame-controls-toolbar').classList.add('hidden');
            
            document.getElementById('top-font-controls').classList.add('hidden');

            if(el.classList.contains('text-layer')) {
                document.getElementById('text-controls').classList.remove('hidden');
                document.getElementById('top-font-controls').classList.remove('hidden');
                document.getElementById('top-font-controls').classList.add('flex');
                
                document.getElementById('panel-title').innerText = "ØªØ­Ø±ÙŠØ± Ø§Ù„Ù†Øµ";
                
                const fSize = parseInt(el.style.fontSize);
                document.getElementById('font-size').value = fSize;
                document.getElementById('font-size-input').value = fSize;
                document.getElementById('top-font-size').value = fSize;
                document.getElementById('top-font-size-input').value = fSize;
                
                const fontFamily = el.style.fontFamily.replace(/"/g, "'");
                document.getElementById('font-family').value = fontFamily;
                document.getElementById('top-font-family').value = fontFamily;
                document.getElementById('quick-color').value = rgbToHex(el.style.color);
                
                document.getElementById('color-label').innerText = "Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:";
                updateBoldButtonState();
            } else if(el.classList.contains('frame-layer')) {
                document.getElementById('frame-controls').classList.remove('hidden');
                document.getElementById('frame-controls-toolbar').classList.remove('hidden');
                document.getElementById('frame-controls-toolbar').classList.add('flex');
                document.getElementById('panel-title').innerText = "ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø·Ø§Ø±";
                const borderColor = el.style.borderColor || el.style.backgroundColor || '#334155';
                document.getElementById('quick-color').value = rgbToHex(borderColor);
                document.getElementById('color-label').innerText = "Ø§Ù„Ù„ÙˆÙ†:";
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙˆÙ„Ø¯
        function toggleBold() {
            if (!activeEl) return;
            const currentWeight = activeEl.style.fontWeight;
            const btn = document.getElementById('btn-bold');
            
            if (currentWeight === 'bold' || currentWeight === '700') {
                activeEl.style.fontWeight = 'normal';
                btn.classList.remove('bg-[#6366f1]', 'text-white');
                btn.classList.add('bg-white', 'text-[#1e293b]');
            } else {
                activeEl.style.fontWeight = 'bold';
                btn.classList.add('bg-[#6366f1]', 'text-white');
                btn.classList.remove('bg-white', 'text-[#1e293b]');
            }
            saveState();
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¨ÙˆÙ„Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        function updateBoldButtonState() {
            const btn = document.getElementById('btn-bold');
            if (!activeEl || !btn) return;
            const currentWeight = activeEl.style.fontWeight;
            if (currentWeight === 'bold' || currentWeight === '700') {
                btn.classList.add('bg-[#6366f1]', 'text-white');
                btn.classList.remove('bg-white', 'text-[#1e293b]');
            } else {
                btn.classList.remove('bg-[#6366f1]', 'text-white');
                btn.classList.add('bg-white', 'text-[#1e293b]');
            }
        }

        function deselect(e) {
            if(e && (e.target.closest('.draggable-el') || e.target.closest('#style-panel') || e.target.closest('select') || e.target.closest('input') || e.target.closest('.controls-row'))) return;

            if(activeEl) activeEl.classList.remove('selected');
            activeEl = null;
            
            document.getElementById('quick-props').classList.add('hidden');
            document.getElementById('quick-props').classList.remove('active');
            document.getElementById('text-controls').classList.add('hidden');
            document.getElementById('frame-controls').classList.add('hidden');
            document.getElementById('frame-controls-toolbar').classList.add('hidden');
            
            document.getElementById('top-font-controls').classList.add('hidden');
            document.getElementById('top-font-controls').classList.remove('flex');
            
            document.getElementById('no-selection-msg').classList.remove('hidden');
            document.getElementById('panel-title').innerText = "Ø§Ù„Ø®ØµØ§Ø¦Øµ";
        }

        function toggleLock(el) {
            el.classList.toggle('is-locked');
            if(el.classList.contains('is-locked')) {
                el.classList.remove('selected');
                if(activeEl === el) deselect();
            }
        }

        function updateStyle(prop, val) {
            if(!activeEl) return;
            activeEl.style[prop] = val;
            
            if(prop === 'fontSize') {
                const numVal = parseInt(val);
                document.getElementById('font-size').value = numVal;
                document.getElementById('font-size-input').value = numVal;
                document.getElementById('top-font-size').value = numVal;
                document.getElementById('top-font-size-input').value = numVal;
            }
            
            if(prop === 'color' || prop === 'borderColor') {
                document.getElementById('quick-color').value = val;
                const surahLabel = activeEl.querySelector('.surah-label');
                if(surahLabel) surahLabel.style.color = val;
            }
            saveState();
        }

        function removeEl(el) {
            el.remove();
            deselect();
            saveState();
        }
        
        function deleteActive() {
            if(activeEl) removeEl(activeEl);
        }

        function toggleGradient() {
            hasGradient = !hasGradient;
            const grad = document.getElementById('card-gradient');
            const controls = document.getElementById('grad-controls');
            const btn = document.getElementById('btn-grad');
            
            if(hasGradient) {
                grad.style.display = 'block';
                controls.classList.add('active');
                btn.classList.add('bg-[#6366f1]', 'text-white');
            } else {
                grad.style.display = 'none';
                controls.classList.remove('active');
                btn.classList.remove('bg-[#6366f1]', 'text-white');
            }
        }
        
        function setGradientColor(color) {
            const grad = document.getElementById('card-gradient');
            const end = color === 'white' ? 'rgba(255,255,255,0.95)' : 'rgba(0,0,0,0.95)';
            const start = color === 'white' ? 'rgba(255,255,255,0)' : 'rgba(0,0,0,0)';
            grad.style.background = `linear-gradient(to top, ${end}, ${start})`;
            
            const blackBtn = document.getElementById('grad-black-btn');
            const whiteBtn = document.getElementById('grad-white-btn');
            if(color === 'white') {
                whiteBtn.classList.add('ring-2', 'ring-[#6366f1]');
                blackBtn.classList.remove('ring-2', 'ring-[#6366f1]');
            } else {
                blackBtn.classList.add('ring-2', 'ring-[#6366f1]');
                whiteBtn.classList.remove('ring-2', 'ring-[#6366f1]');
            }
        }
        
        function setGradientOpacity(val) {
            document.getElementById('card-gradient').style.opacity = val;
        }

        function setGradientHeight(val) {
            document.getElementById('card-gradient').style.height = val + '%';
        }

        function toggleBg() {
            isTransparent = !isTransparent;
            document.getElementById('card').style.backgroundColor = isTransparent ? 'transparent' : 'white';
            document.getElementById('btn-bg').innerText = isTransparent ? 'Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡' : 'Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ©';
        }

        function setCardSize(w, h) {
            const card = document.getElementById('card');
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‚Ø§Ø³ Ø¨Ø¯Ù‚Ø© - Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø§Ù†Ø¶ØºØ§Ø· Ø£Ùˆ ØªÙˆØ³Ø¹
            card.style.width = w + 'px';
            card.style.height = h + 'px';
            card.style.minWidth = w + 'px';
            card.style.maxWidth = w + 'px';
            card.style.minHeight = h + 'px';
            card.style.maxHeight = h + 'px';
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³ ÙÙŠ data attribute Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
            card.setAttribute('data-card-width', w);
            card.setAttribute('data-card-height', h);
            
            // Ø­Ø³Ø§Ø¨ zoom ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            const previewArea = document.querySelector('.preview-area');
            const maxWidth = previewArea.offsetWidth - 100; // Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø·Ø±
            const maxHeight = previewArea.offsetHeight - 100; // Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø·Ø±
            
            const zoomByWidth = (maxWidth / w) * 100;
            const zoomByHeight = (maxHeight / h) * 100;
            const autoZoom = Math.min(zoomByWidth, zoomByHeight, 200); // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 200%
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ zoom Ø§Ù„Ø£Ù…Ø«Ù„
            const optimalZoom = Math.max(25, Math.min(autoZoom, 200));
            setCustomZoom(optimalZoom);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
            const displayEl = document.getElementById('size-display');
            if (displayEl) {
                const cmW = (w / DPI_RATIO).toFixed(2);
                const cmH = (h / DPI_RATIO).toFixed(2);
                displayEl.textContent = `${w} Ã— ${h} px (${cmW} Ã— ${cmH} Ø³Ù…)`;
            }

            // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø·Ø±Ø©
            drawRulers(w, h);
        }
        
        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø·Ø±Ø©
        function drawRulers(w, h) {
            const rulerH = document.getElementById('ruler-h');
            const rulerV = document.getElementById('ruler-v');
            
            if(!rulerH || !rulerV) return;

            rulerH.innerHTML = '';
            rulerV.innerHTML = '';

            const cmW = Math.ceil(w / DPI_RATIO);
            const cmH = Math.ceil(h / DPI_RATIO);

            // Horizontal Ruler
            for (let i = 0; i <= cmW; i++) {
                const leftPos = i * DPI_RATIO;
                if(leftPos > w) break;

                const tick = document.createElement('div');
                tick.className = 'tick';
                tick.style.left = leftPos + 'px';
                tick.style.bottom = '0';
                tick.style.width = '1px';
                tick.style.height = '100%';
                
                const num = document.createElement('span');
                num.className = 'tick-num';
                num.innerText = i;
                num.style.left = (leftPos + 4) + 'px'; // offset slightly
                num.style.bottom = '4px';

                rulerH.appendChild(tick);
                rulerH.appendChild(num);
            }

            // Vertical Ruler
            for (let i = 0; i <= cmH; i++) {
                const topPos = i * DPI_RATIO;
                if(topPos > h) break;

                const tick = document.createElement('div');
                tick.className = 'tick';
                tick.style.top = topPos + 'px';
                tick.style.left = '0';
                tick.style.height = '1px';
                tick.style.width = '100%';
                
                const num = document.createElement('span');
                num.className = 'tick-num';
                num.innerText = i;
                num.style.top = (topPos + 4) + 'px';
                num.style.left = '4px';

                rulerV.appendChild(tick);
                rulerV.appendChild(num);
            }
        }

        function setCustomZoom(zoomValue) {
            currentZoom = Math.max(25, Math.min(zoomValue, 200)); // Ø¨ÙŠÙ† 25% Ùˆ 200%
            const zoomDecimal = currentZoom / 100;
            
            document.documentElement.style.setProperty('--card-zoom', zoomDecimal);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø¨Ø©
            const displayEl = document.getElementById('zoom-display');
            if (displayEl) {
                displayEl.textContent = `${Math.round(currentZoom)}%`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù€ slider
            const slider = document.getElementById('zoom-slider');
            if (slider) {
                slider.value = currentZoom;
            }
            
            saveState();
        }

        function applyCustomSizeSimple() {
            const wInput = document.getElementById('custom-width');
            const hInput = document.getElementById('custom-height');
            
            let widthCm = parseFloat(wInput.value);
            let heightCm = parseFloat(hInput.value);
            
            if (!widthCm || !heightCm) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…');
                return;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ± Ø¥Ù„Ù‰ Ø¨ÙƒØ³Ù„ Ø¨Ø¯Ù‚Ø© (1 Ø³Ù… = 118.11 Ø¨ÙƒØ³Ù„ @ 300 DPI)
            const widthPx = Math.round(widthCm * DPI_RATIO);
            const heightPx = Math.round(heightCm * DPI_RATIO);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„ÙØ¹Ù„ÙŠ
            wInput.value = (widthPx / DPI_RATIO).toFixed(2);
            hInput.value = (heightPx / DPI_RATIO).toFixed(2);
            
            setCardSize(widthPx, heightPx);
            saveState();
        }
        
        function rgbToHex(rgb) {
            if(!rgb || rgb === 'transparent') return '#000000';
            if(rgb.startsWith('#')) return rgb;
            try {
                return '#' + rgb.match(/\d+/g).map(x => (+x).toString(16).padStart(2, '0')).join('');
            } catch(e) { return '#000000'; }
        }

        function downloadImage() {
            const img = document.getElementById('save-img');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `dalal-studio-${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printDesignDirect() {
            // Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡ Ù†Ø¸ÙŠÙ Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ©
            const card = document.getElementById('card');
            const originalBg = card.style.backgroundColor;
            
            // ØªØ¹ÙŠÙŠÙ† Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹
            card.style.backgroundColor = 'transparent';
            
            html2canvas(card, {
                scale: 2,
                allowTaint: true,
                useCORS: true,
                backgroundColor: null,
                logging: false
            }).then(canvas => {
                // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
                card.style.backgroundColor = originalBg;
                
                const printWindow = window.open('', '', 'width=800,height=600');
                const img = canvas.toDataURL('image/png');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Ø·Ø¨Ø§Ø¹Ø©</title>
                        <style>
                            * { margin: 0; padding: 0; }
                            @page { margin: 0; padding: 0; }
                            body { margin: 0; padding: 0; }
                            img { display: block; }
                        </style>
                    </head>
                    <body onload="print()">
                        <img src="${img}" style="width: 100%; height: auto;">
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            });
        }

        // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø­Ø°Ù =====
        
        // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ =====
        function exportTemplates() {
            const templates = getTemplates();
            if (templates.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§!');
                return;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù JSON
            const dataStr = JSON.stringify(templates, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const link = document.createElement('a');
            link.href = url;
            link.download = `dalal_templates_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
        }
        
        function importTemplates() {
            // Ø¥Ù†Ø´Ø§Ø¡ input Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedTemplates = JSON.parse(event.target.result);
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù
                        if (!Array.isArray(importedTemplates)) {
                            alert('âŒ ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
                            return;
                        }
                        
                        // Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        const currentTemplates = getTemplates();
                        let message = `Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedTemplates.length} Ù‚Ø§Ù„Ø¨.\n\n`;
                        
                        if (currentTemplates.length > 0) {
                            message += 'Ù‡Ù„ ØªØ±ÙŠØ¯:\nâœ… Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯\nâŒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨';
                            
                            if (confirm(message)) {
                                // Ø¯Ù…Ø¬
                                const merged = [...currentTemplates, ...importedTemplates];
                                if (merged.length > MAX_TEMPLATES) {
                                    alert(`âš ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙˆÙ„ ${MAX_TEMPLATES} Ù‚Ø§Ù„Ø¨ ÙÙ‚Ø· (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)`);
                                    saveTemplates(merged.slice(0, MAX_TEMPLATES));
                                } else {
                                    saveTemplates(merged);
                                }
                            } else {
                                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                                if (importedTemplates.length > MAX_TEMPLATES) {
                                    alert(`âš ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙˆÙ„ ${MAX_TEMPLATES} Ù‚Ø§Ù„Ø¨ ÙÙ‚Ø· (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)`);
                                    saveTemplates(importedTemplates.slice(0, MAX_TEMPLATES));
                                } else {
                                    saveTemplates(importedTemplates);
                                }
                            }
                        } else {
                            // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©
                            if (importedTemplates.length > MAX_TEMPLATES) {
                                alert(`âš ï¸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙˆÙ„ ${MAX_TEMPLATES} Ù‚Ø§Ù„Ø¨ ÙÙ‚Ø· (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)`);
                                saveTemplates(importedTemplates.slice(0, MAX_TEMPLATES));
                            } else {
                                saveTemplates(importedTemplates);
                            }
                        }
                        
                        alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
                    } catch(error) {
                        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!\n' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        document.addEventListener('keydown', (e) => {
            // ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ
            if(e.target.contentEditable === 'true' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Ctrl+Z = ØªØ±Ø§Ø¬Ø¹
            if(e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undoAction();
                return;
            }
            // Ctrl+J = ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø¨Ù‚Ø©
            if(e.ctrlKey && e.key === 'j') {
                e.preventDefault();
                if(activeEl) {
                    duplicateActive();
                }
                return;
            }
            // Delete = Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
            if(e.key === 'Delete') {
                e.preventDefault();
                if(activeEl) {
                    deleteActive();
                }
                return;
            }
        });

        function duplicateActive() {
            if(!activeEl) return;
            saveState();
            const clone = activeEl.cloneNode(true);
            clone.classList.remove('selected');
            clone.removeAttribute('data-events-bound');
            
            // Ø¥Ø²Ø§Ø­Ø© Ø·ÙÙŠÙØ© Ù„Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            const newLeft = activeEl.offsetLeft + 10;
            const newTop = activeEl.offsetTop + 10;
            clone.style.left = newLeft + 'px';
            clone.style.top = newTop + 'px';
            
            document.getElementById('card').appendChild(clone);
            
            const type = clone.classList.contains('text-layer') ? 'text' : 'box';
            setupInteract(clone, type);
            selectEl(clone);
            saveState();
        }
    </script>
</body>
</html>