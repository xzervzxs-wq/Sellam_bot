                }
                setTimeout(function() {
                    const el = document.getElementById('studio-subtitle-display');
                    if(el) {
                        el.innerHTML = '<span>Ù…Ø³Ø§Ø­Ø© Ù…Ø®ØµØµØ©</span><span style="color: #cccccc; margin: 0 8px; font-weight: 300;">|</span><span>Ø­ÙŠØ« Ø£Ù†Øª âœ¨</span>';
                        el.classList.remove('text-slate-600');
                        el.classList.add('text-[#555555]');
                    }
                }, 500);
                setTimeout(function() {
                    const el = document.getElementById('studio-subtitle-display');
                    if(el) {
                        el.innerHTML = '<span>Ù…Ø³Ø§Ø­Ø© Ù…Ø®ØµØµØ©</span><span style="color: #cccccc; margin: 0 8px; font-weight: 300;">|</span><span>Ø­ÙŠØ« Ø£Ù†Øª âœ¨</span>';
                        el.classList.remove('text-slate-600');
                        el.classList.add('text-[#555555]');
                    }
                }, 1500);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù† ÙˆØ¬Ø¯
                const loginOverlay = document.getElementById('login-overlay');
                if(loginOverlay) loginOverlay.style.display = 'none';
            } else {
                // Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©
                logoutUser();
            }
        } catch (e) {
            console.error('Session error', e);
            logoutUser();
        }
    }
}

function updateFooterForUser(name) {
    const authContainer = document.getElementById('auth-container');
    
    if (authContainer) {
        authContainer.innerHTML = `
            <div class="flex items-center gap-2">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-[#fbbf24]/10 rounded-lg border border-[#fbbf24]/20 text-[#fbbf24] text-xs font-bold shadow-sm">
                        <i class="fas fa-crown text-[#fbbf24]"></i>
                        <span>${name}</span>
                    </div>
                    <span class="flex items-center gap-1 text-[11px] font-bold text-white/70">
                    </span>
                </div>
                <button type="button" id="logout-btn" class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 text-white rounded-lg border border-white/10 transition-all shadow-sm" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        `;
        
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                logoutUser();
            });
        }
    }
    
    const studioTitle = document.getElementById('studio-name-display');
    if(studioTitle) {
        studioTitle.innerHTML = `Ø§Ø³ØªÙˆØ¯ÙŠÙˆ ${name} ğŸ¨`;
    }
}

function logoutUser() {
    localStorage.removeItem('despro_session');
    localStorage.removeItem('userTier');
    sessionStorage.removeItem('studioName');
    sessionStorage.removeItem('expiryDate');
    sessionStorage.removeItem('sessionId');
    window.location.reload();
}
document.addEventListener('DOMContentLoaded', checkSession);
document.addEventListener('DOMContentLoaded', loadAssetsLibraryFromGitHub);


// ============ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª (Layers Panel) ============

function toggleLayersPanel() {
    const content = document.getElementById('layers-panel-content');
    const arrow = document.getElementById('layers-panel-arrow');
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        content.classList.add('flex');
        arrow.style.transform = 'rotate(-90deg)';
    } else {
        content.classList.add('hidden');
        content.classList.remove('flex');
        arrow.style.transform = 'rotate(0deg)';
    }
}


function toggleLayerVisibility(button, elementId) {
    const card = document.getElementById('card');
    const element = card?.querySelector(`[data-element-id="${elementId}"]`);
    
    if (element) {
        element.style.display = element.style.display === 'none' ? '' : 'none';
        button.querySelector('i').classList.toggle('fa-eye-slash');
        button.classList.toggle('opacity-50');
    }
}

function deleteElement(elementId) {
    const card = document.getElementById('card');
    const element = card?.querySelector(`[data-element-id="${elementId}"]`);
    
    if (element && confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) {
        removeEl(element);
    }
}

document.addEventListener('DOMContentLoaded', updateLayersList);

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
const originalSelectEl = selectEl;
selectEl = function(el) {
    originalSelectEl(el);
    if (typeof updateLayersList === 'function') {
        updateLayersList();
    }
};





document.addEventListener('DOMContentLoaded', updateLayersList);

// Override to ensure update on open

// === FIXED updateLayersList - finds ALL elements ===

// === ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø·Ø¨Ù‚Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ (z-index Ø£ÙƒØ¨Ø±) ===
function moveLayerUp(elementId) {
    const card = document.getElementById('card');
    const element = card.querySelector('[data-element-id="' + elementId + '"]');
    if (!element) return;
    
    const allElements = Array.from(card.querySelectorAll('.draggable-el'));
    const currentZ = parseInt(element.style.zIndex) || 10;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙÙˆÙ‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
    let nextHigherZ = Infinity;
    let swapElement = null;
    
    allElements.forEach(el => {
        if (el === element) return;
        const z = parseInt(el.style.zIndex) || 10;
        if (z > currentZ && z < nextHigherZ) {
            nextHigherZ = z;
            swapElement = el;
        }
    });
    
    if (swapElement) {
        // ØªØ¨Ø¯ÙŠÙ„ z-index
        element.style.zIndex = nextHigherZ;
        swapElement.style.zIndex = currentZ;
    } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ØµØ± ÙÙˆÙ‚Ù‡ØŒ Ø²Ø¯ z-index Ø¨Ù€ 1
        element.style.zIndex = currentZ + 1;
    }
    
    updateLayersList();
    saveState();
}

// === ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø·Ø¨Ù‚Ø© Ù„Ù„Ø£Ø³ÙÙ„ (z-index Ø£Ù‚Ù„) ===
function moveLayerDown(elementId) {
    const card = document.getElementById('card');
    const element = card.querySelector('[data-element-id="' + elementId + '"]');
    if (!element) return;
    
    const allElements = Array.from(card.querySelectorAll('.draggable-el'));
    const currentZ = parseInt(element.style.zIndex) || 10;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ØªØ­ØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©
    let nextLowerZ = -Infinity;
    let swapElement = null;
    
    allElements.forEach(el => {
        if (el === element) return;
        const z = parseInt(el.style.zIndex) || 10;
        if (z < currentZ && z > nextLowerZ) {
            nextLowerZ = z;
            swapElement = el;
        }
    });
    
    if (swapElement) {
        // ØªØ¨Ø¯ÙŠÙ„ z-index
        element.style.zIndex = nextLowerZ;
        swapElement.style.zIndex = currentZ;
    } else if (currentZ > 1) {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ØµØ± ØªØ­ØªÙ‡ØŒ Ù‚Ù„Ù„ z-index Ø¨Ù€ 1
        element.style.zIndex = currentZ - 1;
    }
    
    updateLayersList();
    saveState();
}

// === Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ ===
function updateLayersList() {
    const card = document.getElementById('card');
    const layersList = document.getElementById('layers-list');
    
    if (!card || !layersList) return;
    
    const elements = card.querySelectorAll('.draggable-el');
    
    if (elements.length === 0) {
        layersList.innerHTML = '<div class="text-center text-[10px] text-[#64748b] py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„</div>';
        return;
    }
    
    layersList.innerHTML = '';
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ z-index (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ø§Ù‹)
    const elementsArray = Array.from(elements).sort((a, b) => {
        return (parseInt(b.style.zIndex) || 10) - (parseInt(a.style.zIndex) || 10);
    });
    
    elementsArray.forEach((element, index) => {
        let elementId = element.getAttribute('data-element-id');
        if (!elementId) {
            elementId = 'el-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            element.setAttribute('data-element-id', elementId);
        }
        
        let elementType = '';
        let icon = 'fa-square';
        
        if (element.classList.contains('text-layer')) {
            elementType = 'Ù†Øµ';
            icon = 'fa-font';
        } else if (element.classList.contains('image-layer')) {
            elementType = 'ØµÙˆØ±Ø©';
            icon = 'fa-image';
        } else if (element.classList.contains('frame-layer')) {
            elementType = 'Ø¥Ø·Ø§Ø±';
            icon = 'fa-vector-square';
        } else if (element.classList.contains('shape-layer')) {
            elementType = 'Ø´ÙƒÙ„';
            icon = 'fa-shapes';
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
            const categoryName = element.getAttribute('data-category-name');
            if (categoryName) {
                elementType = categoryName;
            } else {
                elementType = 'Ø¹Ù†ØµØ±';
            }
        }
        
        const isSelected = element.classList.contains('selected');
        const isHidden = element.style.display === 'none';
        const zIndex = parseInt(element.style.zIndex) || 10;
        
        const layerItem = document.createElement('div');
        layerItem.className = 'layer-item p-2 rounded-lg border transition-all cursor-pointer flex items-center gap-2 ' + 
            (isSelected 
                ? 'bg-[#6366f1] text-white border-[#6366f1]' 
                : 'bg-white border-[#e2e8f0] text-[#1e293b] hover:border-[#6366f1]');
        
        layerItem.innerHTML = '<div class="flex-1 flex items-center gap-2 min-w-0">' +
            '<i class="fas ' + icon + '"></i>' +
            '<div class="flex-1 min-w-0">' +
                '<div class="text-[10px] font-bold truncate">' + elementType + '</div>' +
            '</div>' +
        '</div>' +
        '<div class="flex items-center gap-0.5" onclick="event.stopPropagation()">' +
            '<button class="p-1 text-[10px] hover:bg-[#e2e8f0] rounded transition" onclick="moveLayerUp(\'' + elementId + '\')" title="ØªÙ‚Ø¯ÙŠÙ… Ù„Ù„Ø£Ù…Ø§Ù…">' +
                '<i class="fas fa-chevron-up"></i>' +
            '</button>' +
            '<button class="p-1 text-[10px] hover:bg-[#e2e8f0] rounded transition" onclick="moveLayerDown(\'' + elementId + '\')" title="Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ù„Ù">' +
                '<i class="fas fa-chevron-down"></i>' +
            '</button>' +
            '<button class="p-1 text-[10px] hover:opacity-70 transition ' + (isHidden ? 'opacity-50' : '') + '" onclick="toggleLayerVisibility(this, \'' + elementId + '\')" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">' +
                '<i class="fas ' + (isHidden ? 'fa-eye-slash' : 'fa-eye') + '"></i>' +
            '</button>' +
            '<button class="p-1 text-[10px] hover:text-red-500 transition" onclick="deleteElement(\'' + elementId + '\')" title="Ø­Ø°Ù">' +
                '<i class="fas fa-trash"></i>' +
            '</button>' +
        '</div>';
        
        layerItem.addEventListener('click', function(e) {
            if (!e.target.closest('button')) {
                selectEl(element);
                updateLayersList();
            }
        });
        
        layersList.appendChild(layerItem);
    });
}
